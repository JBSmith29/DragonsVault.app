services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
    command:
      [
        "redis-server",
        "--save", "60", "1",
        "--loglevel", "warning",
        "--maxmemory", "1gb",
        "--maxmemory-policy", "allkeys-lru"
      ]

  ui:
    build:
      context: ./frontend
    command: npm run dev -- --host 0.0.0.0 --port 5173
    restart: unless-stopped
    environment:
      VITE_API_BASE_URL: /api
    volumes:
      - ./frontend:/app
      - ui-node-modules:/app/node_modules
    depends_on:
      - user-manager
      - card-data
      - folder-service

  user-manager:
    build:
      context: .
      dockerfile: backend/microservices/user-manager/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${USER_MANAGER_CONCURRENCY:-2}
      --threads ${USER_MANAGER_THREADS:-2}
      --worker-class gthread
      --timeout ${USER_MANAGER_TIMEOUT:-90}
      "app:create_app()"
    restart: unless-stopped
    environment:
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      SERVICE_NAME: user-manager
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      DATABASE_SCHEMA: user_manager
    depends_on:
      - postgres
      - pgbouncer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:5000/healthz', timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  card-data:
    build:
      context: .
      dockerfile: backend/microservices/card-data/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${CARD_DATA_CONCURRENCY:-2}
      --threads ${CARD_DATA_THREADS:-2}
      --worker-class gthread
      --timeout ${CARD_DATA_TIMEOUT:-90}
      "app:create_app()"
    restart: unless-stopped
    environment:
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      SERVICE_NAME: card-data
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      DATABASE_SCHEMA: card_data
      SCRYFALL_DATA_DIR: /tmp/scryfall
      SCRYFALL_UA: "DragonsVault/6 (+https://dragonsvault.app)"
      SCRYFALL_TIMEOUT: "180"
      SCRYFALL_KEEP_DOWNLOADS: "0"
    depends_on:
      - postgres
      - pgbouncer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:5000/healthz', timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  folder-service:
    build:
      context: .
      dockerfile: backend/microservices/folder-service/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${FOLDER_SERVICE_CONCURRENCY:-2}
      --threads ${FOLDER_SERVICE_THREADS:-2}
      --worker-class gthread
      --timeout ${FOLDER_SERVICE_TIMEOUT:-90}
      "app:create_app()"
    restart: unless-stopped
    environment:
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      SERVICE_NAME: folder-service
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      DATABASE_SCHEMA: folder_service
    depends_on:
      - postgres
      - pgbouncer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:5000/healthz', timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  price-service:
    build:
      context: .
      dockerfile: backend/microservices/price-service/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${PRICE_SERVICE_CONCURRENCY:-2}
      --threads ${PRICE_SERVICE_THREADS:-2}
      --worker-class gthread
      --timeout ${PRICE_SERVICE_TIMEOUT:-90}
      "app:create_app()"
    restart: unless-stopped
    environment:
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      SERVICE_NAME: price-service
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      DATABASE_SCHEMA: price_service
      MTGJSON_GRAPHQL_URL: ${MTGJSON_GRAPHQL_URL:-https://graphql.mtgjson.com/}
      MTGJSON_API_TOKEN: ${MTGJSON_API_TOKEN:-}
      PRICE_CACHE_TTL: ${PRICE_CACHE_TTL:-43200}
      PRICE_REQUEST_TIMEOUT: ${PRICE_REQUEST_TIMEOUT:-20}
      PRICE_PROVIDER_PREFERENCE: ${PRICE_PROVIDER_PREFERENCE:-tcgplayer,cardmarket,cardkingdom,mtgstocks}
      PRICE_LISTTYPE_PREFERENCE: ${PRICE_LISTTYPE_PREFERENCE:-retail,market}
    depends_on:
      - postgres
      - pgbouncer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:5000/healthz', timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  edhrec-service:
    build:
      context: .
      dockerfile: backend/microservices/edhrec-service/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${EDHREC_SERVICE_CONCURRENCY:-2}
      --threads ${EDHREC_SERVICE_THREADS:-2}
      --worker-class gthread
      --timeout ${EDHREC_SERVICE_TIMEOUT:-90}
      "app:create_app()"
    restart: unless-stopped
    environment:
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      SERVICE_NAME: edhrec-service
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      DATABASE_SCHEMA: edhrec_service
      EDHREC_CACHE_TTL_HOURS: ${EDHREC_CACHE_TTL_HOURS:-72}
      EDHREC_REQUEST_TIMEOUT: ${EDHREC_REQUEST_TIMEOUT:-30}
      EDHREC_HTTP_RETRIES: ${EDHREC_HTTP_RETRIES:-2}
      EDHREC_REFRESH_CONCURRENCY: ${EDHREC_REFRESH_CONCURRENCY:-4}
    depends_on:
      - postgres
      - pgbouncer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:5000/healthz', timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  web:
    build:
      context: .
      dockerfile: infra/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${WEB_CONCURRENCY:-1}
      --threads ${WEB_THREADS:-1}
      --worker-class gthread
      --worker-tmp-dir /dev/shm
      --timeout ${WEB_TIMEOUT:-300}
      --access-logfile -
      --error-logfile -
      --log-level info
      "app:create_app()"
    ports:
      - "127.0.0.1:5000:5000"
    restart: unless-stopped
    environment:
      PYTHONPATH: /app/backend
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      INSTANCE_DIR: /app/instance
      CACHE_DEFAULT_TIMEOUT: "600"
      CACHE_TYPE: RedisCache
      CACHE_REDIS_URL: redis://redis:6379/2
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set_in_env_file}
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      PRICE_SERVICE_URL: http://price-service:5000
      PRICE_SERVICE_HTTP_TIMEOUT: ${PRICE_SERVICE_HTTP_TIMEOUT:-3}
      PRICE_SERVICE_CACHE_TTL: ${PRICE_SERVICE_CACHE_TTL:-300}
      EDHREC_SERVICE_URL: http://edhrec-service:5000
      EDHREC_SERVICE_HTTP_TIMEOUT: ${EDHREC_SERVICE_HTTP_TIMEOUT:-60}
      EDHREC_SERVICE_CACHE_TTL: ${EDHREC_SERVICE_CACHE_TTL:-600}
      WEB_CONCURRENCY: "12"
      WEB_THREADS: "3"
      WEB_TIMEOUT: "180"
      REDIS_URL: redis://redis:6379/0
      RATELIMIT_STORAGE_URI: redis://redis:6379/1
      SCRYFALL_REFRESH_INLINE: "0"
      IMPORT_RUN_INLINE: "0"
      ENABLE_TALISMAN: "1"
      TALISMAN_FORCE_HTTPS: "1"
      SESSION_COOKIE_SECURE: "1"
      PREFERRED_URL_SCHEME: https
      SECRET_KEY_FILE: ${SECRET_KEY_FILE:-/run/secrets/flask_secret_key}
    volumes:
      - .:/app
    secrets:
      - flask_secret_key
    depends_on:
      - redis
      - postgres
      - pgbouncer
      - price-service
      - edhrec-service
    init: true
    mem_limit: 32g
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; req=urllib.request.Request('http://localhost:5000/healthz', headers={'X-Forwarded-Proto':'https'}); sys.exit(0 if urllib.request.urlopen(req, timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  django-api:
    build:
      context: .
      dockerfile: infra/Dockerfile
    command: >-
      gunicorn
      --bind 0.0.0.0:5000
      --workers ${DJANGO_API_CONCURRENCY:-2}
      --threads ${DJANGO_API_THREADS:-2}
      --worker-class gthread
      --timeout ${DJANGO_API_TIMEOUT:-90}
      "dvapi.wsgi:application"
    restart: unless-stopped
    environment:
      PYTHONPATH: /app/backend/django_api
      DJANGO_SETTINGS_MODULE: dvapi.settings
      DJANGO_DEBUG: "0"
      INSTANCE_DIR: /app/instance
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set_in_env_file}
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      SECRET_KEY_FILE: ${SECRET_KEY_FILE:-/run/secrets/flask_secret_key}
    volumes:
      - .:/app
    secrets:
      - flask_secret_key
    depends_on:
      - postgres
      - pgbouncer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://localhost:5000/healthz', timeout=5).getcode()==200 else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  nginx:
    image: nginx:1.26-alpine
    depends_on:
      - ui
      - user-manager
      - card-data
      - folder-service
      - price-service
      - edhrec-service
      - web
      - django-api
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend/static:/app/backend/static:ro
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: infra/Dockerfile
    command: rq worker default
    restart: unless-stopped
    environment:
      PYTHONWARNINGS: "ignore::UserWarning:click.core"
      PYTHONPATH: /app/backend
      FLASK_ENV: production
      FLASK_DEBUG: "0"
      INSTANCE_DIR: /app/instance
      IMPORT_ENABLE_SCRYFALL_LOOKUPS: "0"
      REDIS_URL: redis://redis:6379/0
      RATELIMIT_STORAGE_URI: redis://redis:6379/1
      ENABLE_TALISMAN: "1"
      TALISMAN_FORCE_HTTPS: "1"
      SECRET_KEY_FILE: ${SECRET_KEY_FILE:-/run/secrets/flask_secret_key}
      CACHE_TYPE: RedisCache
      CACHE_REDIS_URL: redis://redis:6379/2
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set_in_env_file}
      DATABASE_URL: postgresql+psycopg2://dvapp:${POSTGRES_PASSWORD}@pgbouncer:6432/dragonsvault
      PRICE_SERVICE_URL: http://price-service:5000
      PRICE_SERVICE_HTTP_TIMEOUT: ${PRICE_SERVICE_HTTP_TIMEOUT:-3}
      PRICE_SERVICE_CACHE_TTL: ${PRICE_SERVICE_CACHE_TTL:-300}
      EDHREC_SERVICE_URL: http://edhrec-service:5000
      EDHREC_SERVICE_HTTP_TIMEOUT: ${EDHREC_SERVICE_HTTP_TIMEOUT:-60}
      EDHREC_SERVICE_CACHE_TTL: ${EDHREC_SERVICE_CACHE_TTL:-600}
      WEB_CONCURRENCY: "12"
      WEB_THREADS: "3"
      WEB_TIMEOUT: "180"
    volumes:
      - .:/app
    secrets:
      - flask_secret_key
    depends_on:
      - redis
      - postgres
      - pgbouncer
    init: true
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import sys, redis; sys.exit(0 if redis.Redis.from_url('redis://redis:6379/0').ping() else 1)\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: dragonsvault
      POSTGRES_USER: dvapp
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set_in_env_file}
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dvapp -d dragonsvault"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: ["-c", "config_file=/etc/postgresql/postgresql.conf"]

  pgbouncer:
    image: edoburu/pgbouncer:latest
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set_in_env_file}
      DATABASE_URL: postgresql://dvapp:${POSTGRES_PASSWORD}@postgres:5432/dragonsvault
      LISTEN_ADDR: 0.0.0.0
      LISTEN_PORT: 6432
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 500
      DEFAULT_POOL_SIZE: 20
      LOG_LEVEL: warning
      ADMIN_USERS: pgbouncer
      SERVER_IDLE_TIMEOUT: 60
      AUTH_TYPE: plain
    depends_on:
      - postgres
    ports:
      - "127.0.0.1:6432:6432"
    restart: unless-stopped

  pgmaintenance:
    image: postgres:16-alpine
    depends_on:
      - postgres
    environment:
      PGHOST: postgres
      PGUSER: dvapp
      PGPASSWORD: ${POSTGRES_PASSWORD:?set_in_env_file}
      PGDATABASE: dragonsvault
      VACUUM_INTERVAL: 604800
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        while true; do
          echo "Running weekly VACUUM (ANALYZE)..." >&2
          su postgres -c "vacuumdb --all --analyze-in-stages"
          sleep $${VACUUM_INTERVAL:-604800}
        done
    restart: unless-stopped
    user: "999:999"

secrets:
  flask_secret_key:
    file: ./.secrets/secret_key

volumes:
  redis-data:
  ui-node-modules:
  pgdata:

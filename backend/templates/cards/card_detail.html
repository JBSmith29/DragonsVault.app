{# Card detail view: shows owned print metadata, alternate arts, and Scryfall info. #}
{% extends "base.html" %}
{% block title %}{{ (info.name or card.name) }} · DragonsVault{% endblock %}
{% block content %}
<div class="container py-4">

  <!-- ---------- Styles (scoped) ---------- -->
  <style>
    .artwork-wrap { max-width: 420px; margin: 0 auto 1rem; position: relative; }
    @media (max-width: 576px) { .artwork-wrap { max-width: 100%; } }

    #artworkCarousel .carousel-item img {
      width: 100%;
      max-height: 520px;
      height: auto;
      object-fit: contain;
      border-radius: .5rem;
      user-select: none;
      cursor: pointer;
    }
    #artworkCarousel .carousel-caption { bottom: .5rem; }

    /* Flip overlay only visible when back face exists */
    .flip-overlay {
      position: absolute; top: .5rem; left: .5rem; z-index: 5;
      padding: .25rem .5rem; line-height: 1; border-radius: .5rem;
      border: 1px solid var(--bs-border-color);
      background: rgba(0,0,0,.6); color: #fff; font-weight: 700;
      display: none;
    }
    @media (hover:hover) { .flip-overlay:hover { background: rgba(0,0,0,.8); } }

    .thumbs a { display: inline-block; border-radius: .35rem; overflow: hidden; border: 1px solid var(--bs-border-color); }
    .thumbs img { height: 96px; width: auto; display: block; object-fit: contain; }

    /* Scryfall symbols inline sizing */
    img[src*="svgs.scryfall.io/card-symbols/"] {
      height: 1.05em; width: auto; max-width: none; display: inline-block; vertical-align: text-bottom;
    }
  </style>

  <!-- ---------- Back button (robust) ---------- -->
  {% set came_from_scry = (from_scryfall if from_scryfall is defined else False) %}
  {% set fallback_href = url_for('views.scryfall_browser') if came_from_scry else url_for('views.list_cards') %}
  {% set return_to = request.args.get('return_to') %}
  {% set back_href = return_to or request.referrer or fallback_href %}

  <a id="detail-back" class="btn btn-sm btn-secondary mb-3" hx-boost="false"
     href="{{ back_href }}" data-return="{{ back_href }}">← Back</a>

  <!-- ---------- Heading ---------- -->
  {% set is_external = came_from_scry or not (card and card.id) %}
  {# Title and quick metadata for the owned print. #}
  <h2 class="mb-1 d-flex align-items-center gap-2 flex-wrap">
    <span>{{ info.name or card.name }}</span>
  </h2>
  <div class="text-muted mb-2">
    {{ (info.set or card.set_code or "")|upper }} #{{ info.collector_number or card.collector_number }}
    {% if card is defined and card is not none %}
      • {{ "Foil" if card.is_foil else "Nonfoil" }}
      {% if card.folder %} • in <strong>{{ card.folder.name }}</strong>{% endif %}
      • Qty: <strong>{{ card.quantity or 1 }}</strong>
    {% endif %}
  </div>

  <!-- ---------- Commander legality badge ---------- -->
  {% set leg = info.commander_legality or (info.legalities.commander if info.legalities is defined else None) %}
  {% if leg %}
    {% set leg_norm = (leg|string) %}
    {% set label = 'Not legal' if leg_norm == 'not_legal' else leg_norm|replace('_',' ')|capitalize %}
    {% set cls = 'bg-secondary' %}
    {% if leg_norm == 'legal' %}{% set cls = 'bg-success' %}
    {% elif leg_norm == 'banned' %}{% set cls = 'bg-danger' %}
    {% elif leg_norm == 'restricted' %}{% set cls = 'bg-warning text-dark' %}
    {% elif leg_norm == 'not_legal' %}{% set cls = 'bg-secondary' %}{% endif %}
    <div class="mb-3"><span class="badge {{ cls }}">Commander: {{ label }}</span></div>
  {% endif %}

  {% set initial_tcg_url = info.tcgplayer_url %}

<!-- ---------- Artwork / Carousel ---------- -->
  {# Primary image carousel seeded with the owned print, with JS fetching alternates. #}
  {% set first_img = (images[0] if images and images|length else None) %}
  {% set first_src = (first_img.large or first_img.normal or first_img.small) if first_img else None %}
  {% set primary_src = (main_img_url or first_src) %}
  <div class="artwork-wrap">
    <!-- overlay flip button (shown only when a back face exists) -->
    <button id="flipOverlayBtn" type="button" class="flip-overlay" aria-pressed="false" title="Flip (⇆)">⇆</button>

    <div id="artworkCarousel"
         class="carousel slide mb-2"
         data-bs-ride="false"
         data-prints-uri="{{ info.prints_search_uri or '' }}"
         data-oracle-id="{{ oracle_id or '' }}"
         data-initial-sid="{{ scryfall_id or '' }}"
         data-initial-src="{{ primary_src or '' }}">
      <div class="carousel-inner">
        {% if primary_src %}
          <div class="carousel-item active"
               data-sid="{{ scryfall_id or '' }}"
               data-set="{{ (info.set or '')|upper }}"
               data-set-name="{{ info.set_name or '' }}"
               data-cn="{{ info.collector_number or '' }}"
               data-lang="{{ (info.lang or '')|upper }}"
               data-rarity="{{ info.rarity or '' }}"
               data-prices='{{ (info.prices or {})|tojson }}'
               data-name="{{ info.name or (card.name if card else name) }}"
               data-scry-uri="{{ info.scryfall_uri or '' }}"
               data-tcg-uri="{{ initial_tcg_url or '' }}">
            <img src="{{ primary_src }}" alt="{{ info.name or (card.name if card else name) }}">
          </div>
        {% else %}
          <div class="carousel-item active">
            <div class="bg-secondary-subtle rounded" style="width:100%;height:420px;opacity:.25;"></div>
          </div>
        {% endif %}
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#artworkCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#artworkCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>

    <!-- Buttons under image: Show Alt Artworks + Flip -->
    <div class="d-flex flex-wrap gap-2 mb-2">
      <!-- Hidden by default; shown by JS only if 2+ alternates exist -->
      <button id="altArtToggle"
              class="btn btn-sm btn-outline-primary d-none"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#altArtCollapse"
              aria-expanded="false" aria-controls="altArtCollapse">
        Show Alternative Artworks (<span id="altArtCount">0</span>)
      </button>

      <!-- Hidden until a back face exists -->
      <button id="flipFaceBtn" class="btn btn-sm btn-primary d-none" type="button" disabled>
        ⇆ Flip
      </button>
    </div>

    <div class="collapse" id="altArtCollapse">
      {# Populated client-side with additional arts fetched from Scryfall. #}
      <div class="thumbs d-flex gap-2 flex-wrap" id="altArtThumbs"></div>
    </div>
  </div>

  <!-- ---------- Details / Rulings / Side info ---------- -->
  <div class="row g-3">
    {# Left column: oracle text, tokens, and external resource links. #}
    <div class="col-lg-7">
      {% if info.oracle_text_html and info.oracle_text_html != '—' %}
        <div class="mb-3">
          <div class="fw-semibold">Card Text</div>
          <div>{{ info.oracle_text_html | safe }}</div>
        </div>
      {% endif %}

      {% if tokens_created and tokens_created|length %}
        <div class="mb-3">
          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#tokensCollapse" aria-expanded="false" aria-controls="tokensCollapse">
            Show Tokens ({{ tokens_created|length }})
          </button>
          <div class="collapse mt-2" id="tokensCollapse">
            <div class="row g-2 g-sm-3">
              {% for t in tokens_created %}
                {% set tok_img = (t.images.small if t.images else None) or (t.images.normal if t.images else None) %}
                {% set tok_href = (url_for('views.scryfall_print_detail', sid=t.id) if t.id else url_for('views.scryfall_browser', q=t.name, unique='1')) %}
                <div class="col-6 col-sm-4 col-md-3">
                  <a class="text-decoration-none" href="{{ tok_href }}">
                    <div class="border rounded p-2 h-100">
                      {% if tok_img %}
                        <img src="{{ tok_img }}" class="img-fluid rounded mb-2" alt="{{ t.name or 'Token' }}">
                      {% else %}
                        <div class="bg-secondary-subtle rounded mb-2" style="width:100%;height:160px;opacity:.25;"></div>
                      {% endif %}
                      <div class="fw-semibold small text-truncate">{{ t.name or 'Token' }}</div>
                      <div class="small text-muted text-truncate">{{ t.type_line or 'Token' }}</div>
                    </div>
                  </a>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <div class="mb-3">
        <div class="fw-semibold">Roles</div>
        <div class="mt-2">
          <div class="small text-muted">Core Roles</div>
          {% if primary_role_label or role_labels %}
            {% if primary_role_label %}
              {% set primary_role_slug = primary_role_label|lower|replace(' ', '-')|replace('/', '-') %}
              <span class="badge role-{{ primary_role_slug }}">
                <img src="{{ url_for('static', filename='img/roles/' ~ primary_role_slug ~ '.svg') }}" class="icon me-1" alt="">
                Primary: {{ primary_role_label }}
              </span>
            {% endif %}
            {% for role in role_labels %}
              {% set role_slug = role|lower|replace(' ', '-')|replace('/', '-') %}
              <span class="badge role-{{ role_slug }}">
                <img src="{{ url_for('static', filename='img/roles/' ~ role_slug ~ '.svg') }}" class="icon me-1" alt="">
                {{ role }}
              </span>
            {% endfor %}
          {% else %}
            <span class="text-muted small">None</span>
          {% endif %}
        </div>
        <div class="mt-2">
          <div class="small text-muted">Sub-Roles</div>
          {% if subrole_labels %}
            {% for sub in subrole_labels %}
              <span class="badge bg-secondary">{{ sub }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted small">None</span>
          {% endif %}
        </div>
      </div>

      <div class="mb-3">
        <div class="d-flex flex-wrap gap-2">
          {% set has_scry = info.scryfall_uri %}
          <a id="detail-scry-link"
             class="btn btn-sm btn-outline-primary {% if not has_scry %}disabled{% endif %}"
             href="{{ info.scryfall_uri or '#' }}"
             data-default-href="{{ info.scryfall_uri or '' }}"
             {% if has_scry %}target="_blank" rel="noopener"{% else %}tabindex="-1" aria-disabled="true"{% endif %}>Open on Scryfall</a>
          {% set has_tcg = initial_tcg_url %}
          <a id="detail-tcg-link"
             class="btn btn-sm btn-outline-success {% if not has_tcg %}disabled{% endif %}"
             href="{{ initial_tcg_url or '#' }}"
             data-default-href="{{ initial_tcg_url or '' }}"
             {% if has_tcg %}target="_blank" rel="noopener"{% else %}tabindex="-1" aria-disabled="true"{% endif %}>Buy on TCGplayer</a>
          {% if info.scryfall_set_uri %}
            <a class="btn btn-sm btn-outline-primary" href="{{ info.scryfall_set_uri }}" target="_blank" rel="noopener">Open Set on Scryfall</a>
          {% endif %}
        </div>
      </div>

      <div class="mb-2 fw-semibold">Rulings</div>
      {% if rulings and rulings|length %}
        {% for r in rulings %}
          <div class="border-start ps-2 mb-2" style="border-color:#dee2e6 !important;">
            <div class="small text-muted">{{ r.published_at }}</div>
            <div>{{ (r.comment or '') | replace('\n','<br>') | safe }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="small text-muted">No rulings cached.</div>
      {% endif %}
    </div>

    <div class="col-lg-5">
      {# Right column: quick reference stats about the owned print. #}
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Quick Facts</div>
        <div class="list-group list-group-flush small">
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Type</span>
          <span>{{ info.type_line or '—' }}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Core Role</span>
          <span class="text-end">
            {% if primary_role_label %}
              {% set primary_role_slug = primary_role_label|lower|replace(' ', '-')|replace('/', '-') %}
              <span class="badge role-{{ primary_role_slug }}">{{ primary_role_label }}</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Evergreen Tags</span>
          <span class="text-end">
            {% if evergreen_labels %}
              {% for tag in evergreen_labels[:4] %}
                <span class="badge text-bg-secondary">{{ tag|replace('_', ' ')|replace('-', ' ')|title }}</span>
              {% endfor %}
              {% if evergreen_labels|length > 4 %}
                <span class="text-muted small">+{{ evergreen_labels|length - 4 }}</span>
              {% endif %}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Mana Cost</span>
          <span class="text-end">{{ info.mana_cost_html|safe if info.mana_cost_html else '—' }}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Colors</span>
          <span class="text-end">
            {% if color_pips and color_pips|length %}
              <span class="pip-row">
                {% for src in color_pips %}<img class="mana mana-sm" src="{{ src }}" alt="color">{% endfor %}
              </span>
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">CMC</span>
          <span>{{ info.cmc if info.cmc is not none else '—' }}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Rarity</span>
          <span>{{ (info.rarity or '—')|upper }}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Set</span>
          <span>{{ info.set_name or '-' }} <span class="text-muted">[{{ (info.set or '')|upper }}]</span></span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Price</span>
          <span id="detail-price-value"
                data-prefix="Price: "
                data-placeholder="N/A">Price: {{ info.price_text or 'N/A' }}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Card #</span>
          <span>{{ info.collector_number or '-' }}</span>
        </div>
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Folder</span>
          <span>{{ card.folder.name if (card and card.folder) else '—' }}</span>
        </div>

        {% set COLLECTION_FOLDERS = collection_folders|default([], true) %}
        {% set ns = namespace(count=0) %}{% for fname, cnt in owned_folders if fname in COLLECTION_FOLDERS %}{% set ns.count = ns.count + 1 %}{% endfor %}
        {% if ns.count > 0 %}
          <div class="list-group-item d-flex justify-content-between">
            <span class="fw-semibold text-muted">Owned in</span>
            <span class="text-end">
              {% for fname, cnt in owned_folders if fname in COLLECTION_FOLDERS %}
                {% if not loop.first %} · {% endif %}{{ fname }} ×{{ cnt }}
              {% endfor %}
            </span>
          </div>
        {% endif %}
        <div class="list-group-item d-flex justify-content-between">
          <span class="fw-semibold text-muted">Quantity</span>
          <span>{{ (card.quantity if card else None) or 1 }}</span>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ---------- Scripts ---------- -->
<script>
(function() {
  // Back button with fallback
  const btn = document.getElementById('detail-back');
  if (btn) {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      let navigated = false;
      const onPop = () => { navigated = true; };
      window.addEventListener('popstate', onPop, { once: true });
      history.back();
      setTimeout(() => {
        if (!navigated) {
          const ret = btn.getAttribute('data-return') || btn.getAttribute('href') || '/';
          window.location.href = ret;
        }
      }, 400);
    });
  }

  // Elements
  const carouselEl  = document.getElementById('artworkCarousel');
  const collapseEl  = document.getElementById('altArtCollapse');
  const toggleBtn   = document.getElementById('altArtToggle');
  const countEl     = document.getElementById('altArtCount');
  const thumbsWrap  = document.getElementById('altArtThumbs');
  const flipBtn     = document.getElementById('flipFaceBtn');
  const flipOverlay = document.getElementById('flipOverlayBtn');
  const priceValueEl = document.getElementById('detail-price-value');
  const pricePrefix = priceValueEl ? (priceValueEl.dataset.prefix || "") : "";
  const pricePlaceholder = priceValueEl ? (priceValueEl.dataset.placeholder || "N/A") : "N/A";
  const scryLinkBtn = document.getElementById('detail-scry-link');
  const scryDefaultHref = scryLinkBtn ? (scryLinkBtn.getAttribute('data-default-href') || '#') : '#';
  const tcgLinkBtn = document.getElementById('detail-tcg-link');
  const tcgDefaultHref = tcgLinkBtn ? (tcgLinkBtn.getAttribute('data-default-href') || '#') : '#';
  let printsMeta = [];

  let carousel = null;
  if (typeof bootstrap !== 'undefined' && carouselEl) {
    carousel = new bootstrap.Carousel(carouselEl, { interval: false, ride: false, pause: true, wrap: true });
  }

  // Clicking the image advances to next slide
  if (carouselEl) {
    carouselEl.addEventListener('click', function (ev) {
      if (ev.target && ev.target.tagName === 'IMG') {
        ev.preventDefault();
        if (carousel) carousel.next();
      }
    });
  }

  function parseJSONSafe(raw, fallback = null) {
    if (!raw) return fallback;
    try {
      return JSON.parse(raw);
    } catch (err) {
      return fallback;
    }
  }

  function formatPriceForDetail(prices) {
    if (!prices) return null;
    const parts = [];
    const fmt = (val, prefix) => {
      if (val === null || val === undefined || val === "" || val === 0 || val === "0") return null;
      const num = Number(val);
      if (!Number.isFinite(num) || num <= 0) return null;
      return `${prefix}${num.toFixed(2)}`;
    };
    const normalUsd = fmt(prices.usd, "$");
    const foilUsd = fmt(prices.usd_foil, "$");
    const etchedUsd = fmt(prices.usd_etched, "$");
    if (normalUsd) parts.push(`Normal ${normalUsd}`);
    if (foilUsd) parts.push(`Foil ${foilUsd}`);
    if (etchedUsd) parts.push(`Etched ${etchedUsd}`);
    if (!parts.length) {
      const normalEur = fmt(prices.eur, "EUR ");
      const foilEur = fmt(prices.eur_foil, "EUR ");
      if (normalEur) parts.push(`Normal ${normalEur}`);
      if (foilEur) parts.push(`Foil ${foilEur}`);
    }
    if (!parts.length) {
      const tixFmt = fmt(prices.tix, "");
      if (tixFmt) parts.push(`${tixFmt} tix`);
    }
    if (!parts.length) return null;
    return parts.join(" | ");
  }

  function updatePriceRow(entry) {
    if (!priceValueEl) return;
    const formatted = entry ? formatPriceForDetail(entry.prices) : null;
    priceValueEl.textContent = pricePrefix + (formatted || pricePlaceholder);
  }

  function toggleLink(btn, url, defaultHref) {
    if (!btn) return;
    const cleaned = (url || "").trim();
    const hasUrl = cleaned.length > 0;
    btn.href = hasUrl ? cleaned : (defaultHref || '#');
    btn.classList.toggle('disabled', !hasUrl);
    if (hasUrl) {
      btn.setAttribute('target', '_blank');
      btn.setAttribute('rel', 'noopener');
      btn.setAttribute('aria-disabled', 'false');
      btn.setAttribute('tabindex', '0');
    } else {
      btn.removeAttribute('target');
      btn.removeAttribute('rel');
      btn.setAttribute('aria-disabled', 'true');
      btn.setAttribute('tabindex', '-1');
    }
  }

  function updateLinks(entry) {
    const scryUri = entry && entry.scryUri ? entry.scryUri : "";
    const tcgUri = entry && entry.tcgUri ? entry.tcgUri : "";
    toggleLink(scryLinkBtn, scryUri, scryDefaultHref);
    toggleLink(tcgLinkBtn, tcgUri, tcgDefaultHref);
  }

  function updateDetailFromEntry(entry) {
    updatePriceRow(entry);
    updateLinks(entry);
  }

  function entryFromSlide(slide) {
    if (!slide) return null;
    const ds = slide.dataset || {};
    return {
      prices: parseJSONSafe(ds.prices, null),
      scryUri: ds.scryUri || "",
      tcgUri: ds.tcgUri || "",
      set: ds.set || "",
      setName: ds.setName || "",
      collectorNumber: ds.cn || "",
      lang: ds.lang || "",
      rarity: ds.rarity || "",
      name: ds.name || ""
    };
  }

  // Collapse btn label mgmt
  function getAltCount() { return (thumbsWrap?.children.length || 0); }
  function updateAltBtnLabel(isOpen) {
    if (!toggleBtn) return;
    const n = getAltCount();
    if (countEl) countEl.textContent = String(n);
    toggleBtn.setAttribute('aria-expanded', String(!!isOpen));
    toggleBtn.firstChild.textContent = (isOpen ? 'Hide Alternative Artworks (' : 'Show Alternative Artworks (');
  }
  let collapseInst = null;
  function ensureCollapse() {
    if (collapseInst || typeof bootstrap === 'undefined' || !collapseEl) return collapseInst;
    collapseInst = new bootstrap.Collapse(collapseEl, { toggle: false });
    collapseEl.addEventListener('shown.bs.collapse', () => updateAltBtnLabel(true));
    collapseEl.addEventListener('hidden.bs.collapse', () => updateAltBtnLabel(false));
    return collapseInst;
  }
  if (toggleBtn && collapseEl) {
    toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const isOpen = collapseEl.classList.contains('show');
      const c = ensureCollapse();
      if (!c) { collapseEl.classList.toggle('show'); updateAltBtnLabel(!isOpen); }
      else { isOpen ? c.hide() : c.show(); }
    });
    updateAltBtnLabel(collapseEl.classList.contains('show'));
  }

  // -------- Load all prints (unique artworks) from Scryfall --------
  const printsUri   = carouselEl?.getAttribute('data-prints-uri') || '';
  const oracleId    = carouselEl?.getAttribute('data-oracle-id') || '';
  const initialSid  = carouselEl?.getAttribute('data-initial-sid') || '';
  const firstServer = carouselEl?.getAttribute('data-initial-src') || '';

  function buildFallbackUri(oracleId) {
    if (!oracleId) return null;
    const q = encodeURIComponent(`oracleid:${oracleId}`);
    return `https://api.scryfall.com/cards/search?q=${q}&unique=prints&order=released`;
  }

  function extractImagesFromCard(c) {
    const out = [];
    const setCode = String(c.set || "").toUpperCase();
    const labelParts = [];
    if (setCode) labelParts.push(setCode);
    if (c.collector_number) labelParts.push(String(c.collector_number));
    if (c.lang) labelParts.push(String(c.lang).toUpperCase());
    const label = labelParts.join(" · " );
    const purchase = c.purchase_uris || {};
    const related = c.related_uris || {};
    const base = {
      id: c.id || "",
      set: setCode,
      setName: c.set_name || "",
      collectorNumber: String(c.collector_number || ""),
      lang: String(c.lang || "").toUpperCase(),
      rarity: c.rarity || "",
      prices: c.prices || {},
      name: c.name || "",
      scryUri: c.scryfall_uri || "",
      tcgUri: purchase.tcgplayer || related.tcgplayer || "",
      releasedAt: c.released_at || ""
    };
    const push = (sm, nm) => {
      if (!sm && !nm) return;
      out.push({
        ...base,
        small: sm || nm,
        normal: nm || sm,
        label
      });
    };
    const iu = c.image_uris || null;
    const faces = Array.isArray(c.card_faces) ? c.card_faces : [];
    if (iu) {
      push(iu.small || iu.normal || iu.large, iu.normal || iu.large || iu.small);
    } else if (faces.length) {
      const fiu = (faces[0] || {}).image_uris || {};
      push(fiu.small || fiu.normal || fiu.large, fiu.normal || fiu.large || fiu.small);
    }
    return out;
  }

  async function fetchAllPrintImages(uri, oracleId) {
    let url = uri || buildFallbackUri(oracleId);
    if (!url) return [];
    try {
      const u = new URL(url);
      if (!u.searchParams.get('unique')) u.searchParams.set('unique', 'prints');
      if (!u.searchParams.get('order'))  u.searchParams.set('order', 'released');
      url = u.toString();
    } catch {}

    const out = [];
    let next = url, pages = 0;
    while (next && pages < 12) {
      pages++;
      const res = await fetch(next, { credentials: 'omit' });
      if (!res.ok) break;
      const payload = await res.json();
      const data = Array.isArray(payload.data) ? payload.data : [];
      for (const c of data) extractImagesFromCard(c).forEach(x => out.push(x));
      next = payload.has_more ? payload.next_page : null;
    }
    // dedupe by print id (or by URL)
    const seen = new Set(), imgs = [];
    for (const x of out) {
      const key = x.id || x.normal || x.small;
      if (seen.has(key)) continue;
      seen.add(key); imgs.push(x);
    }
    // ensure the first image from server is at index 0
    if (firstServer && !imgs.some(x => x.small === firstServer || x.normal === firstServer)) {
      const active = carouselEl ? carouselEl.querySelector('.carousel-item.active') : null;
      const ds = active ? (active.dataset || {}) : {};
      imgs.unshift({
        id: (ds.sid || initialSid || ""),
        set: ds.set || "",
        setName: ds.setName || "",
        collectorNumber: ds.cn || "",
        lang: ds.lang || "",
        rarity: ds.rarity || "",
        prices: parseJSONSafe(ds.prices, {}),
        name: ds.name || "",
        scryUri: ds.scryUri || "",
        tcgUri: ds.tcgUri || "",
        releasedAt: ds.releasedAt || "",
        small: firstServer,
        normal: firstServer,
        label: ds.label || ""
      });
    }
    return imgs;
  }

  function rebuildCarousel(imgs) {
    printsMeta = imgs.map(im => ({ ...im }));
    const inner = carouselEl.querySelector('.carousel-inner');
    inner.innerHTML = '';
    imgs.forEach((im, idx) => {
      const src = im.normal || im.small;
      const item = document.createElement('div');
      item.className = 'carousel-item' + (idx === 0 ? ' active' : '');
      item.dataset.index = String(idx);
      item.dataset.sid = im.id || '';
      item.dataset.set = im.set || '';
      item.dataset.setName = im.setName || '';
      item.dataset.cn = im.collectorNumber || '';
      item.dataset.lang = im.lang || '';
      item.dataset.rarity = im.rarity || '';
      item.dataset.prices = JSON.stringify(im.prices || {});
      item.dataset.name = im.name || '';
      item.dataset.scryUri = im.scryUri || '';
      item.dataset.tcgUri = im.tcgUri || '';
      item.innerHTML = `
        <img src="${src}" alt="artwork ${idx+1}" loading="lazy">
        ${ im.label ? `<div class="carousel-caption d-none d-md-block"><span class="badge bg-dark bg-opacity-75">${im.label}</span></div>` : '' }
      `;
      inner.appendChild(item);
    });
    if (carousel) {
      carousel.dispose();
      carousel = new bootstrap.Carousel(carouselEl, { interval: false, ride: false, pause: true, wrap: true });
    }
    const active = carouselEl ? carouselEl.querySelector('.carousel-item.active') : null;
    const entry = printsMeta[0] || entryFromSlide(active);
    updateDetailFromEntry(entry);
  }

  function rebuildThumbs(imgs) {
    if (!toggleBtn || !thumbsWrap) return;
    thumbsWrap.innerHTML = '';
    const altCount = Math.max(imgs.length - 1, 0);

    // Only show the button if there are 2+ alternates
    const showBtn = altCount >= 2;
    toggleBtn.classList.toggle('d-none', !showBtn);
    if (countEl) countEl.textContent = String(altCount);

    imgs.forEach((im, idx) => {
      if (idx === 0) return;
      const src = im.normal || im.small;
      const a = document.createElement('a');
      a.className = 'border';
      a.setAttribute('data-bs-target', '#artworkCarousel');
      a.setAttribute('data-bs-slide-to', String(idx));
      a.setAttribute('aria-label', `Go to artwork ${idx+1}`);
      a.innerHTML = `<img src="${src}" alt="Alternative artwork ${idx+1}" loading="lazy">`;
      thumbsWrap.appendChild(a);
    });
    updateAltBtnLabel(collapseEl.classList.contains('show'));
  }

  (async function run() {
    if (!carouselEl) return;
    try {
      const imgs = await fetchAllPrintImages(printsUri, oracleId);
      if (imgs && imgs.length) {
        rebuildCarousel(imgs);
        rebuildThumbs(imgs);
      }
    } catch (err) {
      console.warn('[card_detail] prints load failed', err);
    } finally {
      const active = carouselEl ? carouselEl.querySelector('.carousel-item.active') : null;
      const entry = printsMeta[0] || entryFromSlide(active);
      updateDetailFromEntry(entry);
      // prepare flip after initial UI is present
      prepareFlipForActive();
    }
  })();

  // -------- Flip logic using Scryfall card faces --------
  const facesCache = new Map(); // sid -> {front:string|null, back:string|null}
  let flipState = 'front';      // 'front' | 'back'

  async function getFacesForSid(sid) {
    if (!sid) return { front: null, back: null };
    if (facesCache.has(sid)) return facesCache.get(sid);
    try {
      const res = await fetch(`https://api.scryfall.com/cards/${sid}`);
      if (!res.ok) throw new Error('faces fetch failed');
      const c = await res.json();
      const faces = Array.isArray(c.card_faces) ? c.card_faces : [];
      let front = null, back = null;
      if (faces.length >= 1) {
        const f0 = faces[0]?.image_uris || {};
        front = f0.large || f0.normal || f0.small || null;
      }
      if (faces.length >= 2) {
        const f1 = faces[1]?.image_uris || {};
        back = f1.large || f1.normal || f1.small || null;
      }
      const rec = { front, back };
      facesCache.set(sid, rec);
      return rec;
    } catch {
      const rec = { front: null, back: null };
      facesCache.set(sid, rec);
      return rec;
    }
  }

  function activeSlide() { return carouselEl?.querySelector('.carousel-item.active') || null; }

  function setFlipControlsEnabled(enabled) {
    // Hide the button entirely when there is no back
    flipBtn.classList.toggle('d-none', !enabled);
    flipBtn.disabled = !enabled;
    flipBtn.classList.toggle('btn-primary', enabled);
    flipBtn.classList.toggle('btn-outline-secondary', !enabled);
    flipOverlay.style.display = enabled ? 'block' : 'none';
    if (enabled) {
      const txt = (flipState === 'front') ? '⇆ Flip to Back' : '⇆ Flip to Front';
      flipBtn.textContent = txt;
      flipOverlay.setAttribute('aria-pressed', flipState === 'back' ? 'true' : 'false');
    } else {
      flipOverlay.setAttribute('aria-pressed', 'false');
    }
  }

  async function applyFlipToActiveSlide() {
    const slide = activeSlide();
    if (!slide) return;
    const sid = slide.getAttribute('data-sid') || '';
    const img = slide.querySelector('img');
    if (!img) return;

    const faces = await getFacesForSid(sid);
    const hasBack = !!faces.back;
    setFlipControlsEnabled(hasBack);
    if (!hasBack) return;

    const url = (flipState === 'back') ? (faces.back || faces.front) : (faces.front || faces.back);
    if (url && img.getAttribute('src') !== url) {
      img.setAttribute('src', url);
    }
  }

  async function prepareFlipForActive() {
    flipState = 'front';      // reset to front when art/print changes
    await applyFlipToActiveSlide();
  }

  function toggleFlip() {
    if (flipBtn.disabled) return;
    flipState = (flipState === 'front') ? 'back' : 'front';
    applyFlipToActiveSlide();
  }

  if (flipBtn) flipBtn.addEventListener('click', (e) => { e.preventDefault(); toggleFlip(); });
  if (flipOverlay) flipOverlay.addEventListener('click', (e) => { e.preventDefault(); toggleFlip(); });

  // When the slide changes, re-evaluate faces for the new print
  if (carouselEl) {
    carouselEl.addEventListener('slid.bs.carousel', () => {
      const active = carouselEl.querySelector('.carousel-item.active');
      const idx = active ? Number(active.dataset.index || Number.NaN) : Number.NaN;
      const entry = (!Number.isNaN(idx) && printsMeta[idx]) ? printsMeta[idx] : entryFromSlide(active);
      updateDetailFromEntry(entry);
      prepareFlipForActive();
    });
  }
})();

</script>
{% endblock %}

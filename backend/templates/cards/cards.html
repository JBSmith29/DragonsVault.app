{# Cards list view: searchable/filterable table with optional deck context. #}
{% extends "base.html" %}
{% from "shared/components/macros.html" import slug, folder_badge %}
{% from "shared/components/pagination.html" import render_pagination %}
{% block content %}
{% set back_to = request.full_path %}
{% if back_to and back_to.endswith('?') %}
  {% set back_to = back_to[:-1] %}
{% endif %}

{% set per_value = per or 25 %}

{# ---------- local state helpers ---------- #}
{# Prefer explicit querystring; fall back to context vars #}
{% set type_mode_local = (request.args.get('type_mode') or type_mode or 'contains') %}
{% set ui_selected_types = (
      (request.args.getlist('type_any') if type_mode_local != 'exact' else request.args.getlist('type'))
      or selected_types or []
    ) %}

<div class="page-section" id="cardsPageSection">
  <h1 class="mb-3">Browse All Cards</h1>

  {# Badge helper: reuse consistent styling when rendering card types. #}
  {% macro type_badge(t) -%}
    {%- set tl = (t or '')|lower -%}
    <span class="badge badge-type badge-type-{{ tl }}">{{ t }}</span>
  {%- endmacro %}

  {# Local styling keeps the listing layout self-contained. #}
  <style>
    .pagination .page-link { display:inline-block; width:auto; }

    .offcanvas-end.w-500 { width:500px; }
    .offcanvas .card-art {
      width:100%;
      max-width:360px;
      max-height:360px;
      height:auto;
      object-fit:contain;
      border-radius:.5rem;
      display:block;
      margin:0 auto;
      background:#111;
    }

    .card-row { cursor:pointer; }
    .card-row a.card-link { cursor:pointer; text-decoration:none; }
    .col-select { width:36px; min-width:36px; text-align:center; }

    .small-muted { font-size:.875rem; color:#6c757d; }
    .detail-label { font-weight:600; color:#6c757d; width:140px; }

    .card-thumb { display:block; }
    .col-colors { width:170px; min-width:170px; white-space:nowrap; }
    .col-tags { min-width:160px; max-width:240px; }
    .col-tags .badge { margin:0 .25rem .25rem 0; }
    .drawer-cycler { position:relative; }
    .drawer-cycler .nav-btn {
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,.6); color:#fff; border:0; padding:.35rem .5rem; border-radius:.375rem;
    }
    .drawer-cycler .prev { left:.25rem; }
    .drawer-cycler .next { right:.25rem; }
    .drawer-cycler .nav-btn:disabled { opacity:.35; cursor:not-allowed; }

    .cmdr-star { font-size: 1.15rem; line-height: 1; opacity: .45; }
    .cmdr-star.active { opacity: 1; color: var(--bs-warning); }
    .btn-star { padding: 0; border: 0; background: transparent; }
    .col-star { width: 40px; min-width: 40px; text-align:center; }

    .vr { height: 1.25em; opacity: .25; }

    /* —— Flip button overlay (added) —— */
    .flip-face-btn{
      position:absolute; top:.35rem; left:.35rem; z-index:6;
      padding:.25rem .5rem; font-weight:700; line-height:1; border-radius:.5rem;
      border:1px solid rgba(255,255,255,.3);
      background:rgba(0,0,0,.55); color:#fff;
    }
    @media (hover:hover){ .flip-face-btn:hover{ background:rgba(0,0,0,.72);} }

    /* Floating action bar for card actions */
    .card-action-bar {
      position:fixed;
      bottom:1rem;
      left:0;
      right:0;
      z-index:1030;
      pointer-events:none;
    }
    .card-action-bar .bar-surface {
      pointer-events:auto;
      margin:0 auto;
      max-width:1100px;
      background:var(--bs-body-bg);
      border:1px solid var(--bs-border-color-translucent);
      border-radius:1rem;
      box-shadow:0 .75rem 2.5rem rgba(0,0,0,.25);
      padding:.85rem 1rem;
    }
    .card-action-bar .bar-title {
      font-weight:600;
      font-size:.95rem;
    }
    .card-action-bar .muted {
      color:var(--bs-secondary-color);
    }
    .card-action-bar .quantity-wrap { max-width:120px; }
    .card-action-bar .bar-grid { row-gap:.5rem; }
    .page-section-with-bar { padding-bottom:160px; }
    .printing-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:1rem; }
    .printing-card { border:1px solid var(--bs-border-color); border-radius:.75rem; padding:.65rem; background:var(--bs-body-bg); transition:all .15s ease; cursor:pointer; }
    .printing-card.active { border-color: var(--bs-primary); box-shadow:0 0 0 3px rgba(13,110,253,.25); }
    .printing-card .thumb { border-radius:.5rem; background:var(--bs-secondary-bg); width:100%; }
    .printing-card .meta { font-size:.9rem; margin-top:.5rem; }
    .printing-card .badge { font-size:.75rem; }
  </style>

  {# Search + filter form controls the query params for the list view. #}
  <!-- Filters -->
  <form class="mb-3" method="get" action="{{ url_for('views.list_cards') }}" id="cardsFilterForm">
    {% set rarity_value = (rarity or '') %}
    {% set rarity_label = 'Any rarity' %}
    {% if rarity_value %}
      {% set rarity_label = rarity_value.replace('_',' ').replace('-',' ').title() %}
    {% endif %}
    {% set foil_only = foil_only|default(false) %}
    {% set rarity_choices = rarity_options|default([], true) %}
    {% set set_options = set_options|default([], true) %}
    {% set set_label = namespace(text='All sets') %}
    {% if set_code %}
      {% for option in set_options %}
        {% if option.code == set_code %}
          {% set set_label.text = option.label %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if folder_id %}
      <input type="hidden" name="folder" value="{{ folder_id }}">
    {% endif %}
    {% set reset_args = namespace(params={}) %}
    {% if folder_id %}
      {% set _ = reset_args.params.update({'folder': folder_id}) %}
    {% endif %}
    {% if collection_flag %}
      {% set _ = reset_args.params.update({'collection': 1}) %}
    {% endif %}
    {% set reset_url = url_for('views.list_cards', **reset_args.params) %}
    <div class="filter-wrap">
      <div class="filter-row row g-2 align-items-end">
        <div class="col-12 col-xl-6">
          <label class="form-label visually-hidden" for="filterName">Search by card name</label>
          <input id="filterName"
                 class="form-control"
                 name="q"
                 type="text"
                 placeholder="Search by name..."
                 value="{{ q or '' }}">
        </div>
        <div class="col-6 col-md-3 col-xl-3">
          <label class="form-label visually-hidden" for="filterSet">Set</label>
          <div class="dropdown dv-select w-100" data-dv-select="cards-set">
            <input type="hidden"
                   id="filterSet"
                   name="set"
                   value="{{ set_code or '' }}"
                   data-dv-select-input>
            <button class="btn dv-select-toggle w-100 justify-content-between"
                    type="button"
                    id="cardsSetToggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span data-dv-select-label>{{ set_label.text }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="cardsSetToggle">
              <li class="dv-select-search-wrapper">
                <input type="text"
                       class="form-control form-control-sm dv-select-search"
                       placeholder="Search sets"
                       autocomplete="off"
                       data-dv-select-search>
              </li>
              <li>
                <button class="dropdown-item {% if not set_code %}active{% endif %}"
                        type="button"
                        data-dv-select-option
                        data-value=""
                        data-label="All sets">
                  All sets
                </button>
              </li>
              {% for option in set_options %}
                <li>
                  <button class="dropdown-item {% if set_code == option.code %}active{% endif %}"
                          type="button"
                          data-dv-select-option
                          data-value="{{ option.code }}"
                          data-label="{{ option.label }}">
                    {{ option.label }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="col-6 col-md-3 col-xl-3">
          <label class="form-label visually-hidden" for="filterRarity">Rarity</label>
          <div class="dropdown dv-select w-100" data-dv-select="cards-rarity">
            <input type="hidden"
                   id="filterRarity"
                   name="rarity"
                   value="{{ rarity_value or '' }}"
                   data-dv-select-input>
            <button class="btn dv-select-toggle w-100 justify-content-between"
                    type="button"
                    id="cardsRarityToggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span data-dv-select-label>{{ rarity_label }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="cardsRarityToggle">
              <li class="dv-select-search-wrapper">
                <input type="text"
                       class="form-control form-control-sm dv-select-search"
                       placeholder="Search rarity"
                       autocomplete="off"
                       data-dv-select-search>
              </li>
              <li>
                <button class="dropdown-item {% if not rarity_value %}active{% endif %}"
                        type="button"
                        data-dv-select-option
                        data-value=""
                        data-label="Any rarity">
                  Any rarity
                </button>
              </li>
              {% for option in rarity_choices %}
                <li>
                  <button class="dropdown-item {% if rarity_value == option.value %}active{% endif %}"
                          type="button"
                          data-dv-select-option
                          data-value="{{ option.value }}"
                          data-label="{{ option.label }}">
                    {{ option.label }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <div class="filter-row row g-2 align-items-end">
        <div class="col-12 col-xl-6">
          <label class="form-label visually-hidden" for="filterRoleSearch">Search by core role, evergreen, or land type</label>
          <input id="filterRoleSearch"
                 class="form-control"
                 name="role_q"
                 type="text"
                 placeholder="Search by core role, evergreen, or land type..."
                 value="{{ role_query_text or '' }}">
        </div>
      </div>

      <!-- Types -->
      <fieldset class="filter-row">
        <legend class="visually-hidden">Card types</legend>
        <div class="d-flex align-items-center flex-wrap gap-2">
          <div class="small text-muted me-2">Types:</div>
          {% set all_types = ["Artifact","Battle","Creature","Enchantment","Instant","Land","Planeswalker","Sorcery"] %}
          {% for t in all_types %}
            {% set checked = (t.lower() in (ui_selected_types or [])) %}
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="t_{{ t }}" name="type" value="{{ t.lower() }}" {% if checked %}checked{% endif %}>
              <label class="form-check-label" for="t_{{ t }}">{{ t }}</label>
            </div>
          {% endfor %}

          <div class="vr d-none d-sm-block"></div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Type matching mode">
            <input type="radio" class="btn-check" name="type_mode" id="tm_contains" value="contains" {% if type_mode_local != 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="tm_contains">Contains</label>
            <input type="radio" class="btn-check" name="type_mode" id="tm_exact" value="exact" {% if type_mode_local == 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="tm_exact">Exact</label>
          </div>

          {% if ui_selected_types and ui_selected_types|length %}
            <a class="small ms-2" href="{{ url_for('views.list_cards', collection=1 if collection_flag else None) }}">Clear types</a>
          {% endif %}
        </div>
      </fieldset>

      <!-- Colors -->
      <fieldset class="filter-row">
        <legend class="visually-hidden">Color identity</legend>
        <div class="d-flex align-items-center flex-wrap gap-3">
          <div class="small text-muted">Colors:</div>
          {% set COLORS = ['w','u','b','r','g','c'] %}
          {% for c in COLORS %}
            {% set up = c|upper %}
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="c_{{ c }}" name="color" value="{{ c }}" {% if c in (selected_colors or []) %}checked{% endif %}>
              <label class="form-check-label" for="c_{{ c }}">
                <img class="mana mana-sm" src="/static/symbols/{{ up }}.svg" alt="{{ up }}" onerror="this.outerHTML='{{ up }}'">
                <span class="visually-hidden">{{ up }}</span>
              </label>
            </div>
          {% endfor %}
          <div class="vr d-none d-lg-block"></div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Color matching mode">
            <input type="radio" class="btn-check" name="color_mode" id="cm_contains" value="contains" {% if color_mode != 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="cm_contains">Contains</label>
            <input type="radio" class="btn-check" name="color_mode" id="cm_exact" value="exact" {% if color_mode == 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="cm_exact">Exactly</label>
          </div>
          <div class="vr d-none d-lg-block"></div>
          <div class="form-check form-check-inline mb-0">
            <input class="form-check-input"
                   type="checkbox"
                   id="filterFoilOnly"
                   name="foil_only"
                   value="1"
                   {% if foil_only %}checked{% endif %}>
            <label class="form-check-label" for="filterFoilOnly">Foil</label>
          </div>
          {% if selected_colors and selected_colors|length %}
            <a class="small ms-1" href="{{ url_for('views.list_cards', collection=1 if collection_flag else None) }}">Clear colors</a>
          {% endif %}
        </div>
      </fieldset>

      <!-- Actions -->
    <div class="filter-actions d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="small text-muted">
        {{ '{:,}'.format(total|default(cards|length, true) or 0) }} matching cards
      </div>
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <div class="form-check form-switch mb-0">
            <input class="form-check-input"
                   type="checkbox"
                   id="f_collection"
                   name="collection"
                   value="1"
                   {% if collection_flag %}checked{% endif %}
                   onchange="this.form.submit()">
            <label class="form-check-label" for="f_collection">Collection</label>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Apply filters</button>
            <a class="btn btn-outline-secondary" href="{{ reset_url }}">Reset</a>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Summary -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div>
      {# Prefer accurate display count when using client-side Contains types #}
      {% if (ui_selected_types and ui_selected_types|length and type_mode_local != 'exact') and (total is defined) %}
        <small class="text-muted">Showing {{ cards|length }} of {{ total }}</small>
      {% elif start is defined and end is defined and total is defined %}
        <small class="text-muted">{{ cards|length }} result{{ cards|length != 1 and 's' or '' }}</small>
      {% endif %}
      {% if folder_is_proxy %}
        <span class="badge text-bg-warning text-dark ms-2 align-middle">Proxy deck</span>
      {% endif %}
    </div>
    <div class="d-flex gap-3">
      {% if q or role_query_text or folder_id or set_code or foil_only or (ui_selected_types and ui_selected_types|length) or (selected_colors and selected_colors|length) or collection_flag %}
        <a class="small" href="{{ reset_url }}">Reset</a>
      {% endif %}
      <div class="dropdown">
        <button
          class="btn btn-sm btn-outline-secondary dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          data-bs-auto-close="outside"
          aria-expanded="false"
        >
          Columns
        </button>
        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:220px;">
          <div class="small text-muted mb-2">Show columns</div>
          {% if move_folder_options %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cardsColSelect" data-columns-toggle="cards" data-col="select" checked>
              <label class="form-check-label" for="cardsColSelect">Select</label>
            </div>
          {% endif %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColArt" data-columns-toggle="cards" data-col="art" checked>
            <label class="form-check-label" for="cardsColArt">Art</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColName" data-columns-toggle="cards" data-col="name" checked>
            <label class="form-check-label" for="cardsColName">Name</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColType" data-columns-toggle="cards" data-col="type" checked>
            <label class="form-check-label" for="cardsColType">Type</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColCore" data-columns-toggle="cards" data-col="core_role" checked>
            <label class="form-check-label" for="cardsColCore">Core Role</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColEvergreen" data-columns-toggle="cards" data-col="evergreen" checked>
            <label class="form-check-label" for="cardsColEvergreen">Evergreen</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColFolder" data-columns-toggle="cards" data-col="folder" checked>
            <label class="form-check-label" for="cardsColFolder">Folder</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColSet" data-columns-toggle="cards" data-col="set" checked>
            <label class="form-check-label" for="cardsColSet">Set</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColQty" data-columns-toggle="cards" data-col="qty" checked>
            <label class="form-check-label" for="cardsColQty">Qty</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColPrice" data-columns-toggle="cards" data-col="price" checked>
            <label class="form-check-label" for="cardsColPrice">Price</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColColors" data-columns-toggle="cards" data-col="colors" checked>
            <label class="form-check-label" for="cardsColColors">Colors</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColRarity" data-columns-toggle="cards" data-col="rarity" checked>
            <label class="form-check-label" for="cardsColRarity">Rarity</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cardsColCollector" data-columns-toggle="cards" data-col="collector" checked>
            <label class="form-check-label" for="cardsColCollector">Collector #</label>
          </div>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary w-100" data-columns-reset="cards">
              Reset columns
            </button>
          </div>
        </div>
      </div>
      {# Export preserves the correct param flavor for types #}
      {% if type_mode_local == 'exact' %}
        {% set export_url = url_for('views.export_cards',
          q=q, role_q=role_query_text, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None),
          type=ui_selected_types, type_mode=type_mode_local,
          color=selected_colors, color_mode=color_mode,
          collection=1 if collection_flag else None) %}
      {% else %}
        {% set export_url = url_for('views.export_cards',
          q=q, role_q=role_query_text, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None),
          type_any=ui_selected_types, type_mode='contains',
          color=selected_colors, color_mode=color_mode,
          collection=1 if collection_flag else None) %}
      {% endif %}
      {% set export_sep = '&' if '?' in export_url else '?' %}
      {% set export_url_manavault = export_url ~ export_sep ~ 'format=manavault' %}
      {% set export_url_dragonshield = export_url ~ export_sep ~ 'format=dragonshield' %}
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-secondary" href="{{ export_url }}">Export CSV</a>
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Choose export format">
          <span class="visually-hidden">Choose export format</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{{ export_url_manavault }}">Export for ManaVault</a></li>
          <li><a class="dropdown-item" href="{{ export_url_dragonshield }}">Export for Dragon Shield</a></li>
        </ul>
      </div>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('views.shared_folders') }}">
        Shared folders
      </a>
    </div>
  </div>

  {% if cards|length == 0 %}
    <div class="alert alert-secondary">
      No cards match your filters. Try broadening them or
      <a href="{{ url_for('views.import_csv') }}">import a CSV</a>.
    </div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-sm align-middle cards-table" data-columns-table="cards">
        <thead>
          {% set name_dir = 'asc' if sort!='name' or direction=='desc' else 'desc' %}
          {% set ctyp_dir = 'asc' if sort!='ctype' or direction=='desc' else 'desc' %}
          {% set col_dir  = 'asc' if sort!='colors' or direction=='desc' else 'desc' %}
          {% set rar_dir  = 'asc' if sort!='rar'  or direction=='desc' else 'desc' %}
          {% set fol_dir  = 'asc' if sort!='folder' or direction=='desc' else 'desc' %}
          {% set set_dir  = 'asc' if sort!='set'  or direction=='desc' else 'desc' %}
          {% set cn_dir   = 'asc' if sort!='cn'   or direction=='desc' else 'desc' %}
          {% set qty_dir  = 'asc' if sort!='qty'  or direction=='desc' else 'desc' %}
          {% set art_dir  = 'asc' if sort!='art'  or direction=='desc' else 'desc' %}
          {% set core_dir = 'asc' if sort!='core_role' or direction=='desc' else 'desc' %}
          {% set evergreen_dir = 'asc' if sort!='evergreen' or direction=='desc' else 'desc' %}
          {% set price_dir = 'asc' if sort!='price' or direction=='desc' else 'desc' %}
          {% macro keep_params(sort_field, dir_value) -%}
            {%- if type_mode_local == 'exact' -%}
              {{ url_for('views.list_cards',
                  q=q, role_q=role_query_text, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None),
                  type=ui_selected_types, type_mode=type_mode_local,
                  color=selected_colors, color_mode=color_mode,
                  collection=1 if collection_flag else None,
                  sort=sort_field, dir=dir_value) }}
            {%- else -%}
              {{ url_for('views.list_cards',
                  q=q, role_q=role_query_text, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None),
                  type_any=ui_selected_types, type_mode='contains',
                  color=selected_colors, color_mode=color_mode,
                  collection=1 if collection_flag else None,
                  sort=sort_field, dir=dir_value) }}
            {%- endif -%}
          {%- endmacro %}
          <tr>
            {% if move_folder_options %}
              <th class="col-select" data-col="select">
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" id="cardSelectAll" aria-label="Select all cards on this page">
                </div>
              </th>
            {% endif %}
            <th data-col="art"><a href="{{ keep_params('art', art_dir) }}">Art</a></th>
            <th data-col="name"><a href="{{ keep_params('name', name_dir) }}">Name</a></th>
            <th data-col="type"><a href="{{ keep_params('ctype', ctyp_dir) }}">Type</a></th>
            <th class="col-tags" data-col="core_role"><a href="{{ keep_params('core_role', core_dir) }}">Core Role</a></th>
            <th class="col-tags" data-col="evergreen"><a href="{{ keep_params('evergreen', evergreen_dir) }}">Evergreen</a></th>
            <th data-col="folder"><a href="{{ keep_params('folder', fol_dir) }}">Folder</a></th>
            <th data-col="set"><a href="{{ keep_params('set', set_dir) }}">Set</a></th>
            <th class="text-end" data-col="qty"><a href="{{ keep_params('qty', qty_dir) }}">Qty</a></th>
            <th class="text-end" data-col="price"><a href="{{ keep_params('price', price_dir) }}">Price</a></th>
            <th class="col-colors" data-col="colors"><a href="{{ keep_params('colors', col_dir) }}">Colors</a></th>
            <th data-col="rarity"><a href="{{ keep_params('rar', rar_dir) }}">Rarity</a></th>
            <th data-col="collector"><a href="{{ keep_params('cn', cn_dir) }}">#</a></th>
          </tr>
        </thead>
        <tbody>
          {% for card in cards %}
            {% set fname = card.folder_name %}
            {% set hover_src = card.image_large %}
            <tr class="card-row"
                data-card-id="{{ card.id }}"
                data-folder="{{ (fname or '')|lower }}"
                data-folder-id="{{ card.folder_id }}"
                data-quantity="{{ card.quantity }}"
                data-set="{{ card.set_code or '' }}"
                data-cn="{{ card.collector_number or '' }}"
                data-lang="{{ card.lang or '' }}"
                data-foil="{{ 1 if card.is_foil else 0 }}"
                data-rarity="{{ card.rarity_label or '' }}"
                data-type="{{ card.type_tokens_str or '' }}"
                data-img-small="{{ card.image_small or '' }}"
                data-img-large="{{ (hover_src or '') }}"
                data-name="{{ card.display_name }}"
                data-ignore-hover="true">
              {% if move_folder_options %}
                <td class="col-select" data-col="select">
                  <div class="form-check mb-0">
                    <input class="form-check-input card-select"
                           type="checkbox"
                           value="{{ card.id }}"
                           aria-label="Select {{ card.display_name }}"
                           data-card-name="{{ card.display_name }}">
                  </div>
                </td>
              {% endif %}
              <td style="width:52px;" data-col="art">
                {% if card.image_small %}
                  <img decoding="async" src="{{ card.image_small }}" alt="" width="48" height="auto" loading="lazy" class="rounded card-thumb" {% if hover_src %}data-hover-src="{{ hover_src }}"{% endif %}>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td data-col="name"><a class="card-link" href="{{ url_for('views.card_detail', card_id=card.id) }}" {% if hover_src %}data-hover-src="{{ hover_src }}"{% endif %}>{{ card.display_name }}</a></td>
              <td class="align-middle" data-col="type">
                {% if card.type_badges %}
                  {% for t in card.type_badges %}{{ type_badge(t) }}{% endfor %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="col-tags" data-col="core_role">
                {% if card.core_roles_display %}
                  {% for role in card.core_roles_display %}
                    <span class="badge text-bg-secondary">{{ role }}</span>
                  {% endfor %}
                  {% if card.core_roles_overflow %}
                    <span class="text-muted small">+{{ card.core_roles_overflow }}</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="col-tags" data-col="evergreen">
                {% if card.evergreen_display %}
                  {% for tag in card.evergreen_display %}
                    <span class="badge text-bg-secondary">{{ tag }}</span>
                  {% endfor %}
                  {% if card.evergreen_overflow %}
                    <span class="text-muted small">+{{ card.evergreen_overflow }}</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td data-col="folder">
                {% if card.folder_name %}
                  {{ folder_badge(card.folder_name) }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-uppercase" data-col="set">{{ card.set_code or '' }}</td>
              <td class="text-end" data-col="qty">{{ card.quantity }}</td>
              <td class="text-end text-nowrap" data-col="price">
                {% if card.price_text %}
                  {{ card.price_text }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="col-colors" data-col="colors">
                <span class="pip-row">
                  {% for C in card.color_letters %}
                    <img class="mana mana-sm" src="/static/symbols/{{ C }}.svg" alt="{{ C }}" onerror="this.outerHTML='{{ C }}'">
                  {% endfor %}
                </span>
              </td>
              <td data-col="rarity">
                {% if card.rarity_label %}
                  <span class="badge text-bg-{{ card.rarity_badge_class or 'secondary' }}">{{ card.rarity_label }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td data-col="collector">{{ card.collector_number or '' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if pages is defined %}
      <div class="d-flex justify-content-end align-items-center flex-wrap gap-3 mt-3">
        <div class="text-muted small">Showing {{ start }}-{{ end }} of {{ total }}</div>
        <form method="get" class="d-inline" id="cardsPerForm">
          {% for k, v in request.args.items() if k not in ['per','page','page_size','per_page'] %}
            <input type="hidden" name="{{ k }}" value="{{ v }}">
          {% endfor %}
          <label class="me-1 small text-muted" for="cardsPerToggle">/ page</label>
          <div class="dropdown dv-select dv-select-sm d-inline-block" data-dv-select="cards-per" id="cardsPerSelect">
            <input type="hidden" name="per" data-dv-select-input value="{{ per_value }}">
            <button class="btn dv-select-toggle btn-sm d-inline-flex align-items-center gap-2" type="button" id="cardsPerToggle" data-bs-toggle="dropdown" aria-expanded="false">
              <span data-dv-select-label>{{ per_value }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu dropdown-menu-end" aria-labelledby="cardsPerToggle">
              {% for n in [25, 50, 100, 150, 200] %}
                <li>
                  <button class="dropdown-item {% if per_value == n %}active{% endif %}" type="button" data-dv-select-option data-value="{{ n }}" data-label="{{ n }}">
                    {{ n }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
          <input type="hidden" name="page" value="{{ page }}">
          <input type="hidden" name="per_page" value="{{ per_value }}">
        </form>

        <nav aria-label="Cards pagination">
          {% call(page_number) render_pagination(page=page, pages=pages, window=2, classes="pagination pagination-sm mb-0") %}
            {{ page_url_map.get(page_number, '#') }}
          {% endcall %}
        </nav>
      </div>
    {% endif %}
  {% endif %}
</div>

{% if move_folder_options %}
<div class="card-action-bar d-none" id="cardActionBar">
  <div class="bar-surface">
    <div class="row align-items-center bar-grid">
      <div class="col-12 col-md-3 d-flex flex-column">
        <div class="bar-title">Bulk actions</div>
        <div class="small muted" id="cardActionSummary">Select cards to enable actions</div>
      </div>
      <div class="col-12 col-md">
        <label class="form-label mb-1" for="cardActionMoveToggle">Move to</label>
        <div class="dropdown dv-select w-100" data-dv-select="card-action-move" id="cardActionMoveWrapper">
          <input type="hidden" id="cardActionMoveInput" data-dv-select-input value="">
          <button class="btn dv-select-toggle w-100 justify-content-between" type="button" id="cardActionMoveToggle" data-bs-toggle="dropdown" aria-expanded="false">
            <span data-dv-select-label>Choose destination…</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="cardActionMoveToggle">
            <li>
              <button class="dropdown-item active" type="button" data-dv-select-option data-value="" data-label="Choose destination…">Choose destination…</button>
            </li>
            {% for option in move_folder_options %}
              <li>
                <button class="dropdown-item" type="button" data-dv-select-option data-value="{{ option.id }}" data-label="{{ option.name }}">
                  {{ option.name }}
                  {% if option.is_collection %}
                    <span class="badge bg-secondary ms-2">Collection</span>
                  {% elif option.is_proxy %}
                    <span class="badge bg-warning text-dark ms-2">Proxy</span>
                  {% endif %}
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="col-6 col-md-auto quantity-wrap" id="cardActionQtyWrap">
        <label class="form-label mb-1" for="cardActionQty">Qty</label>
        <input type="number" min="1" step="1" class="form-control" id="cardActionQty" value="1">
      </div>
      <div class="col-12 col-md-auto d-flex gap-2 justify-content-end flex-wrap">
        <button type="button" class="btn btn-outline-secondary" id="cardActionEditBtn" disabled>Edit printing</button>
        <button type="button" class="btn btn-primary" id="cardActionMoveBtn" disabled>Move cards</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Drawer -->
<div class="offcanvas offcanvas-end w-500" tabindex="-1" id="cardDrawer" aria-labelledby="cardDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="cardDrawerLabel">Card Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div id="drawerContent">
      <div class="text-center small text-muted">Select a card…</div>
    </div>
  </div>
</div>

{% from "macros/modal_wrapper.html" import wrap_modal %}
{% call wrap_modal() %}
<div class="modal fade" id="editPrintingModal" tabindex="-1" aria-labelledby="editPrintingLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-body text-body border border-secondary-subtle rounded-4">
      <div class="modal-header border-secondary-subtle">
        <div>
          <p class="text-muted small mb-1">Update printing</p>
          <h5 class="modal-title" id="editPrintingLabel">Edit printing</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <form id="editPrintingForm">
          <div class="modal-body">
            <div id="editPrintingAlert" class="alert alert-warning d-none mb-3"></div>
            <div class="border rounded-3 p-3 bg-body-tertiary mb-3">
              <div class="d-flex align-items-center gap-3 flex-wrap">
                <div>
                  <div class="small text-muted">Card</div>
                  <div class="fw-semibold" id="editPrintingCardName">Loading…</div>
                </div>
                <div class="vr d-none d-md-block"></div>
                <div>
                  <div class="small text-muted">Owned quantity</div>
                  <div class="fw-semibold" id="editPrintingOwnedQty">—</div>
                </div>
              </div>
            </div>
            <input type="hidden" id="editPrintingCardId" name="card_id" value="">
            <div class="mb-3">
              <label class="form-label">Printing</label>
              <input type="hidden" id="printingSelectInput" value="">
              <div id="printingGridEmpty" class="text-muted small d-none">No printings found for this card.</div>
              <div class="printing-grid" id="printingOptionsGrid"></div>
              <div class="form-text">Pick the exact set, collector number, language, and variant.</div>
            </div>
            <div class="mb-3">
              <label for="foilingSelectToggle" class="form-label">Foiling</label>
              <div class="dropdown dv-select w-100" data-dv-select="card-foiling" id="foilingSelectWrapper">
                <input type="hidden" id="foilingSelectInput" data-dv-select-input value="nonfoil">
                <button class="btn dv-select-toggle w-100 justify-content-between" type="button" id="foilingSelectToggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <span data-dv-select-label>Nonfoil</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="foilingSelectToggle">
                  <li><button class="dropdown-item active" type="button" data-dv-select-option data-value="nonfoil" data-label="Nonfoil">Nonfoil</button></li>
                  <li><button class="dropdown-item" type="button" data-dv-select-option data-value="foil" data-label="Foil">Foil</button></li>
                </ul>
              </div>
              <div class="form-text" id="foilingAvailability">Select a printing to see available finishes.</div>
            </div>
            <div class="mb-3">
              <label for="editPrintingQty" class="form-label">Quantity</label>
              <input type="number" min="1" step="1" class="form-control" id="editPrintingQty" value="1">
              <div class="form-text" id="editPrintingQtyHelp">Defaulting to 1 copy.</div>
            </div>
          </div>
          <div class="modal-footer border-secondary-subtle">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="editPrintingSubmit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endcall %}

<script>
(function () {
  // --- Ensure 'Contains' ships type_any (not type) ---
  const form = document.getElementById('cardsFilterForm');
  if (form) {
    // Ensure type inputs are enabled (they may have been disabled on a previous submit)
    form.querySelectorAll('input[name="type"]').forEach((input) => {
      input.disabled = false;
    });

    form.addEventListener('submit', function () {
      const contains = form.querySelector('input[name="type_mode"][value="contains"]')?.checked;
      // Clean up any prior temp fields
      form.querySelectorAll('#tmp_type_any, #tmp_type_mode').forEach(n => n.remove());
      if (contains) {
        const checked = Array.from(form.querySelectorAll('input[name="type"]:checked')).map(i => i.value);
        // Disable original "type" so backend won't treat as exact/AND
        form.querySelectorAll('input[name="type"]').forEach(i => { i.disabled = true; });
        // Inject type_any for OR behavior
        const holder = document.createElement('div');
        holder.id = 'tmp_type_any';
        checked.forEach(v => {
          const h = document.createElement('input');
          h.type = 'hidden'; h.name = 'type_any'; h.value = v; holder.appendChild(h);
        });
        // Reinforce the mode
        const tm = document.createElement('input');
        tm.type = 'hidden'; tm.name = 'type_mode'; tm.value = 'contains'; tm.id = 'tmp_type_mode';
        holder.appendChild(tm);
        form.appendChild(holder);
      }
    });

    // Helper to auto-apply filters when toggling checkboxes (types/colors)
    let autoSubmitTimer = null;
    const scheduleSubmit = () => {
      if (!form) return;
      if (autoSubmitTimer) {
        clearTimeout(autoSubmitTimer);
      }
      autoSubmitTimer = window.setTimeout(() => {
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      }, 150);
    };

    form.querySelectorAll('input[name="type"], input[name="color"]').forEach((input) => {
      input.addEventListener('change', scheduleSubmit);
    });
  }

  // Per-page selector (matches dv-select UI)
  const cardsPerForm = document.getElementById('cardsPerForm');
  const cardsPerSelect = document.getElementById('cardsPerSelect');
  if (cardsPerForm && cardsPerSelect) {
    cardsPerSelect.addEventListener('dv-select:change', () => {
      cardsPerForm.submit();
    });
  }

  // Column visibility toggles for the cards table.
  const columnTable = document.querySelector('[data-columns-table="cards"]');
  const columnToggles = Array.from(document.querySelectorAll('[data-columns-toggle="cards"]'));
  const columnReset = document.querySelector('[data-columns-reset="cards"]');
  if (columnTable && columnToggles.length) {
    const storageKey = 'dv:columns:cards';
    const availableCols = new Set(
      columnToggles.map((toggle) => toggle.getAttribute('data-col')).filter(Boolean)
    );

    const readHidden = () => {
      try {
        const raw = window.localStorage?.getItem(storageKey);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed.filter((col) => availableCols.has(col)) : [];
      } catch (_err) {
        return [];
      }
    };

    const writeHidden = (hidden) => {
      try {
        window.localStorage?.setItem(storageKey, JSON.stringify(hidden));
      } catch (_err) {
        /* ignore storage failures */
      }
    };

    const setColumnVisible = (col, visible) => {
      columnTable.querySelectorAll(`[data-col="${col}"]`).forEach((cell) => {
        cell.classList.toggle('d-none', !visible);
      });
    };

    const applyHidden = (hidden) => {
      const hiddenSet = new Set(hidden);
      columnToggles.forEach((toggle) => {
        const col = toggle.getAttribute('data-col');
        if (!col) return;
        const visible = !hiddenSet.has(col);
        toggle.checked = visible;
        setColumnVisible(col, visible);
      });
    };

    const storedHidden = readHidden();
    if (storedHidden.length === availableCols.size) {
      writeHidden([]);
      applyHidden([]);
    } else {
      applyHidden(storedHidden);
    }

    const syncFromUI = () => {
      const hidden = columnToggles
        .filter((toggle) => !toggle.checked)
        .map((toggle) => toggle.getAttribute('data-col'))
        .filter(Boolean);

      if (hidden.length === columnToggles.length) {
        columnToggles.forEach((toggle) => {
          toggle.checked = true;
        });
        writeHidden([]);
        applyHidden([]);
        return;
      }

      writeHidden(hidden);
      applyHidden(hidden);
    };

    columnToggles.forEach((toggle) => {
      toggle.addEventListener('change', syncFromUI);
    });

    if (columnReset) {
      columnReset.addEventListener('click', () => {
        columnToggles.forEach((toggle) => {
          toggle.checked = true;
        });
        writeHidden([]);
        applyHidden([]);
      });
    }
  }

  // --- Drawer (unchanged) ---
  const drawerEl  = document.getElementById('cardDrawer');
  const contentEl = document.getElementById('drawerContent');
  let offcanvas;
  let keyHandler = null;

  function openDrawer() {
    if (typeof bootstrap !== 'undefined') {
      offcanvas = offcanvas || new bootstrap.Offcanvas(drawerEl);
      offcanvas.show();
    } else {
      drawerEl.classList.add('show');
      drawerEl.style.visibility = 'visible';
    }
  }

  function esc(s) {
    return (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  function normalizeImages(payload) {
    const out = [];
    if (Array.isArray(payload?.images)) out.push(...payload.images);
    const info = payload?.info || {};
    if (Array.isArray(info?.faces)) {
      info.faces.forEach(face => { if (face) out.push(face); });
    }
    return out.map(i => ({
      small:  i?.small  || i?.normal || i?.large || i?.url || i?.uri || null,
      normal: i?.normal || i?.large  || i?.small || null,
      large:  i?.large  || i?.normal || i?.small || null,
      label: i?.label || null
    })).filter(i => i.small || i.normal || i.large);
  }
  const imgSrc   = (img) => img.large || img.normal || img.small || null;
  const imgLabel = (img) => img?.label || '';
  const MISSING_TEXT = '&mdash;';

  function renderColorPips(info) {
    const source = (info?.color_identity && info.color_identity.length)
      ? info.color_identity
      : (info?.colors || []);
    if (!source || !source.length) return MISSING_TEXT;
    return `<span class="pip-row">${
      source.map(c => {
        const L = String(c || '').toUpperCase();
        return `<img class="mana mana-sm" src="/static/symbols/${L}.svg" alt="${L}" onerror="this.outerHTML='${L}'">`;
      }).join('')
    }</span>`;
  }

  function renderCommanderBadge(status) {
    if (!status) {
      return `<span class="small text-muted">${MISSING_TEXT}</span>`;
    }
    const normalized = String(status).toLowerCase();
    let theme = 'secondary';
    if (normalized === 'legal') theme = 'success';
    else if (normalized === 'restricted') theme = 'warning';
    else if (normalized === 'banned') theme = 'danger';
    const label = normalized.charAt(0).toUpperCase() + normalized.slice(1);
    return `<span class="badge text-bg-${theme}">Commander: ${esc(label)}</span>`;
  }

  function renderScryfallButtons(info) {
    if (!info) return '';
    const buttons = [];
    if (info.scryfall_uri) {
      buttons.push(`<a class="btn btn-sm btn-outline-primary" href="${info.scryfall_uri}" target="_blank" rel="noopener">View on Scryfall</a>`);
    }
    if (info.scryfall_set_uri) {
      buttons.push(`<a class="btn btn-sm btn-outline-secondary" href="${info.scryfall_set_uri}" target="_blank" rel="noopener">View Set</a>`);
    }
    return buttons.length ? `<div class="d-flex flex-wrap gap-2 mt-2">${buttons.join('')}</div>` : '';
  }

  function buildCyclerHTML(images) {
    if (!images.length) return `<div class="text-center small text-muted mb-3">No image available</div>`;
    const first = images[0], src = imgSrc(first), label = imgLabel(first);
    return `
      <div class="drawer-cycler mb-3" data-count="${images.length}" data-index="0">
        <button type="button" class="nav-btn prev" aria-label="Previous">◀</button>
        <img class="d-block card-art" id="drawerMainImg" src="${src}" alt="${esc(label)}">
        <button type="button" class="nav-btn next" aria-label="Next">▶</button>
        <div class="small-muted text-center mt-1" id="drawerImgLabel">${esc(label)}</div>
      </div>`;
  }
  function initCycler(images) {
    const wrap = contentEl.querySelector('.drawer-cycler'); if (!wrap) return;
    const prevBtn = wrap.querySelector('.prev');
    const nextBtn = wrap.querySelector('.next');
    const imgEl   = wrap.querySelector('#drawerMainImg');
    const capEl   = wrap.querySelector('#drawerImgLabel');

    let idx = 0;
    const N = images.length;
    function show(i) {
      idx = ((i % N) + N) % N;
      const im = images[idx];
      imgEl.src = imgSrc(im);
      capEl.textContent = imgLabel(im) || '';
      // when cycling art, always reset any flipped state
      imgEl.dataset.face = '0';
    }

    if (N < 2) { prevBtn.style.display = 'none'; nextBtn.style.display = 'none'; }
    else {
      prevBtn.addEventListener('click', e => { e.preventDefault(); show(idx - 1); });
      nextBtn.addEventListener('click', e => { e.preventDefault(); show(idx + 1); });
    }

    if (keyHandler) document.removeEventListener('keydown', keyHandler);
    keyHandler = (e) => {
      if (!drawerEl.classList.contains('show')) return;
      if (N < 2) return;
      if (e.key === 'ArrowLeft')  { e.preventDefault(); show(idx - 1); }
      if (e.key === 'ArrowRight') { e.preventDefault(); show(idx + 1); }
    };
    document.addEventListener('keydown', keyHandler);

    if (typeof bootstrap !== 'undefined') {
      drawerEl.addEventListener('hidden.bs.offcanvas', () => {
        if (keyHandler) { document.removeEventListener('keydown', keyHandler); keyHandler = null; }
      }, { once: true });
    }

    show(0);
  }

  /* ==== NEW: flip button for dual-face cards (MDFC) in the drawer ==== */
  async function attachDrawerFlip(scryfallId){
    try {
      const wrap = contentEl.querySelector('.drawer-cycler');
      const img  = contentEl.querySelector('#drawerMainImg');
      if (!wrap || !img || !scryfallId) return;

      // Remove an existing button if present (re-open drawer case)
      const old = wrap.querySelector('.flip-face-btn');
      if (old) old.remove();

      // Get faces
      const res = await fetch(`/api/print/${scryfallId}/faces`);
      if (!res.ok) return;
      const data = await res.json();
      const faces = Array.isArray(data.faces) ? data.faces.filter(f => f && (f.large || f.normal || f.small)) : [];
      if (faces.length < 2) return; // not MDFC — nothing to do

      const pick = (f) => f.large || f.normal || f.small || null;

      // Add button
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'flip-face-btn btn btn-sm';
      btn.title = 'Flip card';
      btn.setAttribute('aria-label','Flip card');
      btn.textContent = '⇆';
      wrap.appendChild(btn);

      const front = pick(faces[0]) || img.getAttribute('src');
      const back  = pick(faces[1]) || img.getAttribute('src');

      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        const cur = img.getAttribute('data-face') === '1' ? 1 : 0;
        const next = cur ^ 1;
        img.setAttribute('data-face', String(next));
        img.setAttribute('src', next ? back : front);
      });

      // If user cycles art with arrows, reset to front
      wrap.addEventListener('click', (ev) => {
        const t = ev.target;
        if (t && (t.classList.contains('prev') || t.classList.contains('next'))) {
          img.setAttribute('data-face', '0');
          img.setAttribute('src', front);
        }
      }, true);
    } catch (_) {}
  }
  /* ===== end new block ===== */

  function buildDetailRow(label, html) {
    const value = (html !== undefined && html !== null && html !== '') ? html : MISSING_TEXT;
    return `<div class="d-flex gap-2 mb-1"><div class="detail-label">${label}</div><div>${value}</div></div>`;
  }

  function renderDrawer(payload) {
    const card = payload?.card || {};
    const info = payload?.info || {};
    const images = normalizeImages(payload);

    document.getElementById('cardDrawerLabel').textContent = info.name || card.name || 'Card';

    const commanderBadge = renderCommanderBadge(info?.commander_legality ?? info?.legalities?.commander);
    const setCode = (info?.set || '').toUpperCase();
    const setName = info?.set_name || '';
    let setHtml = MISSING_TEXT;
    if (setName || setCode) {
      const namePart = setName ? esc(setName) : '';
      const codePart = setCode ? ` <span class="small-muted">[${esc(setCode)}]</span>` : '';
      setHtml = `${namePart}${codePart}`.trim() || MISSING_TEXT;
    }
    const rarityHtml = info?.rarity ? esc(String(info.rarity).toUpperCase()) : MISSING_TEXT;
    const typeHtml = info?.type_line ? esc(info.type_line) : MISSING_TEXT;
    const cardNumberHtml = info?.collector_number ? esc(info.collector_number) : MISSING_TEXT;
    const cmcHtml = info?.cmc !== undefined && info?.cmc !== null ? esc(info.cmc) : MISSING_TEXT;
    const colorsHtml = renderColorPips(info);
    const folderHtml = card?.folder ? esc(card.folder) : MISSING_TEXT;
    const quantityHtml = card?.quantity !== undefined && card?.quantity !== null ? esc(card.quantity) : MISSING_TEXT;
    const scryButtons = renderScryfallButtons(info);

    contentEl.innerHTML = `
      ${buildCyclerHTML(images)}
      ${info?.mana_cost_html
        ? `<div class="mb-2"><div class="fw-semibold">Mana Cost</div><div>${info.mana_cost_html}</div></div>` : ''}
      ${info?.oracle_text_html
        ? `<div class="mb-3"><div class="fw-semibold">Card Text</div><div>${info.oracle_text_html}</div></div>` : ''}
      <div class="mb-3">
        ${buildDetailRow('Type', typeHtml)}
        ${buildDetailRow('Colors', colorsHtml)}
        ${buildDetailRow('CMC', cmcHtml)}
        ${buildDetailRow('Rarity', rarityHtml)}
        ${buildDetailRow('Set', setHtml)}
        ${buildDetailRow('Card #', cardNumberHtml)}
        ${buildDetailRow('Commander', commanderBadge)}
        ${buildDetailRow('Folder', folderHtml)}
        ${buildDetailRow('Quantity', quantityHtml)}
      </div>
      ${scryButtons}
    `;
    initCycler(images);

    /* NEW: add flip overlay if this print has a back side */
    attachDrawerFlip(info.scryfall_id || info.scryfallId || info.id);
  }

  async function openCardDrawer(cardId, hrefFallback) {
    document.getElementById('cardDrawerLabel').textContent = 'Loading…';
    document.getElementById('drawerContent').innerHTML = '<div class="text-center small text-muted">Loading…</div>';
    openDrawer();
    try {
      const res = await fetch(`/api/card/${cardId}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      renderDrawer(await res.json());
    } catch (err) {
      console.warn('[cards drawer] failed:', err);
      document.getElementById('drawerContent').innerHTML = '<div class="text-danger">Failed to load card.</div>';
      if (hrefFallback) window.location = hrefFallback;
    }
  }

  const csrfToken = window.csrfToken || document.querySelector('meta[name="csrf-token"]')?.content || '';
  const csrfHeader = window.csrfHeader || (csrfToken ? {'X-CSRFToken': csrfToken} : {});

  const actionBar = document.getElementById('cardActionBar');
  if (actionBar) {
    const cardCheckboxes = Array.from(document.querySelectorAll('.card-select'));
    const selectAllToggle = document.getElementById('cardSelectAll');
    const actionSummary = document.getElementById('cardActionSummary');
    const qtyInput = document.getElementById('cardActionQty');
    const qtyWrap = document.getElementById('cardActionQtyWrap');
    const moveWrapper = document.getElementById('cardActionMoveWrapper');
    const moveInput = document.getElementById('cardActionMoveInput');
    const moveBtn = document.getElementById('cardActionMoveBtn');
    const editBtn = document.getElementById('cardActionEditBtn');
    const totalCheckboxes = cardCheckboxes.length;
    const pageSection = document.getElementById('cardsPageSection');

    const selectedCards = () => cardCheckboxes.filter(cb => cb.checked);
    const findRow = (cb) => cb?.closest('tr.card-row');
    const selectedRows = () => selectedCards().map(cb => findRow(cb)).filter(Boolean);
    const getMoveTarget = () => {
      const raw = (() => {
        const viaInput = (moveInput?.value || '').trim();
        const viaDataset = (moveWrapper?.dataset.selected || moveWrapper?.dataset.dvSelectValue || '').trim();
        const viaHidden = (moveWrapper?.querySelector('[data-dv-select-input]')?.value || '').trim();
        const viaActive = (document.querySelector('#cardActionMoveWrapper [data-dv-select-option].active')?.getAttribute('data-value') || '').trim();
        return viaInput || viaDataset || viaHidden || viaActive || '';
      })();
      const num = raw ? Number(raw) : NaN;
      return Number.isFinite(num) ? num : null;
    };

    function updateActionUI() {
      const sel = selectedCards();
      const rows = selectedRows();
      const count = sel.length;
      const targetValue = getMoveTarget();
      const singleRow = count === 1 ? rows[0] : null;
      const maxQty = singleRow ? parseInt(singleRow.dataset.quantity || '1', 10) || 1 : 1;

      if (qtyWrap) {
        qtyWrap.classList.toggle('d-none', count !== 1);
      }
      if (qtyInput) {
        qtyInput.disabled = count !== 1;
        qtyInput.max = maxQty;
        if (count !== 1) {
          qtyInput.value = 1;
        } else if (parseInt(qtyInput.value, 10) > maxQty) {
          qtyInput.value = maxQty;
        }
      }

      const summaryText = count === 0
        ? 'Select cards to enable actions'
        : `${count} card${count === 1 ? '' : 's'} selected${count === 1 ? ` (${maxQty} owned)` : ''}`;
      if (actionSummary) {
        actionSummary.textContent = summaryText;
        actionSummary.classList.remove('text-danger');
      }

      if (selectAllToggle && totalCheckboxes) {
        selectAllToggle.checked = count > 0 && count === totalCheckboxes;
        selectAllToggle.indeterminate = count > 0 && count < totalCheckboxes;
      }

      if (moveBtn) moveBtn.disabled = !count || !targetValue;
      if (editBtn) {
        editBtn.disabled = count !== 1;
        editBtn.classList.toggle('d-none', count !== 1);
      }
      actionBar.classList.toggle('d-none', count === 0);
      if (pageSection) {
        pageSection.classList.toggle('page-section-with-bar', count > 0);
      }
    }

    function handleCheckboxChange() {
      updateActionUI();
    }

    cardCheckboxes.forEach(cb => {
      cb.addEventListener('change', handleCheckboxChange);
      cb.addEventListener('click', evt => evt.stopPropagation());
    });

    if (selectAllToggle) {
      selectAllToggle.addEventListener('change', () => {
        const checked = selectAllToggle.checked;
        cardCheckboxes.forEach(cb => { cb.checked = checked; });
        updateActionUI();
      });
    }

      if (moveWrapper) {
        moveWrapper.addEventListener('dv-select:change', (ev) => {
          const val = ev?.detail?.value || '';
          if (moveInput) moveInput.value = val;
          moveWrapper.dataset.selected = val;
          moveWrapper.dataset.dvSelectValue = val;
          updateActionUI();
        });
        moveWrapper.addEventListener('dv-select:ready', () => {
          const val = document.querySelector('#cardActionMoveWrapper [data-dv-select-option].active')?.getAttribute('data-value') || '';
          if (moveInput) moveInput.value = val;
          moveWrapper.dataset.selected = val;
          moveWrapper.dataset.dvSelectValue = val;
          updateActionUI();
        });
        moveWrapper.querySelectorAll('[data-dv-select-option]').forEach(btn => {
          btn.addEventListener('click', () => {
            const val = btn.getAttribute('data-value') || '';
            if (moveInput) moveInput.value = val;
            moveWrapper.dataset.selected = val;
            moveWrapper.dataset.dvSelectValue = val;
            updateActionUI();
          });
        });
      }

    const showToast = (message, isError = false) => {
      const alert = document.getElementById('editPrintingAlert');
      const modalShown = document.getElementById('editPrintingModal')?.classList.contains('show');
      if (alert && modalShown) {
        alert.textContent = message;
        alert.classList.toggle('alert-warning', isError);
        alert.classList.toggle('alert-success', !isError);
        alert.classList.remove('d-none');
        return;
      }
      if (actionSummary) {
        actionSummary.textContent = message;
        actionSummary.classList.toggle('text-danger', isError);
        if (!isError) actionSummary.classList.remove('text-danger');
      }
    };

    function reloadCards() {
      if (window.DV && window.DV.scroll && typeof window.DV.scroll.reload === "function") {
        window.DV.scroll.reload();
        return;
      }
      window.location.reload();
    }

    async function performMove() {
      const ids = selectedCards().map(cb => cb.value);
      if (!ids.length) return;
      const targetVal = getMoveTarget();
      const payload = {
        card_ids: ids,
        target_folder_id: targetVal,
      };
      if (!payload.target_folder_id) {
        showToast("Choose a destination folder before moving.", true);
        return;
      }
      if (ids.length === 1 && qtyInput && !qtyInput.disabled) {
        const row = selectedRows()[0];
        const maxQty = parseInt(row?.dataset.quantity || '1', 10) || 1;
        const qty = Math.min(parseInt(qtyInput.value, 10) || 1, maxQty);
        payload["quantity"] = qty;
      }
      moveBtn.disabled = true;
      try {
        const res = await fetch("{{ url_for('views.bulk_move_cards') }}", {
          method: "POST",
          headers: {"Content-Type": "application/json", ...csrfHeader},
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data?.message || `HTTP ${res.status}`);
        }
        if (data?.success) {
          reloadCards();
          return;
        }
        showToast(data?.message || "Move failed", true);
      } catch (err) {
        console.error("Move failed", err);
        showToast(err?.message || "Move failed. Please try again.", true);
      } finally {
        moveBtn.disabled = false;
      }
    }

    async function fetchPrintingOptions(cardId) {
      const res = await fetch(`/api/card/${cardId}/printing-options`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function setFoilingOptions(finishes) {
      const wrapper = document.getElementById('foilingSelectWrapper');
      const input = document.getElementById('foilingSelectInput');
      if (!wrapper || !input) return;
      const buttons = Array.from(wrapper.querySelectorAll('[data-dv-select-option]'));
      const normalized = (finishes || []).map(f => (f || '').toLowerCase());
      const allowed = new Set(normalized.filter(f => f === 'foil' || f === 'nonfoil'));
      const available = allowed.size ? allowed : new Set(['nonfoil','foil']);
      buttons.forEach(btn => {
        const val = (btn.dataset.value || '').toLowerCase();
        const supported = !available.size || available.has(val);
        btn.disabled = !supported;
        btn.classList.toggle('disabled', !supported);
      });
      const desired = (input.value || '').toLowerCase();
      let chosen = null;
      if (available.size && available.has(desired)) {
        chosen = buttons.find(b => (b.dataset.value || '').toLowerCase() === desired && !b.disabled);
      }
      if (!chosen && available.size) {
        chosen = buttons.find(b => available.has((b.dataset.value || '').toLowerCase()) && !b.disabled);
      }
      if (chosen) {
        chosen.click();
      }
      const hint = document.getElementById('foilingAvailability');
      if (hint) {
        hint.textContent = available.size
          ? `Available finishes: ${Array.from(available).join(', ')}`
          : 'Select a printing to see available finishes.';
      }
    }

    function renderPrintingOptions(options, currentValue) {
      const grid = document.getElementById('printingOptionsGrid');
      const input = document.getElementById('printingSelectInput');
      const emptyState = document.getElementById('printingGridEmpty');
      if (!grid || !input) return;
      grid.innerHTML = '';
      const opts = options || [];
      if (!opts.length) {
        if (emptyState) emptyState.classList.remove('d-none');
        return;
      }
      if (emptyState) emptyState.classList.add('d-none');
      const placeholder = '/static/img/card-placeholder.svg';
      let activeCard = null;

      const setActive = (btn, finishes) => {
        if (activeCard) activeCard.classList.remove('active');
        activeCard = btn;
        btn.classList.add('active');
        input.value = btn.dataset.value || '';
        if (finishes) setFoilingOptions(finishes);
      };

      opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'printing-card text-start';
        btn.dataset.value = opt.value || '';
        btn.dataset.finishes = (opt.finishes || []).join(',');

        const img = document.createElement('img');
        img.src = opt.image || placeholder;
        img.alt = opt.set ? `${opt.set} #${opt.collector_number || ''}` : 'Printing';
        img.loading = 'lazy';
        img.className = 'thumb w-100';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <div class="fw-semibold">${opt.set || ''} #${opt.collector_number || ''}</div>
          <div class="text-muted small">${(opt.set_name || '').replace(/</g,'&lt;')}</div>
          <div class="d-flex flex-wrap gap-1 mt-1">
            <span class="badge text-bg-light text-dark">${(opt.lang || 'EN').toUpperCase()}</span>
            ${(opt.promo_types || []).map(p => `<span class="badge bg-secondary-subtle text-secondary-emphasis">${p}</span>`).join('')}
          </div>
        `;

        btn.appendChild(img);
        btn.appendChild(meta);
        btn.addEventListener('click', (evt) => {
          evt.preventDefault();
          const finishes = (btn.dataset.finishes || '').split(',').filter(Boolean);
          setActive(btn, finishes);
        });
        if (!activeCard && opt.value === currentValue) {
          setActive(btn, opt.finishes || []);
        }
        grid.appendChild(btn);
      });

      if (!activeCard && grid.firstElementChild) {
        const first = grid.firstElementChild;
        const finishes = (first.dataset.finishes || '').split(',').filter(Boolean);
        setActive(first, finishes);
      }
    }

    function openEditModalForRow(row) {
      if (!row) return;
      const cardId = row.dataset.cardId;
      const modalEl = document.getElementById('editPrintingModal');
      if (!modalEl || !cardId) return;
      const alertEl = document.getElementById('editPrintingAlert');
      if (alertEl) alertEl.classList.add('d-none');
      const nameEl = document.getElementById('editPrintingCardName');
      const ownedEl = document.getElementById('editPrintingOwnedQty');
      const qtyInputModal = document.getElementById('editPrintingQty');
      const qtyHelp = document.getElementById('editPrintingQtyHelp');
      const cardIdInput = document.getElementById('editPrintingCardId');
      const foilInput = document.getElementById('foilingSelectInput');
      if (foilInput) {
        foilInput.value = parseInt(row.dataset.foil || '0', 10) ? 'foil' : 'nonfoil';
      }
      if (nameEl) nameEl.textContent = row.dataset.name || 'Card';
      const maxQty = parseInt(row.dataset.quantity || '1', 10) || 1;
      if (ownedEl) ownedEl.textContent = maxQty;
      if (qtyInputModal) {
        qtyInputModal.max = maxQty;
        qtyInputModal.value = Math.min(maxQty, 1);
      }
      if (qtyHelp) qtyHelp.textContent = `You own ${maxQty} cop${maxQty === 1 ? 'y' : 'ies'} of this printing.`;
      if (cardIdInput) cardIdInput.value = cardId;

      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      renderPrintingOptions([], '');
      setFoilingOptions([]);

      fetchPrintingOptions(cardId)
        .then(data => {
          renderPrintingOptions(data?.options || [], data?.current || '');
          if (data?.current_finish && document.getElementById('foilingSelectInput')) {
            document.getElementById('foilingSelectInput').value = data.current_finish;
          }
          if (data?.finishes) setFoilingOptions(data.finishes);
        })
        .catch(err => {
          console.error('Failed to load printing options', err);
          showToast('Failed to load printing options.', true);
        });

      modal.show();
    }

    if (editBtn) {
      editBtn.addEventListener('click', () => {
        const row = selectedRows()[0];
        openEditModalForRow(row);
      });
    }

    if (moveBtn) {
      moveBtn.addEventListener('click', performMove);
    }

    const editForm = document.getElementById('editPrintingForm');
    if (editForm) {
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const cardId = document.getElementById('editPrintingCardId')?.value;
        const printingValue = document.getElementById('printingSelectInput')?.value;
        const finishValue = document.getElementById('foilingSelectInput')?.value || 'nonfoil';
        const qtyInputEl = document.getElementById('editPrintingQty');
        const maxQty = parseInt(qtyInputEl?.max || '1', 10) || 1;
        const qty = Math.min(parseInt(qtyInputEl?.value, 10) || 1, maxQty);
        if (!cardId || !printingValue) {
          showToast("Choose a printing before saving.", true);
          return;
        }
        document.getElementById('editPrintingSubmit').disabled = true;
        try {
          const res = await fetch(`/api/card/${cardId}/update-printing`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', ...csrfHeader},
            body: JSON.stringify({
              printing: printingValue,
              finish: finishValue,
              quantity: qty,
            }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
          if (data?.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPrintingModal'));
            modal?.hide();
            reloadCards();
            return;
          }
          showToast(data?.message || 'Update failed.', true);
        } catch (err) {
          console.error('Update failed', err);
          showToast('Update failed. Please try again.', true);
        } finally {
          document.getElementById('editPrintingSubmit').disabled = false;
        }
      });
    }

    updateActionUI();
  }

  function shouldIgnoreClick(target) {
    return (
      target.closest('a.card-link') ||
      target.closest('.card-select') ||
      target.closest('#cardActionBar') ||
      target.closest('button') ||
      target.closest('input') ||
      target.closest('select')
    );
  }

  document.querySelectorAll('tr.card-row').forEach(tr => {
    tr.setAttribute('tabindex', '0');

    tr.addEventListener('click', (e) => {
      if (shouldIgnoreClick(e.target)) return;
      if (window.getSelection && window.getSelection().toString()) return;
      const id = tr.getAttribute('data-card-id');
      const href = tr.querySelector('a.card-link')?.getAttribute('href') || null;
      if (id) openCardDrawer(id, href);
    });

    tr.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const id = tr.getAttribute('data-card-id');
        const href = tr.querySelector('a.card-link')?.getAttribute('href') || null;
        if (id) openCardDrawer(id, href);
      }
    });
  });
})();
</script>
{% endblock %}

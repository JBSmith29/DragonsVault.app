{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1">Manual Import Wizard</h1>
      <p class="text-muted mb-0">
        Paste a decklist-style card list, confirm the exact printing, foil preference, and folder for each card.
      </p>
    </div>
    <a class="btn btn-outline-secondary" href="{{ url_for('views.import_csv') }}">Back to file import</a>
  </div>

  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
      <form method="post">
        <div class="mb-3">
          <label for="card_list" class="form-label">Card list</label>
          <textarea
            class="form-control"
            rows="8"
            id="card_list"
            name="card_list"
            placeholder="Example:&#10;3 Sol Ring&#10;1 Cyclonic Rift&#10;2 Lightning Greaves"
          >{{ card_list }}</textarea>
          <div class="form-text">
            One card per line. Quantities are optional (default 1). Example formats: <code>3 Sol Ring</code> or <code>Sol Ring</code>.
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="defaultFolderToggle">Default existing folder</label>
            <div class="dropdown dv-select w-100" data-dv-select="default-folder">
              <input type="hidden" name="default_folder_id" data-dv-select-input value="{{ default_folder_id }}">
              <button
                class="btn dv-select-toggle w-100 justify-content-between"
                type="button"
                id="defaultFolderToggle"
                data-bs-toggle="dropdown"
                aria-expanded="false">
                <span data-dv-select-label>{{ default_folder_label }}</span>
                <i class="bi bi-chevron-down"></i>
              </button>
              <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="defaultFolderToggle">
                <li class="dv-select-search-wrapper">
                  <input
                    type="text"
                    class="form-control form-control-sm dv-select-search"
                    placeholder="Search folders..."
                    autocomplete="off"
                    data-dv-select-search>
                </li>
                <li>
                  <button
                    class="dropdown-item {% if not default_folder_id %}active{% endif %}"
                    type="button"
                    data-dv-select-option
                    data-value=""
                    data-label="None (choose per card)">
                    None (choose per card)
                  </button>
                </li>
                {% for folder in folder_options %}
                  <li>
                    <button
                      class="dropdown-item {% if default_folder_id|int == folder.id %}active{% endif %}"
                      type="button"
                      data-dv-select-option
                      data-value="{{ folder.id }}"
                      data-label="{{ folder.name }}">
                      {{ folder.name }}
                    </button>
                  </li>
                {% endfor %}
              </ul>
            </div>
            <div class="form-text">Optional: pre-select this folder for every imported card.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="default_folder_name">Or name a new folder</label>
            <input
              type="text"
              class="form-control"
              id="default_folder_name"
              name="default_folder_name"
              value="{{ default_folder_name }}"
              placeholder="Manual Import"
            >
            <div class="form-text">Leave blank to reuse "Manual Import".</div>
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label d-block">Folder type (for new folders)</label>
          <div class="btn-group" role="group">
            <input
              type="radio"
              class="btn-check"
              name="default_folder_category"
              id="folderTypeDeck"
              value="{{ deck_category }}"
              {% if default_folder_category != collection_category %}checked{% endif %}
            >
            <label class="btn btn-outline-theme btn-sm" for="folderTypeDeck">Deck</label>
            <input
              type="radio"
              class="btn-check"
              name="default_folder_category"
              id="folderTypeCollection"
              value="{{ collection_category }}"
              {% if default_folder_category == collection_category %}checked{% endif %}
            >
            <label class="btn btn-outline-theme btn-sm" for="folderTypeCollection">Collection</label>
          </div>
          <div class="form-text">Used whenever a brand-new folder is created.</div>
        </div>
        <div class="mt-4 d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary" name="action" value="parse">Review cards</button>
          <button type="submit" class="btn btn-outline-success" name="action" value="quick_upload">
            Quick upload (no printing selection)
          </button>
        </div>
        <div class="form-text mt-2">
          Quick upload drops cards into the selected folder (or "Manual Import") with blank printings so you can refine them later.
        </div>
      </form>
    </div>
  </div>

  {% if entries %}
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h2 class="h5 mb-3">Step 2: Confirm printings &amp; folders</h2>
        {% if entry_errors %}
          <div class="alert alert-danger">
            <ul class="mb-0">
              {% for err in entry_errors %}
                <li>{{ err }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        <form method="post">
          <input type="hidden" name="action" value="import">
          <input type="hidden" name="entry_ids" value="{{ entries | map(attribute='index') | join(',') }}">
          <input type="hidden" name="default_folder_id" value="{{ default_folder_id }}">
          <input type="hidden" name="default_folder_name" value="{{ default_folder_name }}">
          <input type="hidden" name="default_folder_category" value="{{ default_folder_category }}">
          <div class="table-responsive">
            <table class="table align-middle manual-import-table">
              <thead>
                <tr>
                  <th>Card</th>
                  <th style="width: 260px;">Printing</th>
                  <th style="width: 140px;">Finish</th>
                  <th style="width: 220px;">Folder</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in entries %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ entry.name }}</div>
                      <div class="text-muted small">Quantity: {{ entry.quantity }}</div>
                      <input type="hidden" name="entry-{{ entry.index }}-name" value="{{ entry.name }}">
                      <input type="hidden" name="entry-{{ entry.index }}-quantity" value="{{ entry.quantity }}">
                    </td>
                    <td>
                      <div class="dropdown dv-select dv-select-sm w-100" data-dv-select="printing-{{ entry.index }}">
                        <input type="hidden" name="entry-{{ entry.index }}-printing" data-dv-select-input value="{{ entry.options[0].value }}">
                        <button
                          class="btn dv-select-toggle btn-sm w-100 justify-content-between"
                          type="button"
                          id="printingToggle{{ entry.index }}"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                          <span data-dv-select-label>
                            {{ entry.options[0].set_code }} · #{{ entry.options[0].collector_number }} · {{ entry.options[0].set_name or 'Unknown Set' }}
                          </span>
                          <i class="bi bi-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="printingToggle{{ entry.index }}">
                          <li class="dv-select-search-wrapper">
                            <input type="text" class="form-control form-control-sm dv-select-search" placeholder="Search printings..." autocomplete="off" data-dv-select-search>
                          </li>
                          {% for option in entry.options %}
                            <li>
                              <button
                                class="dropdown-item {% if loop.first %}active{% endif %}"
                                type="button"
                                data-dv-select-option
                                data-value="{{ option.value }}"
                                data-label="{{ option.set_code }} · #{{ option.collector_number }} · {{ option.set_name or 'Unknown Set' }}">
                                {{ option.set_code }} · #{{ option.collector_number }} · {{ option.set_name or 'Unknown Set' }}
                              </button>
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                      <div class="form-text small">
                        Choose the exact set/collector number.
                      </div>
                    </td>
                    <td>
                      <div class="dropdown dv-select dv-select-sm w-100" data-dv-select="entry-finish-{{ entry.index }}">
                        <input type="hidden" name="entry-{{ entry.index }}-finish" data-dv-select-input value="nonfoil">
                        <button
                          class="btn dv-select-toggle btn-sm w-100 justify-content-between"
                          type="button"
                          id="entryFinishToggle{{ entry.index }}"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                          <span data-dv-select-label>Nonfoil</span>
                          <i class="bi bi-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="entryFinishToggle{{ entry.index }}">
                          <li>
                            <button class="dropdown-item active" type="button" data-dv-select-option data-value="nonfoil" data-label="Nonfoil">Nonfoil</button>
                          </li>
                          <li>
                            <button class="dropdown-item" type="button" data-dv-select-option data-value="foil" data-label="Foil">Foil</button>
                          </li>
                        </ul>
                      </div>
                    </td>
                    <td>
                      {% set prefill_id = entry.prefill_folder_id|default('', true) %}
                      {% set folder_label = namespace(value='New folder...') %}
                      {% if prefill_id %}
                        {% set existing_label = folder_lookup.get(prefill_id) %}
                        {% if existing_label %}
                          {% set folder_label.value = existing_label %}
                        {% endif %}
                      {% elif entry.prefill_folder_name %}
                        {% set folder_label.value = entry.prefill_folder_name %}
                      {% endif %}
                      <div class="dropdown dv-select dv-select-sm w-100" data-dv-select="entry-folder-{{ entry.index }}">
                        <input type="hidden" name="entry-{{ entry.index }}-folder_id" data-dv-select-input value="{{ prefill_id }}">
                        <button
                          class="btn dv-select-toggle btn-sm w-100 justify-content-between"
                          type="button"
                          id="entryFolderToggle{{ entry.index }}"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                          <span data-dv-select-label>{{ folder_label.value }}</span>
                          <i class="bi bi-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="entryFolderToggle{{ entry.index }}">
                          <li class="dv-select-search-wrapper">
                            <input
                              type="text"
                              class="form-control form-control-sm dv-select-search"
                              placeholder="Search folders..."
                              autocomplete="off"
                              data-dv-select-search>
                          </li>
                          <li>
                            <button
                              class="dropdown-item {% if not prefill_id %}active{% endif %}"
                              type="button"
                              data-dv-select-option
                              data-value=""
                              data-label="New folder...">
                              New folder...
                            </button>
                          </li>
                          {% for folder in folder_options %}
                            <li>
                              <button
                                class="dropdown-item {% if prefill_id|int == folder.id %}active{% endif %}"
                                type="button"
                                data-dv-select-option
                                data-value="{{ folder.id }}"
                                data-label="{{ folder.name }}">
                                {{ folder.name }}
                              </button>
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                      {% set prefill_name = entry.prefill_folder_name if entry.prefill_folder_name is not none else 'Manual Import' %}
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        name="entry-{{ entry.index }}-folder_name"
                        value="{{ prefill_name }}"
                        placeholder="Manual Import"
                      >
                      <div class="form-text small">
                        Leave as "Manual Import" (or your default) to auto-create that folder, or pick an existing folder above.
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="submit" class="btn btn-success">Import cards</button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% from "macros/modal_wrapper.html" import wrap_modal %}
{# Folder management page (admin + personal). #}
{% extends "base.html" %}
{% block content %}
<style>
  .bulk-select .dv-select-toggle {
    width: 100%;
    justify-content: space-between;
  }
</style>
<div class="container py-4">
  <h1 class="mb-3">{{ page_title or "Folder Categories" }}</h1>
  {% set default_display = default_collection | map('title') | list %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="alert alert-{{ 'warning' if cat=='message' else cat }} alert-dismissible fade show" role="alert">
          {{ msg|safe }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <p class="text-muted small">
    Mark folders that should count toward your collection. Defaults consider {{ default_display|join(', ') }} as collection buckets, but you can change them at any time.
  </p>

  <div class="mb-3">
    <span class="badge text-bg-primary me-2">Decks: {{ deck_count }}</span>
    <span class="badge text-bg-success me-2">Collection: {{ collection_count }}</span>
    <span class="badge text-bg-info me-2">Proxy: {{ proxy_count }}</span>
    <span class="badge text-bg-secondary">Total: {{ deck_count + collection_count }}</span>
  </div>

  <form method="post" data-ux-submit>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            {% if allow_delete %}
            <th style="width:4%;" class="text-center">
              <input class="form-check-input" type="checkbox" id="select-all-folders" aria-label="Select all folders">
            </th>
            {% endif %}
            <th style="width:26%;">Folder</th>
            <th style="width:28%;">Category</th>
            {% if show_owner_field %}
            <th style="width:20%;">Owner</th>
            {% endif %}
            <th style="width:10%;" class="text-center">Proxy</th>
            <th style="width:16%;">Notes</th>
            {% if allow_delete %}
            <th style="width:6%;" class="text-center">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% if folders and folders|length %}
            {% for folder in folders %}
              {% set is_collection = folder.is_collection %}
              {% set lower_name = (folder.name or '')|lower %}
              <tr>
                {% if allow_delete %}
                <td class="text-center">
                  <input
                    type="checkbox"
                    class="form-check-input folder-select"
                    name="delete_folder_ids"
                    value="{{ folder.id }}"
                    aria-label="Select {{ folder.name or 'folder' }}"
                  >
                </td>
                {% endif %}
                <td class="fw-semibold align-middle">
                  <span>{{ folder.name or '[unnamed]' }}</span>
                </td>
                <td>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="category-{{ folder.id }}"
                      id="cat-{{ folder.id }}-deck"
                      value="{{ deck_category }}"
                      {% if not is_collection %}checked{% endif %}
                    >
                    <label class="form-check-label" for="cat-{{ folder.id }}-deck">Deck</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="category-{{ folder.id }}"
                      id="cat-{{ folder.id }}-collection"
                      value="{{ collection_category }}"
                      {% if is_collection %}checked{% endif %}
                    >
                    <label class="form-check-label" for="cat-{{ folder.id }}-collection">Collection</label>
                  </div>
                </td>
                {% if show_owner_field %}
                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm mb-1"
                    name="owner-{{ folder.id }}"
                    value="{{ folder.owner or '' }}"
                    placeholder="Display owner"
                  >
                  {% if show_owner_controls %}
                  {% set owner_label = "No linked user" %}
                  {% if folder.owner_user_id %}
                    {% for user in users %}
                      {% if folder.owner_user_id == user.id %}
                        {% set owner_label = (user.username or user.email) ~ (' (admin)' if user.is_admin else '') %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  <div class="dropdown dv-select dv-select-sm bulk-select" data-dv-select="owner-user-{{ folder.id }}">
                    <input type="hidden" name="owner_user-{{ folder.id }}" data-dv-select-input value="{{ folder.owner_user_id or '' }}">
                    <button
                      class="btn dv-select-toggle btn-sm d-inline-flex align-items-center gap-2"
                      type="button"
                      id="ownerUserToggle-{{ folder.id }}"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      aria-label="Linked user">
                      <span data-dv-select-label>{{ owner_label }}</span>
                      <i class="bi bi-chevron-down"></i>
                    </button>
                    <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="ownerUserToggle-{{ folder.id }}">
                      <li>
                        <button class="dropdown-item {% if not folder.owner_user_id %}active{% endif %}"
                                type="button"
                                data-dv-select-option
                                data-value=""
                                data-label="No linked user">
                          No linked user
                        </button>
                      </li>
                      {% for user in users %}
                        {% set label = (user.username or user.email) ~ (' (admin)' if user.is_admin else '') %}
                        <li>
                          <button class="dropdown-item {% if folder.owner_user_id == user.id %}active{% endif %}"
                                  type="button"
                                  data-dv-select-option
                                  data-value="{{ user.id }}"
                                  data-label="{{ label }}">
                            {{ label }}
                          </button>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </td>
                {% endif %}
                <td class="text-center">
                  <div class="form-check form-switch d-inline-flex align-items-center gap-2 mb-0">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="proxy-{{ folder.id }}"
                      name="proxy-{{ folder.id }}"
                      value="1"
                      {% if folder.is_proxy %}checked{% endif %}
                    >
                    <label class="form-check-label small" for="proxy-{{ folder.id }}">Proxy</label>
                  </div>
                </td>
                <td>
                  <textarea
                    class="form-control form-control-sm"
                    name="notes-{{ folder.id }}"
                    id="notes-{{ folder.id }}"
                    rows="2"
                    placeholder="Add notes...">{{ folder.notes or '' }}</textarea>
                </td>
                {% if allow_delete %}
                <td class="text-center">
                  <button
                    type="submit"
                    class="btn btn-outline-danger btn-sm"
                    name="delete_folder_id"
                    value="{{ folder.id }}"
                    formnovalidate
                    data-confirm="Delete &ldquo;{{ folder.name|e }}&rdquo;? This removes the folder and its cards."
                    data-progress-label="Deleting...">
                    Delete
                  </button>
                </td>
                {% endif %}
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="{{ 4 + (1 if show_owner_field else 0) + (2 if allow_delete else 0) }}" class="text-muted">
                No folders found. Create folders via CSV import or within the app first.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-4">
      {% if back_url %}
      <a class="btn btn-outline-secondary" href="{{ back_url }}">Back</a>
      {% endif %}
      <div class="d-flex flex-wrap gap-2">
        {% if allow_delete %}
          <button
            type="button"
            class="btn btn-outline-secondary"
            id="bulkEditBtn"
            data-bs-toggle="modal"
            data-bs-target="#bulkEditModal"
            disabled>
            Bulk edit selected
          </button>
          {% if allow_share_controls %}
          <button
            type="button"
            class="btn btn-outline-primary"
            id="bulkShareBtn"
            data-bs-toggle="modal"
            data-bs-target="#bulkShareModal"
            disabled>
            Share selected
          </button>
          {% endif %}
          <button
            type="submit"
            class="btn btn-outline-danger"
            name="bulk_delete"
            value="1"
            formnovalidate
            onclick="return confirm('Delete selected folders? This removes the folders and their cards.');"
            data-progress-label="Deleting..."
          >
            Delete selected
          </button>
        {% endif %}
        <button type="submit" class="btn btn-primary" data-progress-label="Saving...">Save Changes</button>
      </div>
    </div>
  </form>
</div>

{% call wrap_modal() %}
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkEditLabel">Bulk edit folders</h5>
        {% if is_mobile %}{% include "components/modal_close_btn.html" %}{% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="bulkEditForm" data-ux-submit>
        <input type="hidden" name="bulk_action" value="bulk_edit">
        <input type="hidden" name="bulk_folder_ids" value="">
        <div class="modal-body">
          <div class="text-muted small mb-3">Apply the selected values to every checked folder.</div>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Category</label>
              <div class="dropdown dv-select bulk-select" data-dv-select="bulk-category">
                <input type="hidden" name="bulk_category" data-dv-select-input value="">
                <button
                  class="btn dv-select-toggle d-inline-flex align-items-center gap-2"
                  type="button"
                  id="bulkCategoryToggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
                  <span data-dv-select-label>No change</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="bulkCategoryToggle">
                  <li>
                    <button class="dropdown-item active" type="button" data-dv-select-option data-value="" data-label="No change">No change</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-dv-select-option data-value="{{ deck_category }}" data-label="Deck">Deck</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-dv-select-option data-value="{{ collection_category }}" data-label="Collection">Collection</button>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Proxy flag</label>
              <div class="dropdown dv-select bulk-select" data-dv-select="bulk-proxy">
                <input type="hidden" name="bulk_proxy" data-dv-select-input value="">
                <button
                  class="btn dv-select-toggle d-inline-flex align-items-center gap-2"
                  type="button"
                  id="bulkProxyToggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
                  <span data-dv-select-label>No change</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="bulkProxyToggle">
                  <li>
                    <button class="dropdown-item active" type="button" data-dv-select-option data-value="" data-label="No change">No change</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-dv-select-option data-value="proxy" data-label="Mark as proxy">Mark as proxy</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-dv-select-option data-value="owned" data-label="Mark as owned">Mark as owned</button>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check mt-4 pt-2">
                <input class="form-check-input" type="checkbox" id="bulkOwnerApply" name="bulk_owner_apply" value="1">
                <label class="form-check-label" for="bulkOwnerApply">Update owner</label>
              </div>
              <input type="text" class="form-control" name="bulk_owner_value" placeholder="Owner name" aria-describedby="bulkOwnerHelp">
              <div class="form-text" id="bulkOwnerHelp">Only applied when checked.</div>
            </div>
            <div class="col-12">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="bulkNotesApply" name="bulk_notes_apply" value="1">
                <label class="form-check-label" for="bulkNotesApply">Replace notes</label>
              </div>
              <textarea class="form-control" rows="3" name="bulk_notes_value" placeholder="New notes for selected folders"></textarea>
            </div>
          </div>
          <div class="alert alert-info small mt-3 d-flex justify-content-between align-items-center">
            <span>Selected folders: <strong data-bulk-count>0</strong></span>
            <span class="text-muted">Only chosen fields will be changed.</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" data-progress-label="Applying...">Apply changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endcall %}

{% if allow_share_controls %}
{% call wrap_modal() %}
<div class="modal fade" id="bulkShareModal" tabindex="-1" aria-labelledby="bulkShareLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkShareLabel">Share selected decks</h5>
        {% if is_mobile %}{% include "components/modal_close_btn.html" %}{% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="bulkShareForm" data-ux-submit>
        <input type="hidden" name="bulk_action" value="bulk_share">
        <input type="hidden" name="bulk_folder_ids" value="">
        <div class="modal-body">
          <div class="alert alert-info small d-flex justify-content-between align-items-center">
            <span>Selected folders: <strong data-share-count>0</strong></span>
            <span class="text-muted">Existing shares are skipped.</span>
          </div>
          <div class="mb-3">
            <label class="form-label" for="bulkShareIdentifier">Email or username</label>
            <input
              type="text"
              class="form-control"
              id="bulkShareIdentifier"
              name="bulk_share_identifier"
              placeholder="friend@example.com"
              required
            >
            <div class="form-text">The selected decks will be shared with this user.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" data-progress-label="Sharing...">Share decks</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endcall %}
{% endif %}
<script>
  (() => {
    const selectAll = document.getElementById("select-all-folders");
    const getCheckboxes = () => Array.from(document.querySelectorAll(".folder-select"));
    let bulkToggling = false;
    if (!selectAll) return;
    selectAll.addEventListener("change", () => {
      const boxes = getCheckboxes();
      bulkToggling = true;
      boxes.forEach((cb) => {
        cb.checked = selectAll.checked;
        // Fire change so downstream listeners (like bulk edit enablement) update immediately.
        cb.dispatchEvent(new Event("change", { bubbles: true }));
      });
      bulkToggling = false;
      selectAll.indeterminate = false;
      syncHeader();
    });
    const syncHeader = () => {
      if (bulkToggling) return;
      const boxes = getCheckboxes();
      const checkedCount = boxes.filter((cb) => cb.checked).length;
      const total = boxes.length;
      if (!total) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        return;
      }
      if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCount === total) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    };
    getCheckboxes().forEach((cb) => cb.addEventListener("change", syncHeader));
  })();

  (() => {
    const bulkBtn = document.getElementById("bulkEditBtn");
    const shareBtn = document.getElementById("bulkShareBtn");
    const modalEl = document.getElementById("bulkEditModal");
    const shareModalEl = document.getElementById("bulkShareModal");
    const bulkIdsInput = document.querySelector('#bulkEditForm input[name="bulk_folder_ids"]');
    const shareIdsInput = document.querySelector('#bulkShareForm input[name="bulk_folder_ids"]');
    const countEl = document.querySelector('[data-bulk-count]');
    const shareCountEl = document.querySelector('[data-share-count]');
    const checkboxes = Array.from(document.querySelectorAll(".folder-select"));
    const form = document.getElementById("bulkEditForm");
    const shareForm = document.getElementById("bulkShareForm");
    if (!checkboxes.length) return;

    const selectedIds = () => checkboxes.filter((cb) => cb.checked).map((cb) => cb.value);

    const updateButtons = () => {
      const hasSelection = selectedIds().length > 0;
      if (bulkBtn) bulkBtn.disabled = !hasSelection;
      if (shareBtn) shareBtn.disabled = !hasSelection;
    };

    checkboxes.forEach((cb) => cb.addEventListener("change", updateButtons));
    updateButtons();

    if (modalEl && form) {
      modalEl.addEventListener("show.bs.modal", () => {
        const ids = selectedIds();
        if (bulkIdsInput) bulkIdsInput.value = ids.join(",");
        if (countEl) countEl.textContent = ids.length;
      });

      form.addEventListener("submit", (evt) => {
        const ids = selectedIds();
        if (!ids.length) {
          evt.preventDefault();
          return;
        }
        if (bulkIdsInput) bulkIdsInput.value = ids.join(",");
        setTimeout(() => {
          window.location.href = window.location.href;
        }, 50);
      });
    }

    if (shareModalEl && shareForm) {
      shareModalEl.addEventListener("show.bs.modal", () => {
        const ids = selectedIds();
        if (shareIdsInput) shareIdsInput.value = ids.join(",");
        if (shareCountEl) shareCountEl.textContent = ids.length;
      });

      shareForm.addEventListener("submit", (evt) => {
        const ids = selectedIds();
        if (!ids.length) {
          evt.preventDefault();
          return;
        }
        if (shareIdsInput) shareIdsInput.value = ids.join(",");
      });
    }
  })();
</script>
{% endblock %}

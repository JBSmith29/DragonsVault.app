{% extends "base.html" %}
{% block content %}
<div class="container py-4" id="admin-dashboard">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1">Admin Dashboard</h1>
      <div class="text-muted small">Operate users, data pipelines, and cache health from one place.</div>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <form method="post" class="d-inline-flex" data-ux-submit>
        <input type="hidden" name="action" value="refresh_all">
        <button class="btn btn-outline-primary btn-sm" type="submit" data-progress-label="Refreshing...">
          Refresh All Data
        </button>
      </form>
      <div class="dropdown">
        <button
          class="btn btn-outline-secondary btn-sm dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          Users
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{{ url_for('views.manage_api_token') }}">User Settings</a></li>
          <li><a class="dropdown-item" href="{{ url_for('views.admin_manage_users') }}">User Manager</a></li>
          <li><a class="dropdown-item" href="{{ url_for('views.admin_data_operations') }}">Data Operations</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-danger" href="{{ url_for('views.logout') }}" data-hx-boost="false">
              Sign out
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <h5 class="card-title mb-0">Users &amp; Access</h5>
            <span class="badge text-bg-secondary">{{ user_stats.total }} users</span>
            <span class="badge text-bg-primary">{{ user_stats.admins }} admins</span>
          </div>
          <div class="text-muted small mb-3">Create, reset, or remove accounts.</div>
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-primary btn-sm" href="{{ url_for('views.admin_manage_users') }}">Open User Manager</a>
            <button
              class="btn btn-outline-secondary btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#adminCreateUser"
              aria-expanded="false"
              aria-controls="adminCreateUser"
            >
              Create User
            </button>
          </div>
          <div class="collapse mt-3" id="adminCreateUser">
            <form method="post" class="row g-2">
              <input type="hidden" name="action" value="create_user">
              <div class="col-12">
                <label class="form-label small text-muted" for="user_username">Username</label>
                <input type="text" class="form-control form-control-sm" id="user_username" name="user_username" required>
              </div>
              <div class="col-12">
                <label class="form-label small text-muted" for="user_email">Email</label>
                <input type="email" class="form-control form-control-sm" id="user_email" name="user_email" required>
              </div>
              <div class="col-12">
                <label class="form-label small text-muted" for="user_password">Password</label>
                <input type="password" class="form-control form-control-sm" id="user_password" name="user_password" required>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="user_is_admin" name="user_is_admin">
                  <label class="form-check-label" for="user_is_admin">
                    Administrator privileges
                  </label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Create User</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <h5 class="card-title mb-0">Requests Inbox</h5>
            <span class="badge text-bg-secondary">{{ request_counts.total }} total</span>
          </div>
          <div class="text-muted small mb-3">Bug &amp; feature requests waiting on triage.</div>
          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="badge text-bg-secondary">Not started: {{ request_counts.get('not_started', 0) }}</span>
            <span class="badge text-bg-warning-subtle text-warning">Working: {{ request_counts.get('working', 0) }}</span>
            <span class="badge text-bg-success-subtle text-success">Completed: {{ request_counts.get('completed', 0) }}</span>
          </div>
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('views.admin_requests') }}">Review Requests</a>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">Folder Categories</h5>
          <div class="text-muted small mb-3">Control which folders count as decks versus collection buckets.</div>
          <ul class="list-unstyled small mb-3">
            <li>Total folders: {{ folder_counts.total }}</li>
            <li>Decks: {{ folder_counts.deck }}</li>
            <li>Collection buckets: {{ folder_counts.collection }}</li>
          </ul>
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('views.admin_folder_categories') }}">Manage Folder Categories</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">Draconic Attunement</h5>
          <div class="small text-muted mb-3">Core roles and evergreen tags derived from the local Scryfall cache.</div>
          <div class="d-flex flex-wrap gap-2">
            <form method="post" class="d-inline" data-ux-submit>
              <input type="hidden" name="action" value="refresh_oracle_tags">
              <button class="btn btn-primary btn-sm" type="submit" data-progress-label="Refreshing...">Refresh Draconic Attunement</button>
            </form>
            <form method="post" class="d-inline" data-ux-submit>
              <input type="hidden" name="action" value="refresh_oracle_enrichment_full">
              <button class="btn btn-outline-secondary btn-sm" type="submit" data-progress-label="Rebuilding...">Full Oracle Rebuild</button>
            </form>
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('views.admin_oracle_tags') }}">View Draconic Attunement</a>
          </div>
          <div class="text-muted small mt-2">Requires the Scryfall default cards cache.</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">Data Operations</h5>
          <div class="small text-muted mb-3">Manage bulk datasets, symbols, and Commander Spellbook refreshes.</div>
          <ul class="list-unstyled small mb-3">
            <li>
              Default cards:
              <span class="badge text-bg-{{ 'success' if prints.exists else 'danger' }}">{{ 'Loaded' if prints.exists else 'Missing' }}</span>
              {% if prints.exists %}
                <span class="badge text-bg-{{ 'warning' if prints.stale else 'secondary' }}">{{ 'Stale' if prints.stale else 'Fresh' }}</span>
              {% endif %}
            </li>
            <li>
              Rulings:
              <span class="badge text-bg-{{ 'success' if rulings.exists else 'danger' }}">{{ 'Present' if rulings.exists else 'Missing' }}</span>
            </li>
            <li>
              Commander Spellbook:
              <span class="badge text-bg-{{ 'success' if spellbook.exists else 'danger' }}">{{ 'Present' if spellbook.exists else 'Missing' }}</span>
            </li>
            <li>
              Symbols:
              {% if symbols_enabled %}
                <span class="badge text-bg-{{ 'success' if symbols.exists else 'danger' }}">{{ 'Present' if symbols.exists else 'Missing' }}</span>
              {% else %}
                <span class="badge text-bg-warning-subtle text-warning">Unavailable</span>
              {% endif %}
            </li>
            <li>
              EDHREC Synergy Cache:
              {% if edhrec.enabled and not edhrec.error %}
                <span class="badge text-bg-success">Online</span>
                <span class="text-muted">(cmdr: {{ edhrec.commanders.count or 0 }}, tags: {{ edhrec.themes.count or 0 }})</span>
              {% else %}
                <span class="badge text-bg-warning-subtle text-warning">Unavailable</span>
              {% endif %}
            </li>
          </ul>
          <a class="btn btn-primary btn-sm" href="{{ url_for('views.admin_data_operations') }}">Open Data Operations</a>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1">Data Operations</h1>
      <div class="text-muted small">Maintenance tools and system confidence checks.</div>
    </div>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.admin_console') }}">Back to Admin</a>
  </div>

  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">System Health</h2>
      <span class="text-muted small">Read-only status indicators.</span>
    </div>
    <div class="row g-3">
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="text-muted small">Database</div>
              <span class="badge text-bg-{{ system_health.database.tone }}">{{ system_health.database.label }}</span>
            </div>
            <div class="fs-6 fw-semibold">Connection status</div>
            <div class="text-muted small">{{ system_health.database.label }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-muted small mb-2">Card Count</div>
            <div class="fs-4 fw-semibold">{{ '{:,}'.format(system_health.card_count or 0) }}</div>
            <div class="text-muted small">Cards tracked in the collection.</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-muted small mb-2">Deck Count</div>
            <div class="fs-4 fw-semibold">{{ '{:,}'.format(system_health.deck_count or 0) }}</div>
            <div class="text-muted small">Deck folders currently available.</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-muted small mb-2">Last Import Time</div>
            <div class="fs-6 fw-semibold">{{ system_health.last_import }}</div>
            <div class="text-muted small">Latest bulk data refresh timestamp.</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="text-muted small">Tag Vocabulary</div>
              <span class="badge text-bg-{{ 'success' if system_health.tag_count else 'warning' }}">
                {{ system_health.tag_status }}
              </span>
            </div>
            <div class="fs-6 fw-semibold">{{ system_health.tag_count }} tags</div>
            <div class="text-muted small">Canonical deck tags available.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">Data Operations</h2>
      <span class="text-muted small">Actions that change cached or derived data.</span>
    </div>
    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">Import Cards</h5>
              <span class="badge text-bg-danger">High impact</span>
            </div>
            <div class="small text-muted mb-3">
              Downloads the latest Scryfall bulk file to refresh card data and commander lookups.
            </div>
            <form method="post" action="{{ url_for('views.admin_console') }}"
                  data-job-trigger data-job-scope="scryfall" data-job-dataset="default_cards">
              <input type="hidden" name="action" value="refresh_default_cards">
              <input type="hidden" name="redirect_to" value="views.admin_data_operations">
              <button class="btn btn-primary btn-sm" type="submit"
                      data-confirm="Download the latest bulk card file? This may take a few minutes."
                      data-progress-label="Downloading...">
                Download Latest Bulk File
              </button>
            </form>
            <div class="border rounded-3 bg-body-tertiary-subtle p-3 job-monitor mt-3"
                 data-job-monitor
                 data-job-scope="scryfall"
                 data-job-dataset="default_cards"
                 data-job-label="Card import">
              <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                <div>
                  <p class="fw-semibold mb-1 job-monitor__status" data-job-status>No refresh in progress.</p>
                  <p class="text-muted small mb-0 job-monitor__detail" data-job-detail>
                    Start the import to see live status updates.
                  </p>
                </div>
                <span class="badge text-bg-secondary job-monitor__badge" data-job-badge>Idle</span>
              </div>
              <div class="mt-3 d-none" data-job-progress>
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <span class="small text-muted" data-job-progress-text>Working</span>
                  <span class="small fw-semibold" data-job-progress-label>0%</span>
                </div>
                <div class="progress progress-striped" role="progressbar" aria-label="Card import progress" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" data-job-progress-bar style="width: 0%;" aria-valuenow="0"></div>
                </div>
              </div>
              <ul class="list-unstyled small text-muted mb-0 mt-3 job-monitor__log" data-job-log></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">Update EDHREC Cache</h5>
              <span class="badge text-bg-warning">Medium impact</span>
            </div>
            <div class="small text-muted mb-2">
              Refreshes EDHREC-derived tag and synergy data used for recommendations.
            </div>
            <div class="small text-muted mb-3">
              Delta refresh updates current decks plus top 500 commanders (top 5 tags each); full refresh re-pulls everything.
            </div>
            {% if edhrec.enabled and not edhrec.error %}
              <div class="small text-muted mb-3">
                Cached: {{ edhrec.commanders.count or 0 }} commanders &middot; {{ edhrec.themes.count or 0 }} tags
                {% if edhrec.metadata.last_updated %}
                  <br>Last updated: {{ edhrec.metadata.last_updated }}
                {% endif %}
                {% if edhrec.metadata.source_version %}
                  <br>Source version: {{ edhrec.metadata.source_version }}
                {% endif %}
              </div>
              <div class="d-flex flex-wrap gap-2">
                <form method="post" action="{{ url_for('views.admin_console') }}"
                      data-job-trigger data-job-scope="edhrec" data-job-dataset="synergy">
                  <input type="hidden" name="action" value="refresh_edhrec">
                  <input type="hidden" name="refresh_scope" value="delta">
                  <input type="hidden" name="redirect_to" value="views.admin_data_operations">
                  <button class="btn btn-primary btn-sm" type="submit"
                          data-confirm="Refresh EDHREC cache for current decks and top commanders?"
                          data-progress-label="Refreshing...">
                    Delta Refresh
                  </button>
                </form>
                <form method="post" action="{{ url_for('views.admin_console') }}"
                      data-job-trigger data-job-scope="edhrec" data-job-dataset="synergy">
                  <input type="hidden" name="action" value="refresh_edhrec">
                  <input type="hidden" name="refresh_scope" value="missing">
                  <input type="hidden" name="redirect_to" value="views.admin_data_operations">
                  <button class="btn btn-outline-secondary btn-sm" type="submit"
                          data-confirm="Retry only the commanders that failed previously?"
                          data-progress-label="Retrying...">
                    Retry Missing Commanders
                  </button>
                </form>
                <form method="post" action="{{ url_for('views.admin_console') }}"
                      data-job-trigger data-job-scope="edhrec" data-job-dataset="synergy">
                  <input type="hidden" name="action" value="refresh_edhrec">
                  <input type="hidden" name="refresh_scope" value="full">
                  <input type="hidden" name="force_refresh" value="1">
                  <input type="hidden" name="redirect_to" value="views.admin_data_operations">
                  <button class="btn btn-outline-primary btn-sm" type="submit"
                          data-confirm="Run a full EDHREC refresh? This can take a while."
                          data-progress-label="Refreshing...">
                    Full Refresh
                  </button>
                </form>
              </div>
            {% else %}
              <div class="alert alert-warning small mb-3">
                {{ edhrec.error or 'EDHREC service is unavailable.' }}
              </div>
            {% endif %}
            <div class="border rounded-3 bg-body-tertiary-subtle p-3 job-monitor mt-3"
                 data-job-monitor
                 data-job-scope="edhrec"
                 data-job-dataset="synergy"
                 data-job-label="EDHREC cache">
              <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                <div>
                  <p class="fw-semibold mb-1 job-monitor__status" data-job-status>No refresh in progress.</p>
                  <p class="text-muted small mb-0 job-monitor__detail" data-job-detail>
                    Start a refresh to see the latest EDHREC status.
                  </p>
                </div>
                <span class="badge text-bg-secondary job-monitor__badge" data-job-badge>Idle</span>
              </div>
              <div class="mt-3 d-none" data-job-progress>
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <span class="small text-muted" data-job-progress-text>Working</span>
                  <span class="small fw-semibold" data-job-progress-label>0%</span>
                </div>
                <div class="progress progress-striped" role="progressbar" aria-label="EDHREC progress" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" data-job-progress-bar style="width: 0%;" aria-valuenow="0"></div>
                </div>
              </div>
              <ul class="list-unstyled small text-muted mb-0 mt-3 job-monitor__log" data-job-log></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">Recompute Deck Stats</h5>
              <span class="badge text-bg-warning">Medium impact</span>
            </div>
            <div class="small text-muted mb-3">
              Recalculates mana curves and deck analytics to match the current card lists.
            </div>
            <form method="post" action="{{ url_for('views.admin_console') }}"
                  data-job-trigger data-job-scope="deck_stats" data-job-dataset="recompute">
              <input type="hidden" name="action" value="recompute_deck_stats">
              <input type="hidden" name="redirect_to" value="views.admin_data_operations">
              <button class="btn btn-primary btn-sm" type="submit"
                      data-confirm="Recompute deck stats for all decks?"
                      data-progress-label="Recomputing...">
                Recompute Deck Stats
              </button>
            </form>
            <div class="border rounded-3 bg-body-tertiary-subtle p-3 job-monitor mt-3"
                 data-job-monitor
                 data-job-scope="deck_stats"
                 data-job-dataset="recompute"
                 data-job-label="Deck stats">
              <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                <div>
                  <p class="fw-semibold mb-1 job-monitor__status" data-job-status>No refresh in progress.</p>
                  <p class="text-muted small mb-0 job-monitor__detail" data-job-detail>
                    Recompute to refresh deck analytics.
                  </p>
                </div>
                <span class="badge text-bg-secondary job-monitor__badge" data-job-badge>Idle</span>
              </div>
              <div class="mt-3 d-none" data-job-progress>
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <span class="small text-muted" data-job-progress-text>Working</span>
                  <span class="small fw-semibold" data-job-progress-label>0%</span>
                </div>
                <div class="progress progress-striped" role="progressbar" aria-label="Deck stats progress" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" data-job-progress-bar style="width: 0%;" aria-valuenow="0"></div>
                </div>
              </div>
              <ul class="list-unstyled small text-muted mb-0 mt-3 job-monitor__log" data-job-log></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">Rebuild Search Index</h5>
              <span class="badge text-bg-secondary">Low impact</span>
            </div>
            <div class="small text-muted mb-3">
              Rebuilds the internal search index used by filters and quick search.
            </div>
            <form method="post" action="{{ url_for('views.admin_console') }}"
                  data-job-trigger data-job-scope="search_index" data-job-dataset="cards">
              <input type="hidden" name="action" value="rebuild_search_index">
              <input type="hidden" name="redirect_to" value="views.admin_data_operations">
              <button class="btn btn-primary btn-sm" type="submit"
                      data-confirm="Rebuild the search index now?"
                      data-progress-label="Rebuilding...">
                Rebuild Search Index
              </button>
            </form>
            <div class="border rounded-3 bg-body-tertiary-subtle p-3 job-monitor mt-3"
                 data-job-monitor
                 data-job-scope="search_index"
                 data-job-dataset="cards"
                 data-job-label="Search index">
              <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                <div>
                  <p class="fw-semibold mb-1 job-monitor__status" data-job-status>No refresh in progress.</p>
                  <p class="text-muted small mb-0 job-monitor__detail" data-job-detail>
                    Rebuild the index if searches feel stale.
                  </p>
                </div>
                <span class="badge text-bg-secondary job-monitor__badge" data-job-badge>Idle</span>
              </div>
              <div class="mt-3 d-none" data-job-progress>
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <span class="small text-muted" data-job-progress-text>Working</span>
                  <span class="small fw-semibold" data-job-progress-label>0%</span>
                </div>
                <div class="progress progress-striped" role="progressbar" aria-label="Search index progress" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" data-job-progress-bar style="width: 0%;" aria-valuenow="0"></div>
                </div>
              </div>
              <ul class="list-unstyled small text-muted mb-0 mt-3 job-monitor__log" data-job-log></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div>
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">Diagnostics &amp; Maintenance</h2>
      <span class="text-muted small">Read-only checks and advisory tools.</span>
    </div>
    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Validate Database</h5>
            <div class="small text-muted mb-3">Runs a quick integrity check to confirm the database is healthy.</div>
            <form method="post" action="{{ url_for('views.admin_console') }}" data-ux-submit>
              <input type="hidden" name="action" value="validate_database">
              <input type="hidden" name="redirect_to" value="views.admin_data_operations">
              <button class="btn btn-outline-secondary btn-sm" type="submit" data-progress-label="Checking...">
                Run Check
              </button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Check Orphaned Decks</h5>
            <div class="small text-muted mb-3">Finds deck folders with no cards attached.</div>
            <form method="post" action="{{ url_for('views.admin_console') }}" data-ux-submit>
              <input type="hidden" name="action" value="check_orphaned_decks">
              <input type="hidden" name="redirect_to" value="views.admin_data_operations">
              <button class="btn btn-outline-secondary btn-sm" type="submit" data-progress-label="Checking...">
                Run Check
              </button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Verify Tag Integrity</h5>
            <div class="small text-muted mb-3">Confirms deck tags match the current vocabulary.</div>
            <form method="post" action="{{ url_for('views.admin_console') }}" data-ux-submit>
              <input type="hidden" name="action" value="verify_tag_integrity">
              <input type="hidden" name="redirect_to" value="views.admin_data_operations">
              <button class="btn btn-outline-secondary btn-sm" type="submit" data-progress-label="Checking...">
                Run Check
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

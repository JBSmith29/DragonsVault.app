{% extends "base.html" %}

{% block title %}Build Session{% endblock %}

{% block content %}
<div class="page-section build-session container-fluid">
  <!-- Align header structure and spacing with folder_detail for consistent hierarchy. -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-0">Build Session</h1>
      <p class="text-muted mb-0">Proxy-only workspace for {{ build_session.build_name or commander.name }}</p>
    </div>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('views.build_landing') }}">Back to Build-A-Deck</a>
  </div>

  <!-- Mirror folder_detail summary-row grid so stats always sit in three columns. -->
  <style>
    .build-session .summary-row{ --gap: 1rem; display:grid; gap:var(--gap); grid-template-columns: 1fr; }
    @media (min-width:992px){ .build-session .summary-row{ grid-template-columns: repeat(3, 1fr); } }
    .build-session .summary-row > div{ min-width:0; }
    /* Align build summary row with folder_detail commander-meta-secondary layout. */
    .build-session .commander-meta-secondary{ flex:1 1 auto; display:flex; flex-wrap:wrap; gap:1.25rem; align-items:flex-start; }
    .build-session .commander-meta-block{ flex:0 0 auto; min-width:0; display:flex; flex-direction:column; justify-content:space-between; }
    .build-session .commander-meta-divider{ flex:0 0 auto; width:1px; background:var(--bs-border-color); align-self:stretch; }
    .build-session .identity-body{ flex:1 1 auto; display:flex; flex-direction:column; gap:.75rem; align-items:center; text-align:center; }
    .build-session .identity-body.counts-body{ gap:.35rem; }
    .build-session .card-count-block{ flex:0 0 auto; text-align:center; align-items:center; min-width:0; }
    .build-session .card-count-block .counts-body{ gap:0; }
    .build-session .card-count-block .card-count-total{ font-size:clamp(1.8rem, 3vw, 2rem); line-height:1; }
  </style>

  <div class="row g-4">
    <div class="col-12">
      <!-- Match folder_detail commander-meta-secondary layout for summary alignment. -->
      <div class="build-summary-row commander-meta-secondary">
        <div class="commander-meta-block">
          <div class="text-uppercase text-muted small fw-semibold">Commander</div>
          <div class="build-commander d-flex align-items-start gap-3 mt-2">
            {% if commander.image %}
              <img src="{{ commander.image }}" class="build-commander-img" alt="{{ commander.name }}">
            {% endif %}
            <div>
              <div class="fw-semibold">{{ commander.name }}</div>
              {% if commander.colors is defined %}
                {% set colors = commander.colors %}
                {% include "includes/_color_identity.html" %}
              {% endif %}
            </div>
          </div>
          <span class="badge rounded-pill bg-info-subtle text-info-emphasis mt-2">Proxy</span>
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block">
          <!-- Use folder_detail label hierarchy for consistent emphasis. -->
          <div class="text-uppercase text-muted small fw-semibold">Build Name</div>
          <form method="post" action="{{ url_for('views.build_session_name', session_id=build_session.id) }}" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" class="form-control form-control-sm" name="build_name" value="{{ build_session.build_name or '' }}" placeholder="Name this build">
            <button class="btn btn-sm btn-outline-secondary mt-2 w-100" type="submit">Update Name</button>
          </form>
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block">
          <div class="text-uppercase text-muted small fw-semibold">Deck Tag</div>
          <form method="post" action="{{ url_for('views.build_session_tags', session_id=build_session.id) }}" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="dropdown dv-select w-100" data-dv-select="build-session-tag" data-dv-select-portal="body" data-auto-submit="true" data-bs-auto-close="outside">
              <input type="hidden" name="deck_tag" data-dv-select-input value="{{ tags[0] if tags else '' }}">
              <button class="btn dv-select-toggle dropdown-toggle w-100 justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span data-dv-select-label>{{ tags[0] if tags else "Select a Tag..." }}</span>
              </button>
              <ul class="dropdown-menu dv-select-menu">
                <li class="px-2 pb-2">
                  <input type="text" class="form-control form-control-sm dv-select-search" placeholder="Search tags..." autocomplete="off" data-dv-select-search>
                </li>
                <li>
                  <button class="dropdown-item{% if not tags %} active{% endif %}" type="button" data-dv-select-option data-value="" data-label="Select a Tag...">Select a Tag...</button>
                </li>
                {% for category, tag_list in tag_groups.items() %}
                  <li class="dropdown-header text-uppercase small text-muted" data-dv-select-category>{{ category }}</li>
                  {% for tag in tag_list %}
                    <li>
                      <button class="dropdown-item{% if tags and tags[0] == tag %} active{% endif %}" type="button" data-dv-select-option data-value="{{ tag }}" data-label="{{ tag }}">{{ tag }}</button>
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </form>
          {% if tags %}
            <div class="d-flex flex-wrap gap-1 mt-2">
              <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">{{ tags[0] }}</span>
            </div>
          {% else %}
            <p class="text-muted small mt-2 mb-0">No tag selected yet.</p>
          {% endif %}
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block card-count-block align-items-center">
          <div class="identity-body counts-body">
            <div class="text-uppercase text-muted small fw-semibold">Card Counts</div>
            <div class="fw-semibold card-count-total">{{ deck_metrics.total_cards }}</div>
            <div class="small text-muted">Lands {{ deck_metrics.land_count }}</div>
            <div class="small text-muted">Non-lands {{ deck_metrics.non_land_count }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm build-panel">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <div>
              <h5 class="card-title mb-1">Recommendations</h5>
              <p class="text-muted small mb-0">Cards are proxies until you commit the build.</p>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <form method="post" action="{{ url_for('views.build_session_edhrec', session_id=build_session.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if tags %}
                  <input type="hidden" name="deck_tag" value="{{ tags[0] }}">
                {% endif %}
                <button class="btn btn-sm btn-outline-primary" type="submit">Load EDHREC Data</button>
              </form>
              <form method="get" action="{{ url_for('views.build_session', session_id=build_session.id) }}">
                <div class="dropdown dv-select" data-dv-select="build-sort" data-dv-select-portal="body" data-auto-submit="true" data-bs-auto-close="outside">
                  <input type="hidden" name="sort" data-dv-select-input value="{{ sort_mode }}">
                  <button class="btn dv-select-toggle dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span data-dv-select-label>
                      {% if sort_mode == 'role' %}Role Fit{% elif sort_mode == 'need' %}Deck Needs{% else %}Synergy{% endif %}
                    </span>
                  </button>
                  <ul class="dropdown-menu dv-select-menu">
                    <li><button class="dropdown-item{% if sort_mode == 'synergy' %} active{% endif %}" type="button" data-dv-select-option data-value="synergy" data-label="Synergy">Synergy</button></li>
                    <li><button class="dropdown-item{% if sort_mode == 'role' %} active{% endif %}" type="button" data-dv-select-option data-value="role" data-label="Role Fit">Role Fit</button></li>
                    <li><button class="dropdown-item{% if sort_mode == 'need' %} active{% endif %}" type="button" data-dv-select-option data-value="need" data-label="Deck Needs">Deck Needs</button></li>
                  </ul>
                </div>
              </form>
            </div>
          </div>

          {% if recommendations %}
            <div class="build-rec-list">
              {% for section in recommendations %}
                <details class="build-rec-section"{% if section.default_open %} open{% endif %}>
                  <summary class="build-rec-summary">
                    <span class="fw-semibold">{{ section.label }}</span>
                    <span class="text-muted small">{{ section.count }} cards</span>
                  </summary>
                  <p class="text-muted small mb-3">{{ section.description }}</p>
                  {% set section_key = (section.label or '')|lower %}
                  {% if section_key in ['high synergy cards', 'top cards'] %}
                    <form method="post"
                          action="{{ url_for('views.build_session_add_bulk', session_id=build_session.id) }}"
                          class="d-flex justify-content-start mb-3">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% for rec in section.cards %}
                        <input type="hidden" name="card_oracle_id" value="{{ rec.oracle_id }}">
                      {% endfor %}
                      <button class="btn btn-sm btn-outline-primary" type="submit">Add All</button>
                    </form>
                  {% endif %}
                  <div class="row g-3">
                    {% for rec in section.cards %}
                      <div class="col-6 col-md-4 col-xxl-3">
                        <div class="card h-100 build-rec-card">
                          <span class="build-proxy-badge">proxy</span>
                          {% if rec.image %}
                            <img src="{{ rec.image }}" class="card-img-top build-card-img" alt="{{ rec.name }}">
                          {% endif %}
                          <div class="card-body">
                            <div class="build-rec-title">{{ rec.name }}</div>
                            {% if rec.synergy_percent is not none %}
                              <div class="text-muted small">Synergy {{ rec.synergy_percent }}%</div>
                            {% endif %}
                            {% if rec.reasons %}
                              <div class="d-flex flex-wrap gap-1 mt-2">
                                {% for reason in rec.reasons %}
                                  <span class="badge rounded-pill bg-info-subtle text-info-emphasis">{{ reason }}</span>
                                {% endfor %}
                              </div>
                            {% endif %}
                            <form method="post" action="{{ url_for('views.build_session_add', session_id=build_session.id) }}" class="mt-3">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <input type="hidden" name="card_oracle_id" value="{{ rec.oracle_id }}">
                              <button class="btn btn-sm btn-outline-primary w-100" type="submit">Add to Build</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </details>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mb-0">No recommendations available yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12">
      <!-- Mirror folder_detail stats row structure for consistent scan patterns. -->
      <div class="summary-row mb-3">
        <div>
          {% if deck_type_breakdown and deck_type_breakdown|length %}
            <div class="section-title">Type Breakdown</div>
            <div class="d-flex flex-wrap justify-content-center gap-2 type-pill-group">
              {% for t, n in deck_type_breakdown %}
                <button type="button"
                        class="pill type-pill"
                        data-type="{{ t|lower }}"
                        data-type-label="{{ t }}"
                        aria-pressed="false">
                  {{ t }} <span class="ms-1 badge text-bg-light">{{ n }}</span>
                </button>
              {% endfor %}
            </div>
            <div id="typeFilterHint" class="small text-muted text-center mt-2 d-none">
              Filtering by <strong data-type-name></strong>.
              <button type="button" class="btn btn-link btn-sm p-0 ms-1" id="typeFilterClear">Clear</button>
            </div>
          {% endif %}
        </div>

        <div class="summary-center">
          {% if mana_pip_dist and mana_pip_dist|length %}
            <div class="section-title">Color Distribution (from mana costs)</div>
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
              {% for c, pip, n in mana_pip_dist %}
                <span class="pill d-inline-flex align-items-center">
                  {% if pip %}<img src="{{ pip }}" alt="{{ c }}" style="height:1.1em;" class="me-1">{% else %}<span class="me-1">{{ c }}</span>{% endif %}
                  <span class="fw-semibold">{{ n }}</span>
                </span>
              {% endfor %}
            </div>
          {% endif %}

          {% if land_mana_sources and land_mana_sources|length %}
            <div class="section-title">Mana Sources</div>
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
              {% for c, pip, n in land_mana_sources %}
                <span class="pill d-inline-flex align-items-center">
                  {% if pip %}
                    <img src="{{ pip }}" alt="{{ c }}" style="height:1.1em;" class="me-1">
                  {% elif c in ['C', 'Colorless'] %}
                    <img src="{{ url_for('static', filename='symbols/C.svg') }}" alt="C" style="height:1.1em;" class="me-1">
                  {% else %}
                    <span class="me-1">{{ c }}</span>
                  {% endif %}
                  <span class="fw-semibold">{{ n }}</span>
                </span>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <div>
          {% if deck_metrics.curve_rows and deck_metrics.curve_rows|length %}
            <div class="section-title">Mana Curve</div>
            <div class="curve-grid">
              {% for row in deck_metrics.curve_rows %}
                <div class="curve-col" title="{{ row.count }} cards at {{ row.label }} CMC">
                  <button type="button"
                          class="curve-bar-btn"
                          data-cmc-bucket="{{ row.label }}"
                          data-cmc-label="{{ row.label }}"
                          aria-pressed="false">
                    <div class="curve-bar">
                      <div class="fill" style="height: {{ row.pct }}%;"></div>
                      <div class="curve-count">{{ row.count }}</div>
                    </div>
                    <div class="curve-label">{{ row.label }}</div>
                  </button>
                </div>
              {% endfor %}
            </div>
            <div id="cmcFilterHint" class="small text-muted text-center mt-2 d-none">
              Filtering by CMC <strong data-cmc-label></strong>.
              <button type="button" class="btn btn-link btn-sm p-0 ms-1" id="cmcFilterClear">Clear</button>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 shadow-sm build-panel">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="card-title mb-0">Current Build</h5>
            <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">Proxy</span>
          </div>
          {% if session_cards %}
            <div class="table-responsive">
              <table class="table cards-table align-middle">
                <thead>
                  <tr>
                    <th>Card</th>
                    <th class="text-center">Qty</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="buildSessionTable">
                  {% for card in session_cards %}
                    <tr class="build-row"
                        data-name="{{ card.name | e }}"
                        data-type="{{ card.type_line | lower }}"
                        data-cmc-bucket="{{ card.cmc_bucket }}">
                      <td>
                        <div class="d-flex align-items-center gap-2">
                          {% if card.image %}
                            <img src="{{ card.image }}" alt="{{ card.name }}" class="rounded" style="width: 44px;">
                          {% endif %}
                          <span>{{ card.name }}</span>
                        </div>
                      </td>
                      <td class="text-center">
                        <form method="post" action="{{ url_for('views.build_session_quantity', session_id=build_session.id) }}" class="d-inline-flex align-items-center gap-2">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                          <input type="number"
                                 name="quantity"
                                 class="form-control form-control-sm text-center"
                                 value="{{ card.quantity }}"
                                 min="1"
                                 step="1"
                                 style="width: 80px;">
                          <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                        </form>
                      </td>
                      <td class="text-end">
                        <form method="post" action="{{ url_for('views.build_session_remove', session_id=build_session.id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                          <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">No cards added yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<button class="btn btn-primary build-breakdown-fab"
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#buildTypeBreakdownModal">
  Type Breakdown
</button>

<div class="modal fade" id="buildTypeBreakdownModal" tabindex="-1" aria-labelledby="buildTypeBreakdownLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="buildTypeBreakdownLabel">Deck Type Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="close"></button>
      </div>
      <div class="modal-body">
        {% set TYPE_COLOR_FALLBACKS = {
          'Artifact': '#94A3B8',
          'Battle': '#F97316',
          'Creature': '#198754',
          'Enchantment': '#8B5CF6',
          'Instant': '#0EA5E9',
          'Land': '#8B5E3C',
          'Planeswalker': '#EAB308',
          'Sorcery': '#EF4444'
        } %}
        <div class="row g-4">
          <div class="col-12 col-lg-6">
            <h6 class="text-uppercase text-muted fw-semibold small mb-2">Build Distribution</h6>
            <div class="card bg-body-secondary border-0">
              <div class="card-body">
                {% set total = deck_type_breakdown | sum(attribute=1) %}
                <div class="d-flex flex-column gap-2">
                  {% for t, n in deck_type_breakdown %}
                    {% set pct = ((n * 100) / total) | round(0, 'floor') if total else 0 %}
                    <div>
                      <div class="d-flex justify-content-between small">
                        <span>{{ t }}</span>
                        <span>{{ n }} ({{ pct }}%)</span>
                      </div>
                      <div class="progress" style="height:6px;">
                        <div class="progress-bar" style="width: {{ pct }}%; background-color: {{ TYPE_COLOR_FALLBACKS.get(t, '#0d6efd') }};"></div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                {% if not total %}
                  <div class="text-muted small mt-2">No cards in the build yet.</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <h6 class="text-uppercase text-muted fw-semibold small mb-2">EDHREC Distribution</h6>
            <div class="card bg-body-secondary border-0">
              <div class="card-body">
                {% set total = edhrec_type_breakdown | sum(attribute=1) %}
                <div class="d-flex flex-column gap-2">
                  {% for t, n in edhrec_type_breakdown %}
                    {% set pct = ((n * 100) / total) | round(0, 'floor') if total else 0 %}
                    <div>
                      <div class="d-flex justify-content-between small">
                        <span>{{ t }}</span>
                        <span>{{ n }} ({{ pct }}%)</span>
                      </div>
                      <div class="progress" style="height:6px;">
                        <div class="progress-bar" style="width: {{ pct }}%; background-color: {{ TYPE_COLOR_FALLBACKS.get(t, '#0d6efd') }};"></div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                {% if not total %}
                  <div class="text-muted small mt-2">EDHREC data not loaded yet.</div>
                {% elif tags %}
                  <div class="text-muted small mt-2">EDHREC snapshot for {{ tags[0] }}.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
<script>
(() => {
  const tableBody = document.getElementById('buildSessionTable');
  if (!tableBody) return;
  let rows = Array.from(tableBody.querySelectorAll('.build-row'));
  const typePills = Array.from(document.querySelectorAll('.type-pill'));
  const cmcButtons = Array.from(document.querySelectorAll('.curve-bar-btn'));
  const typeHint = document.getElementById('typeFilterHint');
  const typeHintLabel = typeHint ? typeHint.querySelector('[data-type-name]') : null;
  const typeClearBtn = document.getElementById('typeFilterClear');
  const cmcHint = document.getElementById('cmcFilterHint');
  const cmcHintLabel = cmcHint ? cmcHint.querySelector('[data-cmc-label]') : null;
  const cmcClearBtn = document.getElementById('cmcFilterClear');
  let activeType = '';
  let activeCmc = '';

  function updateTypeUI() {
    typePills.forEach(btn => {
      const value = (btn.dataset.type || '').toLowerCase();
      const isActive = activeType && activeType === value;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    if (typeHint) {
      const show = !!activeType;
      typeHint.classList.toggle('d-none', !show);
      if (show && typeHintLabel) {
        const pill = typePills.find(btn => (btn.dataset.type || '').toLowerCase() === activeType);
        typeHintLabel.textContent = pill ? (pill.dataset.typeLabel || pill.textContent || activeType) : activeType;
      }
    }
    applyFilters();
  }

  function updateCmcUI() {
    cmcButtons.forEach(btn => {
      const value = btn.dataset.cmcBucket || '';
      const isActive = activeCmc && activeCmc === value;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    if (cmcHint) {
      const show = !!activeCmc;
      cmcHint.classList.toggle('d-none', !show);
      if (show && cmcHintLabel) {
        const btn = cmcButtons.find(el => (el.dataset.cmcBucket || '') === activeCmc);
        cmcHintLabel.textContent = btn ? (btn.dataset.cmcLabel || btn.dataset.cmcBucket || activeCmc) : activeCmc;
      }
    }
    applyFilters();
  }

  function applyFilters() {
    rows = Array.from(tableBody.querySelectorAll('.build-row')).filter(r => r.isConnected);
    rows.forEach(row => {
      const types = (row.getAttribute('data-type') || '').toLowerCase();
      const cmcBucket = row.getAttribute('data-cmc-bucket') || '';
      const typeMatch = !activeType || types.includes(activeType);
      const cmcMatch = !activeCmc || cmcBucket === activeCmc;
      row.classList.toggle('d-none', !(typeMatch && cmcMatch));
    });
  }

  if (typePills.length) {
    typePills.forEach(btn => {
      btn.addEventListener('click', () => {
        const value = (btn.dataset.type || '').toLowerCase();
        activeType = activeType === value ? '' : value;
        updateTypeUI();
      });
    });
  }
  if (typeClearBtn) {
    typeClearBtn.addEventListener('click', () => {
      activeType = '';
      updateTypeUI();
    });
  }

  if (cmcButtons.length) {
    cmcButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const value = btn.dataset.cmcBucket || '';
        activeCmc = activeCmc === value ? '' : value;
        updateCmcUI();
      });
    });
  }
  if (cmcClearBtn) {
    cmcClearBtn.addEventListener('click', () => {
      activeCmc = '';
      updateCmcUI();
    });
  }

  applyFilters();
})();
</script>
{% endblock %}

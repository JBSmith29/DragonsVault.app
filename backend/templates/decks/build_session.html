{% extends "base.html" %}

{% block title %}Build Session{% endblock %}

{% block content %}
<div class="page-section build-session container-fluid">
  <!-- Align header structure and spacing with folder_detail for consistent hierarchy. -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-0">Build Session</h1>
      <p class="text-muted mb-0">Proxy-only workspace for {{ build_session.build_name or commander.name }}</p>
    </div>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('views.build_landing') }}">Back to Build-A-Deck</a>
  </div>

  <!-- Mirror folder_detail summary-row grid so stats always sit in three columns. -->
  <style>
    .build-session .summary-row{ --gap: 1rem; display:grid; gap:var(--gap); grid-template-columns: 1fr; }
    @media (min-width:992px){ .build-session .summary-row{ grid-template-columns: repeat(3, 1fr); } }
    .build-session .summary-row > div{ min-width:0; }
    /* Align build summary row with folder_detail commander-meta-secondary layout. */
    .build-session .commander-meta-secondary{ flex:1 1 auto; display:flex; flex-wrap:wrap; gap:1.25rem; align-items:flex-start; }
    .build-session .commander-meta-block{ flex:0 0 auto; min-width:0; display:flex; flex-direction:column; justify-content:space-between; }
    .build-session .commander-meta-divider{ flex:0 0 auto; width:1px; background:var(--bs-border-color); align-self:stretch; }
    .build-session .identity-body{ flex:1 1 auto; display:flex; flex-direction:column; gap:.75rem; align-items:center; text-align:center; }
    .build-session .identity-body.counts-body{ gap:.35rem; }
    .build-session .card-count-block{ flex:0 0 auto; text-align:center; align-items:center; min-width:0; }
    .build-session .card-count-block .counts-body{ gap:0; }
    .build-session .card-count-block .card-count-total{ font-size:clamp(1.8rem, 3vw, 2rem); line-height:1; }
    /* Keep recommendation source dropdowns and nav anchored without overlapping content. */
    .build-session .build-rec-source{ margin-bottom:1.25rem; }
    .build-nav-dropdown{ position:fixed; bottom:1.5rem; left:calc(var(--sidebar-w, 0px) + 1.5rem); z-index:1100; }
    @media (max-width: 991.98px){
      .build-nav-dropdown{ left:1rem; }
    }
    .build-nav-toggle{ min-width: 8.5rem; }
    .build-session .build-nav-modal .build-nav-links{ display:flex; flex-direction:column; gap:0.55rem; }
    .build-session .build-nav-link{ text-align:left; }
    .build-session .build-nav-link[data-level="2"]{ padding-left:1.15rem; font-size:0.85rem; }
    .build-session .build-nav-link[data-level="3"]{ padding-left:2rem; font-size:0.8rem; }
    .build-nav-menu{ max-height: 60vh; overflow-y: auto; }
  </style>

  <div class="row g-4">
    <div class="col-12">
      <!-- Match folder_detail commander-meta-secondary layout for summary alignment. -->
      <div class="build-summary-row commander-meta-secondary" id="buildCommander" data-nav-section data-nav-label="Commander" data-nav-level="1">
        <div class="commander-meta-block">
          <div class="text-uppercase text-muted small fw-semibold">Commander</div>
          <div class="build-commander d-flex align-items-start gap-3 mt-2">
            <div class="commander-portrait">
              <div class="commander-portrait-frame">
                {% if commander.image %}
                  <img src="{{ commander.image }}" class="build-commander-img" alt="{{ commander.name }}">
                {% else %}
                  <div class="commander-portrait-placeholder">
                    <div class="fw-semibold mb-1">{{ commander.name or 'Commander not set' }}</div>
                    <div class="small text-muted">No image available</div>
                  </div>
                {% endif %}
              </div>
            </div>
            <div>
              <div class="fw-semibold">{{ commander.name }}</div>
              {% if commander.colors is defined %}
                {% set colors = commander.colors %}
                {% include "includes/_color_identity.html" %}
              {% endif %}
            </div>
          </div>
          <span class="badge rounded-pill bg-info-subtle text-info-emphasis mt-2">Proxy</span>
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block">
          <!-- Use folder_detail label hierarchy for consistent emphasis. -->
          <div class="text-uppercase text-muted small fw-semibold">Build Name</div>
          <form method="post" action="{{ url_for('views.build_session_name', session_id=build_session.id) }}" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" class="form-control form-control-sm" name="build_name" value="{{ build_session.build_name or '' }}" placeholder="Name this build">
            <button class="btn btn-sm btn-outline-secondary mt-2 w-100" type="submit">Update Name</button>
          </form>
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block">
          <div class="text-uppercase text-muted small fw-semibold">Deck Tag</div>
          <form method="post" action="{{ url_for('views.build_session_tags', session_id=build_session.id) }}" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="dropdown dv-select w-100" data-dv-select="build-session-tag" data-dv-select-portal="body" data-auto-submit="true" data-bs-auto-close="outside">
              <input type="hidden" name="deck_tag" data-dv-select-input value="{{ tags[0] if tags else '' }}">
              <button class="btn dv-select-toggle dropdown-toggle w-100 justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span data-dv-select-label>{{ tags[0] if tags else "Select a Tag..." }}</span>
              </button>
              <ul class="dropdown-menu dv-select-menu">
                <li class="px-2 pb-2">
                  <input type="text" class="form-control form-control-sm dv-select-search" placeholder="Search tags..." autocomplete="off" data-dv-select-search>
                </li>
                <li>
                  <button class="dropdown-item{% if not tags %} active{% endif %}" type="button" data-dv-select-option data-value="" data-label="Select a Tag...">Select a Tag...</button>
                </li>
                {% for category, tag_list in tag_groups.items() %}
                  <li class="dropdown-header text-uppercase small text-muted" data-dv-select-category>{{ category }}</li>
                  {% for tag in tag_list %}
                    <li>
                      <button class="dropdown-item{% if tags and tags[0] == tag %} active{% endif %}" type="button" data-dv-select-option data-value="{{ tag }}" data-label="{{ tag }}">{{ tag }}</button>
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </form>
          {% if tags %}
            <div class="d-flex flex-wrap gap-1 mt-2">
              <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">{{ tags[0] }}</span>
            </div>
          {% else %}
            <p class="text-muted small mt-2 mb-0">No tag selected yet.</p>
          {% endif %}
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block card-count-block align-items-center">
          <div class="identity-body counts-body">
            <div class="text-uppercase text-muted small fw-semibold">Card Counts</div>
            <div class="fw-semibold card-count-total">{{ deck_metrics.total_cards }}</div>
            <div class="small text-muted">Lands {{ deck_metrics.land_count }}</div>
            <div class="small text-muted">Non-lands {{ deck_metrics.non_land_count }}</div>
          </div>
        </div>

        <div class="commander-meta-divider d-none d-lg-block"></div>

        <div class="commander-meta-block card-count-block align-items-center">
          <div class="identity-body counts-body">
            <div class="text-uppercase text-muted small fw-semibold">Bracket</div>
            {% if build_bracket and build_bracket.level %}
              <div class="d-flex align-items-center justify-content-center gap-2 mt-1">
                <span class="badge text-bg-primary">{{ build_bracket.level }}</span>
                {% if build_bracket.label %}
                  <span class="small text-muted">{{ build_bracket.label }}</span>
                {% endif %}
              </div>
              {% if build_bracket.score is not none %}
                <div class="small text-muted">Score {{ build_bracket.score }}</div>
              {% endif %}
            {% else %}
              <div class="small text-muted">—</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm build-panel" id="buildRecommendations" data-nav-section data-nav-label="Recommendations" data-nav-level="1">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <div>
              <h5 class="card-title mb-1">Recommendations</h5>
              <p class="text-muted small mb-0">Cards are proxies until you commit the build.</p>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <form method="post" action="{{ url_for('views.build_session_edhrec', session_id=build_session.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if tags %}
                  <input type="hidden" name="deck_tag" value="{{ tags[0] }}">
                {% endif %}
                <button class="btn btn-sm btn-outline-primary" type="submit">Load EDHREC Data</button>
              </form>
              <form method="get" action="{{ url_for('views.build_session', session_id=build_session.id) }}" class="d-flex flex-wrap align-items-center gap-2">
                <div class="dropdown dv-select" data-dv-select="build-rec-source" data-dv-select-portal="body" data-auto-submit="true" data-bs-auto-close="outside">
                  <input type="hidden" name="rec_source" data-dv-select-input value="{{ rec_source }}">
                  <button class="btn dv-select-toggle dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span data-dv-select-label>
                      {% if rec_source == 'collection' %}Collection{% else %}EDHRec{% endif %}
                    </span>
                  </button>
                  <ul class="dropdown-menu dv-select-menu">
                    <li><button class="dropdown-item{% if rec_source == 'edhrec' %} active{% endif %}" type="button" data-dv-select-option data-value="edhrec" data-label="EDHRec">EDHRec</button></li>
                    <li><button class="dropdown-item{% if rec_source == 'collection' %} active{% endif %}" type="button" data-dv-select-option data-value="collection" data-label="Collection">Collection</button></li>
                  </ul>
                </div>
                <div class="dropdown dv-select" data-dv-select="build-sort" data-dv-select-portal="body" data-auto-submit="true" data-bs-auto-close="outside">
                  <input type="hidden" name="sort" data-dv-select-input value="{{ sort_mode }}">
                  <button class="btn dv-select-toggle dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span data-dv-select-label>
                      {% if sort_mode == 'role' %}Role Fit{% elif sort_mode == 'need' %}Deck Needs{% else %}Synergy{% endif %}
                    </span>
                  </button>
                  <ul class="dropdown-menu dv-select-menu">
                    <li><button class="dropdown-item{% if sort_mode == 'synergy' %} active{% endif %}" type="button" data-dv-select-option data-value="synergy" data-label="Synergy">Synergy</button></li>
                    <li><button class="dropdown-item{% if sort_mode == 'role' %} active{% endif %}" type="button" data-dv-select-option data-value="role" data-label="Role Fit">Role Fit</button></li>
                    <li><button class="dropdown-item{% if sort_mode == 'need' %} active{% endif %}" type="button" data-dv-select-option data-value="need" data-label="Deck Needs">Deck Needs</button></li>
                  </ul>
                </div>
              </form>
            </div>
          </div>

          <div class="build-rec-list">
            {% set show_edhrec = rec_source != 'collection' %}
            {% set show_collection = rec_source == 'collection' %}
            <!-- edhrec dropdown keeps existing ordering and scoring. -->
            <details class="build-rec-section build-rec-source{% if not show_edhrec %} d-none{% endif %}"
                     id="buildEdhrecRecommendations"
                     {% if show_edhrec %}data-nav-section data-nav-label="EDHRec Recommendations" data-nav-level="1"{% endif %}
                     {% if show_edhrec %}open{% endif %}>
              <summary class="build-rec-summary">
                <span class="fw-semibold">EDHRec</span>
                <span class="text-muted small">Synergy-first</span>
              </summary>
              <p class="text-muted small mb-3">Cards you already own are tagged in the list.</p>
              {% if recommendations %}
                <div class="build-rec-list">
                  {% for section in recommendations %}
                    <details class="build-rec-section"
                             id="buildEdhrec-{{ section.key }}"
                             data-nav-section
                             data-nav-label="{{ section.label }}"
                             data-nav-level="2"
                             {% if section.default_open %} open{% endif %}>
                      <summary class="build-rec-summary">
                        <span class="fw-semibold">{{ section.label }}</span>
                        <span class="text-muted small">{{ section.count }} cards</span>
                      </summary>
                      <p class="text-muted small mb-3">{{ section.description }}</p>
                      {% set section_key = (section.label or '')|lower %}
                      {% if section_key in ['high synergy cards', 'top cards'] %}
                        <form method="post"
                              action="{{ url_for('views.build_session_add_bulk', session_id=build_session.id) }}"
                              class="d-flex justify-content-start mb-3">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          {% for rec in section.cards %}
                            <input type="hidden" name="card_oracle_id" value="{{ rec.oracle_id }}">
                          {% endfor %}
                          <button class="btn btn-sm btn-outline-primary" type="submit">Add All</button>
                        </form>
                      {% endif %}
                      <div class="row g-3">
                        {% for rec in section.cards %}
                          <div class="col-6 col-md-4 col-xxl-3">
                            <div class="card h-100 build-rec-card">
                              <span class="build-proxy-badge">proxy</span>
                              {% if rec.image %}
                                <img src="{{ rec.image }}" class="card-img-top build-card-img" alt="{{ rec.name }}">
                              {% endif %}
                              <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between gap-2">
                                  <div class="build-rec-title">{{ rec.name }}</div>
                                  {% if rec.in_collection %}
                                    <span class="badge rounded-pill bg-success-subtle text-success-emphasis text-nowrap">In Collection</span>
                                  {% endif %}
                                </div>
                                {% if rec.synergy_percent is not none %}
                                  <div class="text-muted small">Synergy {{ rec.synergy_percent }}%</div>
                                {% endif %}
                                {% if rec.reasons %}
                                  <div class="d-flex flex-wrap gap-1 mt-2">
                                    {% for reason in rec.reasons %}
                                      <span class="badge rounded-pill bg-info-subtle text-info-emphasis">{{ reason }}</span>
                                    {% endfor %}
                                  </div>
                                {% endif %}
                                <form method="post" action="{{ url_for('views.build_session_add', session_id=build_session.id) }}" class="mt-3">
                                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                  <input type="hidden" name="card_oracle_id" value="{{ rec.oracle_id }}">
                                  {% set add_locked = rec.in_build and not rec.is_basic_land %}
                                  <button class="btn btn-sm w-100 {% if add_locked %}btn-outline-secondary{% else %}btn-outline-primary{% endif %}"
                                          type="submit"
                                          {% if add_locked %}disabled{% endif %}>
                                    {% if add_locked %}In Build{% else %}Add to Build{% endif %}
                                  </button>
                                </form>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </details>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted mb-0">No EDHRec recommendations yet.</p>
              {% endif %}
            </details>

            <!-- collection dropdown shows owned cards grouped by type. -->
            <details class="build-rec-section build-rec-source{% if not show_collection %} d-none{% endif %}"
                     id="buildCollectionRecommendations"
                     {% if show_collection %}data-nav-section data-nav-label="Collection Recommendations" data-nav-level="1"{% endif %}
                     {% if show_collection %}open{% endif %}>
              <summary class="build-rec-summary">
                <span class="fw-semibold">Collection</span>
                <span class="text-muted small">Owned cards only</span>
              </summary>
              <p class="text-muted small mb-3">Cards are grouped by type and filtered to your commander.</p>
              {% if collection_sections %}
                <div class="build-rec-list">
                  {% for section in collection_sections %}
                    <details class="build-rec-section"
                             id="buildCollection-{{ section.key }}"
                             data-nav-section
                             data-nav-label="{{ section.label }}"
                             data-nav-level="2"
                             {% if section.default_open %} open{% endif %}>
                      <summary class="build-rec-summary">
                        <span class="fw-semibold">{{ section.label }}</span>
                        <span class="text-muted small">{{ section.count }} cards</span>
                      </summary>
                      <div class="row g-3 mt-1">
                        {% for rec in section.cards %}
                          <div class="col-6 col-md-4 col-xxl-3">
                            <div class="card h-100 build-rec-card">
                              <span class="build-proxy-badge">proxy</span>
                              {% if rec.image %}
                                <img src="{{ rec.image }}" class="card-img-top build-card-img" alt="{{ rec.name }}">
                              {% endif %}
                              <div class="card-body">
                                <div class="build-rec-title">{{ rec.name }}</div>
                                {% if rec.synergy_percent is not none %}
                                  <div class="text-muted small">EDHRec {{ rec.synergy_percent }}%</div>
                                {% endif %}
                                {% if rec.collection_score_percent is not none %}
                                  <div class="text-muted small">Fit {{ rec.collection_score_percent }}%</div>
                                {% endif %}
                                {% if rec.reasons %}
                                  <div class="d-flex flex-wrap gap-1 mt-2">
                                    {% for reason in rec.reasons %}
                                      <span class="badge rounded-pill bg-info-subtle text-info-emphasis">{{ reason }}</span>
                                    {% endfor %}
                                  </div>
                                {% endif %}
                                <form method="post" action="{{ url_for('views.build_session_add', session_id=build_session.id) }}" class="mt-3">
                                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                  <input type="hidden" name="card_oracle_id" value="{{ rec.oracle_id }}">
                                  {% set add_locked = rec.in_build and not rec.is_basic_land %}
                                  <button class="btn btn-sm w-100 {% if add_locked %}btn-outline-secondary{% else %}btn-outline-primary{% endif %}"
                                          type="submit"
                                          {% if add_locked %}disabled{% endif %}>
                                    {% if add_locked %}In Build{% else %}Add to Build{% endif %}
                                  </button>
                                </form>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </details>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted mb-0">No collection recommendations yet.</p>
              {% endif %}
            </details>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <!-- Mirror folder_detail stats row structure for consistent scan patterns. -->
      <div class="summary-row mb-3">
        <div>
          {% if deck_type_breakdown and deck_type_breakdown|length %}
            <div class="section-title">Type Breakdown</div>
            <div class="d-flex flex-wrap justify-content-center gap-2 type-pill-group">
              {% for t, n in deck_type_breakdown %}
                <button type="button"
                        class="pill type-pill"
                        data-type="{{ t|lower }}"
                        data-type-label="{{ t }}"
                        aria-pressed="false">
                  {{ t }} <span class="ms-1 badge text-bg-light">{{ n }}</span>
                </button>
              {% endfor %}
            </div>
            <div id="typeFilterHint" class="small text-muted text-center mt-2 d-none">
              Filtering by <strong data-type-name></strong>.
              <button type="button" class="btn btn-link btn-sm p-0 ms-1" id="typeFilterClear">Clear</button>
            </div>
          {% endif %}
        </div>

        <div class="summary-center">
          {% if mana_pip_dist and mana_pip_dist|length %}
            <div class="section-title">Color Distribution (from mana costs)</div>
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
              {% for c, pip, n in mana_pip_dist %}
                <span class="pill d-inline-flex align-items-center">
                  {% if pip %}<img src="{{ pip }}" alt="{{ c }}" style="height:1.1em;" class="me-1">{% else %}<span class="me-1">{{ c }}</span>{% endif %}
                  <span class="fw-semibold">{{ n }}</span>
                </span>
              {% endfor %}
            </div>
          {% endif %}

          {% if land_mana_sources and land_mana_sources|length %}
            <div class="section-title">Mana Sources</div>
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
              {% for c, pip, n in land_mana_sources %}
                <span class="pill d-inline-flex align-items-center">
                  {% if pip %}
                    <img src="{{ pip }}" alt="{{ c }}" style="height:1.1em;" class="me-1">
                  {% elif c in ['C', 'Colorless'] %}
                    <img src="{{ url_for('static', filename='symbols/C.svg') }}" alt="C" style="height:1.1em;" class="me-1">
                  {% else %}
                    <span class="me-1">{{ c }}</span>
                  {% endif %}
                  <span class="fw-semibold">{{ n }}</span>
                </span>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <div>
          {% if deck_metrics.curve_rows and deck_metrics.curve_rows|length %}
            <div class="section-title">Mana Curve</div>
            <div class="curve-grid">
              {% for row in deck_metrics.curve_rows %}
                <div class="curve-col" title="{{ row.count }} cards at {{ row.label }} CMC">
                  <button type="button"
                          class="curve-bar-btn"
                          data-cmc-bucket="{{ row.label }}"
                          data-cmc-label="{{ row.label }}"
                          aria-pressed="false">
                    <div class="curve-bar">
                      <div class="fill" style="height: {{ row.pct }}%;"></div>
                      <div class="curve-count">{{ row.count }}</div>
                    </div>
                    <div class="curve-label">{{ row.label }}</div>
                  </button>
                </div>
              {% endfor %}
            </div>
            <div id="cmcFilterHint" class="small text-muted text-center mt-2 d-none">
              Filtering by CMC <strong data-cmc-label></strong>.
              <button type="button" class="btn btn-link btn-sm p-0 ms-1" id="cmcFilterClear">Clear</button>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 shadow-sm build-panel" id="buildCurrent" data-nav-section data-nav-label="Current Build" data-nav-level="1">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <div class="d-flex align-items-center gap-2">
              <h5 class="card-title mb-0">Current Build</h5>
              <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">Proxy</span>
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="Current build view">
              <button type="button" class="btn btn-outline-secondary build-view-toggle" data-build-view-toggle data-view="list" aria-pressed="false">List</button>
              <button type="button" class="btn btn-outline-secondary build-view-toggle" data-build-view-toggle data-view="gallery" aria-pressed="false">Gallery</button>
              <button type="button" class="btn btn-outline-secondary build-view-toggle" data-build-view-toggle data-view="type" aria-pressed="false">Type</button>
            </div>
          </div>
          {% if session_cards %}
            <div class="build-view" data-build-view="list">
              <div class="table-responsive">
                <table class="table cards-table align-middle">
                  <thead>
                    <tr>
                      <th>Card</th>
                      <th class="text-center">Qty</th>
                      <th class="text-end">Cheapest</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="buildSessionTable">
                    {% for card in session_cards %}
                      <tr class="build-row"
                          data-name="{{ card.name | e }}"
                          data-type="{{ card.type_line | lower }}"
                          data-cmc-bucket="{{ card.cmc_bucket }}">
                        <td>
                          <div class="d-flex align-items-center gap-2">
                            {% if card.image %}
                              <img src="{{ card.image }}" alt="{{ card.name }}" class="rounded" style="width: 44px;">
                            {% endif %}
                            <span>{{ card.name }}</span>
                          </div>
                        </td>
                        <td class="text-center">
                          <form method="post" action="{{ url_for('views.build_session_quantity', session_id=build_session.id) }}" class="d-inline-flex align-items-center gap-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                            <input type="number"
                                   name="quantity"
                                   class="form-control form-control-sm text-center"
                                   value="{{ card.quantity }}"
                                   min="1"
                                   step="1"
                                   style="width: 80px;">
                            <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                          </form>
                        </td>
                        <td class="text-end small text-muted">{{ card.price_text or '—' }}</td>
                        <td class="text-end">
                          <form method="post" action="{{ url_for('views.build_session_remove', session_id=build_session.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                            <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="build-view d-none" data-build-view="gallery">
              <div class="row g-3">
                {% for card in session_cards %}
                  <div class="col-6 col-md-4 col-lg-3">
                    <div class="card h-100">
                      {% if card.image %}
                        <img src="{{ card.image }}" alt="{{ card.name }}" class="card-img-top">
                      {% endif %}
                      <div class="card-body d-flex flex-column gap-2">
                        <div class="fw-semibold">{{ card.name }}</div>
                        <div class="small text-muted">{{ card.price_text or '—' }}</div>
                        <form method="post" action="{{ url_for('views.build_session_quantity', session_id=build_session.id) }}" class="d-flex align-items-center gap-2">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                          <input type="number"
                                 name="quantity"
                                 class="form-control form-control-sm text-center"
                                 value="{{ card.quantity }}"
                                 min="1"
                                 step="1">
                          <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                        </form>
                      </div>
                      <div class="card-footer bg-transparent border-0 pt-0">
                        <form method="post" action="{{ url_for('views.build_session_remove', session_id=build_session.id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                          <button class="btn btn-sm btn-outline-danger w-100" type="submit">Remove</button>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="build-view d-none" data-build-view="type">
              {% for group in session_cards_by_type %}
                <div class="mb-4">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="mb-0">{{ group.label }}</h6>
                    <span class="text-muted small">{{ group.cards | length }} cards</span>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm cards-table align-middle">
                      <thead>
                        <tr>
                          <th>Card</th>
                          <th class="text-center">Qty</th>
                          <th class="text-end">Cheapest</th>
                          <th class="text-end">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for card in group.cards %}
                          <tr>
                            <td>
                              <div class="d-flex align-items-center gap-2">
                                {% if card.image %}
                                  <img src="{{ card.image }}" alt="{{ card.name }}" class="rounded" style="width: 36px;">
                                {% endif %}
                                <span>{{ card.name }}</span>
                              </div>
                            </td>
                            <td class="text-center">
                              <form method="post" action="{{ url_for('views.build_session_quantity', session_id=build_session.id) }}" class="d-inline-flex align-items-center gap-2">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                                <input type="number"
                                       name="quantity"
                                       class="form-control form-control-sm text-center"
                                       value="{{ card.quantity }}"
                                       min="1"
                                       step="1"
                                       style="width: 80px;">
                                <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                              </form>
                            </td>
                            <td class="text-end small text-muted">{{ card.price_text or '—' }}</td>
                            <td class="text-end">
                              <form method="post" action="{{ url_for('views.build_session_remove', session_id=build_session.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="card_oracle_id" value="{{ card.oracle_id }}">
                                <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                              </form>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mb-0">No cards added yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- floating toggle + dropdown jump list for quick section jumps. -->
<div class="dropdown dropup build-nav-dropdown">
  <button class="btn btn-sm btn-primary build-nav-toggle dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          data-bs-auto-close="true"
          aria-expanded="false">
    Jump to
  </button>
  <div class="dropdown-menu build-nav-menu p-2" data-build-nav-links></div>
</div>

<button class="btn btn-primary build-breakdown-fab"
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#buildTypeBreakdownModal">
  Type Breakdown
</button>

<div class="modal fade" id="buildTypeBreakdownModal" tabindex="-1" aria-labelledby="buildTypeBreakdownLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="buildTypeBreakdownLabel">Deck Type Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="close"></button>
      </div>
      <div class="modal-body">
        {% set TYPE_COLOR_FALLBACKS = {
          'Artifact': '#94A3B8',
          'Battle': '#F97316',
          'Creature': '#198754',
          'Enchantment': '#8B5CF6',
          'Instant': '#0EA5E9',
          'Land': '#8B5E3C',
          'Planeswalker': '#EAB308',
          'Sorcery': '#EF4444'
        } %}
        <div class="row g-4">
          <div class="col-12 col-lg-6">
            <h6 class="text-uppercase text-muted fw-semibold small mb-2">Build Distribution</h6>
            <div class="card bg-body-secondary border-0">
              <div class="card-body">
                {% set total = deck_type_distribution | sum(attribute=1) %}
                {% if total %}
                  <div class="d-flex flex-column gap-2">
                    {% for t, n in deck_type_distribution %}
                      {% set pct = ((n * 100) / total) | round(0, 'floor') if total else 0 %}
                      <div>
                        <div class="d-flex justify-content-between small">
                          <span>{{ t }}</span>
                          <span>{{ n }} ({{ pct }}%)</span>
                        </div>
                        <div class="progress" style="height:6px;">
                          <div class="progress-bar" style="width: {{ pct }}%; background-color: {{ TYPE_COLOR_FALLBACKS.get(t, '#0d6efd') }};"></div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
                {% if not total %}
                  <div class="text-muted small mt-2">No cards in the build yet.</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <h6 class="text-uppercase text-muted fw-semibold small mb-2">EDHREC Distribution</h6>
            <div class="card bg-body-secondary border-0">
              <div class="card-body">
                {% set total = edhrec_type_distribution | sum(attribute=1) %}
                {% if total %}
                  <div class="d-flex flex-column gap-2">
                    {% for t, n in edhrec_type_distribution %}
                      {% set pct = ((n * 100) / total) | round(0, 'floor') if total else 0 %}
                      <div>
                        <div class="d-flex justify-content-between small">
                          <span>{{ t }}</span>
                          <span>{{ n }} ({{ pct }}%)</span>
                        </div>
                        <div class="progress" style="height:6px;">
                          <div class="progress-bar" style="width: {{ pct }}%; background-color: {{ TYPE_COLOR_FALLBACKS.get(t, '#0d6efd') }};"></div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
                {% if not total %}
                  <div class="text-muted small mt-2">EDHREC data not loaded yet.</div>
                {% elif tags %}
                  <div class="text-muted small mt-2">EDHREC snapshot for {{ tags[0] }}.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
<script>
(() => {
  const tableBody = document.getElementById('buildSessionTable');
  if (!tableBody) return;
  let rows = Array.from(tableBody.querySelectorAll('.build-row'));
  const typePills = Array.from(document.querySelectorAll('.type-pill'));
  const cmcButtons = Array.from(document.querySelectorAll('.curve-bar-btn'));
  const typeHint = document.getElementById('typeFilterHint');
  const typeHintLabel = typeHint ? typeHint.querySelector('[data-type-name]') : null;
  const typeClearBtn = document.getElementById('typeFilterClear');
  const cmcHint = document.getElementById('cmcFilterHint');
  const cmcHintLabel = cmcHint ? cmcHint.querySelector('[data-cmc-label]') : null;
  const cmcClearBtn = document.getElementById('cmcFilterClear');
  let activeType = '';
  let activeCmc = '';

  function updateTypeUI() {
    typePills.forEach(btn => {
      const value = (btn.dataset.type || '').toLowerCase();
      const isActive = activeType && activeType === value;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    if (typeHint) {
      const show = !!activeType;
      typeHint.classList.toggle('d-none', !show);
      if (show && typeHintLabel) {
        const pill = typePills.find(btn => (btn.dataset.type || '').toLowerCase() === activeType);
        typeHintLabel.textContent = pill ? (pill.dataset.typeLabel || pill.textContent || activeType) : activeType;
      }
    }
    applyFilters();
  }

  function updateCmcUI() {
    cmcButtons.forEach(btn => {
      const value = btn.dataset.cmcBucket || '';
      const isActive = activeCmc && activeCmc === value;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    if (cmcHint) {
      const show = !!activeCmc;
      cmcHint.classList.toggle('d-none', !show);
      if (show && cmcHintLabel) {
        const btn = cmcButtons.find(el => (el.dataset.cmcBucket || '') === activeCmc);
        cmcHintLabel.textContent = btn ? (btn.dataset.cmcLabel || btn.dataset.cmcBucket || activeCmc) : activeCmc;
      }
    }
    applyFilters();
  }

  function applyFilters() {
    rows = Array.from(tableBody.querySelectorAll('.build-row')).filter(r => r.isConnected);
    rows.forEach(row => {
      const types = (row.getAttribute('data-type') || '').toLowerCase();
      const cmcBucket = row.getAttribute('data-cmc-bucket') || '';
      const typeMatch = !activeType || types.includes(activeType);
      const cmcMatch = !activeCmc || cmcBucket === activeCmc;
      row.classList.toggle('d-none', !(typeMatch && cmcMatch));
    });
  }

  if (typePills.length) {
    typePills.forEach(btn => {
      btn.addEventListener('click', () => {
        const value = (btn.dataset.type || '').toLowerCase();
        activeType = activeType === value ? '' : value;
        updateTypeUI();
      });
    });
  }
  if (typeClearBtn) {
    typeClearBtn.addEventListener('click', () => {
      activeType = '';
      updateTypeUI();
    });
  }

  if (cmcButtons.length) {
    cmcButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const value = btn.dataset.cmcBucket || '';
        activeCmc = activeCmc === value ? '' : value;
        updateCmcUI();
      });
    });
  }
  if (cmcClearBtn) {
    cmcClearBtn.addEventListener('click', () => {
      activeCmc = '';
      updateCmcUI();
    });
  }

  applyFilters();
})();

(() => {
  const toggles = Array.from(document.querySelectorAll('[data-build-view-toggle]'));
  const views = Array.from(document.querySelectorAll('[data-build-view]'));
  if (!toggles.length || !views.length) return;
  const storageKey = 'buildSessionView:{{ build_session.id }}';

  function setView(name, persist = true) {
    const target = name || 'list';
    views.forEach(view => {
      view.classList.toggle('d-none', view.dataset.buildView !== target);
    });
    toggles.forEach(btn => {
      const isActive = btn.dataset.view === target;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    if (persist && window.sessionStorage) {
      sessionStorage.setItem(storageKey, target);
    }
  }

  toggles.forEach(btn => {
    btn.addEventListener('click', () => setView(btn.dataset.view));
  });

  let initial = 'list';
  if (window.sessionStorage) {
    initial = sessionStorage.getItem(storageKey) || initial;
  }
  setView(initial, false);
})();

(() => {
  const dropdownMenu = document.querySelector('[data-build-nav-links]');
  const toggleBtn = document.querySelector('.build-nav-dropdown .build-nav-toggle');
  if (!dropdownMenu || !toggleBtn) return;
  const dropdown = typeof bootstrap !== 'undefined' && bootstrap.Dropdown
    ? bootstrap.Dropdown.getOrCreateInstance(toggleBtn)
    : null;

  function collectSections() {
    const items = [];
    const allowedLabels = new Set(['commander', 'recommendations', 'current build']);
    document.querySelectorAll('[data-nav-section]').forEach(section => {
      if (section.classList.contains('d-none')) return;
      if (section.closest('.d-none')) return;
      if (section.closest('.build-rec-source.d-none')) return;
      const label = (section.getAttribute('data-nav-label') || '').trim();
      const level = (section.getAttribute('data-nav-level') || '1').trim();
      const id = section.getAttribute('id');
      if (!label || !id) return;
      const isTop = level === '1';
      if (isTop && !allowedLabels.has(label.toLowerCase())) return;
      items.push({ id, label, level });
    });
    return items;
  }

  function renderLinks() {
    dropdownMenu.innerHTML = '';
    collectSections().forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dropdown-item build-nav-link';
      btn.textContent = item.label;
      btn.dataset.level = item.level;
      btn.addEventListener('click', () => {
        const target = document.getElementById(item.id);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        if (dropdown) {
          dropdown.hide();
        }
      });
      dropdownMenu.appendChild(btn);
    });
  }

  toggleBtn.addEventListener('click', renderLinks);
  toggleBtn.addEventListener('show.bs.dropdown', renderLinks);
  renderLinks();
})();
</script>
{% endblock %}

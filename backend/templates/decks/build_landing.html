{% extends "base.html" %}
{% block title %}Build a Deck - DragonsVault{% endblock %}
{% block content %}

<div class="page-section">
  <div class="d-flex align-items-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">Build a Deck</h1>
      <div class="text-muted small">Discover what you can build before you commit.</div>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
        <div>
          <div class="section-label mb-1">Start from what you already know you want</div>
          <div class="text-muted small">You choose the commander and any tags. Nothing is suggested or applied automatically.</div>
        </div>
        <span class="badge text-bg-primary">User intent</span>
      </div>
      <form method="post" action="{{ url_for('views.start_build_deck') }}" data-ux-submit>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <label for="landingCommanderName" class="form-label">Commander</label>
            <input type="text"
                   class="form-control"
                   id="landingCommanderName"
                   name="commander_name"
                   placeholder="e.g. Atraxa, Praetors' Voice"
                   required>
            <div class="form-text">Start from a commander you already have in mind.</div>
          </div>
          <div class="col-12 col-lg-6">
            <label for="landingDeckTagsToggle" class="form-label">Optional deck tags</label>
            <div class="dropdown dv-select w-100" data-multi-select="build-landing-tags">
              <div data-multi-select-values></div>
              <button class="btn dv-select-toggle w-100 justify-content-between"
                      type="button"
                      id="landingDeckTagsToggle"
                      data-bs-toggle="dropdown"
                      data-bs-auto-close="outside"
                      aria-expanded="false">
                <span data-multi-select-label>No tags selected</span>
                <i class="bi bi-chevron-down"></i>
              </button>
              <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="landingDeckTagsToggle">
                {% for category, tags in deck_tag_groups.items() %}
                  <li class="dropdown-header text-muted small">{{ category }}</li>
                  {% for tag in tags %}
                    {% set tag_id = "landingTag-" ~ category|replace(' ', '-') ~ "-" ~ loop.index %}
                    <li>
                      <div class="dropdown-item">
                        <div class="form-check m-0">
                          <input class="form-check-input" type="checkbox" value="{{ tag }}" id="{{ tag_id }}" data-multi-select-option>
                          <label class="form-check-label" for="{{ tag_id }}">{{ tag }}</label>
                        </div>
                      </div>
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            <div class="form-text">Add playstyle tags only if you want them applied.</div>
          </div>
        </div>
        <div class="d-flex justify-content-end mt-3">
          <button class="btn btn-success" type="submit" data-progress-label="Starting...">Start a New Build</button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
    <div>
      <div class="section-label mb-1">Good fits based on your collection</div>
      <div class="text-muted small">Strong options based on cards you already own.</div>
    </div>
    <span class="badge text-bg-secondary">App guidance</span>
  </div>

  {% if landing.collection_fits and landing.collection_fits|length %}
    <div class="row g-3 mb-4">
      {% for fit in landing.collection_fits %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
            {% if fit.commander_image %}
              <img src="{{ fit.commander_image }}" class="card-img-top build-commander-image" alt="{{ fit.commander_name }}" loading="lazy">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <div class="fw-semibold mb-1">{{ fit.commander_name }}</div>
              {% if fit.tag_hints %}
                <div class="d-flex flex-wrap gap-1 mb-2">
                  {% for hint in fit.tag_hints %}
                    <span class="badge build-tag-badge">{{ hint }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="small text-muted mb-2">{{ fit.owned_label }}</div>
              <div class="small text-muted mb-3">{{ fit.reason }}</div>
              {% if fit.color_hint %}
                <div class="small text-muted mb-3">{{ fit.color_hint }}</div>
              {% endif %}
              <form method="post" action="{{ url_for('views.start_build_deck') }}" data-ux-submit class="mt-auto">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="commander_oracle_id" value="{{ fit.commander_oracle_id }}">
                <input type="hidden" name="commander_name" value="{{ fit.commander_name }}">
                <button class="btn btn-outline-success btn-sm w-100" type="submit" data-progress-label="Starting...">
                  Build This Commander
                </button>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary mb-4">
      {% if not landing.edhrec_ready %}
        Recommendations are unavailable until the EDHREC cache is refreshed.
      {% elif landing.collection_count == 0 %}
        Add cards to your collection to see strong commander fits.
      {% else %}
        No strong fits found yet. Try adding more collection cards or pick a tag below.
      {% endif %}
    </div>
  {% endif %}

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
        <div>
          <div class="section-label mb-1">Explore by playstyle (using your collection)</div>
          <div class="text-muted small">You pick a tag, then we suggest commanders based on the cards you own.</div>
        </div>
        <span class="badge text-bg-secondary">App guidance</span>
      </div>

      <form method="get" action="{{ url_for('views.build_deck_landing') }}" class="row g-3 align-items-end">
        <div class="col-12 col-lg-6">
          <label for="landingTagToggle" class="form-label">Deck tag</label>
          <div class="dropdown dv-select w-100" data-dv-select="build-landing-tag">
            <input type="hidden" name="tag" data-dv-select-input value="{{ landing.selected_tag or '' }}">
            <button class="btn dv-select-toggle w-100 justify-content-between"
                    type="button"
                    id="landingTagToggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span data-dv-select-label>{{ landing.selected_tag or 'Choose a tag' }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="landingTagToggle">
              <li class="dv-select-search-wrapper">
                <input type="text" class="form-control form-control-sm" placeholder="Search tags..." data-dv-select-search>
              </li>
              <li>
                <button class="dropdown-item {% if not landing.selected_tag %}active{% endif %}"
                        type="button"
                        data-dv-select-option
                        data-value=""
                        data-label="Choose a tag">
                  Choose a tag
                </button>
              </li>
              {% for tag in deck_tags %}
                <li>
                  <button class="dropdown-item {% if landing.selected_tag == tag %}active{% endif %}"
                          type="button"
                          data-dv-select-option
                          data-value="{{ tag }}"
                          data-label="{{ tag }}">
                    {{ tag }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
          {% if tag_notice %}
            <div class="form-text text-warning">{{ tag_notice }}</div>
          {% endif %}
        </div>
        <div class="col-12 col-lg-auto d-flex align-items-center gap-2">
          <button class="btn btn-outline-primary" type="submit">Explore</button>
          {% if landing.selected_tag %}
            <a class="btn btn-link btn-sm" href="{{ url_for('views.build_deck_landing') }}">Clear</a>
          {% endif %}
        </div>
      </form>

      {% if landing.selected_tag %}
        <div class="text-muted small mt-3">
          Showing commanders for {{ landing.selected_tag }}{% if landing.tag_candidates %} &middot; {{ landing.tag_candidates }} cached options{% endif %}.
        </div>
      {% endif %}

      {% if landing.tag_fits and landing.tag_fits|length %}
        <div class="row g-3 mt-2">
          {% for fit in landing.tag_fits %}
            <div class="col-12 col-md-6 col-lg-4">
              <div class="card h-100 border-0 shadow-sm">
                {% if fit.commander_image %}
                  <img src="{{ fit.commander_image }}" class="card-img-top build-commander-image" alt="{{ fit.commander_name }}" loading="lazy">
                {% endif %}
                <div class="card-body d-flex flex-column">
                  <div class="fw-semibold mb-1">{{ fit.commander_name }}</div>
                  {% if fit.tag_hints %}
                    <div class="d-flex flex-wrap gap-1 mb-2">
                      {% for hint in fit.tag_hints %}
                        <span class="badge build-tag-badge">{{ hint }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <div class="small text-muted mb-2">{{ fit.coverage_label }}</div>
                  <div class="small text-muted mb-3">{{ fit.reason }}</div>
                  {% if fit.color_hint %}
                    <div class="small text-muted mb-3">{{ fit.color_hint }}</div>
                  {% endif %}
                  <form method="post" action="{{ url_for('views.start_build_deck') }}" data-ux-submit class="mt-auto">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="commander_oracle_id" value="{{ fit.commander_oracle_id }}">
                    <input type="hidden" name="commander_name" value="{{ fit.commander_name }}">
                    <input type="hidden" name="tags" value="{{ landing.selected_tag }}">
                    <button class="btn btn-outline-success btn-sm w-100" type="submit" data-progress-label="Starting...">
                      Build This Commander
                    </button>
                  </form>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% elif landing.selected_tag %}
        <div class="alert alert-secondary mt-3">
          {% if landing.tag_candidates == 0 %}
            No cached commanders for {{ landing.selected_tag }} yet. Refresh EDHREC data to unlock more options.
          {% else %}
            No strong matches for {{ landing.selected_tag }} yet. Try another tag or add more cards to your collection.
          {% endif %}
        </div>
      {% else %}
        <div class="alert alert-secondary mt-3">
          Choose a tag to see suggested commanders based on your collection.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function () {
  const multiSelect = document.querySelector('[data-multi-select=\"build-landing-tags\"]');
  if (!multiSelect) {
    return;
  }
  const label = multiSelect.querySelector('[data-multi-select-label]');
  const valuesContainer = multiSelect.querySelector('[data-multi-select-values]');
  const options = Array.from(multiSelect.querySelectorAll('[data-multi-select-option]'));

  function sync() {
    const selected = options.filter(opt => opt.checked).map(opt => opt.value);
    if (label) {
      const count = selected.length;
      label.textContent = count ? `${count} tag${count !== 1 ? 's' : ''} selected` : 'No tags selected';
    }
    if (valuesContainer) {
      valuesContainer.innerHTML = '';
      selected.forEach(val => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tags';
        input.value = val;
        valuesContainer.appendChild(input);
      });
    }
  }

  options.forEach(opt => opt.addEventListener('change', sync));
  sync();
})();
</script>

{% endblock %}

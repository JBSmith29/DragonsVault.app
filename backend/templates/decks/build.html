{% extends "base.html" %}
{% block title %}{{ folder.name }} - Build Deck{% endblock %}
{% block content %}

<div class="page-section build-workspace {{ 'build-view-list' if build_view_mode == 'list' else 'build-view-gallery' }} {{ 'build-rec-collection' if build_rec_source == 'collection' else 'build-rec-edhrec' }} build-deck-view-list"
     id="buildWorkspace"
     data-view-mode="{{ build_view_mode or 'gallery' }}"
     data-rec-source="{{ build_rec_source or 'edhrec' }}"
     data-deck-view="list">
  {% set build_state = build_state or {} %}
  <style>
    .build-workspace {
      --build-panel-border: rgba(148, 163, 184, 0.2);
      --build-panel-bg: rgba(15, 23, 42, 0.78);
    }
    .build-header-title { font-weight: 700; }
    .build-header-meta { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    .build-header-meta .badge { border-radius:999px; padding:.4em .75em; }
    .build-context { position: sticky; top: 1rem; display:flex; flex-direction:column; gap:1rem; }
    .build-deck-column { position: sticky; top: 1rem; display:flex; flex-direction:column; gap:1rem; }
    .build-panel {
      background: linear-gradient(160deg, rgba(15, 23, 42, .85), rgba(15, 23, 42, .7));
      border:1px solid var(--build-panel-border);
      border-radius:1rem;
      box-shadow: 0 14px 32px rgba(0,0,0,.28);
    }
    .build-panel .card-header { background: transparent; border-bottom: 1px solid var(--build-panel-border); }
    .build-section-title { font-weight:600; }
    .build-section-sub { color: var(--bs-secondary-color); font-size:.85rem; }
    .build-section-label {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--bs-secondary-color);
    }
    .commander-preview {
      width: 132px;
      min-height: 180px;
      border-radius: .85rem;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: .35rem;
    }
    .commander-preview img { width:100%; height:auto; border-radius:.65rem; display:block; }
    .commander-placeholder { font-size:.8rem; color: var(--bs-secondary-color); text-align:center; padding:.5rem; }
    .build-tags { display:flex; flex-wrap:wrap; gap:.35rem; }
    .build-tags .badge {
      border-radius:999px;
      padding:.35em .65em;
      background: rgba(108, 117, 125, .2);
      color: var(--bs-body-color);
    }
    .build-stat-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:.6rem; }
    .build-stat {
      padding:.6rem .7rem;
      border-radius:.8rem;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
    }
    .build-stat .label {
      font-size:.7rem;
      text-transform: uppercase;
      letter-spacing:.08em;
      color: var(--bs-secondary-color);
    }
    .build-stat .value { font-weight:700; font-variant-numeric: tabular-nums; }
    .build-progress .progress { height:.5rem; }
    .build-toolbar { backdrop-filter: blur(8px); }
    .build-view-toggle .btn.active { background: var(--bs-primary); color:#fff; border-color: var(--bs-primary); }
    .build-rec-toggle .btn.active { background: var(--bs-primary); color:#fff; border-color: var(--bs-primary); }
    .build-deck-toggle .btn.active { background: var(--bs-primary); color:#fff; border-color: var(--bs-primary); }
    .build-rec-edhrec [data-rec-section="collection"] { display: none; }
    .build-rec-collection [data-rec-section="edhrec"] { display: none; }
    .rec-type-group { margin-bottom: 1.1rem; }
    .rec-group-toggle {
      width: 100%;
      border: 0;
      background: transparent;
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .6rem;
      padding: .2rem 0 .6rem;
      font-weight: 600;
    }
    .rec-group-toggle .bi {
      font-size: .85rem;
      opacity: .8;
      transition: transform .18s ease;
    }
    .rec-group-toggle[aria-expanded="true"] .bi { transform: rotate(180deg); }
    .rec-group-header {
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--bs-body-bg);
      padding: .4rem 0;
      border-bottom: 1px solid var(--bs-border-color);
      margin-bottom: .5rem;
    }
    .rec-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:.95rem; }
    .rec-card {
      background: rgba(15, 23, 42, 0.55);
      border:1px solid var(--build-panel-border);
      border-radius:.85rem;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow: 0 10px 24px rgba(0,0,0,.2);
      transition: transform .18s ease, border-color .18s ease;
    }
    .rec-card__image {
      position: relative;
      width: 100%;
      aspect-ratio: 0.715;
      background: rgba(2, 6, 23, .6);
    }
    .rec-card__image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform .18s ease;
    }
    .rec-card__placeholder {
      position: absolute;
      inset: 0;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: .65rem;
      margin: .5rem;
      background: rgba(2, 6, 23, .6);
    }
    .rec-card:hover { border-color: rgba(99, 102, 241, 0.4); transform: translateY(-2px); }
    .rec-card:hover img { transform: scale(1.04); }
    .rec-card-body { padding:.7rem .7rem .8rem; display:flex; flex-direction:column; gap:.35rem; }
    .rec-card-title { font-weight:600; font-size:.9rem; }
    .rec-card-meta { font-size:.8rem; color: var(--bs-secondary-color); }
    .rec-reasons { display:flex; flex-wrap:wrap; gap:.35rem; }
    .rec-reasons .badge { font-weight:600; font-size:.7rem; line-height:1.1; white-space:normal; }
    .edhrec-card-grid {
      display: grid;
      gap: 1.1rem;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    .edhrec-card {
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid var(--build-panel-border);
      border-radius: .9rem;
      padding: .9rem;
      display: flex;
      flex-direction: column;
      gap: .6rem;
      box-shadow: 0 10px 24px rgba(0,0,0,.2);
      transition: transform .18s ease, border-color .18s ease, background-color .18s ease;
    }
    .edhrec-card:hover {
      transform: translateY(-3px);
      background: rgba(99, 102, 241, 0.12);
      border-color: rgba(99, 102, 241, 0.45);
    }
    .edhrec-card__image {
      display: flex;
      justify-content: center;
    }
    .edhrec-card__image img {
      width: 100%;
      max-width: 210px;
      border-radius: .85rem;
      object-fit: contain;
      background: rgba(2, 6, 23, .6);
      box-shadow: 0 1rem 2rem rgba(15, 23, 42, 0.3);
    }
    .edhrec-card__placeholder {
      width: 100%;
      max-width: 210px;
      aspect-ratio: 0.715;
      border-radius: .85rem;
      background: rgba(2, 6, 23, .6);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .edhrec-card__body {
      display: flex;
      flex-direction: column;
      gap: .45rem;
      text-align: center;
    }
    .edhrec-card__badges,
    .edhrec-card__actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: .35rem;
    }
    .edhrec-card__actions .btn {
      width: 100%;
    }
    .build-view-list .edhrec-card-grid {
      grid-template-columns: 1fr;
    }
    .build-view-list .edhrec-card {
      flex-direction: row;
      align-items: center;
      padding: .75rem;
      gap: 1rem;
    }
    .build-view-list .edhrec-card__image img {
      max-width: 72px;
    }
    .build-view-list .edhrec-card__placeholder {
      max-width: 72px;
    }
    .build-view-list .edhrec-card__body {
      text-align: left;
      align-items: flex-start;
    }
    .build-view-list .edhrec-card__badges,
    .build-view-list .edhrec-card__actions {
      justify-content: flex-start;
    }
    .build-view-list .edhrec-card__actions .btn {
      width: auto;
    }
    .deck-group { margin-bottom:1.5rem; }
    .deck-group-header {
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--bs-body-bg);
      padding: .35rem 0;
      border-bottom: 1px solid var(--bs-border-color);
      margin-bottom:.5rem;
    }
    .deck-card-row {
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:.6rem 0.75rem;
      align-items:center;
      padding:.6rem .7rem;
      border-radius:.85rem;
      border:1px solid var(--build-panel-border);
      background: rgba(15, 23, 42, 0.45);
    }
    .deck-card-row + .deck-card-row { margin-top:.5rem; }
    .deck-card-row img { width:48px; height:auto; object-fit:contain; border-radius:.4rem; background: rgba(2, 6, 23, .6); }
    .deck-card-meta { min-width: 0; }
    .deck-card-name { font-weight: 600; }
    .deck-card-type { font-size: .75rem; color: var(--bs-secondary-color); }
    .deck-breakdown-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:.6rem; }
    .deck-breakdown-pill {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem;
      padding:.45rem .7rem;
      border-radius:999px;
      background: rgba(148, 163, 184, .12);
      border:1px solid rgba(148, 163, 184, .2);
      font-weight:600;
    }
    .breakdown-summary {
      display:grid;
      gap:1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .breakdown-pill-group { display:flex; flex-wrap:wrap; gap:.5rem; }
    .breakdown-pill {
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.35rem .7rem;
      border-radius:999px;
      background: rgba(15, 23, 42, 0.6);
      border:1px solid rgba(148, 163, 184, 0.2);
      font-size:.85rem;
      font-weight:600;
    }
    .breakdown-pill .badge { font-weight:700; }
    .deck-card-actions { display:flex; align-items:center; gap:.35rem; flex-wrap:wrap; justify-content:flex-end; }
    .deck-card-qty { font-weight:600; min-width:2rem; text-align:center; }
    .build-deck-table { width: 100%; }
    .build-deck-table th,
    .build-deck-table td { vertical-align: middle; }
    .build-deck-table .group-row td {
      background: rgba(15, 23, 42, 0.55);
      border-top: 1px solid var(--build-panel-border);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .02em;
      color: var(--bs-secondary-color);
    }
    .build-deck-table .card-cell { display:flex; align-items:center; gap:.6rem; }
    .build-deck-table .card-cell img { width: 48px; height: auto; border-radius: .35rem; }
    .build-deck-table .card-name { font-weight: 600; }
    .build-deck-table .card-sub { font-size: .8rem; color: var(--bs-secondary-color); }
    .deck-view { display: none; }
    .build-deck-view-gallery .deck-view-gallery { display: block; }
    .build-deck-view-list .deck-view-list { display: block; }
    .build-deck-view-breakdown .deck-view-type { display: block; }
    .deck-gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .deck-gallery-card {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--build-panel-border);
      border-radius: .9rem;
      padding: .75rem;
      display: flex;
      flex-direction: column;
      gap: .6rem;
      height: 100%;
    }
    .deck-gallery-card img {
      width: 100%;
      border-radius: .7rem;
      box-shadow: 0 .9rem 1.8rem rgba(0,0,0,.3);
    }
    .deck-gallery-title { font-weight: 600; }
    .deck-gallery-sub { font-size: .8rem; color: var(--bs-secondary-color); }
    .deck-type-columns {
      column-width: 320px;
      column-gap: 1rem;
    }
    .deck-type-section {
      break-inside: avoid;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--build-panel-border);
      border-radius: .85rem;
      padding: .75rem;
      margin-bottom: 1rem;
    }
    .deck-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      margin-bottom: .5rem;
    }
    .deck-type-table td { vertical-align: middle; }
    .build-breakdown-btn { position: fixed; right: 1.5rem; bottom: 1.5rem; z-index: 1030; }
    @media (max-width: 991px) {
      .build-context { position: static; }
    }
  </style>

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1 build-header-title">{{ folder.name }}</h1>
      <div class="build-header-meta">
        <span class="badge text-bg-warning">Build Queue</span>
        {% if folder.is_proxy %}<span class="badge text-bg-info">Proxy</span>{% endif %}
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <form method="post"
            action="{{ url_for('views.finish_build', folder_id=folder.id) }}"
            data-ux-submit>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-outline-success"
                type="submit"
                data-confirm="Finish this build and convert it into a normal deck?"
                data-progress-label="Finishing...">
          Finish Build
        </button>
      </form>
    </div>
  </div>

  <div class="row g-3 build-top-row mb-3">
    <div class="col-12 col-xl-4">
      <div class="card build-panel h-100">
        <div class="card-body">
          <div class="build-section-label">Commander</div>
          <div class="d-flex gap-3 align-items-start mt-2">
            <div class="commander-preview">
              {% if build_state and build_state.commander_image %}
                <img src="{{ build_state.commander_image }}" alt="{{ build_state.commander_name or 'Commander' }}" loading="lazy">
              {% else %}
                <div class="commander-placeholder">No commander selected.</div>
              {% endif %}
            </div>
            <div class="flex-grow-1">
              <div class="fw-semibold">{{ build_state.commander_name or 'Not set' }}</div>
              {% if build_state.color_icons and build_state.color_icons|length %}
                <div class="d-flex align-items-center gap-1 mt-1">
                  {% for icon in build_state.color_icons %}
                    <img src="{{ icon }}" alt="color" style="height:1rem;width:auto;">
                  {% endfor %}
                </div>
              {% endif %}
              <div class="d-flex flex-wrap gap-2 mt-2">
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#commanderPickerModal">
                  Change commander
                </button>
                {% if folder.commander_oracle_id %}
                  <form method="post"
                        action="{{ url_for('views.clear_folder_commander', folder_id=folder.id) }}"
                        data-confirm="Clear the commander for this deck?"
                        class="mb-0">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Clear</button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card build-panel h-100">
        <div class="card-body">
          <div class="build-section-label">Deck Summary</div>
          {% set total_cards = build_state.deck_total_with_commander or 0 %}
          {% set target_cards = build_state.deck_total_target or 100 %}
          {% set remaining_cards = target_cards - total_cards %}
          <div class="build-stat-grid mt-2">
            <div class="build-stat">
              <div class="label">Total</div>
              <div class="value">{{ total_cards }} / {{ target_cards }}</div>
            </div>
            <div class="build-stat">
              <div class="label">Lands</div>
              <div class="value">{{ build_state.land_qty or 0 }}</div>
            </div>
            <div class="build-stat">
              <div class="label">Non-Lands</div>
              <div class="value">{{ build_state.non_land_qty or 0 }}</div>
            </div>
            <div class="build-stat">
              <div class="label">Remaining</div>
              <div class="value">{{ remaining_cards if remaining_cards > 0 else 0 }}</div>
            </div>
          </div>
          <div class="build-progress mt-3">
            <div class="progress">
              <div class="progress-bar"
                   role="progressbar"
                   style="width: {{ build_state.deck_progress_pct or 0 }}%;"
                   aria-valuenow="{{ build_state.deck_progress_pct or 0 }}"
                   aria-valuemin="0"
                   aria-valuemax="100"></div>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% if build_state.needs_lands %}
              <span class="badge text-bg-warning">Needs lands</span>
            {% endif %}
            {% if build_state.over_limit %}
              <span class="badge text-bg-danger">Over 100 cards</span>
            {% endif %}
            {% if build_state.commander_missing %}
              <span class="badge text-bg-danger">Commander missing</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card build-panel h-100">
        <div class="card-body">
          <div class="build-section-label">Deck Tags</div>
          <div class="build-tags mt-2">
            {% if build_state and build_state.tags %}
              {% for tag in build_state.tags %}
                <span class="badge text-bg-secondary">{{ tag }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted small">No tags selected.</span>
            {% endif %}
          </div>
          <button class="btn btn-sm btn-outline-secondary mt-2" type="button" data-bs-toggle="modal" data-bs-target="#tagPickerModal">
            Adjust tags
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 build-columns">
    <div class="col-12">
      <div class="card build-panel build-toolbar mb-3">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div>
            <div class="build-section-title">Recommendations</div>
            <div class="build-section-sub">Switch between EDHREC data and your collection.</div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="btn-group btn-group-sm build-rec-toggle" role="group" aria-label="Recommendation source toggle">
              <button type="button" class="btn btn-outline-secondary" data-build-rec-toggle="edhrec">EDHREC</button>
              <button type="button" class="btn btn-outline-secondary" data-build-rec-toggle="collection">Your Collection</button>
            </div>
            {% if current_user.is_authenticated and (current_user.is_admin in [true, True, 1, '1', 'true', 'True']) %}
              <form method="post"
                    action="{{ url_for('views.admin_console') }}"
                    data-ux-submit
                    data-hx-boost="false"
                    class="mb-0">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="refresh_edhrec">
                <input type="hidden" name="refresh_scope" value="delta">
                <button class="btn btn-sm btn-outline-primary"
                        type="submit"
                        data-progress-label="Refreshing..."
                        formtarget="_blank">
                  Pull EDHREC Data
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>

      {% set edhrec_groups = build_state.edhrec_groups if build_state else [] %}
      {% set card_placeholder = url_for('static', filename='img/card-placeholder.svg') %}
      <div class="card build-panel mb-3" data-rec-section="edhrec">
        <div class="card-header">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <div class="build-section-title">Popular cards for this commander (EDHREC)</div>
              <div class="build-section-sub">Ordered by EDHREC synergy.</div>
            </div>
            <span class="badge text-bg-secondary">{{ build_state.edhrec_cards|length if build_state and build_state.edhrec_cards else 0 }}</span>
          </div>
        </div>
        <div class="card-body">
          {% if edhrec_groups %}
            {% for group in edhrec_groups %}
              {% if group.count %}
                {% set group_id = "edhrec-group-" ~ loop.index %}
                {% set is_open = group.label in ['Creatures', 'Lands'] %}
                <div class="rec-type-group">
                  <button class="rec-group-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#{{ group_id }}" aria-expanded="{{ 'true' if is_open else 'false' }}" aria-controls="{{ group_id }}">
                    <span>{{ group.label }}</span>
                    <span class="badge text-bg-secondary">{{ group.count }}</span>
                    <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="{{ group_id }}" class="collapse {% if is_open %}show{% endif %}">
                    <div class="rec-grid">
                      {% for rec in group.cards %}
                        {% set rec_image = rec.image_large or rec.image_normal or rec.image_small %}
                        <div class="rec-card">
                          <div class="rec-card__image">
                            {% if rec_image %}
                              <img src="{{ rec_image }}" alt="{{ rec.name }}" loading="lazy" data-hover-src="{{ rec_image }}">
                            {% else %}
                              <img src="{{ card_placeholder }}" alt="" loading="lazy">
                            {% endif %}
                          </div>
                          <div class="rec-card-body">
                            <div class="rec-card-title" {% if rec_image %}data-hover-src="{{ rec_image }}"{% endif %}>{{ rec.name }}</div>
                            <div class="rec-reasons">
                              {% if rec.get('synergy_score') is not none %}
                                <span class="badge text-bg-primary">Synergy {{ "%.1f"|format(rec.get('synergy_score')) }}</span>
                              {% else %}
                                <span class="badge text-bg-primary">Rank {{ rec.get('synergy_rank') or '—' }}</span>
                              {% endif %}
                              {% if rec.in_deck %}
                                <span class="badge text-bg-success">In Deck</span>
                              {% endif %}
                              {% if rec.owned and not rec.in_deck %}
                                <span class="badge text-bg-info text-dark">In Collection</span>
                              {% endif %}
                            </div>
                            <form method="post"
                                  action="{{ url_for('views.build_add_card', folder_id=folder.id) }}"
                                  data-ux-submit>
                              <input type="hidden" name="oracle_id" value="{{ rec.oracle_id }}">
                              <button class="btn btn-sm btn-outline-primary w-100"
                                      type="submit"
                                      data-progress-label="Adding..."
                                      {% if not rec.can_add %}disabled title="{{ rec.disabled_reason }}"{% endif %}>
                                Add to deck
                              </button>
                            </form>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="text-muted small">EDHREC recommendations are unavailable right now.</div>
          {% endif %}
        </div>
      </div>

      {% set edhrec_tag_groups = build_state.edhrec_tag_groups if build_state else [] %}
      {% if edhrec_tag_groups %}
        <div class="card build-panel mb-3" data-rec-section="edhrec">
          <div class="card-header">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
              <div>
                <div class="build-section-title">EDHREC Tag Explorer</div>
                <div class="build-section-sub">Synergy cards grouped by selected deck tags.</div>
              </div>
              <span class="badge text-bg-secondary">{{ edhrec_tag_groups|length }}</span>
            </div>
          </div>
          <div class="card-body">
            {% for group in edhrec_tag_groups %}
              {% if group.count %}
                {% set group_id = "edhrec-tag-group-" ~ loop.index %}
                <div class="rec-type-group">
                  <button class="rec-group-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#{{ group_id }}" aria-expanded="false" aria-controls="{{ group_id }}">
                    <span>{{ group.label }}</span>
                    <span class="badge text-bg-secondary">{{ group.count }}</span>
                    <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="{{ group_id }}" class="collapse">
                    <div class="rec-grid">
                      {% for rec in group.cards %}
                        {% set rec_image = rec.image_large or rec.image_normal or rec.image_small %}
                        <div class="rec-card">
                          <div class="rec-card__image">
                            {% if rec_image %}
                              <img src="{{ rec_image }}" alt="{{ rec.name }}" loading="lazy" data-hover-src="{{ rec_image }}">
                            {% else %}
                              <img src="{{ card_placeholder }}" alt="" loading="lazy">
                            {% endif %}
                          </div>
                          <div class="rec-card-body">
                            <div class="rec-card-title" {% if rec_image %}data-hover-src="{{ rec_image }}"{% endif %}>{{ rec.name }}</div>
                            <div class="rec-reasons">
                              {% if rec.get('synergy_score') is not none %}
                                <span class="badge text-bg-primary">Synergy {{ "%.1f"|format(rec.get('synergy_score')) }}</span>
                              {% else %}
                                <span class="badge text-bg-primary">Rank {{ rec.get('synergy_rank') or '—' }}</span>
                              {% endif %}
                              {% if rec.in_deck %}
                                <span class="badge text-bg-success">In Deck</span>
                              {% endif %}
                            </div>
                            <form method="post"
                                  action="{{ url_for('views.build_add_card', folder_id=folder.id) }}"
                                  data-ux-submit>
                              <input type="hidden" name="oracle_id" value="{{ rec.oracle_id }}">
                              <button class="btn btn-sm btn-outline-primary w-100"
                                      type="submit"
                                      data-progress-label="Adding..."
                                      {% if not rec.can_add %}disabled title="{{ rec.disabled_reason }}"{% endif %}>
                                Add to deck
                              </button>
                            </form>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% set collection_groups = build_state.collection_groups if build_state else [] %}
      <div class="card build-panel" data-rec-section="collection">
        <div class="card-header">
          <div class="build-section-title">Recommended from your collection</div>
          <div class="build-section-sub">Owned cards plus land gaps.</div>
        </div>
        <div class="card-body">
          {% if collection_groups %}
            {% for group in collection_groups %}
              {% if group.count %}
                {% set group_id = "collection-group-" ~ loop.index %}
                {% set is_open = group.label in ['Creatures', 'Lands'] %}
                <div class="rec-type-group">
                  <button class="rec-group-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#{{ group_id }}" aria-expanded="{{ 'true' if is_open else 'false' }}" aria-controls="{{ group_id }}">
                    <span>{{ group.label }}</span>
                    <span class="badge text-bg-secondary">{{ group.count }}</span>
                    <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="{{ group_id }}" class="collapse {% if is_open %}show{% endif %}">
                    <div class="rec-grid">
                      {% for rec in group.cards %}
                        {% set rec_image = rec.image_large or rec.image_normal or rec.image_small %}
                        <div class="rec-card">
                          <div class="rec-card__image">
                            {% if rec_image %}
                              <img src="{{ rec_image }}" alt="{{ rec.name }}" loading="lazy" data-hover-src="{{ rec_image }}">
                            {% else %}
                              <img src="{{ card_placeholder }}" alt="" loading="lazy">
                            {% endif %}
                          </div>
                          <div class="rec-card-body">
                            <div class="rec-card-title" {% if rec_image %}data-hover-src="{{ rec_image }}"{% endif %}>{{ rec.name }}</div>
                            <div class="rec-reasons">
                              {% if rec.owned_qty %}
                                <span class="badge text-bg-success">You own this</span>
                              {% endif %}
                              {% for reason in rec.reasons or [] %}
                                <span class="badge text-bg-info">{{ reason }}</span>
                              {% endfor %}
                            </div>
                            <form method="post"
                                  action="{{ url_for('views.build_add_card', folder_id=folder.id) }}"
                                  data-ux-submit>
                              <input type="hidden" name="oracle_id" value="{{ rec.oracle_id }}">
                              <button class="btn btn-sm btn-outline-primary w-100"
                                      type="submit"
                                      data-progress-label="Adding..."
                                      {% if not rec.can_add %}disabled title="{{ rec.disabled_reason }}"{% endif %}>
                                Add to deck
                              </button>
                            </form>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="text-muted small">Collection recommendations are not available right now.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <div class="row g-3 mt-1">
    <div class="col-12">
      <div class="card build-panel">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <div class="build-section-title">Current Deck</div>
            <div class="build-section-sub">Cards added to this build.</div>
          </div>
          <div class="btn-group btn-group-sm build-deck-toggle" role="group" aria-label="Deck display mode">
            <button type="button" class="btn btn-outline-secondary" data-build-deck-toggle="gallery">Gallery</button>
            <button type="button" class="btn btn-outline-secondary" data-build-deck-toggle="list">List</button>
            <button type="button" class="btn btn-outline-secondary" data-build-deck-toggle="breakdown">Type</button>
          </div>
        </div>
        <div class="card-body">
          {% if build_state and build_state.deck_groups %}
            <div class="deck-view deck-view-gallery">
              <div class="deck-gallery-grid">
                {% for group in build_state.deck_groups %}
                  {% for card in group.cards %}
                    {% set deck_hover = card.image_large or card.image_normal or card.image_small %}
                    <div class="deck-gallery-card">
                      {% if card.image_normal %}
                        <img src="{{ card.image_normal }}" alt="{{ card.name }}" loading="lazy" {% if deck_hover %}data-hover-src="{{ deck_hover }}"{% endif %}>
                      {% endif %}
                      <div>
                        <div class="deck-gallery-title" {% if deck_hover %}data-hover-src="{{ deck_hover }}"{% endif %}>{{ card.name }}</div>
                        <div class="deck-gallery-sub">{{ card.type_line }}</div>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                          {% if card.is_commander %}
                            <span class="badge text-bg-warning">Commander</span>
                          {% endif %}
                          {% if card.allows_multiple %}
                            <span class="badge text-bg-secondary">Multiple</span>
                          {% endif %}
                        </div>
                      </div>
                      <div class="d-flex flex-wrap gap-2">
                        <form method="post"
                              action="{{ url_for('views.build_remove_cards', folder_id=folder.id) }}"
                              data-ux-submit
                              class="mb-0">
                          <input type="hidden" name="card_id" value="{{ card.card_id }}">
                          <input type="hidden" name="delta" value="1">
                          <button class="btn btn-sm btn-outline-secondary"
                                  type="submit"
                                  {% if not card.can_decrement %}disabled title="Minimum reached"{% endif %}>
                            -
                          </button>
                        </form>
                        <div class="fw-semibold">{{ card.quantity }}</div>
                        <form method="post"
                              action="{{ url_for('views.build_add_card', folder_id=folder.id) }}"
                              data-ux-submit
                              class="mb-0">
                          <input type="hidden" name="oracle_id" value="{{ card.oracle_id }}">
                          <button class="btn btn-sm btn-outline-secondary"
                                  type="submit"
                                  {% if not card.can_increment %}disabled title="{{ 'Commander already assigned' if card.is_commander else 'Singleton rule' }}"{% endif %}>
                            +
                          </button>
                        </form>
                        <form method="post"
                              action="{{ url_for('views.build_remove_cards', folder_id=folder.id) }}"
                              data-ux-submit
                              class="mb-0">
                          <input type="hidden" name="card_id" value="{{ card.card_id }}">
                          <button class="btn btn-sm btn-outline-danger"
                                  type="submit"
                                  data-progress-label="Removing...">
                            Remove
                          </button>
                        </form>
                      </div>
                    </div>
                  {% endfor %}
                {% endfor %}
              </div>
            </div>

            <div class="deck-view deck-view-list">
              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle build-deck-table mb-0">
                  <thead>
                    <tr>
                      <th style="width:55%;">Card</th>
                      <th style="width:20%;">Type</th>
                      <th style="width:10%;">Qty</th>
                      <th style="width:15%;" class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for group in build_state.deck_groups %}
                      {% for card in group.cards %}
                        {% set deck_hover = card.image_large or card.image_normal or card.image_small %}
                        <tr>
                          <td>
                            <div class="card-cell">
                              {% if card.image_small %}
                                <img src="{{ card.image_small }}" alt="{{ card.name }}" loading="lazy" {% if deck_hover %}data-hover-src="{{ deck_hover }}"{% endif %}>
                              {% endif %}
                              <div>
                                <div class="card-name text-truncate" {% if deck_hover %}data-hover-src="{{ deck_hover }}"{% endif %}>{{ card.name }}</div>
                                <div class="card-sub text-truncate">{{ card.type_line }}</div>
                                <div class="d-flex flex-wrap gap-1 mt-1">
                                  {% if card.is_commander %}
                                    <span class="badge text-bg-warning">Commander</span>
                                  {% endif %}
                                  {% if card.allows_multiple %}
                                    <span class="badge text-bg-secondary">Multiple</span>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                          </td>
                          <td class="text-muted">{{ card.type_line }}</td>
                          <td class="fw-semibold">{{ card.quantity }}</td>
                          <td class="text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                              <form method="post"
                                    action="{{ url_for('views.build_remove_cards', folder_id=folder.id) }}"
                                    data-ux-submit
                                    class="mb-0">
                                <input type="hidden" name="card_id" value="{{ card.card_id }}">
                                <input type="hidden" name="delta" value="1">
                                <button class="btn btn-sm btn-outline-secondary"
                                        type="submit"
                                        {% if not card.can_decrement %}disabled title="Minimum reached"{% endif %}>
                                  -
                                </button>
                              </form>
                              <form method="post"
                                    action="{{ url_for('views.build_add_card', folder_id=folder.id) }}"
                                    data-ux-submit
                                    class="mb-0">
                                <input type="hidden" name="oracle_id" value="{{ card.oracle_id }}">
                                <button class="btn btn-sm btn-outline-secondary"
                                        type="submit"
                                        {% if not card.can_increment %}disabled title="{{ 'Commander already assigned' if card.is_commander else 'Singleton rule' }}"{% endif %}>
                                  +
                                </button>
                              </form>
                              <form method="post"
                                    action="{{ url_for('views.build_remove_cards', folder_id=folder.id) }}"
                                    data-ux-submit
                                    class="mb-0">
                                <input type="hidden" name="card_id" value="{{ card.card_id }}">
                                <button class="btn btn-sm btn-outline-danger"
                                        type="submit"
                                        data-progress-label="Removing...">
                                  Remove
                                </button>
                              </form>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="deck-view deck-view-type">
              <div class="deck-type-columns">
                {% for group in build_state.deck_groups %}
                  {% if group.count %}
                    <section class="deck-type-section">
                      <div class="deck-type-header">
                        <span>{{ group.label }}</span>
                        <span class="badge text-bg-secondary">{{ group.count }}</span>
                      </div>
                      <table class="table table-sm deck-type-table mb-0">
                        <tbody>
                          {% for card in group.cards %}
                            {% set deck_hover = card.image_large or card.image_normal or card.image_small %}
                            <tr>
                              <td class="fw-semibold">{{ card.quantity }}</td>
                              <td>
                                <span {% if deck_hover %}data-hover-src="{{ deck_hover }}"{% endif %}>{{ card.name }}</span>
                                <div class="text-muted small">{{ card.type_line }}</div>
                              </td>
                              <td class="text-end">
                                <div class="d-inline-flex align-items-center gap-2">
                                  <form method="post"
                                        action="{{ url_for('views.build_remove_cards', folder_id=folder.id) }}"
                                        data-ux-submit
                                        class="mb-0">
                                    <input type="hidden" name="card_id" value="{{ card.card_id }}">
                                    <input type="hidden" name="delta" value="1">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="submit"
                                            {% if not card.can_decrement %}disabled title="Minimum reached"{% endif %}>
                                      -
                                    </button>
                                  </form>
                                  <form method="post"
                                        action="{{ url_for('views.build_add_card', folder_id=folder.id) }}"
                                        data-ux-submit
                                        class="mb-0">
                                    <input type="hidden" name="oracle_id" value="{{ card.oracle_id }}">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="submit"
                                            {% if not card.can_increment %}disabled title="{{ 'Commander already assigned' if card.is_commander else 'Singleton rule' }}"{% endif %}>
                                      +
                                    </button>
                                  </form>
                                  <form method="post"
                                        action="{{ url_for('views.build_remove_cards', folder_id=folder.id) }}"
                                        data-ux-submit
                                        class="mb-0">
                                    <input type="hidden" name="card_id" value="{{ card.card_id }}">
                                    <button class="btn btn-sm btn-outline-danger"
                                            type="submit"
                                            data-progress-label="Removing...">
                                      Remove
                                    </button>
                                  </form>
                                </div>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </section>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% else %}
            <div class="text-muted small">No cards in this build yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="build-breakdown-btn">
    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#deckBreakdownModal">
      Deck Breakdown
    </button>
  </div>
</div>

{% from "macros/modal_wrapper.html" import wrap_modal %}
{% set commander_slot_count = folder.commander_slot_count %}
{% set commander_limit_reached = commander_slot_count >= 2 %}

{% call wrap_modal() %}
<div class="modal fade" id="commanderPickerModal" tabindex="-1" aria-labelledby="commanderPickerLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commanderPickerLabel">Commander Settings</h5>
        {% if is_mobile %}{% include "components/modal_close_btn.html" %}{% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <div>
            <div class="text-uppercase text-muted small fw-semibold">Current Commander</div>
            <div class="fs-5 fw-semibold">{{ folder.commander_name or 'Not set' }}</div>
          </div>
          <div class="ms-auto d-flex flex-wrap gap-2">
            {% if folder.commander_oracle_id %}
              <form method="post"
                    action="{{ url_for('views.clear_folder_commander', folder_id=folder.id) }}"
                    data-confirm="Clear the commander for this deck?"
                    hx-boost="false">
                <button class="btn btn-outline-danger" type="submit">Clear Commander</button>
              </form>
            {% endif %}
          </div>
        </div>
        <div class="text-muted small mt-3">Up to two commanders can be assigned. Use Add Partner to append a second commander, or Clear to reset.</div>

        <div class="mt-4">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div class="fw-semibold">Legendary creatures in this deck</div>
            <input id="cmdrFilter"
                   class="form-control form-control-sm"
                   placeholder="Filter by name..."
                   style="max-width:240px;">
          </div>
          {% if commander_candidates and commander_candidates|length %}
            <div id="cmdrList" class="legend-grid">
              {% for r in commander_candidates %}
              <div class="legend-card cmdr-item" data-name="{{ (r.name or '')|lower }}">
                <div class="legend-thumb-wrap">
                  {% if r.image %}
                    <img class="legend-thumb cmdr-thumb"
                         src="{{ r.image }}"
                         alt="{{ r.name }} thumbnail"
                         loading="lazy">
                  {% else %}
                    <div class="bg-secondary-subtle rounded" style="width:100%;height:100%;opacity:.35;"></div>
                  {% endif %}
                </div>
                <div class="legend-body">
                  <div class="legend-title" title="{{ r.name }}">{{ r.name }}</div>
                  <div class="legend-sub text-muted">{{ r.set_code|upper }} #{{ r.collector_number }}{% if r.is_foil %} - Foil{% endif %}</div>
                  <form method="post"
                        action="{{ url_for('views.set_folder_commander', folder_id=folder.id) }}"
                        class="mt-2 d-flex flex-wrap gap-2"
                        data-confirm="Set commander to {{ r.name }}?"
                        hx-boost="false">
                    <input type="hidden" name="oracle_id" value="{{ r.oracle_id }}">
                    <input type="hidden" name="name" value="{{ r.name }}">
                    <button class="btn btn-sm btn-outline-primary" type="submit" name="mode" value="replace">Set Commander</button>
                    <button class="btn btn-sm btn-outline-secondary"
                            type="submit"
                            name="mode"
                            value="append"
                            {% if commander_limit_reached %}disabled title="Already using two commanders."{% endif %}>
                      Add Partner
                    </button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted small">
              No obvious legendary creatures found in this deck.
              <a href="{{ cards_link }}">Open deck list</a>
              to add one, then return here.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endcall %}

{% call wrap_modal() %}
<div class="modal fade" id="tagPickerModal" tabindex="-1" aria-labelledby="tagPickerLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post"
            action="{{ url_for('views.set_folder_tag', folder_id=folder.id) }}"
            data-ux-submit>
        <div class="modal-header">
          <h5 class="modal-title" id="tagPickerLabel">Select a Deck Tag</h5>
          {% if is_mobile %}{% include "components/modal_close_btn.html" %}{% endif %}
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-muted small">Choose a tag to classify this deck.</div>
          <input id="tagFilter"
                 class="form-control form-control-sm mt-2"
                 placeholder="Filter tags..."
                 autocomplete="off">
          {% if folder.deck_tag %}
            {% set formatted_deck_tag = folder_tag_category ~ ': ' ~ folder.deck_tag if folder_tag_category else folder.deck_tag %}
            <div class="small text-muted mt-2">
              Current tag: <strong>{{ formatted_deck_tag }}</strong>
            </div>
          {% endif %}
          <div class="tag-group-stack d-flex flex-column gap-3 mt-3">
            {% for category, tags in deck_tag_groups.items() %}
              <div class="tag-category" data-category="{{ category|lower }}">
                <div class="text-uppercase text-muted small fw-semibold mb-2">{{ category }}</div>
                <div class="d-flex flex-wrap gap-2">
                  {% for tag in tags %}
                    <button type="submit"
                            name="tag"
                            value="{{ tag }}"
                            class="type-pill tag-option{% if folder.deck_tag == tag %} active{% endif %}"
                            data-label="{{ tag|lower }}"
                            data-category="{{ category|lower }}"
                            aria-pressed="{{ 'true' if folder.deck_tag == tag else 'false' }}">
                      {{ tag }}
                    </button>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
          <div id="tagFilterEmpty" class="text-muted small fst-italic text-center d-none">
            No tags match this filter.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
          {% if folder.deck_tag %}
            <button class="btn btn-outline-danger"
                    formaction="{{ url_for('views.clear_folder_tag', folder_id=folder.id) }}"
                    data-confirm="Clear the deck tag for this deck?">
              Clear Tag
            </button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
{% endcall %}

{% call wrap_modal() %}
<div class="modal fade" id="deckBreakdownModal" tabindex="-1" aria-labelledby="deckBreakdownLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deckBreakdownLabel">Deck Breakdown</h5>
        {% if is_mobile %}{% include "components/modal_close_btn.html" %}{% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small">Compare expected composition against the current build.</div>
        {% if build_state and build_state.breakdown_rows %}
          <div class="breakdown-summary mt-3">
            <div>
              <div class="fw-semibold mb-2">EDHREC Expected Breakdown</div>
              <div class="breakdown-pill-group">
                {% for row in build_state.breakdown_rows %}
                  <span class="breakdown-pill">
                    <span>{{ row.label }}</span>
                    <span class="badge text-bg-secondary">{{ row.expected }}</span>
                  </span>
                {% endfor %}
              </div>
            </div>
            <div>
              <div class="fw-semibold mb-2">Current Deck Breakdown</div>
              <div class="breakdown-pill-group">
                {% for row in build_state.breakdown_rows %}
                  <span class="breakdown-pill">
                    <span>{{ row.label }}</span>
                    <span class="badge text-bg-secondary">{{ row.current }}</span>
                    <span class="badge {{ row.status_class }}">{{ row.status|title }}</span>
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-muted small mt-2">Breakdown data is not available yet.</div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endcall %}

<script data-hx-preserve="true">
(function () {
  const root = document.getElementById('buildWorkspace');
  if (!root) return;
  const buttons = Array.from(document.querySelectorAll('[data-build-view-toggle]'));
  const recButtons = Array.from(document.querySelectorAll('[data-build-rec-toggle]'));
  const deckButtons = Array.from(document.querySelectorAll('[data-build-deck-toggle]'));
  const csrfToken = window.csrfToken || document.querySelector('meta[name="csrf-token"]')?.content || '';
  const collapseKey = `build-collapse:${window.location.pathname}`;
  const deckViewKey = `build-deck-view:${window.location.pathname}`;
  let collapseState = {};
  try {
    collapseState = JSON.parse(sessionStorage.getItem(collapseKey) || '{}') || {};
  } catch (err) {
    collapseState = {};
  }

  function applyMode(mode) {
    const normalized = mode === 'list' ? 'list' : 'gallery';
    root.dataset.viewMode = normalized;
    root.classList.toggle('build-view-list', normalized === 'list');
    root.classList.toggle('build-view-gallery', normalized === 'gallery');
    buttons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.buildViewToggle === normalized);
    });
  }

  function applyRecSource(source) {
    const normalized = source === 'collection' ? 'collection' : 'edhrec';
    root.dataset.recSource = normalized;
    root.classList.toggle('build-rec-collection', normalized === 'collection');
    root.classList.toggle('build-rec-edhrec', normalized === 'edhrec');
    recButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.buildRecToggle === normalized);
    });
  }

  function applyDeckView(view) {
    const normalized = ['list', 'gallery', 'breakdown'].includes(view) ? view : 'list';
    root.dataset.deckView = normalized;
    root.classList.toggle('build-deck-view-list', normalized === 'list');
    root.classList.toggle('build-deck-view-gallery', normalized === 'gallery');
    root.classList.toggle('build-deck-view-breakdown', normalized === 'breakdown');
    deckButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.buildDeckToggle === normalized);
    });
  }

  function persistMode(mode) {
    const payload = new URLSearchParams();
    payload.set('build_view_mode', mode);
    fetch(window.location.pathname, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        ...(csrfToken ? {'X-CSRFToken': csrfToken} : {}),
      },
      body: payload.toString(),
    }).catch(() => {});
  }

  function persistRecSource(source) {
    const payload = new URLSearchParams();
    payload.set('build_rec_source', source);
    fetch(window.location.pathname, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        ...(csrfToken ? {'X-CSRFToken': csrfToken} : {}),
      },
      body: payload.toString(),
    }).catch(() => {});
  }

  function persistCollapseState(id, isOpen) {
    if (!id) return;
    collapseState[id] = isOpen;
    try {
      sessionStorage.setItem(collapseKey, JSON.stringify(collapseState));
    } catch (err) {
      // ignore storage failures
    }
  }

  function applyCollapseState() {
    const collapses = Array.from(document.querySelectorAll('#buildWorkspace .rec-type-group .collapse'));
    collapses.forEach((section) => {
      const id = section.id;
      if (!id || typeof collapseState[id] !== 'boolean') return;
      const isOpen = collapseState[id];
      const toggler = document.querySelector(`[data-bs-target="#${id}"]`);
      if (window.bootstrap && window.bootstrap.Collapse) {
        const instance = window.bootstrap.Collapse.getOrCreateInstance(section, { toggle: false });
        if (isOpen) {
          instance.show();
        } else {
          instance.hide();
        }
      } else {
        section.classList.toggle('show', isOpen);
      }
      if (toggler) {
        toggler.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      }
    });

    collapses.forEach((section) => {
      const id = section.id;
      if (!id) return;
      section.addEventListener('shown.bs.collapse', () => persistCollapseState(id, true));
      section.addEventListener('hidden.bs.collapse', () => persistCollapseState(id, false));
    });
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.buildViewToggle || 'gallery';
      applyMode(mode);
      persistMode(mode);
    });
  });

  recButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.buildRecToggle || 'edhrec';
      applyRecSource(mode);
      persistRecSource(mode);
    });
  });

  deckButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.buildDeckToggle || 'list';
      applyDeckView(mode);
      try {
        sessionStorage.setItem(deckViewKey, mode);
      } catch (err) {
        // ignore storage failures
      }
    });
  });

  applyMode(root.dataset.viewMode || 'gallery');
  applyRecSource(root.dataset.recSource || 'edhrec');
  let storedDeckView = null;
  try {
    storedDeckView = sessionStorage.getItem(deckViewKey);
  } catch (err) {
    storedDeckView = null;
  }
  applyDeckView(storedDeckView || root.dataset.deckView || 'list');
  applyCollapseState();
})();
</script>

<script data-hx-preserve="true">
/* Commander picker: client-side name filter + robust image fallback */
(function(){
  const inp = document.getElementById('cmdrFilter');
  const items = Array.from(document.querySelectorAll('#cmdrList .cmdr-item'));
  const commanderModal = document.getElementById('commanderPickerModal');

  function applyCommanderFilter(value) {
    const q = (value || '').toLowerCase().trim();
    items.forEach(el => {
      const n = el.getAttribute('data-name') || '';
      el.style.display = (!q || n.includes(q)) ? '' : 'none';
    });
  }

  if (inp) {
    inp.addEventListener('input', () => applyCommanderFilter(inp.value));
  }

  if (commanderModal) {
    commanderModal.addEventListener('shown.bs.modal', () => {
      if (inp) {
        inp.focus();
        inp.select();
      }
    });
    commanderModal.addEventListener('hidden.bs.modal', () => {
      if (inp) {
        inp.value = '';
        applyCommanderFilter('');
      }
    });
  }

  const thumbs = document.querySelectorAll('.cmdr-thumb');
  thumbs.forEach(img => {
    let triedNormal = false, triedLarge = false;
    img.addEventListener('error', function onErr() {
      const src = img.getAttribute('src') || '';
      if (!triedNormal && src.includes('/small/')) {
        triedNormal = true; img.src = src.replace('/small/', '/normal/'); return;
      }
      if (!triedLarge && src.includes('/normal/')) {
        triedLarge = true; img.src = src.replace('/normal/', '/large/'); return;
      }
      img.style.display = 'none';
      const wrap = img.closest('.legend-thumb-wrap');
      if (wrap) wrap.innerHTML = '<div class="bg-secondary-subtle rounded" style="width:100%;height:100%;opacity:.35;"></div>';
      img.removeEventListener('error', onErr);
    });
  });
})();
</script>

<script data-hx-preserve="true">
/* Deck tag picker: quick filter + reset on close */
(function() {
  const modal = document.getElementById('tagPickerModal');
  if (!modal) return;
  const filterInput = modal.querySelector('#tagFilter');
  const tagButtons = Array.from(modal.querySelectorAll('.tag-option'));
  const categorySections = Array.from(modal.querySelectorAll('.tag-category'));
  const emptyState = modal.querySelector('#tagFilterEmpty');

  function applyTagFilter(value) {
    const q = (value || '').toLowerCase().trim();
    let visibleCount = 0;
    tagButtons.forEach(btn => {
      const label = (btn.dataset.label || '').toLowerCase();
      const category = (btn.dataset.category || '').toLowerCase();
      const matches = !q || label.includes(q) || category.includes(q);
      btn.classList.toggle('d-none', !matches);
      if (matches) visibleCount += 1;
    });
    categorySections.forEach(section => {
      const hasVisible = !!section.querySelector('.tag-option:not(.d-none)');
      section.classList.toggle('d-none', !hasVisible);
    });
    if (emptyState) {
      emptyState.classList.toggle('d-none', visibleCount > 0);
    }
  }

  filterInput?.addEventListener('input', () => applyTagFilter(filterInput.value));
  modal.addEventListener('hidden.bs.modal', () => {
    if (filterInput) {
      filterInput.value = '';
      applyTagFilter('');
    }
  });
})();
</script>

{% endblock %}

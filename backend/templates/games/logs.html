{% extends "base.html" %}
{% block title %}Commander Games{% endblock %}
{% block content %}
<style>
  .game-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    border: 1px solid var(--bs-border-color);
    background: var(--bs-secondary-bg);
    font-size: 0.85rem;
  }
  .game-drawer-section {
    margin-bottom: 1.25rem;
  }
  .game-seat-row {
    padding: 0.6rem 0.75rem;
    border-radius: 0.6rem;
    border: 1px solid var(--bs-border-color);
    background: rgba(255, 255, 255, 0.02);
    margin-bottom: 0.6rem;
  }
  .game-seat-row:last-child { margin-bottom: 0; }
  .game-seat-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.35rem;
  }
  .game-seat-meta .badge { font-size: 0.72rem; }
  .offcanvas-end.w-500 { width: 520px; }
  .game-action-buttons {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .game-action-buttons .btn {
    min-width: 84px;
  }
</style>

<div class="container py-4">
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1">Commander Games</h1>
      <p class="text-muted mb-0">Track pods, decks, and outcomes for future analytics.</p>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <form class="d-flex gap-2" method="get">
        <input class="form-control form-control-sm" type="search" name="q" placeholder="Search notes" value="{{ search_query or '' }}">
        <button class="btn btn-outline-secondary btn-sm" type="submit">Search</button>
      </form>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_export') }}">Export</a>
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#gameImportModal">Import</button>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_landing') }}">Back to Landing</a>
      <a class="btn btn-primary btn-sm" href="{{ url_for('views.games_new') }}">Log Game</a>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <span class="game-chip">Total games: <strong>{{ summary.total_games }}</strong></span>
    <span class="game-chip">Combo wins: <strong>{{ summary.combo_wins }}</strong></span>
  </div>

  {% if games and games|length %}
    <div class="table-responsive">
      <table class="table table-sm align-middle cards-table">
        <thead>
          <tr>
            <th>Date</th>
            <th class="text-center">Players</th>
            <th>Winner</th>
            <th>Result</th>
            <th>Notes</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for game in games %}
            <tr>
              <td class="text-nowrap">{{ game.played_at_label }}</td>
              <td class="text-center">{{ game.seat_count }}</td>
              <td>{{ game.winner_label or '—' }}</td>
              <td>
                {% if game.win_via_combo %}
                  <span class="badge text-bg-warning">Combo win</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-muted">{{ game.notes|truncate(80) if game.notes else '—' }}</td>
              <td class="text-end">
                <div class="game-action-buttons justify-content-end">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-game-preview data-game-id="{{ game.id }}">Preview</button>
                  <a class="btn btn-primary btn-sm" href="{{ url_for('views.games_detail', game_id=game.id) }}">View</a>
                  {% if game.can_edit %}
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_edit', game_id=game.id) }}">Edit</a>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info mb-0">
      No games logged yet. Use "Log Game" to record your first pod.
    </div>
  {% endif %}
</div>

<div class="modal fade" id="gameImportModal" tabindex="-1" aria-labelledby="gameImportModalLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" action="{{ url_for('views.games_import') }}" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="gameImportModalLabel">Import Game Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label" for="gameImportFile">Game log CSV file</label>
            <input class="form-control" type="file" id="gameImportFile" name="import_file" accept=".csv,text/csv">
            <div class="form-text">Exported game logs from DragonsVault can be imported here.</div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="gameImportText">Or paste CSV</label>
            <textarea class="form-control" id="gameImportText" name="import_csv" rows="6" placeholder="game_id,played_at,notes,win_via_combo,winner_seat,seat_number,..."></textarea>
            <div class="form-text">Decks missing from your account are stored as manual snapshots.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Import Logs</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end w-500" tabindex="-1" id="gameDrawer" aria-labelledby="gameDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="gameDrawerLabel">Game Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" id="gameDrawerBody">
    <div class="text-muted small">Select a game to preview details.</div>
  </div>
</div>

<script>
  (function () {
    const drawerEl = document.getElementById('gameDrawer');
    const bodyEl = document.getElementById('gameDrawerBody');
    if (!drawerEl || !bodyEl) return;

    const gameRows = {{ games|tojson }};
    const gameMap = new Map(gameRows.map(game => [String(game.id), game]));

    const esc = (value) => {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const renderSeat = (seat, winViaCombo) => {
      const winnerBadge = seat.is_winner ? '<span class="badge text-bg-success">Winner</span>' : '';
      const comboBadge = seat.is_winner && winViaCombo ? '<span class="badge text-bg-warning">Combo</span>' : '';
      const bracket = seat.bracket_level ? `${esc(seat.bracket_level)}${seat.bracket_label ? ' · ' + esc(seat.bracket_label) : ''}` : '—';
      return `
        <div class="game-seat-row">
          <div class="game-seat-meta">
            <span class="badge text-bg-secondary">Seat ${esc(seat.seat_number)}</span>
            <span class="text-muted small">Turn ${esc(seat.turn_order)}</span>
            ${winnerBadge}
            ${comboBadge}
          </div>
          <div class="fw-semibold">${esc(seat.player_label)}</div>
          <div class="small text-muted">${esc(seat.deck_name)}${seat.commander_name ? ' · ' + esc(seat.commander_name) : ''}</div>
          <div class="small text-muted">Bracket: ${bracket}</div>
        </div>
      `;
    };

    const renderGame = (game) => {
      const seatsMarkup = (game.seats || []).map(seat => renderSeat(seat, game.win_via_combo)).join('');
      const winnerLine = game.winner_label ? `<div><strong>Winner:</strong> ${esc(game.winner_label)}</div>` : '';
      const notesLine = game.notes ? `<div class="mt-2"><strong>Notes:</strong> ${esc(game.notes)}</div>` : '';
      return `
        <div class="game-drawer-section">
          <div class="fw-semibold">Played</div>
          <div class="text-muted">${esc(game.played_at_label)}</div>
          ${winnerLine}
          ${notesLine}
        </div>
        <div class="game-drawer-section">
          <div class="fw-semibold mb-2">Seats</div>
          ${seatsMarkup || '<div class="text-muted small">No seats recorded.</div>'}
        </div>
      `;
    };

    let drawerInstance = null;
    const openDrawer = (gameId) => {
      const game = gameMap.get(String(gameId));
      if (!game) return;
      bodyEl.innerHTML = renderGame(game);
      if (!drawerInstance && window.bootstrap) {
        drawerInstance = new bootstrap.Offcanvas(drawerEl, { backdrop: false, scroll: true });
      }
      if (drawerInstance) {
        drawerInstance.show();
      } else {
        drawerEl.classList.add('show');
        drawerEl.style.visibility = 'visible';
      }
    };

    document.querySelectorAll('[data-game-preview]').forEach((btn) => {
      btn.addEventListener('click', () => openDrawer(btn.dataset.gameId));
    });
  })();
</script>
{% endblock %}

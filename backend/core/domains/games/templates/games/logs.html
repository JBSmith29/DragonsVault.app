{% extends "base.html" %}
{% block title %}Commander Games{% endblock %}
{% block content %}
<style>
  .game-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    border: 1px solid var(--bs-border-color);
    background: var(--bs-secondary-bg);
    font-size: 0.85rem;
  }
  .game-drawer-section {
    margin-bottom: 1.25rem;
  }
  .game-seat-row {
    padding: 0.6rem 0.75rem;
    border-radius: 0.6rem;
    border: 1px solid var(--bs-border-color);
    background: rgba(255, 255, 255, 0.02);
    margin-bottom: 0.6rem;
  }
  .game-seat-row:last-child { margin-bottom: 0; }
  .game-seat-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.35rem;
  }
  .game-seat-meta .badge { font-size: 0.72rem; }
  .offcanvas-end.w-500 { width: 520px; }
  .game-action-buttons {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .game-action-buttons .btn {
    min-width: 84px;
  }
  .game-action-buttons form {
    margin: 0;
  }
  .game-bulk-bar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.8rem;
    border-radius: 0.75rem;
    border: 1px solid var(--bs-border-color);
    background: rgba(255, 255, 255, 0.03);
    margin-bottom: 0.75rem;
  }
  .game-bulk-bar.d-none {
    display: none;
  }
  .game-select-col {
    width: 36px;
  }
  .commander-hover {
    cursor: pointer;
    text-decoration: underline dotted;
    text-underline-offset: 2px;
  }
  th[data-sort-type] {
    cursor: pointer;
    user-select: none;
  }
  th[data-sort-type] .sort-indicator {
    margin-left: 0.35rem;
    font-size: 0.7rem;
    opacity: 0.6;
  }
  th[aria-sort="ascending"] .sort-indicator::after {
    content: "▲";
  }
  th[aria-sort="descending"] .sort-indicator::after {
    content: "▼";
  }
  th[data-sort-type]:not([aria-sort]) .sort-indicator::after {
    content: "↕";
  }
</style>

<div class="container py-4">
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1">Commander Games</h1>
      <p class="text-muted mb-0">Track pods, decks, and outcomes for future analytics.</p>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <form class="d-flex gap-2" method="get">
        <input class="form-control form-control-sm" type="search" name="q" placeholder="Search notes" value="{{ search_query or '' }}">
        <button class="btn btn-outline-secondary btn-sm" type="submit">Search</button>
      </form>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_export') }}" data-hx-boost="false">Export</a>
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#gameImportModal">Import</button>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_landing') }}">Back to Landing</a>
      <a class="btn btn-primary btn-sm" href="{{ url_for('views.games_new') }}">Log Game</a>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <span class="game-chip">Total games: <strong>{{ summary.total_games }}</strong></span>
    <span class="game-chip">Combo wins: <strong>{{ summary.combo_wins }}</strong></span>
  </div>

  {% if games and games|length %}
    {% set editable_games = games|selectattr('can_edit')|list %}
    {% set has_editable = editable_games|length > 0 %}
    {% if has_editable %}
      <form id="gameBulkForm" method="post" action="{{ url_for('views.games_bulk_delete') }}" onsubmit="return confirm('Delete the selected game logs?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="game_ids" id="gameBulkIds" value="">
        <div class="game-bulk-bar d-none" id="gameBulkBar">
          <div class="text-muted small">Selected <span id="gameBulkCount">0</span> games</div>
          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="gameBulkClear">Clear</button>
            <button class="btn btn-outline-danger btn-sm" type="submit" id="gameBulkDelete" disabled>Delete selected</button>
          </div>
        </div>
      </form>
    {% endif %}
    <div class="table-responsive">
      <table class="table table-sm align-middle cards-table" id="gameLogsTable">
        <thead>
          <tr>
            <th class="text-center game-select-col">
              {% if has_editable %}
                <input class="form-check-input" type="checkbox" id="gameSelectAll" aria-label="Select all games">
              {% endif %}
            </th>
            <th data-sort-type="date">Date<span class="sort-indicator"></span></th>
            <th class="text-center" data-sort-type="number">Players<span class="sort-indicator"></span></th>
            <th data-sort-type="text">Winner<span class="sort-indicator"></span></th>
            <th data-sort-type="number">Result<span class="sort-indicator"></span></th>
            <th data-sort-type="text">Notes<span class="sort-indicator"></span></th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for game in games %}
            <tr>
              <td class="text-center">
                {% if game.can_edit %}
                  <input class="form-check-input" type="checkbox" data-game-select value="{{ game.id }}" aria-label="Select game {{ game.id }}">
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-nowrap" data-sort-value="{{ game.played_at_iso or '' }}">{{ game.played_at_label }}</td>
              <td class="text-center" data-sort-value="{{ game.seat_count }}">{{ game.seat_count }}</td>
              <td data-sort-value="{{ game.winner_label or '' }}">{{ game.winner_label or '—' }}</td>
              <td data-sort-value="{{ '1' if game.win_via_combo else '0' }}">
                {% if game.win_via_combo %}
                  <span class="badge text-bg-warning">Combo win</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-muted" data-sort-value="{{ game.notes or '' }}">{{ game.notes|truncate(80) if game.notes else '—' }}</td>
              <td class="text-end">
                <div class="game-action-buttons justify-content-end">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-game-preview data-game-id="{{ game.id }}">Preview</button>
                  <a class="btn btn-primary btn-sm" href="{{ url_for('views.games_detail', game_id=game.id) }}">View</a>
                  {% if game.can_edit %}
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_edit', game_id=game.id) }}">Edit</a>
                    <form method="post" action="{{ url_for('views.games_delete', game_id=game.id) }}" onsubmit="return confirm('Delete this game log?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info mb-0">
      No games logged yet. Use "Log Game" to record your first pod.
    </div>
  {% endif %}
</div>

<div class="modal fade" id="gameImportModal" tabindex="-1" aria-labelledby="gameImportModalLabel" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" action="{{ url_for('views.games_import') }}" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="gameImportModalLabel">Import Game Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label" for="gameImportFile">Game log CSV file</label>
            <input class="form-control" type="file" id="gameImportFile" name="import_file" accept=".csv,text/csv">
            <div class="form-text">Exported game logs from DragonsVault can be imported here.</div>
            <div class="mt-2">
              <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.games_import_template') }}" data-hx-boost="false">Download CSV template</a>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="gameImportText">Or paste CSV</label>
            <textarea class="form-control" id="gameImportText" name="import_csv" rows="6" placeholder="played_at,notes,win_via_combo,winner_seat,seat_count,seat_1_player_name,seat_1_deck_name,..."></textarea>
            <div class="form-text">Decks missing from your account are stored as manual snapshots. Dates should be YYYY-MM-DD.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Import Logs</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end w-500" tabindex="-1" id="gameDrawer" aria-labelledby="gameDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="gameDrawerLabel">Game Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" id="gameDrawerBody">
    <div class="text-muted small">Select a game to preview details.</div>
  </div>
</div>

<script>
  (function () {
    const drawerEl = document.getElementById('gameDrawer');
    const bodyEl = document.getElementById('gameDrawerBody');
    if (!drawerEl || !bodyEl) return;

    const gameRows = {{ games|tojson }};
    const gameMap = new Map(gameRows.map(game => [String(game.id), game]));

    const esc = (value) => {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const renderSeat = (seat, winViaCombo) => {
      const winnerBadge = seat.is_winner ? '<span class="badge text-bg-success">Winner</span>' : '';
      const comboBadge = seat.is_winner && winViaCombo ? '<span class="badge text-bg-warning">Combo</span>' : '';
      const bracket = seat.bracket_level ? `${esc(seat.bracket_level)}${seat.bracket_label ? ' · ' + esc(seat.bracket_label) : ''}` : '—';
      const commanderAttr = seat.commander_image ? ` data-hover-src="${esc(seat.commander_image)}"` : '';
      const commander = seat.commander_name
        ? ` · <span class="commander-hover"${commanderAttr} data-card-name="${esc(seat.commander_name)}">${esc(seat.commander_name)}</span>`
        : '';
      return `
        <div class="game-seat-row">
          <div class="game-seat-meta">
            <span class="badge text-bg-secondary">Seat ${esc(seat.seat_number)}</span>
            <span class="text-muted small">Turn ${esc(seat.turn_order)}</span>
            ${winnerBadge}
            ${comboBadge}
          </div>
          <div class="fw-semibold">${esc(seat.player_label)}</div>
          <div class="small text-muted">${esc(seat.deck_name)}${commander}</div>
          <div class="small text-muted">Bracket: ${bracket}</div>
        </div>
      `;
    };

    const renderGame = (game) => {
      const seatsMarkup = (game.seats || []).map(seat => renderSeat(seat, game.win_via_combo)).join('');
      const winnerLine = game.winner_label ? `<div><strong>Winner:</strong> ${esc(game.winner_label)}</div>` : '';
      const notesLine = game.notes ? `<div class="mt-2"><strong>Notes:</strong> ${esc(game.notes)}</div>` : '';
      return `
        <div class="game-drawer-section">
          <div class="fw-semibold">Played</div>
          <div class="text-muted">${esc(game.played_at_label)}</div>
          ${winnerLine}
          ${notesLine}
        </div>
        <div class="game-drawer-section">
          <div class="fw-semibold mb-2">Seats</div>
          ${seatsMarkup || '<div class="text-muted small">No seats recorded.</div>'}
        </div>
      `;
    };

    let drawerInstance = null;
    const openDrawer = (gameId) => {
      const game = gameMap.get(String(gameId));
      if (!game) return;
      bodyEl.innerHTML = renderGame(game);
      if (!drawerInstance && window.bootstrap) {
        drawerInstance = new bootstrap.Offcanvas(drawerEl, { backdrop: false, scroll: true });
      }
      if (drawerInstance) {
        drawerInstance.show();
      } else {
        drawerEl.classList.add('show');
        drawerEl.style.visibility = 'visible';
      }
    };

    document.querySelectorAll('[data-game-preview]').forEach((btn) => {
      btn.addEventListener('click', () => openDrawer(btn.dataset.gameId));
    });
  })();
</script>
<script>
  (function () {
    const bulkBar = document.getElementById('gameBulkBar');
    const bulkCount = document.getElementById('gameBulkCount');
    const bulkIdsInput = document.getElementById('gameBulkIds');
    const bulkDelete = document.getElementById('gameBulkDelete');
    const bulkClear = document.getElementById('gameBulkClear');
    const selectAll = document.getElementById('gameSelectAll');
    const checkboxes = Array.from(document.querySelectorAll('[data-game-select]'));

    if (!bulkBar || !bulkCount || !bulkIdsInput || !bulkDelete || !checkboxes.length) {
      return;
    }

    const updateBulk = () => {
      const selected = checkboxes.filter((cb) => cb.checked).map((cb) => cb.value);
      bulkIdsInput.value = selected.join(',');
      bulkCount.textContent = String(selected.length);
      bulkBar.classList.toggle('d-none', selected.length === 0);
      bulkDelete.disabled = selected.length === 0;
      if (selectAll) {
        selectAll.checked = selected.length > 0 && selected.length === checkboxes.length;
        selectAll.indeterminate = selected.length > 0 && selected.length < checkboxes.length;
      }
    };

    checkboxes.forEach((cb) => cb.addEventListener('change', updateBulk));
    selectAll?.addEventListener('change', () => {
      const checked = selectAll.checked;
      checkboxes.forEach((cb) => {
        cb.checked = checked;
      });
      updateBulk();
    });
    bulkClear?.addEventListener('click', () => {
      checkboxes.forEach((cb) => {
        cb.checked = false;
      });
      if (selectAll) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
      updateBulk();
    });
  })();
</script>
<script>
  (function () {
    const table = document.getElementById('gameLogsTable');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const headers = Array.from(table.querySelectorAll('th[data-sort-type]'));
    if (!tbody || !headers.length) return;

    const getCellValue = (row, index) => {
      const cell = row.children[index];
      if (!cell) return '';
      if (cell.dataset && cell.dataset.sortValue !== undefined) {
        return cell.dataset.sortValue;
      }
      return (cell.textContent || '').trim();
    };

    const parseValue = (value, type) => {
      if (type === 'number') {
        const parsed = parseFloat(value);
        return Number.isNaN(parsed) ? 0 : parsed;
      }
      if (type === 'date') {
        const parsed = Date.parse(value);
        return Number.isNaN(parsed) ? 0 : parsed;
      }
      return (value || '').toString().toLowerCase();
    };

    const sortRows = (index, type, direction) => {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const aVal = parseValue(getCellValue(a, index), type);
        const bVal = parseValue(getCellValue(b, index), type);
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
      rows.forEach(row => tbody.appendChild(row));
    };

    headers.forEach((th) => {
      th.addEventListener('click', () => {
        const index = th.cellIndex;
        const type = th.dataset.sortType || 'text';
        const current = th.getAttribute('aria-sort');
        const nextDirection = current === 'ascending' ? 'desc' : 'asc';
        headers.forEach((header) => header.removeAttribute('aria-sort'));
        th.setAttribute('aria-sort', nextDirection === 'asc' ? 'ascending' : 'descending');
        sortRows(index, type, nextDirection);
      });
    });
  })();
</script>
{% endblock %}

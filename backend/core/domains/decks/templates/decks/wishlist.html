{% extends "base.html" %}
{% block title %}Wishlist - DragonsVault{% endblock %}
{% block content %}

<h1 class="mb-3">Wishlist</h1>

<style>
  .wishlist-view-toggle .btn {
    min-width: 80px;
  }
  .wishlist-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1rem;
  }
  .wishlist-card {
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    background: rgba(15, 23, 42, 0.55);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    height: 100%;
  }
  .wishlist-card .thumb {
    width: 100%;
    aspect-ratio: 3 / 4;
    border-radius: 10px;
    overflow: hidden;
    background: rgba(255,255,255,0.05);
  }
  .wishlist-card .thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .wishlist-card .meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: .5rem;
  }
  .wishlist-card .status {
    min-width: 110px;
  }
  .wishlist-card .actions {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }
  /* Floating action bar (mirrors cards page) */
  .card-action-bar {
    position: fixed;
    bottom: 1rem;
    left: 0;
    right: 0;
    z-index: 1030;
    pointer-events: none;
  }
  .card-action-bar .bar-surface {
    pointer-events: auto;
    margin: 0 auto;
    max-width: 1100px;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color-translucent);
    border-radius: 1rem;
    box-shadow: 0 .75rem 2.5rem rgba(0,0,0,.25);
    padding: .85rem 1rem;
  }
  .card-action-bar .bar-title { font-weight: 600; font-size: .95rem; }
  .card-action-bar .muted { color: var(--bs-secondary-color); }
  .card-action-bar .bar-grid { row-gap: .5rem; }
  .page-section-with-bar { padding-bottom: 160px; }
</style>

<div id="wishlistPageSection">

{# Safe fallbacks if counts are missing from the view #}
{% set total_items = total if total is defined else (items|length) %}
{% set open_cnt = open_count if open_count is defined else (items|selectattr('status','equalto','open')|list|length) %}
{% set acq_cnt = acquired if acquired is defined else (items|selectattr('status','equalto','acquired')|list|length) %}
{% set ord_cnt = ordered_count if ordered_count is defined else (items|selectattr('status','equalto','ordered')|list|length) %}
{% set fetch_cnt = to_fetch_count if to_fetch_count is defined else (items|selectattr('status','equalto','to_fetch')|list|length) %}
{% set removed_cnt = removed if removed is defined else (items|selectattr('status','equalto','removed')|list|length) %}
{% set sort = sort if sort is defined else (request.args.get('sort') or 'name') %}
{% set direction = direction if direction is defined else (request.args.get('dir') or 'asc') %}
{% set status_filter = (status_filter if status_filter is defined else (request.args.get('status') or 'all'))|lower %}

<!-- Summary + actions -->
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div class="d-flex gap-2 flex-wrap">
    <span class="badge text-bg-primary">Open: {{ open_cnt }}</span>
    <span class="badge text-bg-warning">To Fetch: {{ fetch_cnt }}</span>
    <span class="badge text-bg-info">Ordered: {{ ord_cnt }}</span>
    <span class="badge text-bg-success">Acquired: {{ acq_cnt }}</span>
    <span class="badge text-bg-secondary">Removed: {{ removed_cnt }}</span>
    <span class="badge text-bg-dark">Total: {{ total_items }}</span>
  </div>

  <div class="d-flex align-items-center gap-2">
    <a href="{{ url_for('views.list_checker') }}" class="btn btn-outline-theme btn-sm">List Checker</a>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="wishlistExportBtn" data-export-url="{{ url_for('views.wishlist_export') }}">Export CSV</button>
    <button type="button" class="btn btn-outline-primary btn-sm" id="wishlistCopyBtn">Copy All to Clipboard</button>
    <div class="btn-group btn-group-sm wishlist-view-toggle" role="group" aria-label="Wishlist view toggle">
      <button type="button" class="btn btn-outline-theme active" data-view-mode="list">List</button>
      <button type="button" class="btn btn-outline-theme" data-view-mode="gallery">Gallery</button>
    </div>
  </div>
</div>

<!-- Filters + search -->
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <ul class="nav nav-pills small" id="wl-filters">
    <li class="nav-item"><a class="nav-link {% if status_filter == 'all' %}active{% endif %}" href="{{ url_for('views.wishlist', status=None, sort=sort, dir=direction, per=per_page, page=1) }}" data-filter="all">All</a></li>
    <li class="nav-item"><a class="nav-link {% if status_filter == 'open' %}active{% endif %}" href="{{ url_for('views.wishlist', status='open', sort=sort, dir=direction, per=per_page, page=1) }}" data-filter="open">Open</a></li>
    <li class="nav-item"><a class="nav-link {% if status_filter == 'to_fetch' %}active{% endif %}" href="{{ url_for('views.wishlist', status='to_fetch', sort=sort, dir=direction, per=per_page, page=1) }}" data-filter="to_fetch">To Fetch</a></li>
    <li class="nav-item"><a class="nav-link {% if status_filter == 'ordered' %}active{% endif %}" href="{{ url_for('views.wishlist', status='ordered', sort=sort, dir=direction, per=per_page, page=1) }}" data-filter="ordered">Ordered</a></li>
    <li class="nav-item"><a class="nav-link {% if status_filter == 'acquired' %}active{% endif %}" href="{{ url_for('views.wishlist', status='acquired', sort=sort, dir=direction, per=per_page, page=1) }}" data-filter="acquired">Acquired</a></li>
    <li class="nav-item"><a class="nav-link {% if status_filter == 'removed' %}active{% endif %}" href="{{ url_for('views.wishlist', status='removed', sort=sort, dir=direction, per=per_page, page=1) }}" data-filter="removed">Removed</a></li>
  </ul>

  <div class="input-group input-group-sm" style="max-width: 360px;">
    <span class="input-group-text">Search</span>
    <input type="search" class="form-control" id="wl-search" placeholder="Card name..." />
    <button class="btn btn-outline-secondary" type="button" id="wl-clear">Clear</button>
  </div>
</div>

<!-- List view -->
<div class="table-responsive" id="wl-list-view">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <div class="text-muted small">
      {% if total_items > 0 %}
        Showing {{ start }}-{{ end }} of {{ total_items }}
      {% else %}
        No wishlist items yet.
      {% endif %}
    </div>
    {% if pages > 1 %}
      <nav aria-label="Wishlist pagination">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not prev_url %}disabled{% endif %}">
            <a class="page-link" href="{{ prev_url or '#' }}" aria-label="Previous page" {% if not prev_url %}tabindex="-1" aria-disabled="true"{% endif %}>&laquo;</a>
          </li>
          {% for num, href in page_urls %}
            <li class="page-item {% if num == page %}active{% endif %}">
              <a class="page-link" href="{{ href }}">{{ num }}</a>
            </li>
          {% endfor %}
          <li class="page-item {% if not next_url %}disabled{% endif %}">
            <a class="page-link" href="{{ next_url or '#' }}" aria-label="Next page" {% if not next_url %}tabindex="-1" aria-disabled="true"{% endif %}>&raquo;</a>
          </li>
        </ul>
      </nav>
    {% endif %}
  </div>

    {% set name_dir = 'asc' if sort!='name' or direction=='desc' else 'desc' %}
  {% set color_dir = 'asc' if sort!='color' or direction=='desc' else 'desc' %}
  {% set location_dir = 'asc' if sort!='location' or direction=='desc' else 'desc' %}
  {% set requested_dir = 'asc' if sort!='requested' or direction=='desc' else 'desc' %}
  {% set missing_dir = 'asc' if sort!='missing' or direction=='desc' else 'desc' %}
  {% set status_dir = 'asc' if sort!='status' or direction=='desc' else 'desc' %}
  {% set order_dir = 'asc' if sort!='order' or direction=='desc' else 'desc' %}
  {% macro sort_url(field, dir_value) -%}
    {{ url_for('views.wishlist', status=status_filter if status_filter != 'all' else None, sort=field, dir=dir_value, per=per_page, page=1) }}
  {%- endmacro %}

  <table class="table table-sm align-middle table-hover cards-table" id="wl-table">
    <thead>
      <tr>
        <th style="width:36px;" class="text-center">
          <input class="form-check-input" type="checkbox" id="wlSelectAll" aria-label="Select all wishlist items">
        </th>
        <th style="min-width:260px;"><a href="{{ sort_url('name', name_dir) }}">Card</a></th>
        <th class="text-center" style="width:120px;"><a href="{{ sort_url('color', color_dir) }}">Color ID</a></th>
        <th style="width:220px;"><a href="{{ sort_url('location', location_dir) }}">Location</a></th>
        <th class="text-center" style="width:120px;"><a href="{{ sort_url('requested', requested_dir) }}">Requested</a></th>
        <th class="text-center" style="width:110px;"><a href="{{ sort_url('missing', missing_dir) }}">Missing</a></th>
        <th style="width:120px;"><a href="{{ sort_url('status', status_dir) }}">Status</a></th>
        <th style="width:240px;"><a href="{{ sort_url('order', order_dir) }}">Order</a></th>
        <th style="width:260px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr class="wishlist-row" data-wl-item data-status="{{ it.status|default('open') }}" data-name="{{ it.name|lower }}">
        <td class="text-center">
          <input
            type="checkbox"
            class="form-check-input wl-select"
            value="{{ it.id }}"
            aria-label="Select {{ it.name }}"
            data-mark-url="{{ url_for('views.wishlist_mark', item_id=it.id) }}"
            data-delete-url="{{ url_for('views.wishlist_delete', item_id=it.id) }}"
          >
        </td>
        <td>
          {% set back_to = request.full_path %}
          {% set wl_href = (
            url_for('views.scryfall_print_detail', sid=it.scryfall_id, return_to=back_to)
            if it.scryfall_id
            else url_for('views.scryfall_resolve_by_name', name=it.name, return_to=back_to)
          ) %}
          <a
            class="link-light link-underline-opacity-25 wl-card-link fw-semibold"
            href="{{ wl_href }}"
            data-scry-id="{{ it.scryfall_id or '' }}"
            data-name="{{ it.name }}"
          >{{ it.name }}</a>
          <div class="small text-muted">
            {% if it.created_at %}Added {{ it.created_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
          </div>
        </td>

        <td class="text-center">
          {% set colors = it.display_color_identity %}
          {% if colors %}
            {% include "includes/_color_identity.html" %}
          {% else %}
            <span class="text-muted">&mdash;</span>
          {% endif %}
        </td>

        <td>
          {% set folder_list = it.display_source_folders if it.display_source_folders is defined else it.source_folders_list %}
          {% if folder_list %}
            <div class="d-flex flex-wrap gap-1">
              {% for entry in folder_list %}
                {% set entry_label = entry.label if entry.label is defined else entry.name %}
                <span class="badge bg-secondary-subtle text-secondary" data-folder-badge>
                  {{ entry_label }}{% if entry.qty is not none %} x{{ entry.qty }}{% endif %}
                </span>
              {% endfor %}
            </div>
          {% else %}
            <span class="text-muted">&mdash;</span>
          {% endif %}
        </td>

        <td class="text-center">
          <form method="post"
                action="{{ url_for('views.wishlist_update', item_id=it.id) }}"
                class="d-inline-flex gap-1 justify-content-center align-items-center"
                hx-boost="false">
            <input type="number"
                   name="requested_qty"
                   class="form-control form-control-sm text-center"
                   value="{{ it.requested_qty or 0 }}"
                   min="0" style="max-width:80px;">
            <button type="submit" class="btn btn-primary btn-sm">Save</button>
          </form>
        </td>

        <td class="text-center">
          {% if (it.missing_qty or 0) > 0 %}
            <span class="badge rounded-pill text-bg-danger">x{{ it.missing_qty }}</span>
          {% else %}
            <span class="text-muted">&mdash;</span>
          {% endif %}
        </td>

        {% set st = it.status or 'open' %}
        {% set order_ref = it.order_ref or '' %}
        {% set order_is_url = order_ref.startswith('http://') or order_ref.startswith('https://') %}

        <td>
          {% if st == 'acquired' %}
            <span class="badge text-bg-success">Acquired</span>
          {% elif st == 'ordered' %}
            <span class="badge text-bg-info">Ordered</span>
          {% elif st == 'to_fetch' %}
            <span class="badge text-bg-warning">To Fetch</span>
          {% elif st == 'removed' %}
            <span class="badge text-bg-secondary">Removed</span>
          {% else %}
            <span class="badge text-bg-primary">Open</span>
          {% endif %}
        </td>

        <td data-order-cell>
          <div class="d-flex align-items-center gap-2">
            <div class="wl-order-display small" data-order-display>
              {% if order_ref %}
                {% if order_is_url %}
                  <a class="link-light link-underline-opacity-25"
                     href="{{ order_ref }}"
                     target="_blank"
                     rel="noopener">Order link</a>
                {% else %}
                  {{ order_ref }}
                {% endif %}
              {% else %}
                <span class="text-muted">&mdash;</span>
              {% endif %}
            </div>
            {% if order_ref %}
              <button type="button"
                      class="btn btn-outline-secondary btn-sm wl-order-toggle"
                      data-order-toggle
                      aria-label="Edit order"
                      title="Edit order">Edit</button>
            {% else %}
              <button type="button"
                      class="btn btn-outline-secondary btn-sm wl-order-toggle"
                      data-order-toggle
                      aria-label="Add order"
                      title="Add order">Add</button>
            {% endif %}
          </div>
          <form method="post"
                action="{{ url_for('views.wishlist_order_ref', item_id=it.id) }}"
                class="d-flex flex-wrap align-items-center gap-1 mt-1 d-none"
                data-order-form
                hx-boost="false">
            <input type="text"
                   name="order_ref"
                   class="form-control form-control-sm"
                   placeholder="Order # or URL"
                   value="{{ order_ref }}"
                   style="min-width: 160px; max-width: 260px;">
            <button type="submit" class="btn btn-outline-primary btn-sm">Save</button>
          </form>
        </td>

        <td>
          <div class="wl-row-actions d-flex align-items-center gap-2 flex-wrap">
            <form method="post"
                  action="{{ url_for('views.wishlist_mark', item_id=it.id) }}"
                  class="d-inline-flex align-items-center"
                  hx-boost="false">
              {% set status_label = st.replace('_', ' ')|title %}
              <div class="dropdown dv-select wl-status-select" data-dv-select="wishlist-status-{{ it.id }}" data-wl-status-select>
                <input type="hidden" name="status" data-dv-select-input value="{{ st }}">
                <button class="btn dv-select-toggle d-inline-flex align-items-center gap-2"
                        type="button"
                        id="wlStatusToggle-{{ it.id }}"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                        aria-labelledby="wlStatusToggle-{{ it.id }}">
                  <span data-dv-select-label>{{ status_label }}</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dv-select-menu" aria-labelledby="wlStatusToggle-{{ it.id }}">
                  <li><button class="dropdown-item {% if st == 'open' %}active{% endif %}" type="button" data-dv-select-option data-value="open" data-label="Open">Open</button></li>
                  <li><button class="dropdown-item {% if st == 'to_fetch' %}active{% endif %}" type="button" data-dv-select-option data-value="to_fetch" data-label="To Fetch">To Fetch</button></li>
                  <li><button class="dropdown-item {% if st == 'ordered' %}active{% endif %}" type="button" data-dv-select-option data-value="ordered" data-label="Ordered">Ordered</button></li>
                  <li><button class="dropdown-item {% if st == 'acquired' %}active{% endif %}" type="button" data-dv-select-option data-value="acquired" data-label="Acquired">Acquired</button></li>
                  <li><button class="dropdown-item {% if st == 'removed' %}active{% endif %}" type="button" data-dv-select-option data-value="removed" data-label="Removed">Removed</button></li>
                </ul>
              </div>
            </form>
            <form method="post"
                  action="{{ url_for('views.wishlist_delete', item_id=it.id) }}"
                  class="d-inline"
                  hx-boost="false"
                  data-confirm='Delete "{{ it.name }}" from wishlist?'>
              <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Gallery view -->
<div id="wl-gallery-view" class="d-none">
  <div class="wishlist-gallery">
    {% for it in items %}
    <div class="wishlist-card" data-wl-item data-status="{{ it.status|default('open') }}" data-name="{{ it.name|lower }}">
      <div class="thumb">
        <img
          src="{{ (it.image_url or static_url('img/card-placeholder.svg')) | e }}"
          alt="{{ it.name }}"
          class="wishlist-thumb-img"
          data-scry-id="{{ it.scryfall_id or '' }}"
          data-name="{{ it.name }}"
          loading="lazy"
        >
      </div>
      <div class="meta">
        <div class="fw-semibold text-truncate">{{ it.name }}</div>
        <span class="badge text-bg-secondary status">{{ it.status|default('Open')|title }}</span>
      </div>
      <div class="text-muted small">Requested: {{ it.requested_qty or it.quantity or 1 }}</div>
      {% set colors = it.display_color_identity %}
      {% if colors %}
        <div class="text-muted small d-flex align-items-center gap-2">
          <span>Color:</span>
          {% include "includes/_color_identity.html" %}
        </div>
      {% endif %}
      {% set folder_list = it.display_source_folders if it.display_source_folders is defined else it.source_folders_list %}
      {% if folder_list %}
      <div class="text-muted small">Location:
        {% for entry in folder_list %}
          {% set entry_label = entry.label if entry.label is defined else entry.name %}
          <span class="badge bg-secondary-subtle text-secondary">
            {{ entry_label }}{% if entry.qty is not none %} x{{ entry.qty }}{% endif %}
          </span>
        {% endfor %}
      </div>
      {% endif %}
      {% set st = it.status or 'open' %}
      {% set order_ref = it.order_ref or '' %}
      {% set order_is_url = order_ref.startswith('http://') or order_ref.startswith('https://') %}
      <div class="d-flex flex-column gap-1" data-order-cell>
        <div class="d-flex align-items-center gap-2">
          <div class="wl-order-display small" data-order-display>
            {% if order_ref %}
              {% if order_is_url %}
                <a class="link-light link-underline-opacity-25"
                   href="{{ order_ref }}"
                   target="_blank"
                   rel="noopener">Order link</a>
              {% else %}
                Order: {{ order_ref }}
              {% endif %}
            {% else %}
              <span class="text-muted">Order: &mdash;</span>
            {% endif %}
          </div>
          {% if order_ref %}
            <button type="button"
                    class="btn btn-outline-secondary btn-sm wl-order-toggle"
                    data-order-toggle
                    aria-label="Edit order"
                    title="Edit order">Edit</button>
          {% else %}
            <button type="button"
                    class="btn btn-outline-secondary btn-sm wl-order-toggle"
                    data-order-toggle
                    aria-label="Add order"
                    title="Add order">Add</button>
          {% endif %}
        </div>
        <form method="post"
              action="{{ url_for('views.wishlist_order_ref', item_id=it.id) }}"
              class="d-flex flex-column gap-1 d-none"
              data-order-form
              hx-boost="false">
          <input type="text"
                 name="order_ref"
                 class="form-control form-control-sm"
                 placeholder="Order # or URL"
                 value="{{ order_ref }}">
          <button type="submit" class="btn btn-outline-primary btn-sm align-self-start">Save</button>
        </form>
      </div>
      <div class="actions">
        <form method="post"
              action="{{ url_for('views.wishlist_mark', item_id=it.id) }}"
              class="d-inline-flex align-items-center"
              hx-boost="false">
          {% set status_label = st.replace('_', ' ')|title %}
          <div class="dropdown dv-select wl-status-select" data-dv-select="wishlist-status-card-{{ it.id }}" data-wl-status-select>
            <input type="hidden" name="status" data-dv-select-input value="{{ st }}">
            <button class="btn dv-select-toggle d-inline-flex align-items-center gap-2"
                    type="button"
                    id="wlStatusCardToggle-{{ it.id }}"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    aria-labelledby="wlStatusCardToggle-{{ it.id }}">
              <span data-dv-select-label>{{ status_label }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu" aria-labelledby="wlStatusCardToggle-{{ it.id }}">
              <li><button class="dropdown-item {% if st == 'open' %}active{% endif %}" type="button" data-dv-select-option data-value="open" data-label="Open">Open</button></li>
              <li><button class="dropdown-item {% if st == 'to_fetch' %}active{% endif %}" type="button" data-dv-select-option data-value="to_fetch" data-label="To Fetch">To Fetch</button></li>
              <li><button class="dropdown-item {% if st == 'ordered' %}active{% endif %}" type="button" data-dv-select-option data-value="ordered" data-label="Ordered">Ordered</button></li>
              <li><button class="dropdown-item {% if st == 'acquired' %}active{% endif %}" type="button" data-dv-select-option data-value="acquired" data-label="Acquired">Acquired</button></li>
              <li><button class="dropdown-item {% if st == 'removed' %}active{% endif %}" type="button" data-dv-select-option data-value="removed" data-label="Removed">Removed</button></li>
            </ul>
          </div>
        </form>
        <form method="post"
              action="{{ url_for('views.wishlist_delete', item_id=it.id) }}"
              class="d-inline"
              data-confirm='Delete "{{ it.name }}"?'>
          <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Bulk actions bar -->
<div class="card-action-bar d-none" id="wishlistActionBar">
  <div class="bar-surface">
    <div class="row align-items-center bar-grid">
      <div class="col-12 col-md-4 d-flex flex-column">
        <div class="bar-title">Bulk actions</div>
        <div class="small muted" id="wlBulkSummary">Select wishlist items to enable actions</div>
      </div>
      <div class="col-12 col-md">
        <label class="form-label mb-1" for="wlBulkStatusToggle">Move to</label>
        <div class="dropdown dv-select w-100" data-dv-select="wishlist-bulk-status" id="wlBulkStatusWrapper">
          <input type="hidden" id="wlBulkStatusInput" data-dv-select-input value="">
          <button class="btn dv-select-toggle w-100 justify-content-between"
                  type="button"
                  id="wlBulkStatusToggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  aria-labelledby="wlBulkStatusToggle">
            <span data-dv-select-label>Choose status...</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="wlBulkStatusToggle">
            <li><button class="dropdown-item active" type="button" data-dv-select-option data-value="" data-label="Choose status...">Choose status...</button></li>
            <li><button class="dropdown-item" type="button" data-dv-select-option data-value="open" data-label="Open">Open</button></li>
            <li><button class="dropdown-item" type="button" data-dv-select-option data-value="to_fetch" data-label="To Fetch">To Fetch</button></li>
            <li><button class="dropdown-item" type="button" data-dv-select-option data-value="ordered" data-label="Ordered">Ordered</button></li>
            <li><button class="dropdown-item" type="button" data-dv-select-option data-value="acquired" data-label="Acquired">Acquired</button></li>
            <li><button class="dropdown-item" type="button" data-dv-select-option data-value="removed" data-label="Removed">Removed</button></li>
          </ul>
        </div>
      </div>
      <div class="col-12 col-md-auto d-flex gap-2 justify-content-end flex-wrap">
        <button type="button" class="btn btn-primary btn-sm" id="wlBulkApplyBtn" disabled>Apply</button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="wlBulkDeleteBtn" disabled>Delete</button>
      </div>
    </div>
  </div>
</div>

</div>

<style>
  #wl-filters .nav-link { cursor: pointer; }

  .wl-row-actions { max-width: 100%; }
  .wl-status-select .dv-select-toggle {
    padding: .25rem .6rem;
    font-size: .85rem;
  }
  .wl-status-select .dv-select-menu { min-width: 160px; }
  .wl-order-display {
    display: inline-block;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .wl-order-toggle { line-height: 1; padding: .25rem .65rem; }
  .wishlist-thumb { width: 120px; min-width: 120px; max-width: 120px; }
  .wishlist-thumb img { object-fit: contain; width: 100%; height: auto; display: block; }
  .wishlist-row td { padding-top: .9rem; padding-bottom: .9rem; }
  .wl-select { cursor: pointer; }
</style>

<script nonce="{{ csp_nonce() }}">
(function () {
  const FALLBACK_IMG = "{{ static_url('img/card-back-placeholder.png') }}";

  // -------- Filter + search --------
  const table = document.getElementById('wl-table');
  const gallery = document.getElementById('wl-gallery-view');
  const search = document.getElementById('wl-search');
  const clearBtn = document.getElementById('wl-clear');
  const filters = document.getElementById('wl-filters');

  function applyFilter() {
    const active = filters.querySelector('.nav-link.active');
    const mode = active ? active.dataset.filter : 'all'; // all | open | to_fetch | ordered | acquired | removed
    const q = (search?.value || '').trim().toLowerCase();

    document.querySelectorAll('[data-wl-item]').forEach(tr => {
      const status = tr.getAttribute('data-status') || 'open';
      const name = tr.getAttribute('data-name') || '';
      const statusOk = (mode === 'all') || (status === mode);
      const searchOk = !q || name.includes(q);
      const visible = statusOk && searchOk;
      tr.style.display = visible ? '' : 'none';
      if (!visible) {
        const cb = tr.querySelector('.wl-select');
        if (cb && cb.checked) {
          cb.checked = false;
          cb.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }
    });
  }

  if (filters) {
    filters.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-filter]');
      if (!a) return;
      const href = a.getAttribute('href') || '';
      if (href && href !== '#') {
        return;
      }
      e.preventDefault();
      filters.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
      a.classList.add('active');
      applyFilter();
    });
  }
  search?.addEventListener('input', applyFilter);
  clearBtn?.addEventListener('click', () => { search.value = ''; applyFilter(); });
  applyFilter();

  // -------- Thumb images --------
  const thumbCache = new Map();

  async function fetchThumbByScryId(sid) {
    if (thumbCache.has(sid)) return thumbCache.get(sid);
    try {
      const r = await fetch(`/api/scryfall/print/${encodeURIComponent(sid)}`);
      if (!r.ok) throw 0;
      const data = await r.json();
      const img = data?.image || {};
      const src = img.normal || img.small || img.large || null;
      thumbCache.set(sid, src);
      return src;
    } catch {
      thumbCache.set(sid, null);
      return null;
    }
  }

  async function hydrateThumb(img) {
    if (!img) return;
    const sid = img.dataset.scryId;
    let src = null;
    if (sid) {
      src = await fetchThumbByScryId(sid);
    }
    img.src = src || FALLBACK_IMG;
  }

  document.querySelectorAll('.wishlist-thumb-img').forEach((img) => hydrateThumb(img));

  // Copy wishlist names to clipboard
  (function(){
    const btn = document.getElementById('wishlistCopyBtn');
    if (!btn) return;
    const original = btn.textContent;
    btn.addEventListener('click', async () => {
      const items = Array.from(document.querySelectorAll('[data-wl-item]'));
      const lines = items.map(row => {
        const name = (row.dataset.name || '').trim();
        const fetchBadges = Array.from(row.querySelectorAll('[data-folder-badge]')).map(b => b.textContent.trim()).filter(Boolean);
        if (!name) return null;
        return fetchBadges.length ? `${name} â€” ${fetchBadges.join(', ')}` : name;
      }).filter(Boolean);
      if (!lines.length) {
        btn.textContent = 'Nothing to copy';
        setTimeout(() => btn.textContent = original, 1200);
        return;
      }
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(lines.join('\n'));
        } else {
          throw new Error('Clipboard unavailable');
        }
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = original, 1000);
      } catch (err) {
        btn.textContent = 'Copy failed';
        setTimeout(() => btn.textContent = original, 1300);
      }
    });
  })();

  // Export CSV via fetch (stay on page)
  (function(){
    const btn = document.getElementById('wishlistExportBtn');
    if (!btn) return;
    const exportUrl = btn.dataset.exportUrl;
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'Exporting...';
      try {
        const resp = await fetch(exportUrl, { method: 'GET' });
        if (!resp.ok) throw new Error('Export failed');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'wishlist.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        btn.textContent = 'Exported';
        setTimeout(() => btn.textContent = original, 1200);
      } catch (err) {
        btn.textContent = 'Export failed';
        setTimeout(() => btn.textContent = original, 1400);
      } finally {
        btn.disabled = false;
      }
    });
  })();

  // View toggle
  (function(){
    const buttons = Array.from(document.querySelectorAll('[data-view-mode]'));
    if (!buttons.length) return;
    const listView = document.getElementById('wl-list-view');
    const galleryView = document.getElementById('wl-gallery-view');
    const STORAGE_KEY = 'dv:wishlist:view';

    function applyView(mode){
      buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.viewMode === mode));
      if (listView) listView.classList.toggle('d-none', mode !== 'list');
      if (galleryView) galleryView.classList.toggle('d-none', mode !== 'gallery');
      try { localStorage.setItem(STORAGE_KEY, mode); } catch (_) {}
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        applyView(btn.dataset.viewMode || 'list');
      });
    });

    let saved = 'list';
    try { saved = localStorage.getItem(STORAGE_KEY) || 'list'; } catch (_) {}
    applyView(saved);
  })();

  // -------- Order refs --------
  document.querySelectorAll('[data-order-toggle]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const cell = btn.closest('[data-order-cell]');
      if (!cell) return;
      const form = cell.querySelector('[data-order-form]');
      const display = cell.querySelector('[data-order-display]');
      if (!form) return;
      const wasHidden = form.classList.contains('d-none');
      form.classList.toggle('d-none');
      if (display) display.classList.toggle('d-none', wasHidden);
      if (wasHidden) {
        const input = form.querySelector('input[name="order_ref"]');
        if (input) {
          input.focus();
          input.select();
        }
      }
    });
  });

  // -------- Row status dropdowns --------
  document.querySelectorAll('[data-wl-status-select]').forEach((wrapper) => {
    wrapper.addEventListener('dv-select:change', () => {
      const form = wrapper.closest('form');
      if (form) form.submit();
    });
  });

  // -------- Bulk selection + actions --------
  const selectAll = document.getElementById('wlSelectAll');
  const bulkBar = document.getElementById('wishlistActionBar');
  const bulkSummary = document.getElementById('wlBulkSummary');
  const bulkStatusWrapper = document.getElementById('wlBulkStatusWrapper');
  const bulkStatusInput = document.getElementById('wlBulkStatusInput');
  const bulkApplyBtn = document.getElementById('wlBulkApplyBtn');
  const bulkDeleteBtn = document.getElementById('wlBulkDeleteBtn');
  const pageSection = document.getElementById('wishlistPageSection');
  const itemCheckboxes = Array.from(document.querySelectorAll('.wl-select'));

  function getBulkStatus() {
    const viaInput = (bulkStatusInput?.value || '').trim();
    const viaDataset = (bulkStatusWrapper?.dataset.dvSelectValue || '').trim();
    return viaInput || viaDataset || '';
  }

  function selectedItems() {
    return itemCheckboxes.filter(cb => cb.checked);
  }

  function updateBulkUI() {
    const selected = selectedItems();
    const count = selected.length;
    if (bulkSummary) {
      bulkSummary.textContent = count
        ? `${count} item${count === 1 ? '' : 's'} selected`
        : 'Select wishlist items to enable actions';
    }
    if (bulkBar) bulkBar.classList.toggle('d-none', count === 0);
    if (pageSection) pageSection.classList.toggle('page-section-with-bar', count > 0);
    if (bulkApplyBtn) bulkApplyBtn.disabled = !count || !getBulkStatus();
    if (bulkDeleteBtn) bulkDeleteBtn.disabled = !count;
    if (!selectAll) return;
    if (count === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (count === itemCheckboxes.length) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
  }

  selectAll?.addEventListener('change', () => {
    const checked = !!selectAll.checked;
    itemCheckboxes.forEach(cb => {
      cb.checked = checked;
      cb.dispatchEvent(new Event('change', { bubbles: true }));
    });
    selectAll.indeterminate = false;
  });

  itemCheckboxes.forEach(cb => cb.addEventListener('change', updateBulkUI));
  bulkStatusWrapper?.addEventListener('dv-select:change', updateBulkUI);
  bulkStatusWrapper?.addEventListener('dv-select:ready', updateBulkUI);
  updateBulkUI();

  async function postAction(url, payload) {
    const body = new URLSearchParams(payload || {});
    const headers = { ...(window.csrfHeader || {}) };
    if (!headers['X-CSRFToken']) {
      const token = document.querySelector('meta[name="csrf-token"]')?.content;
      if (token) headers['X-CSRFToken'] = token;
    }
    const res = await fetch(url, {
      method: 'POST',
      headers,
      body,
      credentials: 'same-origin',
    });
    return res.ok;
  }

  async function applyStatus(status) {
    const selected = selectedItems();
    if (!selected.length || !status) return;
    const promises = selected.map(cb => postAction(cb.dataset.markUrl, { status }));
    await Promise.all(promises);
    if (window.DV && window.DV.scroll && typeof window.DV.scroll.reload === 'function') {
      window.DV.scroll.reload();
    } else {
      window.location.reload();
    }
  }

  async function applyDelete() {
    const selected = selectedItems();
    if (!selected.length) return;
    if (!confirm(`Delete ${selected.length} item(s) from wishlist?`)) return;
    const promises = selected.map(cb => postAction(cb.dataset.deleteUrl, {}));
    await Promise.all(promises);
    if (window.DV && window.DV.scroll && typeof window.DV.scroll.reload === 'function') {
      window.DV.scroll.reload();
    } else {
      window.location.reload();
    }
  }

  bulkApplyBtn?.addEventListener('click', () => applyStatus(getBulkStatus()));
  bulkDeleteBtn?.addEventListener('click', applyDelete);
})();
</script>

{% endblock %}

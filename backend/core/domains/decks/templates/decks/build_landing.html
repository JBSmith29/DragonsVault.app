{% extends "base.html" %}

{% block title %}build-a-deck{% endblock %}

{% block content %}
<style>
  /* Ensure the build drawer overlays the high z-index build-landing header cards. */
  #buildDrawer.offcanvas {
    z-index: 6100;
    width: 620px;
    max-width: 100vw;
  }
  /* Match deck drawer curve styling when cache-busting is delayed. */
  #buildDrawer .deck-curve-grid { display:flex; gap:0.6rem; justify-content:center; flex-wrap:wrap; }
  #buildDrawer .deck-curve-col { width:48px; text-align:center; }
  #buildDrawer .deck-curve-bar {
    position:relative;
    height:140px;
    border:1px solid var(--bs-border-color);
    border-radius:0.65rem;
    background:rgba(255, 255, 255, 0.05);
    display:flex;
    align-items:flex-end;
    justify-content:center;
    overflow:hidden;
  }
  #buildDrawer .deck-curve-fill {
    width:100%;
    background:var(--bs-primary);
    opacity:0.3;
    border-radius:0.65rem 0.65rem 0 0;
    transition:height 0.15s ease;
  }
  #buildDrawer .deck-curve-count {
    position:absolute;
    top:0.35rem;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0, 0, 0, 0.6);
    color:#fff;
    font-weight:700;
    padding:0.1rem 0.45rem;
    border-radius:0.35rem;
    font-size:0.75rem;
  }
  #buildDrawer .deck-curve-label {
    margin-top:0.35rem;
    font-size:0.8rem;
    color:var(--bs-secondary-color);
    font-weight:600;
  }
</style>
<div class="container-fluid">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h2 mb-1">build-a-deck</h1>
      <p class="text-muted mb-0">choose a commander and optional theme to begin a proxy build session.</p>
    </div>
  </div>

  {% if not edhrec_ready %}
    <div class="alert alert-warning">
      Build recommendations are unavailable until EDHREC data has been cached.
    </div>
  {% endif %}

  <div class="row g-4 build-landing-top">
    <div class="col-12 col-xl-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">start from what you want</h5>
          <p class="text-muted small mb-3">themes adjust recommendations later. nothing is committed yet.</p>

          <form method="post" action="{{ url_for('views.build_start') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-3">
              <label class="form-label small text-muted">Commander</label>
              <input type="text" class="form-control" name="commander_name" placeholder="Enter commander name" autocomplete="off">
            </div>

            <div class="mb-3">
              <label class="form-label small text-muted">Build name (optional)</label>
              <input type="text" class="form-control" name="build_name" placeholder="Enter build name" autocomplete="off">
            </div>

            <div class="mb-3">
              <label class="form-label small text-muted">Optional deck tag</label>
              <div class="dropdown dv-select w-100 build-landing-select" data-dv-select="build-tag" data-dv-select-portal="body" data-bs-auto-close="outside">
                <input type="hidden" name="deck_tag" data-dv-select-input value="{{ selected_tag }}">
                <button class="btn dv-select-toggle dropdown-toggle w-100 justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <span data-dv-select-label>{{ selected_tag or "Select a tag..." }}</span>
                </button>
                <ul class="dropdown-menu dv-select-menu">
                  <li class="px-2 pb-2">
                    <input type="text" class="form-control form-control-sm dv-select-search" placeholder="Search tags..." autocomplete="off" data-dv-select-search>
                  </li>
                  <li>
                    <button class="dropdown-item{% if not selected_tag %} active{% endif %}" type="button" data-dv-select-option data-value="" data-label="Select a tag...">Select a tag...</button>
                  </li>
                  {% for category, tags in tag_groups.items() %}
                    <li class="dropdown-header text-uppercase small text-muted" data-dv-select-category>{{ category }}</li>
                    {% for tag in tags %}
                      <li>
                        <button class="dropdown-item{% if selected_tag == tag %} active{% endif %}" type="button" data-dv-select-option data-value="{{ tag }}" data-label="{{ tag }}">{{ tag }}</button>
                      </li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            </div>

            {% if recommended_tags %}
              <div class="d-flex flex-wrap gap-2 mb-3">
                {% for tag in recommended_tags %}
                  <a class="badge rounded-pill bg-info-subtle text-info-emphasis text-decoration-none" href="{{ url_for('views.build_landing', tag=tag.tag) }}">
                    {{ tag.tag }} · {{ tag.owned_count }}
                  </a>
                {% endfor %}
              </div>
            {% endif %}

            <button class="btn btn-primary w-100" type="submit">begin exploration</button>
            <p class="text-muted small mt-3 mb-0 build-proxy-note">this workspace uses proxy cards until you explicitly commit changes.</p>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">find commanders by deck tag</h5>
          <p class="text-muted small mb-3">filter a tag to see commanders that fit cards you already own.</p>

          <form method="get" action="{{ url_for('views.build_landing') }}" class="mb-3">
            <div class="dropdown dv-select w-100 build-landing-select" data-dv-select="build-tag-filter" data-dv-select-portal="body" data-auto-submit="true" data-bs-auto-close="outside">
              <input type="hidden" name="tag" data-dv-select-input value="{{ selected_tag }}">
              <button class="btn dv-select-toggle dropdown-toggle w-100 justify-content-between" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span data-dv-select-label>{{ selected_tag or "Select a tag..." }}</span>
              </button>
              <ul class="dropdown-menu dv-select-menu">
                <li class="px-2 pb-2">
                  <input type="text" class="form-control form-control-sm dv-select-search" placeholder="Search tags..." autocomplete="off" data-dv-select-search>
                </li>
                <li>
                  <button class="dropdown-item{% if not selected_tag %} active{% endif %}" type="button" data-dv-select-option data-value="" data-label="Select a tag...">Select a tag...</button>
                </li>
                {% for category, tags in tag_groups.items() %}
                  <li class="dropdown-header text-uppercase small text-muted" data-dv-select-category>{{ category }}</li>
                  {% for tag in tags %}
                    <li>
                      <button class="dropdown-item{% if selected_tag == tag %} active{% endif %}" type="button" data-dv-select-option data-value="{{ tag }}" data-label="{{ tag }}">{{ tag }}</button>
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </form>

          {% if selected_tag %}
            {% if tag_commanders %}
              <div class="row g-3">
                {% for rec in tag_commanders %}
                  <div class="col-12 col-md-6">
                    <div class="card h-100 bg-body-tertiary border-0">
                      {% if rec.image %}
                        <img src="{{ rec.image }}" class="card-img-top build-landing-commander-img" alt="{{ rec.name }}">
                      {% endif %}
                      <div class="card-body">
                        <h6 class="card-title mb-1">{{ rec.name }}</h6>
                        <p class="text-muted small mb-2">you own {{ rec.owned_count }} synergy cards</p>
                        <form method="post" action="{{ url_for('views.build_start') }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="commander_oracle_id" value="{{ rec.oracle_id }}">
                          <input type="hidden" name="deck_tag" value="{{ selected_tag }}">
                          <button class="btn btn-sm btn-outline-primary w-100" type="submit">build this commander</button>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">no commanders found for this tag in your collection.</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">select a tag to see collection-based commander fits.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm mt-4">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="card-title mb-1">current builds</h5>
          <p class="text-muted small mb-0">resume active proxy builds and continue refining.</p>
        </div>
      </div>
      {% if current_builds %}
        <div class="table-responsive">
          <table class="table table-sm align-middle cards-table">
            <thead>
              <tr>
                <th>deck</th>
                <th>deck tag</th>
                <th>owner</th>
                <th>color identity</th>
                <th class="col-ci-pips">pips</th>
                <th class="text-start">bracket</th>
                <th class="text-end">qty</th>
                <th class="text-end">actions</th>
              </tr>
            </thead>
            <tbody>
              {% for build in current_builds %}
                <tr class="deck-row build-row"
                    data-build-id="{{ build.id }}"
                    data-build-name="{{ (build.build_name or build.commander_name)|e }}"
                    data-commander-name="{{ build.commander_name|e }}"
                    data-build-tags="{{ build.tags|join(', ')|e }}"
                    data-card-count="{{ build.card_count }}"
                    data-updated="{{ build.updated_label|e }}"
                    data-image="{{ build.image or '' }}"
                    data-colors="{{ build.colors|join(',') }}">
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      {% if build.image %}
                        <img src="{{ build.image }}" class="build-session-thumb" alt="{{ build.commander_name }}">
                      {% else %}
                        <div class="build-session-thumb build-session-thumb-placeholder">?</div>
                      {% endif %}
                      <div>
                        <div class="fw-semibold">
                          <a class="text-decoration-none" href="{{ url_for('views.build_session', session_id=build.id) }}">
                            {{ build.build_name or build.commander_name }}
                          </a>
                        </div>
                        <div class="text-muted small">
                          commander:
                          <a class="text-muted text-decoration-none" href="{{ url_for('views.build_session', session_id=build.id) }}">
                            {{ build.commander_name }}
                          </a>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if build.tags %}
                      <div class="d-flex flex-wrap gap-1">
                        {% for tag in build.tags %}
                          <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">{{ tag }}</span>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="text-muted small">none</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="text-muted small">{{ current_user.display_name or current_user.username or 'you' }}</span>
                  </td>
                  <td>
                    {% if build.color_label %}
                      <span class="text-muted small">{{ build.color_label }}</span>
                    {% else %}
                      <span class="text-muted small">—</span>
                    {% endif %}
                  </td>
                  <td class="col-ci-pips">
                    {% set colors = build.colors %}
                    {% include "includes/_color_identity.html" %}
                  </td>
                  <td class="text-start">
                    {% if build.bracket_level %}
                      <div class="deck-bracket">
                        <span class="badge bracket-badge" data-bracket="{{ build.bracket_level }}">{{ build.bracket_level }}</span>
                        {% if build.bracket_label %}
                          <span class="label text-muted">{{ build.bracket_label }}</span>
                        {% endif %}
                        {% if build.bracket_score is not none %}
                          <span class="text-muted small">Score {{ build.bracket_score }}</span>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="text-end">{{ build.card_count }}</td>
                  <td class="text-end">
                    <div class="d-inline-flex gap-2">
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('views.build_session', session_id=build.id) }}">resume</a>
                      <form method="post" action="{{ url_for('views.build_session_delete', session_id=build.id) }}" onsubmit="return confirm('Delete this build session? This cannot be undone.');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">no active builds yet.</p>
      {% endif %}
    </div>
  </div>

</div>

<!-- Drawer moved outside the landing container to avoid stacking/overflow clipping. -->
<div class="offcanvas offcanvas-end w-500"
     tabindex="-1"
     id="buildDrawer"
     aria-labelledby="buildDrawerLabel"
     data-bs-backdrop="false"
     data-bs-scroll="true">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="buildDrawerLabel">build details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" id="buildDrawerBody"></div>
</div>

<script nonce="{{ csp_nonce() }}">
(function(){
  const drawerEl = document.getElementById('buildDrawer');
  const bodyEl = document.getElementById('buildDrawerBody');
  if (!drawerEl || !bodyEl || typeof bootstrap === 'undefined') return;
  const instance = new bootstrap.Offcanvas(drawerEl, { backdrop: false, scroll: true });

  function buildPill(label, count, icon){
    const span = document.createElement('span');
    span.className = 'deck-drawer-pill';
    const labelWrap = document.createElement('span');
    if (icon){
      const img = document.createElement('img');
      img.src = icon;
      img.alt = label;
      img.className = 'mana mana-sm';
      labelWrap.appendChild(img);
    } else {
      const textNode = document.createElement('span');
      textNode.textContent = label;
      labelWrap.appendChild(textNode);
    }
    span.appendChild(labelWrap);
    const value = document.createElement('span');
    value.textContent = count;
    span.appendChild(value);
    return span;
  }

  function appendBadges(section, title, pills){
    if (!pills || !pills.length) return;
    const heading = document.createElement('h6');
    heading.className = 'text-uppercase text-muted fw-semibold mb-2';
    heading.textContent = title;
    section.appendChild(heading);
    const grid = document.createElement('div');
    grid.className = 'deck-drawer-grid';
    pills.forEach(p => grid.appendChild(p));
    section.appendChild(grid);
  }

  function appendList(section, title, items){
    if (!items || !items.length) return;
    const heading = document.createElement('h6');
    heading.className = 'text-uppercase text-muted fw-semibold mb-2';
    heading.textContent = title;
    section.appendChild(heading);
    const list = document.createElement('ul');
    list.className = 'deck-drawer-list';
    items.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = item;
      list.appendChild(li);
    });
    section.appendChild(list);
  }

  function renderSummary(data){
    bodyEl.innerHTML = '';
    const deck = data.deck || {};
    const commander = data.commander || {};
    const bracket = data.bracket || {};

    const topSection = document.createElement('div');
    topSection.className = 'deck-drawer-section';
    const headerRow = document.createElement('div');
    headerRow.className = 'd-flex align-items-center gap-3';

    const imgWrap = document.createElement('div');
    imgWrap.className = 'rounded overflow-hidden';
    if (commander.image || commander.hover) {
      const img = document.createElement('img');
      img.src = commander.image || commander.hover;
      img.alt = commander.name || 'Commander';
      img.style.width = '72px';
      img.style.height = 'auto';
      img.className = 'rounded';
      imgWrap.appendChild(img);
    } else {
      const placeholder = document.createElement('div');
      placeholder.className = 'bg-secondary-subtle rounded';
      placeholder.style.width = '72px';
      placeholder.style.height = '96px';
      placeholder.style.opacity = '.25';
      imgWrap.appendChild(placeholder);
    }
    headerRow.appendChild(imgWrap);

    const meta = document.createElement('div');
    meta.className = 'min-w-0';
    const title = document.createElement('div');
    title.className = 'h5 mb-1 text-truncate';
    title.textContent = deck.name || 'Build';
    meta.appendChild(title);
    if (deck.tag_label) {
      const tagLine = document.createElement('div');
      tagLine.className = 'small text-muted text-truncate';
      tagLine.textContent = deck.tag_label;
      meta.appendChild(tagLine);
    }
    if (commander.name) {
      const cmdLine = document.createElement('div');
      cmdLine.className = 'small text-muted text-truncate';
      cmdLine.textContent = 'Commander: ' + commander.name;
      meta.appendChild(cmdLine);
    }
    if (data.total_cards) {
      const totalLine = document.createElement('div');
      totalLine.className = 'small text-muted';
      totalLine.textContent = data.total_cards + ' total cards';
      meta.appendChild(totalLine);
    }
    headerRow.appendChild(meta);
    topSection.appendChild(headerRow);
    bodyEl.appendChild(topSection);

    if (bracket.level) {
      const bracketSection = document.createElement('div');
      bracketSection.className = 'deck-drawer-section';
      const badgeRow = document.createElement('div');
      badgeRow.className = 'd-flex align-items-center gap-2 mb-2';
      const badge = document.createElement('span');
      badge.className = 'badge bracket-badge';
      badge.textContent = bracket.level;
      badge.dataset.bracket = bracket.level;
      badgeRow.appendChild(badge);
      if (bracket.label) {
        const label = document.createElement('span');
        label.className = 'fw-semibold';
        label.textContent = bracket.label;
        badgeRow.appendChild(label);
      }
      if (typeof bracket.score === 'number') {
        const score = document.createElement('span');
        score.className = 'text-muted small';
        score.textContent = 'Score ' + bracket.score;
        badgeRow.appendChild(score);
      }
      bracketSection.appendChild(badgeRow);
      const points = bracket.summary_points || [];
      if (points.length) {
        const list = document.createElement('ul');
        list.className = 'deck-drawer-list';
        points.forEach(point => {
          const li = document.createElement('li');
          li.textContent = point;
          list.appendChild(li);
        });
        bracketSection.appendChild(list);
      } else {
        const empty = document.createElement('div');
        empty.className = 'text-muted small';
        empty.textContent = 'No summary available.';
        bracketSection.appendChild(empty);
      }
      bodyEl.appendChild(bracketSection);
    }

    const typePills = (data.type_breakdown || []).map(item => buildPill(item[0] + ":", item[1], null));
    const typeSection = document.createElement('div');
    typeSection.className = 'deck-drawer-section';
    appendBadges(typeSection, 'Types', typePills);
    if (typeSection.children.length > 0) bodyEl.appendChild(typeSection);

    const manaCostPills = (data.mana_pip_dist || []).map(item => buildPill(item.color, item.count, item.icon));
    const costSection = document.createElement('div');
    costSection.className = 'deck-drawer-section';
    appendBadges(costSection, 'Color Distribution', manaCostPills);
    if (costSection.children.length > 0) bodyEl.appendChild(costSection);

    const deckColors = new Set((data.deck_colors || []).map(color => String(color || '').toUpperCase()));
    const manaSourcePills = (data.land_mana_sources || [])
      .filter(item => {
        const code = String(item.color || item.code || '').toUpperCase();
        if (!code) return false;
        return deckColors.has(code) || code === 'C';
      })
      .map(item => {
        let label = item.label || item.color || "C";
        let icon = item.icon;
        if ((label === "C" || label.toUpperCase() === "COLORLESS") && !icon) {
          icon = "{{ static_url('symbols/C.svg') }}";
          label = "C";
        }
        return buildPill(label + ":", item.count, icon);
      });
    if (manaSourcePills.length) {
      const sourceSection = document.createElement('div');
      sourceSection.className = 'deck-drawer-section';
      appendBadges(sourceSection, 'Mana Sources', manaSourcePills);
      bodyEl.appendChild(sourceSection);
    }

    const curveRows = data.curve_rows || [];
    if (curveRows.length) {
      const section = document.createElement('div');
      section.className = 'deck-drawer-section';
      const heading = document.createElement('h6');
      heading.className = 'text-uppercase text-muted fw-semibold mb-2';
      heading.textContent = 'Mana Curve';
      section.appendChild(heading);
      const grid = document.createElement('div');
      grid.className = 'deck-curve-grid';
      const maxPct = Math.max(...curveRows.map(row => row.pct || 0));
      curveRows.forEach(row => {
        const col = document.createElement('div');
        col.className = 'deck-curve-col';
        const bar = document.createElement('div');
        bar.className = 'deck-curve-bar';
        const fill = document.createElement('div');
        fill.className = 'deck-curve-fill';
        const pct = row.pct || 0;
        const height = maxPct ? Math.max(12, (pct / maxPct) * 100) : 0;
        fill.style.height = height + '%';
        bar.appendChild(fill);
        const count = document.createElement('div');
        count.className = 'deck-curve-count';
        count.textContent = row.count;
        bar.appendChild(count);
        col.appendChild(bar);
        const label = document.createElement('div');
        label.className = 'deck-curve-label';
        label.textContent = row.label;
        col.appendChild(label);
        grid.appendChild(col);
      });
      section.appendChild(grid);
      bodyEl.appendChild(section);
    }

    const combos = (bracket.spellbook_combos || []);
    if (combos.length) {
      const comboSection = document.createElement('div');
      comboSection.className = 'deck-drawer-section';
      const heading = document.createElement('h6');
      heading.className = 'text-uppercase text-muted fw-semibold mb-2';
      heading.textContent = 'Commander Spellbook Combos';
      comboSection.appendChild(heading);
      const list = document.createElement('div');
      list.className = 'd-flex flex-column gap-2';
      combos.forEach(combo => {
        const wrapper = document.createElement(combo.url ? 'a' : 'div');
        wrapper.classList.add('deck-drawer-combo-wrapper');
        if (combo.url) {
          wrapper.href = combo.url;
          wrapper.target = '_blank';
          wrapper.rel = 'noopener';
          wrapper.classList.add('text-decoration-none', 'text-reset');
        }
        const tags = Array.isArray(combo.tags) ? combo.tags : [];
        if (tags.length) {
          const tagGroup = document.createElement('div');
          tagGroup.className = 'deck-drawer-tags';
          tags.forEach(label => {
            const tagEl = document.createElement('span');
            tagEl.className = 'deck-drawer-tag';
            tagEl.textContent = label;
            tagGroup.appendChild(tagEl);
          });
          wrapper.appendChild(tagGroup);
        }
        const pill = document.createElement('div');
        pill.className = 'deck-drawer-combo';
        const cards = combo.cards || [];
        cards.forEach((card, index) => {
          const span = document.createElement('span');
          span.textContent = card.name;
          if (card.hover) {
            span.setAttribute('data-hover-src', card.hover);
          }
          pill.appendChild(span);
          if (index < cards.length - 1) {
            const plus = document.createElement('span');
            plus.textContent = '+';
            pill.appendChild(plus);
          }
        });
        wrapper.appendChild(pill);
        list.appendChild(wrapper);
      });
      comboSection.appendChild(list);
      bodyEl.appendChild(comboSection);
    }

    if (deck.id) {
      const actionSection = document.createElement('div');
      actionSection.className = 'deck-drawer-section';
      const link = document.createElement('a');
      link.className = 'btn btn-outline-primary w-100';
      link.href = '/decks/build/' + deck.id;
      link.textContent = 'resume build';
      actionSection.appendChild(link);
      bodyEl.appendChild(actionSection);
    }
  }

  async function openDrawer(buildId){
    if (!buildId) return;
    bodyEl.innerHTML = '<div class="text-center py-5 text-muted">Loading build insight...</div>';
    bodyEl.scrollTop = 0;
    drawerEl.scrollTop = 0;
    instance.show();
    try {
      const resp = await fetch('/api/build-sessions/' + buildId + '/insight');
      if (!resp.ok) throw new Error('Failed to load build insight');
      const payload = await resp.json();
      renderSummary(payload);
      bodyEl.scrollTop = 0;
      drawerEl.scrollTop = 0;
    } catch (err) {
      const message = err && err.message ? err.message : 'Unable to load build details.';
      bodyEl.innerHTML = '<div class="text-center text-danger py-5">' + message + '</div>';
      bodyEl.scrollTop = 0;
      drawerEl.scrollTop = 0;
    }
  }

  document.querySelectorAll('.build-row').forEach(row => {
    row.addEventListener('click', (event) => {
      if (event.target.closest('a, button, form')) return;
      const buildId = row.dataset.buildId;
      openDrawer(buildId);
    });
    row.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      if (event.target.closest('a, button, form')) return;
      event.preventDefault();
      const buildId = row.dataset.buildId;
      openDrawer(buildId);
    });
  });
})();
</script>
{% endblock %}

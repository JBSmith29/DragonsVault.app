{% extends "base.html" %}
{% block title %}Dashboard - DragonsVault{% endblock %}
{% from "shared/components/macros.html" import commander_chip %}
{% block content %}
<style>
  .section-label {
    font-size: 0.8rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--bs-secondary-color);
    margin: 0.25rem 0 0.5rem;
  }

  .quick-tile {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 76px;
    padding: 1rem;
  }

  .quick-tile .qi {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
  }

  .icon-circle {
    width: 36px;
    height: 36px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--bs-tertiary-bg);
    color: var(--bs-primary);
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--bs-secondary-color);
  }

  .stat-number {
    font-size: clamp(1.75rem, 2.3vw + 1rem, 2.75rem);
    font-weight: 700;
    line-height: 1;
  }

  .tile.deck-tile {
    padding: 1.25rem 1.5rem;
  }

  @media (min-width: 768px) {
    .tile.deck-tile {
      padding: 1.5rem 1.75rem;
    }
  }

  .deck-name {
    font-weight: 700;
    font-size: 1.05rem;
  }

  .badge.text-bg-secondary {
    font-size: 0.9rem;
    padding: 0.35em 0.6em;
  }
</style>

<div class="page-section">
  <div class="section-label">Quick actions</div>
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block" href="{{ url_for('views.scryfall_browser') }}">
        <span class="qi"><i class="bi bi-search"></i> Scryfall Cards</span>
      </a>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block" href="{{ url_for('views.list_checker') }}">
        <span class="qi"><i class="bi bi-list-check"></i> List Checker</span>
      </a>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block" href="{{ url_for('views.wishlist') }}">
        <span class="qi"><i class="bi bi-heart"></i> Wishlist</span>
      </a>
    </div>
  </div>
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block" href="{{ url_for('views.commander_brackets_info') }}">
        <span class="qi"><i class="bi bi-trophy"></i> Commander Bracket</span>
      </a>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block hover-lift" href="{{ url_for('views.commander_spellbook_combos') }}">
        <span class="qi"><i class="bi bi-lightning-charge"></i> Spellbook Combos</span>
      </a>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block hover-lift" href="{{ url_for('views.import_csv') }}">
        <span class="qi"><i class="bi bi-file-earmark-arrow-up"></i> Import CSV</span>
      </a>
    </div>
  </div>
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block hover-lift" href="https://mtg.dragonshield.com/splash" target="_blank" rel="noopener">
        <span class="qi"><i class="bi bi-shield-check"></i> Dragon Shield</span>
      </a>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block hover-lift" href="https://www.mtggoldfish.com/" target="_blank" rel="noopener">
        <span class="qi"><i class="bi bi-globe"></i> MTGGoldfish</span>
      </a>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <a class="tile quick-tile d-block hover-lift" href="{{ url_for('views.admin_console') }}">
        <span class="qi"><i class="bi bi-sliders"></i> Admin</span>
      </a>
    </div>
  </div>

  <div class="section-label">Overview</div>
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <a class="tile d-block p-3 hover-lift card-hover-shadow" href="{{ url_for('views.decks_overview') }}">
        <div class="icon-circle"><i class="bi bi-collection"></i></div>
        <div class="stat-label">Decks</div>
        <div class="stat-number">{{ '{:,}'.format(stats.decks or 0) }}</div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a class="tile d-block p-3 hover-lift card-hover-shadow" href="{{ url_for('views.list_cards') }}">
        <div class="icon-circle"><i class="bi bi-stack"></i></div>
        <div class="stat-label">Total Cards</div>
        <div class="stat-number">{{ '{:,}'.format(stats.qty or 0) }}</div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a class="tile d-block p-3 hover-lift card-hover-shadow" href="{{ url_for('views.collection_overview') }}">
        <div class="icon-circle"><i class="bi bi-box-seam"></i></div>
        <div class="stat-label">Collection Cards</div>
        <div class="stat-number">{{ '{:,}'.format(stats.collection_qty or 0) }}</div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a class="tile d-block p-3 hover-lift card-hover-shadow" href="{{ url_for('views.sets_overview') }}">
        <div class="icon-circle"><i class="bi bi-grid-3x3-gap"></i></div>
        <div class="stat-label">Sets</div>
        <div class="stat-number">
          {% if stats.sets is defined %}
            {{ '{:,}'.format(stats.sets or 0) }}
          {% else %}
            &mdash;
          {% endif %}
        </div>
      </a>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="section-label mb-0">All Decks</div>
    <div class="ms-auto" style="max-width: 280px;">
      <input id="deckFilter" type="search" class="form-control form-control-sm" placeholder="Filter decks..." aria-label="Filter decks">
    </div>
  </div>

  {% if decks and decks|length %}
    <div class="row g-3 mb-4" id="deckGrid">
      {% for d in decks %}
        {% set cmd = d.commander %}
        <div class="col-12 col-sm-12 col-md-6 col-lg-6" data-deck-name="{{ (d.name or '')|lower }}">
          <a class="tile d-block h-100 deck-tile hover-lift card-hover-shadow"
             href="{{ url_for('views.folder_detail', folder_id=d.id) }}">
            <div class="d-flex align-items-center justify-content-between gap-3">
              <div class="d-flex align-items-center gap-3 min-w-0">
                <span class="deck-hover-target" {% if cmd and cmd.large %}data-hover-src="{{ cmd.large }}"{% endif %}>
                  {{ commander_chip(cmd, 80) }}
                </span>
                <div class="min-w-0">
                  <div class="deck-name text-truncate deck-hover-target"
                       title="{{ d.name }}"
                       {% if cmd and cmd.large %}data-hover-src="{{ cmd.large }}"{% endif %}>
                    {{ d.name }}
                  </div>
                  <div class="small text-muted">
                    {% if d.ci_html %}
                      <span class="pip-row">{{ d.ci_html | safe }}</span>
                      <span class="ms-1">{{ d.ci_name }}</span>
                    {% else %}
                      <span class="pip-row"><img class="mana mana-sm" src="{{ static_url('symbols/C.svg') }}" alt="{C}"></span>
                      <span class="ms-1">Colorless</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              <span class="badge text-bg-secondary" title="Total cards">{{ '{:,}'.format(d.qty or 0) }}</span>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary mb-4">
      No decks yet. Create a folder for a deck or visit the <a href="{{ url_for('views.decks_overview') }}" class="alert-link">Decks page</a>.
    </div>
  {% endif %}
</div>

<script nonce="{{ csp_nonce() }}">
(function () {
  const input = document.getElementById('deckFilter');
  if (!input) {
    return;
  }
  input.addEventListener('input', () => {
    const term = input.value.trim().toLowerCase();
    document.querySelectorAll('#deckGrid [data-deck-name]').forEach(col => {
      const name = col.getAttribute('data-deck-name') || '';
      col.style.display = !term || name.includes(term) ? '' : 'none';
    });
  });

  // Hover preview only on commander chip or deck name
  // Reuse global hover preview if available to avoid double overlays
  const globalHover = window.dvHoverPreview;
  if (globalHover && typeof globalHover.show === 'function' && typeof globalHover.hide === 'function') {
    document.querySelectorAll('.deck-hover-target[data-hover-src]').forEach(el => {
      const src = el.getAttribute('data-hover-src');
      el.addEventListener('mouseenter', (e) => globalHover.show(el, src, e));
      el.addEventListener('mousemove', (e) => globalHover.show(el, src, e));
      el.addEventListener('mouseleave', (e) => globalHover.hide());
    });
  } else {
    const preview = document.createElement('div');
    preview.id = 'deckHoverPreview';
    preview.style.position = 'fixed';
    preview.style.pointerEvents = 'none';
    preview.style.zIndex = '1080';
    preview.style.display = 'none';
    preview.innerHTML = '<img alt="Commander art" style="max-width:260px; max-height:360px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); background:#111;">';
    document.body.appendChild(preview);

    const imgEl = preview.querySelector('img');
    function hidePreview() { preview.style.display = 'none'; imgEl.src = ''; }
    function showPreview(src, evt) {
      if (!src) return;
      imgEl.src = src;
      preview.style.display = 'block';
      positionPreview(evt);
    }
    function positionPreview(evt) {
      const pad = 16;
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const rect = preview.getBoundingClientRect();
      let x = evt.clientX + pad;
      let y = evt.clientY + pad;
      if (x + rect.width + pad > vw) x = evt.clientX - rect.width - pad;
      if (y + rect.height + pad > vh) y = vh - rect.height - pad;
      preview.style.left = `${x}px`;
      preview.style.top = `${y}px`;
    }

    document.querySelectorAll('.deck-hover-target[data-hover-src]').forEach(el => {
      const src = el.getAttribute('data-hover-src');
      el.addEventListener('mouseenter', (e) => showPreview(src, e));
      el.addEventListener('mousemove', positionPreview);
      el.addEventListener('mouseleave', hidePreview);
    });
  }
})();
</script>
{% endblock %}

{% set suffix = modal_suffix|default('') %}
{% set modal_id = "commanderModal-" ~ suffix ~ (commander.card_id or loop.index or 0) %}
{% set commander_image = commander.image_hover or commander.image_url or url_for('static', filename='img/card-placeholder.svg') %}
<div class="modal fade commander-modal" id="{{ modal_id }}" tabindex="-1" aria-labelledby="{{ modal_id }}Label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header align-items-start">
        <div>
          <div class="d-flex align-items-center gap-2">
            <h5 class="modal-title" id="{{ modal_id }}Label">{{ commander.name }}</h5>
            {% set colors = commander.color_identity %}
            {% include "includes/_color_identity.html" %}
          </div>
          <div class="small text-muted">{{ commander.type_line }}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-12 col-lg-5">
            <div class="ratio ratio-2x3 rounded-4 overflow-hidden shadow-sm bg-body">
              <img src="{{ commander_image }}"
                   class="w-100 h-100 object-fit-cover"
                   alt="{{ commander.name }}">
            </div>
          </div>
          <div class="col-12 col-lg-7">
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
              <span class="badge text-bg-primary rounded-pill px-3 py-2">
                CRS {{ commander.synergy_score|round(1) }}
              </span>
              <span class="badge text-bg-secondary">{{ commander.dominant_themes|join(', ') or 'Balanced' }}</span>
            </div>

            <div class="card bg-body-secondary border-0 shadow-sm mb-3">
              <div class="card-body">
                <h6 class="text-uppercase text-muted fw-semibold small mb-2">Score Breakdown</h6>
                <div class="row g-3">
                  {% set component_caps = {'synergy': 40, 'color_identity': 20, 'roles': 20, 'themes': 10, 'curve': 10} %}
                  {% for key, val in commander.component_scores.items() %}
                    {% set cap = component_caps.get(key, 20) %}
                    {% set pct = (val or 0) * 100 / cap %}
                    <div class="col-6 col-md-4">
                      <div class="d-flex justify-content-between align-items-center small text-muted">
                        <span class="text-capitalize">{{ key }}</span>
                        <span>{{ val|round(1) }}</span>
                      </div>
                      <div class="progress" style="height:6px;">
                        <div class="progress-bar" style="width: {{ pct if pct < 100 else 100 }}%;"></div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <div class="mb-3">
              <h6 class="text-uppercase text-muted fw-semibold small mb-2">Role Coverage</h6>
              {% set role_strengths = commander.role_strengths %}
              {% include "includes/_role_bars.html" %}
            </div>

            <div class="mb-3">
              <h6 class="text-uppercase text-muted fw-semibold small mb-2">Top Synergy Cards</h6>
              <div class="synergy-track">
                {% for card in commander.top_synergy_cards %}
                  <div class="synergy-chip card shadow-sm">
                    <div class="d-flex align-items-start gap-3 p-3 h-100">
                      <div class="flex-shrink-0">
                        <img src="{{ card.image or url_for('static', filename='img/card-placeholder.svg') }}"
                             alt="{{ card.name }}"
                             class="rounded"
                             style="width:54px;height:76px;object-fit:cover;">
                      </div>
                      <div class="min-w-0">
                        <div class="fw-semibold small text-truncate">{{ card.name }}</div>
                        <div class="text-muted small">{{ card.reason }}</div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
                {% if commander.top_synergy_cards|length == 0 %}
                  <div class="text-muted small">No strong matches detected yet.</div>
                {% endif %}
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <h6 class="text-uppercase text-muted fw-semibold small mb-2">Themes</h6>
                <div class="d-flex flex-wrap gap-2">
                  {% for theme in commander.dominant_themes %}
                    <span class="badge text-bg-info text-dark">{{ theme }}</span>
                  {% endfor %}
                  {% if commander.dominant_themes|length == 0 %}
                    <span class="text-muted small">No dominant themes detected.</span>
                  {% endif %}
                </div>
              </div>
              <div class="col-12 col-md-6">
                <h6 class="text-uppercase text-muted fw-semibold small mb-2">Warnings</h6>
                {% if commander.warnings %}
                  <ul class="mb-0 small">
                    {% for warn in commander.warnings %}
                      <li>{{ warn }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="text-success small">All core roles covered.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary w-100 w-sm-auto" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% extends "base.html" %}
{% block title %}Commander Recommendations • DragonsVault{% endblock %}
{% block content %}
<div class="page-section" id="commanderRecommendPage">
  <style>
    .commander-hero {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.18), rgba(59, 130, 246, 0.16));
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
    }
    .commander-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
    }
    .commander-card {
      background: var(--bs-body-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      transition: transform .18s var(--dv-ease-soft, ease), box-shadow .18s var(--dv-ease-soft, ease);
    }
    .commander-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 1.25rem 2.5rem rgba(0,0,0,.35);
    }
    .commander-card__image {
      position: relative;
      aspect-ratio: 3 / 4;
      background: rgba(15, 23, 42, 0.45);
    }
    .commander-card__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .object-fit-cover { object-fit: cover; }
    .commander-card__score {
      position: absolute;
      top: .75rem;
      left: .75rem;
      border-radius: 999px;
      padding: .45rem .7rem;
      box-shadow: 0 .75rem 1.5rem rgba(0,0,0,.25);
    }
    .commander-card__body {
      padding: .85rem .95rem 1rem;
      display: flex;
      flex-direction: column;
      gap: .35rem;
      flex-grow: 1;
    }
    .commander-name {
      word-break: break-word;
    }
    .commander-type {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.3em;
    }
    .commander-why-btn {
      white-space: nowrap;
    }
    .commander-modal { z-index: 1080; }
    .commander-modal .modal-content { border-radius: 18px; }
    .commander-sort,
    .commander-tag-filter { min-width: 220px; }
    .synergy-track {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      align-items: stretch;
    }
    .synergy-chip { min-width: 240px; border-radius: 12px; height: 100%; flex: 1 1 260px; }
  </style>

  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
    <div>
      <h1 class="mb-1">Commander Recommendations</h1>
      <p class="text-muted mb-0">We scanned only your owned cards to find legal commanders with strong support, themes, and roles covered.</p>
    </div>
    <div class="badge text-bg-primary rounded-pill px-3 py-2">
      {{ recommendations|length }} commanders detected
    </div>
  </div>

  {% set tag_ns = namespace(options=[]) %}
  {% for commander in recommendations %}
    {% set theme = commander.dominant_themes|first %}
    {% if theme and theme not in tag_ns.options %}
      {% set _ = tag_ns.options.append(theme) %}
    {% endif %}
  {% endfor %}

  <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
    <div class="fw-semibold text-muted small text-uppercase">Sort</div>
    <div class="dropdown dv-select dv-select-sm commander-sort" data-dv-select="commander-sort" id="commanderSortSelect">
      <input type="hidden" data-dv-select-input value="score">
      <button class="btn dv-select-toggle btn-sm d-inline-flex align-items-center gap-2" type="button" id="commanderSortToggle" data-bs-toggle="dropdown" aria-expanded="false" aria-labelledby="commanderSortToggle">
        <span data-dv-select-label>Synergy score</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <ul class="dropdown-menu dv-select-menu" aria-labelledby="commanderSortToggle">
        <li><button class="dropdown-item active" type="button" data-dv-select-option data-value="score" data-label="Synergy score">Synergy score</button></li>
        <li><button class="dropdown-item" type="button" data-dv-select-option data-value="name" data-label="Name (A–Z)">Name (A–Z)</button></li>
        <li><button class="dropdown-item" type="button" data-dv-select-option data-value="tag" data-label="Tag">Tag</button></li>
      </ul>
    </div>
    {% if tag_ns.options %}
      <div class="fw-semibold text-muted small text-uppercase">Filter</div>
      <div class="dropdown dv-select dv-select-sm commander-tag-filter" data-dv-select="commander-tag-filter" id="commanderTagFilter">
        <input type="hidden" data-dv-select-input value="">
        <button class="btn dv-select-toggle btn-sm d-inline-flex align-items-center gap-2" type="button" id="commanderTagFilterToggle" data-bs-toggle="dropdown" aria-expanded="false" aria-labelledby="commanderTagFilterToggle">
          <span data-dv-select-label>All tags</span>
          <i class="bi bi-chevron-down"></i>
        </button>
        <ul class="dropdown-menu dv-select-menu" aria-labelledby="commanderTagFilterToggle">
          <li><button class="dropdown-item active" type="button" data-dv-select-option data-value="" data-label="All tags">All tags</button></li>
          {% for tag in tag_ns.options|sort %}
            <li><button class="dropdown-item" type="button" data-dv-select-option data-value="{{ tag }}" data-label="{{ tag }}">{{ tag }}</button></li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>

  <div class="commander-hero p-3 p-md-4 mb-4">
    <div class="d-flex flex-wrap align-items-center gap-3">
      <div class="fs-5 fw-semibold">How this works</div>
      <div class="text-muted">We rank your legendary creatures, planeswalkers, and backgrounds by synergy, color support, role coverage, themes, and curve.</div>
    </div>
    <div class="mt-3">
      <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#scoreExplain" aria-expanded="false" aria-controls="scoreExplain">
        How we calculate scores
      </button>
      <div class="collapse mt-3" id="scoreExplain">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="p-3 rounded-3 bg-body text-body shadow-sm h-100">
              <div class="fw-semibold mb-2">Commander Recommendation Score</div>
              <ul class="small mb-0 ps-3">
                <li>Synergy (40%): tribal/mechanic matches, theme overlaps, role support</li>
                <li>Color Identity Support (20%): lands/rocks matching commander colors</li>
                <li>Role Coverage (20%): ramp, draw, interaction, recursion, finishers</li>
                <li>Theme Strength (10%): token/artifact/graveyard/etc. support</li>
                <li>Curve &amp; Efficiency (10%): low-curve enablers and early plays</li>
              </ul>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="p-3 rounded-3 bg-body text-body shadow-sm h-100">
              <div class="fw-semibold mb-2">Data sources</div>
              <ul class="small mb-0 ps-3">
                <li>Your owned cards only (no wishlist)</li>
                <li>Commander rules text for synergy hooks</li>
                <li>Role engine for ramp/draw/removal/etc.</li>
                <li>Theme detector (+1/+1, tokens, artifacts, graveyard, wheels)</li>
                <li>Color fixing &amp; curve from your collection’s lands/rocks</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs mb-3" id="commanderTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tabRec" data-bs-toggle="tab" data-bs-target="#tabRecommended" type="button" role="tab" aria-controls="tabRecommended" aria-selected="true">
        Recommended for You
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tabAll" data-bs-toggle="tab" data-bs-target="#tabAllOwned" type="button" role="tab" aria-controls="tabAllOwned" aria-selected="false">
        All Commanders You Own
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tabRecommended" role="tabpanel" aria-labelledby="tabRec">
      <div class="commander-grid">
        {% for commander in recommendations %}
          {% set modal_suffix = 'rec-' %}
          {% include "includes/_commander_card.html" %}
        {% else %}
          <div class="text-muted small">No commanders detected in your collection yet.</div>
        {% endfor %}
      </div>
    </div>
    <div class="tab-pane fade" id="tabAllOwned" role="tabpanel" aria-labelledby="tabAll">
      <div class="commander-grid">
        {% for commander in all_commanders %}
          {% set modal_suffix = 'all-' %}
          {% include "includes/_commander_card.html" %}
        {% else %}
          <div class="text-muted small">No commanders detected in your collection yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/build_commander_recommend.js') }}"></script>
{% endblock %}

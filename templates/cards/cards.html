{# Cards list view: searchable/filterable table with optional deck context. #}
{% extends "base.html" %}
{% from "shared/components/macros.html" import slug, folder_badge %}
{% from "shared/components/pagination.html" import render_pagination %}
{% block content %}
{% set back_to = request.full_path %}
{% if back_to and back_to.endswith('?') %}
  {% set back_to = back_to[:-1] %}
{% endif %}

{% set hover_map = hover_map|default({}, true) %}
{% set per_value = per or 25 %}

{# ---------- local state helpers ---------- #}
{# Prefer explicit querystring; fall back to context vars #}
{% set type_mode_local = (request.args.get('type_mode') or type_mode or 'contains') %}
{% set ui_selected_types = (
      (request.args.getlist('type_any') if type_mode_local != 'exact' else request.args.getlist('type'))
      or selected_types or []
    ) %}

<div class="page-section">
  <h1 class="mb-3">Browse All Cards</h1>

  {# Badge helper: reuse consistent styling when rendering card types. #}
  {% macro type_badge(t) -%}
    {%- set tl = (t or '')|lower -%}
    <span class="badge badge-type badge-type-{{ tl }}">{{ t }}</span>
  {%- endmacro %}

  {% set COLLECTION_FOLDERS = collection_folders|default([], true) %}

  {# Local styling keeps the listing layout self-contained. #}
  <style>
    .pagination .page-link { display:inline-block; width:auto; }

    .offcanvas-end.w-500 { width:500px; }
    .offcanvas .card-art { width:100%; height:auto; border-radius:.5rem; display:block; margin:0 auto; background:#111; }

    .card-row { cursor:pointer; }
    .card-row a.card-link { cursor:pointer; text-decoration:none; }
    .col-select { width:36px; min-width:36px; text-align:center; }

    .small-muted { font-size:.875rem; color:#6c757d; }
    .detail-label { font-weight:600; color:#6c757d; width:140px; }

    .card-thumb { display:block; }
    .col-colors { width:170px; min-width:170px; white-space:nowrap; }

    .drawer-cycler { position:relative; }
    .drawer-cycler .nav-btn {
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,.6); color:#fff; border:0; padding:.35rem .5rem; border-radius:.375rem;
    }
    .drawer-cycler .prev { left:.25rem; }
    .drawer-cycler .next { right:.25rem; }
    .drawer-cycler .nav-btn:disabled { opacity:.35; cursor:not-allowed; }

    .cmdr-star { font-size: 1.15rem; line-height: 1; opacity: .45; }
    .cmdr-star.active { opacity: 1; color: var(--bs-warning); }
    .btn-star { padding: 0; border: 0; background: transparent; }
    .col-star { width: 40px; min-width: 40px; text-align:center; }

    .vr { height: 1.25em; opacity: .25; }

    /* —— Flip button overlay (added) —— */
    .flip-face-btn{
      position:absolute; top:.35rem; left:.35rem; z-index:6;
      padding:.25rem .5rem; font-weight:700; line-height:1; border-radius:.5rem;
      border:1px solid rgba(255,255,255,.3);
      background:rgba(0,0,0,.55); color:#fff;
    }
    @media (hover:hover){ .flip-face-btn:hover{ background:rgba(0,0,0,.72);} }
  </style>

  {# Search + filter form controls the query params for the list view. #}
  <!-- Filters -->
  <form class="mb-3" method="get" action="{{ url_for('views.list_cards') }}" id="cardsFilterForm">
    {% set rarity_value = (rarity or '') %}
    {% set rarity_label = 'Any rarity' %}
    {% if rarity_value %}
      {% set rarity_label = rarity_value.replace('_',' ').replace('-',' ').title() %}
    {% endif %}
    {% set foil_only = foil_only|default(false) %}
    {% set rarity_choices = rarity_options|default([], true) %}
    {% set set_options = set_options|default([], true) %}
    {% set set_label = namespace(text='All sets') %}
    {% if set_code %}
      {% for option in set_options %}
        {% if option.code == set_code %}
          {% set set_label.text = option.label %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if folder_id %}
      <input type="hidden" name="folder" value="{{ folder_id }}">
    {% endif %}
    {% if include_proxies %}
      <input type="hidden" name="include_proxies" value="1">
    {% endif %}
    {% set reset_args = namespace(params={}) %}
    {% if folder_id %}
      {% set _ = reset_args.params.update({'folder': folder_id}) %}
    {% endif %}
    {% if include_proxies %}
      {% set _ = reset_args.params.update({'include_proxies': '1'}) %}
    {% endif %}
    {% if collection_flag %}
      {% set _ = reset_args.params.update({'collection': 1}) %}
    {% endif %}
    {% set reset_url = url_for('views.list_cards', **reset_args.params) %}
    <div class="filter-wrap">
    <div class="filter-row row g-2 align-items-end">
        <div class="col-12 col-xl-4">
          <label class="form-label visually-hidden" for="filterName">Search by card name</label>
          <input id="filterName"
                 class="form-control"
                 name="q"
                 type="text"
                 placeholder="Search by name..."
                 value="{{ q or '' }}">
        </div>
        <div class="col-6 col-md-4 col-xl-2">
          <label class="form-label visually-hidden" for="filterSet">Set</label>
          <div class="dropdown dv-select w-100" data-dv-select="cards-set">
            <input type="hidden"
                   id="filterSet"
                   name="set"
                   value="{{ set_code or '' }}"
                   data-dv-select-input>
            <button class="btn dv-select-toggle w-100 justify-content-between"
                    type="button"
                    id="cardsSetToggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span data-dv-select-label>{{ set_label.text }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="cardsSetToggle">
              <li class="dv-select-search-wrapper">
                <input type="text"
                       class="form-control form-control-sm dv-select-search"
                       placeholder="Search sets"
                       autocomplete="off"
                       data-dv-select-search>
              </li>
              <li>
                <button class="dropdown-item {% if not set_code %}active{% endif %}"
                        type="button"
                        data-dv-select-option
                        data-value=""
                        data-label="All sets">
                  All sets
                </button>
              </li>
              {% for option in set_options %}
                <li>
                  <button class="dropdown-item {% if set_code == option.code %}active{% endif %}"
                          type="button"
                          data-dv-select-option
                          data-value="{{ option.code }}"
                          data-label="{{ option.label }}">
                    {{ option.label }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
          <label class="form-label visually-hidden" for="filterRarity">Rarity</label>
          <div class="dropdown dv-select w-100" data-dv-select="cards-rarity">
            <input type="hidden"
                   id="filterRarity"
                   name="rarity"
                   value="{{ rarity_value or '' }}"
                   data-dv-select-input>
            <button class="btn dv-select-toggle w-100 justify-content-between"
                    type="button"
                    id="cardsRarityToggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
              <span data-dv-select-label>{{ rarity_label }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="cardsRarityToggle">
              <li class="dv-select-search-wrapper">
                <input type="text"
                       class="form-control form-control-sm dv-select-search"
                       placeholder="Search rarity"
                       autocomplete="off"
                       data-dv-select-search>
              </li>
              <li>
                <button class="dropdown-item {% if not rarity_value %}active{% endif %}"
                        type="button"
                        data-dv-select-option
                        data-value=""
                        data-label="Any rarity">
                  Any rarity
                </button>
              </li>
              {% for option in rarity_choices %}
                <li>
                  <button class="dropdown-item {% if rarity_value == option.value %}active{% endif %}"
                          type="button"
                          data-dv-select-option
                          data-value="{{ option.value }}"
                          data-label="{{ option.label }}">
                    {{ option.label }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="col-12 col-lg-6 col-xl-4">
          <label class="form-label visually-hidden" for="filterTribe">Typal or tribe</label>
          <input id="filterTribe"
                 class="form-control"
                 name="tribe"
                 type="text"
                 placeholder="Typal (e.g. Merfolk)"
                 value="{{ tribe or '' }}">
        </div>
      </div>

      <!-- Types -->
      <fieldset class="filter-row">
        <legend class="visually-hidden">Card types</legend>
        <div class="d-flex align-items-center flex-wrap gap-2">
          <div class="small text-muted me-2">Types:</div>
          {% set all_types = ["Artifact","Battle","Creature","Enchantment","Instant","Land","Planeswalker","Sorcery"] %}
          {% for t in all_types %}
            {% set checked = (t.lower() in (ui_selected_types or [])) %}
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="t_{{ t }}" name="type" value="{{ t.lower() }}" {% if checked %}checked{% endif %}>
              <label class="form-check-label" for="t_{{ t }}">{{ t }}</label>
            </div>
          {% endfor %}

          <div class="vr d-none d-sm-block"></div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Type matching mode">
            <input type="radio" class="btn-check" name="type_mode" id="tm_contains" value="contains" {% if type_mode_local != 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="tm_contains">Contains</label>
            <input type="radio" class="btn-check" name="type_mode" id="tm_exact" value="exact" {% if type_mode_local == 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="tm_exact">Exact</label>
          </div>

          {% if ui_selected_types and ui_selected_types|length %}
            <a class="small ms-2" href="{{ url_for('views.list_cards', collection=1 if collection_flag else None) }}">Clear types</a>
          {% endif %}
        </div>
      </fieldset>

      <!-- Colors -->
      <fieldset class="filter-row">
        <legend class="visually-hidden">Color identity</legend>
        <div class="d-flex align-items-center flex-wrap gap-3">
          <div class="small text-muted">Colors:</div>
          {% set COLORS = ['w','u','b','r','g','c'] %}
          {% for c in COLORS %}
            {% set up = c|upper %}
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="c_{{ c }}" name="color" value="{{ c }}" {% if c in (selected_colors or []) %}checked{% endif %}>
              <label class="form-check-label" for="c_{{ c }}">
                <img class="mana mana-sm" src="/static/symbols/{{ up }}.svg" alt="{{ up }}" onerror="this.outerHTML='{{ up }}'">
                <span class="visually-hidden">{{ up }}</span>
              </label>
            </div>
          {% endfor %}
          <div class="vr d-none d-lg-block"></div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Color matching mode">
            <input type="radio" class="btn-check" name="color_mode" id="cm_contains" value="contains" {% if color_mode != 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="cm_contains">Contains</label>
            <input type="radio" class="btn-check" name="color_mode" id="cm_exact" value="exact" {% if color_mode == 'exact' %}checked{% endif %} onchange="this.form.submit()">
            <label class="btn btn-outline-secondary" for="cm_exact">Exactly</label>
          </div>
          <div class="vr d-none d-lg-block"></div>
          <div class="form-check form-check-inline mb-0">
            <input class="form-check-input"
                   type="checkbox"
                   id="filterFoilOnly"
                   name="foil_only"
                   value="1"
                   {% if foil_only %}checked{% endif %}>
            <label class="form-check-label" for="filterFoilOnly">Foil</label>
          </div>
          {% if selected_colors and selected_colors|length %}
            <a class="small ms-1" href="{{ url_for('views.list_cards', collection=1 if collection_flag else None) }}">Clear colors</a>
          {% endif %}
        </div>
      </fieldset>

      <!-- Actions -->
      <div class="filter-actions d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="small text-muted">
          {{ '{:,}'.format(total|default(cards|length, true) or 0) }} matching cards
        </div>
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <div class="form-check form-switch mb-0">
            <input class="form-check-input"
                   type="checkbox"
                   id="f_collection"
                   name="collection"
                   value="1"
                   {% if collection_flag %}checked{% endif %}
                   onchange="this.form.submit()">
            <label class="form-check-label" for="f_collection">Collection</label>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Apply filters</button>
            <a class="btn btn-outline-secondary" href="{{ reset_url }}">Reset</a>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Summary -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div>
      {# Prefer accurate display count when using client-side Contains types #}
      {% if (ui_selected_types and ui_selected_types|length and type_mode_local != 'exact') and (total is defined) %}
        <small class="text-muted">Showing {{ cards|length }} of {{ total }}</small>
      {% elif start is defined and end is defined and total is defined %}
        <small class="text-muted">{{ cards|length }} result{{ cards|length != 1 and 's' or '' }}</small>
      {% endif %}
      {% if include_proxies %}
        <span class="badge text-bg-primary ms-2 align-middle">Including proxy cards</span>
      {% elif folder_is_proxy %}
        <span class="badge text-bg-warning text-dark ms-2 align-middle">Proxy deck (proxy cards hidden)</span>
      {% endif %}
    </div>
    <div class="d-flex gap-3">
      {% if q or folder_id or set_code or foil_only or tribe or (ui_selected_types and ui_selected_types|length) or (selected_colors and selected_colors|length) or collection_flag %}
        <a class="small" href="{{ reset_url }}">Reset</a>
      {% endif %}
      {# Export preserves the correct param flavor for types #}
      {% if type_mode_local == 'exact' %}
        {% set export_url = url_for('views.export_cards',
          q=q, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None), tribe=tribe,
          type=ui_selected_types, type_mode=type_mode_local,
          color=selected_colors, color_mode=color_mode,
          collection=1 if collection_flag else None) %}
      {% else %}
        {% set export_url = url_for('views.export_cards',
          q=q, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None), tribe=tribe,
          type_any=ui_selected_types, type_mode='contains',
          color=selected_colors, color_mode=color_mode,
          collection=1 if collection_flag else None) %}
      {% endif %}
      {% set export_sep = '&' if '?' in export_url else '?' %}
      {% set export_url_manavault = export_url ~ export_sep ~ 'format=manavault' %}
      {% set export_url_dragonshield = export_url ~ export_sep ~ 'format=dragonshield' %}
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-secondary" href="{{ export_url }}">Export CSV</a>
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Choose export format">
          <span class="visually-hidden">Choose export format</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{{ export_url_manavault }}">Export for ManaVault</a></li>
          <li><a class="dropdown-item" href="{{ export_url_dragonshield }}">Export for Dragon Shield</a></li>
        </ul>
      </div>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('views.shared_folders') }}">
        Shared folders
      </a>
    </div>
  </div>

  {% if move_folder_options %}
    <div id="cardSelectToolbar" class="alert alert-secondary d-flex flex-wrap align-items-center gap-3 mb-3 d-none">
      <div class="fw-semibold mb-0">
        <strong id="cardSelectCount">0</strong>
        card<span id="cardSelectPlural">s</span> selected
      </div>
      <form id="cardSelectForm"
            method="post"
            action="{{ url_for('views.bulk_move_cards') }}"
            class="d-flex flex-wrap align-items-center gap-2 ms-auto">
        <input type="hidden" name="card_ids" id="cardSelectInput">
        <input type="hidden" name="redirect_to" value="{{ back_to }}">
        <label class="visually-hidden" for="cardSelectTargetToggle">Move cards to folder</label>
        <div class="dropdown dv-select dv-select-sm"
             data-dv-select="card-move-target"
             id="cardSelectTargetWrapper">
          <input type="hidden"
                 name="target_folder_id"
                 id="cardSelectTargetInput"
                 data-dv-select-input
                 value="">
          <button class="btn dv-select-toggle btn-sm d-flex align-items-center gap-2"
                  type="button"
                  id="cardSelectTargetToggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            <span data-dv-select-label>Choose destination…</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <ul class="dropdown-menu dv-select-menu"
              aria-labelledby="cardSelectTargetToggle">
            <li>
              <button class="dropdown-item active"
                      type="button"
                      data-dv-select-option
                      data-value=""
                      data-label="Choose destination…">
                Choose destination…
              </button>
            </li>
            {% for option in move_folder_options %}
              <li>
                <button class="dropdown-item"
                        type="button"
                        data-dv-select-option
                        data-value="{{ option.id }}"
                        data-label="{{ option.name }}">
                  {{ option.name }}
                  {% if option.is_collection %}
                    <span class="badge bg-secondary ms-2">Collection</span>
                  {% elif option.is_proxy %}
                    <span class="badge bg-warning text-dark ms-2">Proxy</span>
                  {% endif %}
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>
        <button class="btn btn-primary btn-sm" type="submit" id="cardSelectSubmit" disabled>Move cards</button>
        <button class="btn btn-link btn-sm" type="button" id="cardSelectClear">Clear selection</button>
      </form>
    </div>
    {% endif %}
  {% if cards|length == 0 %}
    <div class="alert alert-secondary">
      No cards match your filters. Try broadening them or
      <a href="{{ url_for('views.import_csv') }}">import a CSV</a>.
    </div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-sm align-middle cards-table">
        <thead>
          {% set name_dir = 'asc' if sort!='name' or direction=='desc' else 'desc' %}
          {% set ctyp_dir = 'asc' if sort!='ctype' or direction=='desc' else 'desc' %}
          {% set col_dir  = 'asc' if sort!='colors' or direction=='desc' else 'desc' %}
          {% set rar_dir  = 'asc' if sort!='rar'  or direction=='desc' else 'desc' %}
          {% set fol_dir  = 'asc' if sort!='folder' or direction=='desc' else 'desc' %}
          {% set set_dir  = 'asc' if sort!='set'  or direction=='desc' else 'desc' %}
          {% set cn_dir   = 'asc' if sort!='cn'   or direction=='desc' else 'desc' %}
          {% set foil_dir = 'asc' if sort!='foil' or direction=='desc' else 'desc' %}
          {% set qty_dir  = 'asc' if sort!='qty'  or direction=='desc' else 'desc' %}
          {% macro keep_params(sort_field, dir_value) -%}
            {%- if type_mode_local == 'exact' -%}
              {{ url_for('views.list_cards',
                  q=q, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None), tribe=tribe,
                  type=ui_selected_types, type_mode=type_mode_local,
                  color=selected_colors, color_mode=color_mode,
                  collection=1 if collection_flag else None,
                  sort=sort_field, dir=dir_value) }}
            {%- else -%}
              {{ url_for('views.list_cards',
                  q=q, folder=folder_id, set=set_code, foil_only=('1' if foil_only else None), tribe=tribe,
                  type_any=ui_selected_types, type_mode='contains',
                  color=selected_colors, color_mode=color_mode,
                  collection=1 if collection_flag else None,
                  sort=sort_field, dir=dir_value) }}
            {%- endif -%}
          {%- endmacro %}
          <tr>
            {% if move_folder_options %}
              <th class="col-select">
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" id="cardSelectAll" aria-label="Select all cards on this page">
                </div>
              </th>
            {% endif %}
            <th>Art</th>
            <th><a href="{{ keep_params('name', name_dir) }}">Name</a></th>
            <th><a href="{{ keep_params('ctype', ctyp_dir) }}">Type</a></th>
            <th class="col-colors"><a href="{{ keep_params('colors', col_dir) }}">Colors</a></th>
            <th><a href="{{ keep_params('rar', rar_dir) }}">Rarity</a></th>
            <th><a href="{{ keep_params('folder', fol_dir) }}">Folder</a></th>
            <th><a href="{{ keep_params('set', set_dir) }}">Set</a></th>
            <th><a href="{{ keep_params('cn', cn_dir) }}">#</a></th>
            <th><a href="{{ keep_params('foil', foil_dir) }}">Foil</a></th>
            <th class="text-end"><a href="{{ keep_params('qty', qty_dir) }}">Qty</a></th>
          </tr>
        </thead>
        <tbody>
          {% for card in cards %}
            {% set fname = card.folder.name if (card.folder and card.folder.name) else None %}

            {# ---- TYPES FILTER (tokenize; OR for contains, AND for exact) ---- #}
            {% set raw_types = type_map.get(card.id) if type_map else [] %}
            {% if raw_types is string %}
              {% set tokens = raw_types
                               | replace('—',' ')
                               | replace('-',' ')
                               | replace(',',' ')
                               | lower
                               | split() %}
            {% else %}
              {% set tokens = (raw_types or []) | map('lower') | list %}
            {% endif %}

            {% set type_ok = True %}
            {% if ui_selected_types and ui_selected_types|length %}
              {% set sel = ui_selected_types | map('lower') | list %}
              {% if type_mode_local == 'exact' %}
                {% set ns = namespace(ok=true) %}
                {% for t in sel %}
                  {% if t not in tokens %}{% set ns.ok = false %}{% endif %}
                {% endfor %}
                {% set type_ok = ns.ok %}
              {% else %}
                {% set ns = namespace(hit=false) %}
                {% for t in sel %}
                  {% if t in tokens %}{% set ns.hit = true %}{% endif %}
                {% endfor %}
                {% set type_ok = ns.hit %}
              {% endif %}
            {% endif %}

            {% if (not collection_flag or (fname in COLLECTION_FOLDERS)) and type_ok %}
            {% set hover_src = hover_map.get(card.id) if hover_map else None %}
            {% set display_name = display_name_map.get(card.id) or card.name %}
            <tr class="card-row" data-card-id="{{ card.id }}" data-folder="{{ (fname or '')|lower }}" data-ignore-hover="true">
              {% if move_folder_options %}
                <td class="col-select">
                  <div class="form-check mb-0">
                    <input class="form-check-input card-select"
                           type="checkbox"
                           value="{{ card.id }}"
                           aria-label="Select {{ display_name }}"
                           data-card-name="{{ display_name }}">
                  </div>
                </td>
              {% endif %}
              <td style="width:52px;">
                {% if image_map and image_map.get(card.id) %}
                  <img decoding="async" src="{{ image_map.get(card.id) }}" alt="" width="48" height="auto" loading="lazy" class="rounded card-thumb" {% if hover_src %}data-hover-src="{{ hover_src }}"{% endif %}>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td><a class="card-link" href="{{ url_for('views.card_detail', card_id=card.id) }}" {% if hover_src %}data-hover-src="{{ hover_src }}"{% endif %}>{{ display_name_map.get(card.id) or card.name }}</a></td>
              <td class="align-middle">
                {% if raw_types %}
                  {% if raw_types is string %}
                    {% for tkn in tokens %}
                      {% if tkn in ['artifact','battle','creature','enchantment','instant','land','planeswalker','sorcery'] %}
                        {{ type_badge(tkn|capitalize) }}
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    {% for t in raw_types %}{{ type_badge(t) }}{% endfor %}
                  {% endif %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="col-colors">
                {% set cols = (color_map.get(card.id) if color_map else []) %}
                {% if not cols or not cols|length %}{% set cols = ['C'] %}{% endif %}
                <span class="pip-row">
                  {% for C in cols %}
                    <img class="mana mana-sm" src="/static/symbols/{{ C }}.svg" alt="{{ C }}" onerror="this.outerHTML='{{ C }}'">
                  {% endfor %}
                </span>
              </td>
              <td>
                {% set r = (rarity_map.get(card.id) if rarity_map else None) %}
                {% if r %}
                  {% set rl = r|lower %}
                  {% set cls = 'secondary' %}
                  {% if rl == 'common' %}{% set cls = 'secondary' %}
                  {% elif rl == 'uncommon' %}{% set cls = 'success' %}
                  {% elif rl == 'rare' %}{% set cls = 'warning' %}
                  {% elif rl in ['mythic','mythic rare'] %}{% set cls = 'danger' %}{% endif %}
                  <span class="badge text-bg-{{ cls }}">{{ r|capitalize }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if card.folder and card.folder.name %}
                  {{ folder_badge(card.folder.name) }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-uppercase">{{ card.set_code }}</td>
              <td>{{ card.collector_number }}</td>
              <td>{{ "✓" if card.is_foil else "" }}</td>
              <td class="text-end">{{ card.quantity }}</td>
            </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if pages is defined %}
      <div class="d-flex justify-content-end align-items-center flex-wrap gap-3 mt-3">
        <div class="text-muted small">Showing {{ start }}-{{ end }} of {{ total }}</div>
        <form method="get" class="d-inline" id="cardsPerForm">
          {% for k, v in request.args.items() if k not in ['per','page','page_size','per_page'] %}
            <input type="hidden" name="{{ k }}" value="{{ v }}">
          {% endfor %}
          <label class="me-1 small text-muted" for="cardsPerToggle">/ page</label>
          <div class="dropdown dv-select dv-select-sm d-inline-block" data-dv-select="cards-per" id="cardsPerSelect">
            <input type="hidden" name="per" data-dv-select-input value="{{ per_value }}">
            <button class="btn dv-select-toggle btn-sm d-inline-flex align-items-center gap-2" type="button" id="cardsPerToggle" data-bs-toggle="dropdown" aria-expanded="false">
              <span data-dv-select-label>{{ per_value }}</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <ul class="dropdown-menu dv-select-menu dropdown-menu-end" aria-labelledby="cardsPerToggle">
              {% for n in [25, 50, 100, 150, 200] %}
                <li>
                  <button class="dropdown-item {% if per_value == n %}active{% endif %}" type="button" data-dv-select-option data-value="{{ n }}" data-label="{{ n }}">
                    {{ n }}
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
          <input type="hidden" name="page" value="{{ page }}">
          <input type="hidden" name="per_page" value="{{ per_value }}">
        </form>

        <nav aria-label="Cards pagination">
          {% call(page_number) render_pagination(page=page, pages=pages, window=2, classes="pagination pagination-sm mb-0") %}
            {{ page_url_map.get(page_number, '#') }}
          {% endcall %}
        </nav>
      </div>
    {% endif %}
  {% endif %}
</div>

<!-- Drawer -->
<div class="offcanvas offcanvas-end w-500" tabindex="-1" id="cardDrawer" aria-labelledby="cardDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="cardDrawerLabel">Card Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div id="drawerContent">
      <div class="text-center small text-muted">Select a card…</div>
    </div>
  </div>
</div>

<script>
(function () {
  // --- Ensure 'Contains' ships type_any (not type) ---
  const form = document.getElementById('cardsFilterForm');
  if (form) {
    // Ensure type inputs are enabled (they may have been disabled on a previous submit)
    form.querySelectorAll('input[name="type"]').forEach((input) => {
      input.disabled = false;
    });

    form.addEventListener('submit', function () {
      const contains = form.querySelector('input[name="type_mode"][value="contains"]')?.checked;
      // Clean up any prior temp fields
      form.querySelectorAll('#tmp_type_any, #tmp_type_mode').forEach(n => n.remove());
      if (contains) {
        const checked = Array.from(form.querySelectorAll('input[name="type"]:checked')).map(i => i.value);
        // Disable original "type" so backend won't treat as exact/AND
        form.querySelectorAll('input[name="type"]').forEach(i => { i.disabled = true; });
        // Inject type_any for OR behavior
        const holder = document.createElement('div');
        holder.id = 'tmp_type_any';
        checked.forEach(v => {
          const h = document.createElement('input');
          h.type = 'hidden'; h.name = 'type_any'; h.value = v; holder.appendChild(h);
        });
        // Reinforce the mode
        const tm = document.createElement('input');
        tm.type = 'hidden'; tm.name = 'type_mode'; tm.value = 'contains'; tm.id = 'tmp_type_mode';
        holder.appendChild(tm);
        form.appendChild(holder);
      }
    });

    // Helper to auto-apply filters when toggling checkboxes (types/colors)
    let autoSubmitTimer = null;
    const scheduleSubmit = () => {
      if (!form) return;
      if (autoSubmitTimer) {
        clearTimeout(autoSubmitTimer);
      }
      autoSubmitTimer = window.setTimeout(() => {
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      }, 150);
    };

    form.querySelectorAll('input[name="type"], input[name="color"]').forEach((input) => {
      input.addEventListener('change', scheduleSubmit);
    });
  }

  // Per-page selector (matches dv-select UI)
  const cardsPerForm = document.getElementById('cardsPerForm');
  const cardsPerSelect = document.getElementById('cardsPerSelect');
  if (cardsPerForm && cardsPerSelect) {
    cardsPerSelect.addEventListener('dv-select:change', () => {
      cardsPerForm.submit();
    });
  }

  // --- Drawer (unchanged) ---
  const drawerEl  = document.getElementById('cardDrawer');
  const contentEl = document.getElementById('drawerContent');
  let offcanvas;
  let keyHandler = null;

  function openDrawer() {
    if (typeof bootstrap !== 'undefined') {
      offcanvas = offcanvas || new bootstrap.Offcanvas(drawerEl);
      offcanvas.show();
    } else {
      drawerEl.classList.add('show');
      drawerEl.style.visibility = 'visible';
    }
  }

  function esc(s) {
    return (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  function normalizeImages(payload) {
    const out = [];
    if (Array.isArray(payload?.images)) out.push(...payload.images);
    const info = payload?.info || {};
    if (info?.image_uris) out.push(info.image_uris);
    if (Array.isArray(info?.card_faces)) {
      info.card_faces.forEach(face => { if (face?.image_uris) out.push(face.image_uris); });
    }
    return out.map(i => ({
      small:  i?.small  || i?.normal || i?.large || i?.url || i?.uri || null,
      normal: i?.normal || i?.large  || i?.small || null,
      large:  i?.large  || i?.normal || i?.small || null,
      label: i?.label || null
    })).filter(i => i.small || i.normal || i.large);
  }
  const imgSrc   = (img) => img.large || img.normal || img.small || null;
  const imgLabel = (img) => img?.label || '';
  const MISSING_TEXT = '&mdash;';

  function renderColorPips(info) {
    const source = (info?.color_identity && info.color_identity.length)
      ? info.color_identity
      : (info?.colors || []);
    if (!source || !source.length) return MISSING_TEXT;
    return `<span class="pip-row">${
      source.map(c => {
        const L = String(c || '').toUpperCase();
        return `<img class="mana mana-sm" src="/static/symbols/${L}.svg" alt="${L}" onerror="this.outerHTML='${L}'">`;
      }).join('')
    }</span>`;
  }

  function renderCommanderBadge(status) {
    if (!status) {
      return `<span class="small text-muted">${MISSING_TEXT}</span>`;
    }
    const normalized = String(status).toLowerCase();
    let theme = 'secondary';
    if (normalized === 'legal') theme = 'success';
    else if (normalized === 'restricted') theme = 'warning';
    else if (normalized === 'banned') theme = 'danger';
    const label = normalized.charAt(0).toUpperCase() + normalized.slice(1);
    return `<span class="badge text-bg-${theme}">Commander: ${esc(label)}</span>`;
  }

  function renderScryfallButtons(info) {
    if (!info) return '';
    const buttons = [];
    if (info.scryfall_uri) {
      buttons.push(`<a class="btn btn-sm btn-outline-primary" href="${info.scryfall_uri}" target="_blank" rel="noopener">View on Scryfall</a>`);
    }
    if (info.scryfall_set_uri) {
      buttons.push(`<a class="btn btn-sm btn-outline-secondary" href="${info.scryfall_set_uri}" target="_blank" rel="noopener">View Set</a>`);
    }
    return buttons.length ? `<div class="d-flex flex-wrap gap-2 mt-2">${buttons.join('')}</div>` : '';
  }

  function buildCyclerHTML(images) {
    if (!images.length) return `<div class="text-center small text-muted mb-3">No image available</div>`;
    const first = images[0], src = imgSrc(first), label = imgLabel(first);
    return `
      <div class="drawer-cycler mb-3" data-count="${images.length}" data-index="0">
        <button type="button" class="nav-btn prev" aria-label="Previous">◀</button>
        <img class="d-block card-art" id="drawerMainImg" src="${src}" alt="${esc(label)}">
        <button type="button" class="nav-btn next" aria-label="Next">▶</button>
        <div class="small-muted text-center mt-1" id="drawerImgLabel">${esc(label)}</div>
      </div>`;
  }
  function initCycler(images) {
    const wrap = contentEl.querySelector('.drawer-cycler'); if (!wrap) return;
    const prevBtn = wrap.querySelector('.prev');
    const nextBtn = wrap.querySelector('.next');
    const imgEl   = wrap.querySelector('#drawerMainImg');
    const capEl   = wrap.querySelector('#drawerImgLabel');

    let idx = 0;
    const N = images.length;
    function show(i) {
      idx = ((i % N) + N) % N;
      const im = images[idx];
      imgEl.src = imgSrc(im);
      capEl.textContent = imgLabel(im) || '';
      // when cycling art, always reset any flipped state
      imgEl.dataset.face = '0';
    }

    if (N < 2) { prevBtn.style.display = 'none'; nextBtn.style.display = 'none'; }
    else {
      prevBtn.addEventListener('click', e => { e.preventDefault(); show(idx - 1); });
      nextBtn.addEventListener('click', e => { e.preventDefault(); show(idx + 1); });
    }

    if (keyHandler) document.removeEventListener('keydown', keyHandler);
    keyHandler = (e) => {
      if (!drawerEl.classList.contains('show')) return;
      if (N < 2) return;
      if (e.key === 'ArrowLeft')  { e.preventDefault(); show(idx - 1); }
      if (e.key === 'ArrowRight') { e.preventDefault(); show(idx + 1); }
    };
    document.addEventListener('keydown', keyHandler);

    if (typeof bootstrap !== 'undefined') {
      drawerEl.addEventListener('hidden.bs.offcanvas', () => {
        if (keyHandler) { document.removeEventListener('keydown', keyHandler); keyHandler = null; }
      }, { once: true });
    }

    show(0);
  }

  /* ==== NEW: flip button for dual-face cards (MDFC) in the drawer ==== */
  async function attachDrawerFlip(scryfallId){
    try {
      const wrap = contentEl.querySelector('.drawer-cycler');
      const img  = contentEl.querySelector('#drawerMainImg');
      if (!wrap || !img || !scryfallId) return;

      // Remove an existing button if present (re-open drawer case)
      const old = wrap.querySelector('.flip-face-btn');
      if (old) old.remove();

      // Get faces
      const res = await fetch(`/api/print/${scryfallId}/faces`);
      if (!res.ok) return;
      const data = await res.json();
      const faces = Array.isArray(data.faces) ? data.faces.filter(f => f && (f.large || f.normal || f.small)) : [];
      if (faces.length < 2) return; // not MDFC — nothing to do

      const pick = (f) => f.large || f.normal || f.small || null;

      // Add button
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'flip-face-btn btn btn-sm';
      btn.title = 'Flip card';
      btn.setAttribute('aria-label','Flip card');
      btn.textContent = '⇆';
      wrap.appendChild(btn);

      const front = pick(faces[0]) || img.getAttribute('src');
      const back  = pick(faces[1]) || img.getAttribute('src');

      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        const cur = img.getAttribute('data-face') === '1' ? 1 : 0;
        const next = cur ^ 1;
        img.setAttribute('data-face', String(next));
        img.setAttribute('src', next ? back : front);
      });

      // If user cycles art with arrows, reset to front
      wrap.addEventListener('click', (ev) => {
        const t = ev.target;
        if (t && (t.classList.contains('prev') || t.classList.contains('next'))) {
          img.setAttribute('data-face', '0');
          img.setAttribute('src', front);
        }
      }, true);
    } catch (_) {}
  }
  /* ===== end new block ===== */

  function buildDetailRow(label, html) {
    const value = (html !== undefined && html !== null && html !== '') ? html : MISSING_TEXT;
    return `<div class="d-flex gap-2 mb-1"><div class="detail-label">${label}</div><div>${value}</div></div>`;
  }

  function renderDrawer(payload) {
    const card = payload?.card || {};
    const info = payload?.info || {};
    const images = normalizeImages(payload);

    document.getElementById('cardDrawerLabel').textContent = info.name || card.name || 'Card';

    const commanderBadge = renderCommanderBadge(info?.commander_legality ?? info?.legalities?.commander);
    const setCode = (info?.set || '').toUpperCase();
    const setName = info?.set_name || '';
    let setHtml = MISSING_TEXT;
    if (setName || setCode) {
      const namePart = setName ? esc(setName) : '';
      const codePart = setCode ? ` <span class="small-muted">[${esc(setCode)}]</span>` : '';
      setHtml = `${namePart}${codePart}`.trim() || MISSING_TEXT;
    }
    const rarityHtml = info?.rarity ? esc(String(info.rarity).toUpperCase()) : MISSING_TEXT;
    const typeHtml = info?.type_line ? esc(info.type_line) : MISSING_TEXT;
    const cardNumberHtml = info?.collector_number ? esc(info.collector_number) : MISSING_TEXT;
    const cmcHtml = info?.cmc !== undefined && info?.cmc !== null ? esc(info.cmc) : MISSING_TEXT;
    const colorsHtml = renderColorPips(info);
    const folderHtml = card?.folder ? esc(card.folder) : MISSING_TEXT;
    const quantityHtml = card?.quantity !== undefined && card?.quantity !== null ? esc(card.quantity) : MISSING_TEXT;
    const scryButtons = renderScryfallButtons(info);

    contentEl.innerHTML = `
      ${buildCyclerHTML(images)}
      ${info?.mana_cost_html
        ? `<div class="mb-2"><div class="fw-semibold">Mana Cost</div><div>${info.mana_cost_html}</div></div>` : ''}
      ${info?.oracle_text_html
        ? `<div class="mb-3"><div class="fw-semibold">Card Text</div><div>${info.oracle_text_html}</div></div>` : ''}
      <div class="mb-3">
        ${buildDetailRow('Type', typeHtml)}
        ${buildDetailRow('Colors', colorsHtml)}
        ${buildDetailRow('CMC', cmcHtml)}
        ${buildDetailRow('Rarity', rarityHtml)}
        ${buildDetailRow('Set', setHtml)}
        ${buildDetailRow('Card #', cardNumberHtml)}
        ${buildDetailRow('Commander', commanderBadge)}
        ${buildDetailRow('Folder', folderHtml)}
        ${buildDetailRow('Quantity', quantityHtml)}
      </div>
      ${scryButtons}
    `;
    initCycler(images);

    /* NEW: add flip overlay if this print has a back side */
    attachDrawerFlip(info.scryfall_id || info.scryfallId || info.id);
  }

  async function openCardDrawer(cardId, hrefFallback) {
    document.getElementById('cardDrawerLabel').textContent = 'Loading…';
    document.getElementById('drawerContent').innerHTML = '<div class="text-center small text-muted">Loading…</div>';
    openDrawer();
    try {
      const res = await fetch(`/api/card/${cardId}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      renderDrawer(await res.json());
    } catch (err) {
      console.warn('[cards drawer] failed:', err);
      document.getElementById('drawerContent').innerHTML = '<div class="text-danger">Failed to load card.</div>';
      if (hrefFallback) window.location = hrefFallback;
    }
  }

  const selectionToolbar = document.getElementById('cardSelectToolbar');
  if (selectionToolbar) {
    const cardCheckboxes = Array.from(document.querySelectorAll('.card-select'));
    const selectAllToggle = document.getElementById('cardSelectAll');
    const countEl = document.getElementById('cardSelectCount');
    const pluralEl = document.getElementById('cardSelectPlural');
    const hiddenInput = document.getElementById('cardSelectInput');
    const clearBtn = document.getElementById('cardSelectClear');
    const submitBtn = document.getElementById('cardSelectSubmit');
    const targetWrapper = document.getElementById('cardSelectTargetWrapper');
    const targetInput = document.getElementById('cardSelectTargetInput');
    const formEl = document.getElementById('cardSelectForm');

    const totalCheckboxes = cardCheckboxes.length;

    const getTargetValue = () => (targetInput?.value || '').trim();

    const resetTargetSelection = () => {
      if (targetWrapper) {
        const defaultBtn = targetWrapper.querySelector('[data-dv-select-option][data-value=""]');
        if (defaultBtn) {
          defaultBtn.click();
          return;
        }
      }
      if (targetInput) {
        targetInput.value = '';
      }
    };

    function syncSelectionState() {
      const selected = cardCheckboxes.filter(cb => cb.checked);
      const ids = selected.map(cb => cb.value);
      const count = ids.length;
      countEl.textContent = count;
      if (pluralEl) pluralEl.textContent = count === 1 ? '' : 's';
      hiddenInput.value = ids.join(',');
      if (count > 0) {
        selectionToolbar.classList.remove('d-none');
      } else {
        selectionToolbar.classList.add('d-none');
      }
      if (selectAllToggle && totalCheckboxes) {
        selectAllToggle.checked = count > 0 && count === totalCheckboxes;
        selectAllToggle.indeterminate = count > 0 && count < totalCheckboxes;
      }
      submitBtn.disabled = !count || !getTargetValue();
    }

    cardCheckboxes.forEach(cb => {
      cb.addEventListener('change', syncSelectionState);
      cb.addEventListener('click', evt => evt.stopPropagation());
    });

    if (selectAllToggle) {
      selectAllToggle.addEventListener('change', () => {
        const checked = selectAllToggle.checked;
        cardCheckboxes.forEach(cb => {
          cb.checked = checked;
        });
        syncSelectionState();
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        cardCheckboxes.forEach(cb => {
          cb.checked = false;
        });
        if (selectAllToggle) {
          selectAllToggle.checked = false;
          selectAllToggle.indeterminate = false;
        }
        resetTargetSelection();
        syncSelectionState();
      });
    }

    if (targetWrapper) {
      targetWrapper.addEventListener('dv-select:change', () => {
        syncSelectionState();
      });
      targetWrapper.addEventListener('dv-select:ready', () => {
        syncSelectionState();
      });
    } else if (targetInput) {
      targetInput.addEventListener('change', syncSelectionState);
    }

    if (formEl) {
      formEl.addEventListener('submit', () => {
        submitBtn.disabled = true;
      });
    }

    syncSelectionState();
  }

  document.addEventListener('click', function (e) {
    if (e.target.closest('a.card-link')) return;
    if (e.target.closest('.card-select')) return;
    const row = e.target.closest('tr.card-row');
    if (!row) return;
    if (window.getSelection && window.getSelection().toString()) return;

    const id = row.getAttribute('data-card-id');
    const href = row.querySelector('a.card-link')?.getAttribute('href') || null;
    if (id) openCardDrawer(id, href);
  });

  document.querySelectorAll('tr.card-row').forEach(tr => {
    tr.setAttribute('tabindex', '0');
    tr.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const id = tr.getAttribute('data-card-id');
        const href = tr.querySelector('a.card-link')?.getAttribute('href') || null;
        if (id) openCardDrawer(id, href);
      }
    });
  });
})();
</script>
{% endblock %}

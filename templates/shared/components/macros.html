{# shared macros #}
{% macro slug(s) -%}
  {%- set t = (s or '') -%}
  {%- set t = t|replace('&', 'and') -%}
  {%- set bad = ['"', "'", '(', ')', '/', '\\', ',', '.', ':', ';', '[', ']', '{', '}', '!', '?', '#', '$', '%', '@', '*', '–', '—'] -%}
  {%- for ch in bad -%}{%- set t = t|replace(ch, '') -%}{%- endfor -%}
  {%- set t = t|trim|replace(' ', '-')|replace('_','-') -%}
  {%- for i in range(6) -%}{%- set t = t|replace('--','-') -%}{%- endfor -%}
  {{- t|lower -}}
{%- endmacro %}

{# badge for folders; adds Bootstrap rarity contexts for common/uncommon/rare/mythic #}
{% macro folder_badge(name, suffix=None) -%}
  {%- set s = slug(name) -%}
  {%- set ctx_map = {'common':'secondary','uncommon':'success','rare':'warning','mythic':'danger'} -%}
  {%- set ctx = ctx_map.get(s) -%}
  <span class="badge badge-folder badge-folder-{{ s }} {% if ctx %}text-bg-{{ ctx }}{% endif %}">
    {{ name }}{% if suffix %} {{ suffix }}{% endif %}
  </span>
{%- endmacro %}

{% macro commander_chip(card, size=40) -%}
  {% if card %}
    {# Accept Card rows (image_small/scryfall_small) and presenters (small/large/name/alt) #}
    {% set src = (card.small if card.small is defined and card.small
                  else card.image_small if card.image_small is defined and card.image_small
                  else card.scryfall_small if card.scryfall_small is defined and card.scryfall_small
                  else url_for('static', filename='img/card-back-small.jpg')) %}
    {% set altcore = (card.alt if card.alt is defined and card.alt else (card.name|default('Commander'))) %}
    <img
      src="{{ src }}"
      alt="{{ altcore }} (Commander)"
      class="cmdr-thumb"
      style="width: {{ size }}px; height:auto; border-radius:.5rem;"
      loading="lazy" referrerpolicy="no-referrer">
  {% endif %}
{%- endmacro %}

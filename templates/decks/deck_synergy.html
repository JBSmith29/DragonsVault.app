{% extends "base.html" %}
{% block title %}Deck Synergy - DragonsVault{% endblock %}
{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="mb-3">
  {% set deck_crumb_name = none %}
  {% if analysis and analysis.deck and analysis.deck.name %}
    {% set deck_crumb_name = analysis.deck.name %}
  {% elif selected_folder and selected_folder.name %}
    {% set deck_crumb_name = selected_folder.name %}
  {% endif %}
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{{ url_for('views.dashboard') }}">Dashboard</a></li>
    {% if selected_id and deck_crumb_name %}
      <li class="breadcrumb-item"><a href="{{ url_for('views.deck_synergy') }}">Synergy Lab</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ deck_crumb_name }}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">Synergy Lab</li>
    {% endif %}
  </ol>
</nav>
{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/role-icons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/deckbuilder-modern.css') }}">

<div id="synergyRoot" class="page-section container-fluid px-3 px-lg-4">
  {% if deck_options %}
    {% set selected_tile = (deck_options | selectattr('id','equalto',selected_id) | list | first) %}
    {% if selected_id and selected_tile %}
      <div class="card shadow-sm mb-3">
        <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div class="d-flex align-items-center gap-3">
            <a class="card synergy-tile mb-0 text-reset text-decoration-none"
               href="{{ url_for('views.deck_synergy', folder_id=selected_tile.id) }}"
               data-deck-id="{{ selected_tile.id }}"
               data-hover-src="{{ selected_tile.commander_hover }}">
              <div class="card-body d-flex align-items-center gap-3 flex-nowrap">
                {% set hover = selected_tile.commander_hover %}
                <div class="commander-thumb-wrapper" style="width:48px;height:68px;">
                  {% if hover %}
                    <img src="{{ hover }}"
                         alt="{{ selected_tile.commander or 'Commander' }}"
                         class="commander-thumb"
                         style="width:100%;height:auto;max-height:68px;object-fit:contain;">
                  {% else %}
                    <i class="bi bi-person-badge fs-4 text-muted"></i>
                  {% endif %}
                </div>
                <div class="flex-grow-1 min-w-0">
                  <span class="fw-semibold d-block text-truncate">{{ selected_tile.name }}</span>
                  <span class="text-muted small d-block text-truncate">{{ selected_tile.commander or 'Commander not set' }}</span>
                  {% if selected_tile.tag %}<span class="badge text-bg-info text-dark mt-1">{{ selected_tile.tag }}</span>{% endif %}
                </div>
                <span class="badge text-bg-secondary align-self-start">{{ selected_tile.qty }} cards</span>
              </div>
            </a>
          </div>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('views.deck_synergy') }}">Back to decks</a>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <h5 class="mb-0">Choose a deck to analyse</h5>
            <span class="text-muted small">{{ deck_options|length }} available</span>
          </div>
          <div class="row g-3">
            {% for deck in deck_options %}
              <div class="col-12 col-md-6 col-xl-4">
                <a class="card synergy-tile h-100 text-reset text-decoration-none hover-lift"
                   href="{{ url_for('views.deck_synergy', folder_id=deck.id) }}"
                   data-deck-id="{{ deck.id }}"
                   data-hover-src="{{ deck.commander_hover }}">
                  <div class="card-body d-flex align-items-center gap-3 flex-nowrap">
                    {% set hover = deck.commander_hover %}
                    <div class="commander-thumb-wrapper" style="width:48px;height:68px;">
                      {% if hover %}
                        <img src="{{ hover }}"
                             alt="{{ deck.commander or 'Commander' }}"
                             class="commander-thumb"
                             style="width:100%;height:auto;max-height:68px;object-fit:contain;">
                      {% else %}
                        <i class="bi bi-person-badge fs-4 text-muted"></i>
                      {% endif %}
                    </div>
                    <div class="flex-grow-1 min-w-0">
                      <span class="fw-semibold d-block text-truncate">{{ deck.name }}</span>
                      <span class="text-muted small d-block text-truncate">{{ deck.commander or 'Commander not set' }}</span>
                      {% if deck.tag %}<span class="badge text-bg-info text-dark mt-1">{{ deck.tag }}</span>{% endif %}
                    </div>
                    <span class="badge text-bg-secondary align-self-start">{{ deck.qty }} cards</span>
                  </div>
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

{% if analysis %}
  <div class="card deck-summary-card mb-4 w-100">
    <div class="card-body">
      <div class="summary-header d-flex flex-column flex-lg-row align-items-lg-center gap-2 w-100">
        <div class="d-flex flex-column flex-grow-1 gap-1">
          <div class="text-muted small text-uppercase">Synergy Lab</div>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <h2 class="h5 mb-0">{{ analysis.deck.name }}</h2>
          </div>
        </div>
        {% if selected_folder %}
          <a class="btn btn-outline-light btn-sm align-self-stretch align-self-lg-center" href="{{ url_for('views.build_a_deck', folder_id=selected_folder.id) }}">Open Builder</a>
        {% endif %}
      </div>
      <div class="d-flex align-items-center gap-3 flex-wrap mt-3">
        {% set commander = analysis.deck.commander %}
        {% set commander_img = commander.hover_image if commander else None %}
        <div class="flex-shrink-0 d-flex flex-column align-items-start gap-2">
          {% if commander_img %}
            <a href="{{ commander.scryfall_url if commander and commander.scryfall_url else '#' }}" data-hover-src="{{ commander_img }}" class="card-hover-link">
              <img src="{{ commander_img }}" alt="Commander" class="commander-thumb-inline rounded">
            </a>
          {% endif %}
        </div>
        <div class="flex-grow-1">
          <div class="text-muted text-uppercase small mb-1">Commander</div>
          <div class="h5 mb-1 d-flex align-items-center gap-2 flex-wrap">
            <span>{{ commander.name if commander else 'â€”' }}</span>
            {% if analysis.deck.color_identity and analysis.deck.color_identity.html %}
              <span class="pip-row" aria-label="Color identity">{{ analysis.deck.color_identity.html | safe }}</span>
            {% endif %}
          </div>
          {% if commander and commander.oracle_text %}
            <div class="small text-muted mt-1 text-truncate" title="{{ commander.oracle_text }}">{{ commander.oracle_text }}</div>
          {% endif %}
        </div>
        <div class="deck-summary-grid w-100 mt-2">
          <div class="deck-summary-stat">
            <div class="label">Total cards</div>
            <div class="value">{{ analysis.deck.total_cards or 0 }}</div>
          </div>
          <div class="deck-summary-stat">
            <div class="label">Unique</div>
            <div class="value">{{ analysis.deck.unique_cards or 0 }}</div>
          </div>
          <div class="deck-summary-stat">
            <div class="label">Themes</div>
            <div class="value">{{ theme_count }}</div>
          </div>
          <div class="deck-summary-stat">
            <div class="label">Roles needing attention</div>
            <div class="value">{{ role_alert_count }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if analysis and analysis.roles %}
    <div class="card deck-summary-card mb-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Role Coverage</span>
      </div>
      <div class="card-body">
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
          {% for role in analysis.roles %}
            <div class="col">
              <div class="card synergy-role-card h-100 shadow-sm">
                <div class="card-body d-flex flex-column gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <div class="flex-grow-1 min-w-0">
                      <div class="fw-semibold text-truncate">{{ role.label }}</div>
                      <div class="text-muted small text-truncate">
                        {{ role.current }} cards
                      </div>
                    </div>
                  </div>
                  {% if role.cards %}
                    <div class="pill-stack small mt-2 show" id="role-cards-{{ loop.index }}">
                      {% for card in role.cards %}
                        {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                        <span class="role-pill role-card-hover" data-hover-src="{{ hover_src }}">{{ card.name }}</span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-muted small">No cards tagged for this role.</div>
                  {% endif %}
                  {% set upgrades = role.recommendations or role.upgrades or role.missing %}
                  {% if upgrades %}
                    <div class="text-muted small mt-2">Potential upgrades</div>
                    <div class="pill-stack small">
                      {% for card in upgrades %}
                        {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                        <span class="role-pill role-card-hover" data-hover-src="{{ hover_src }}">{{ card.name }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {% if analysis and analysis.themes %}
    <div class="card deck-summary-card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Theme Synergies</span>
        <span class="text-muted small">Tap to expand details</span>
      </div>
      <div class="card-body">
        <div class="accordion" id="themeAccordion">
          {% for theme in analysis.themes %}
            {% set tid = 'theme-' ~ loop.index %}
            <div class="accordion-item synergy-theme">
              <h2 class="accordion-header" id="h-{{ tid }}">
                <button class="accordion-button d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#c-{{ tid }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="c-{{ tid }}">
                  <span class="fw-semibold">{{ theme.label }}</span>
                  <span class="badge text-bg-primary">{{ theme.score }}</span>
                </button>
              </h2>
              <div id="c-{{ tid }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="h-{{ tid }}" data-bs-parent="#themeAccordion">
                <div class="accordion-body">
                  <div class="text-muted small mb-3">{{ theme.description }}</div>
                  {% if theme.sample_cards %}
                    <div class="pill-stack mb-3">
                      {% for c in theme.sample_cards %}
                        {% set hover_src = c.hover_image or hover_lookup.get(c.name|default('', true)|lower) %}
                        {% set in_deck = c.in_deck or c.get('in_deck') if c is mapping else False %}
                        {% if in_deck %}
                          <span class="role-pill role-card-hover bg-success-subtle text-success fw-semibold"
                                data-hover-src="{{ hover_src }}"
                                title="Already in deck">
                            {{ c.name }}
                          </span>
                        {% else %}
                          <span class="role-pill role-card-hover" data-hover-src="{{ hover_src }}">{{ c.name }}</span>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                  {% if theme.recommendations %}
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                      {% for rec in theme.recommendations %}
                        <div class="col">
                          <div class="card card-body shadow-sm card-row-modern">
                            {% set hover_src = rec.hover_image or hover_lookup.get(rec.name|default('', true)|lower) %}
                            <div class="fw-semibold">
                              {% set detail_href = rec.id and url_for('views.card_detail', card_id=rec.id) or rec.scryfall_url or '#' %}
                              <a class="text-reset text-decoration-none role-card-hover"
                                 data-hover-src="{{ hover_src }}"
                                 href="{{ detail_href }}">
                                {{ rec.name }}
                              </a>
                            </div>
                            {% if rec.type_line %}<div class="meta">{{ rec.type_line }}</div>{% endif %}
                            {% if rec.scryfall_url %}<div class="d-flex gap-2 flex-wrap mt-1"><a class="btn btn-sm btn-outline-secondary" href="{{ rec.scryfall_url }}" target="_blank" rel="noreferrer">Scryfall</a></div>{% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-muted">No recommendations available.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

{% else %}
  <div class="alert alert-info">Select a deck to analyse.</div>
{% endif %}

<script src="{{ url_for('static', filename='js/role_display.js') }}"></script>
<script>
  // Ensure deck tiles navigate even if nested elements consume the click
  document.querySelectorAll('.synergy-tile').forEach((tile) => {
    tile.addEventListener('click', (evt) => {
      if (tile.href) {
        // Allow normal navigation; prevent other handlers from swallowing it
        window.location.href = tile.href;
      } else if (tile.dataset.deckId) {
        const url = `${window.location.pathname}?folder_id=${tile.dataset.deckId}`;
        window.location.href = url;
      }
    });
  });
</script>
{% endblock %}

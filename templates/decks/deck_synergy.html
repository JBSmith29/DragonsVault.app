{% extends "base.html" %}
{% block title %}Deck Synergy - DragonsVault{% endblock %}
{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="mb-3">
  {% set deck_crumb_name = none %}
  {% if analysis and analysis.deck and analysis.deck.name %}
    {% set deck_crumb_name = analysis.deck.name %}
  {% elif selected_folder and selected_folder.name %}
    {% set deck_crumb_name = selected_folder.name %}
  {% endif %}
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{{ url_for('views.dashboard') }}">Dashboard</a></li>
    {% if selected_id and deck_crumb_name %}
      <li class="breadcrumb-item"><a href="{{ url_for('views.deck_synergy') }}">Synergy Lab</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ deck_crumb_name }}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">Synergy Lab</li>
    {% endif %}
  </ol>
</nav>
{% endblock %}
{% block content %}

<style>
  .view-toggle-group .btn.view-mode-active {
    background: var(--bs-primary);
    color: #fff;
    border-color: var(--bs-primary);
  }

  .synergy-summary img.commander-thumb {
    width: 140px;
    height: auto;
    border-radius: .85rem;
    box-shadow: 0 1.5rem 3rem rgba(15, 23, 42, 0.3);
  }
  @media (min-width: 768px) {
    .synergy-summary img.commander-thumb {
      width: 160px;
    }
  }

  .deck-header-meta {
    display: flex;
    flex-direction: column;
    gap: .65rem;
    color: var(--bs-secondary-color);
  }
  .deck-commander-line {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: .35rem;
    color: var(--bs-body-color);
    font-size: .95rem;
  }
  .deck-commander-line strong {
    color: var(--bs-body-color);
  }
  .deck-commander-line a {
    color: inherit;
  }
  .deck-color-identity {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    align-items: center;
  }
  .deck-color-identity-label {
    font-weight: 600;
    color: var(--bs-body-color);
    font-size: .9rem;
  }
  .deck-color-identity .synergy-card-color {
    flex-wrap: nowrap;
    white-space: nowrap;
    gap: .4rem;
  }

  #synergyRoot .card.shadow-sm {
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.16);
    box-shadow: none;
    border-radius: 1rem;
    backdrop-filter: blur(12px);
  }
  #synergyRoot .card.shadow-sm + .card.shadow-sm {
    margin-top: 1.25rem;
  }
  #synergyRoot .card-header {
    background: linear-gradient(135deg, rgba(56, 189, 248, 0.12), rgba(99, 102, 241, 0.18));
    border-bottom: 1px solid rgba(148, 163, 184, 0.14);
    text-transform: uppercase;
    letter-spacing: .14em;
    font-size: .72rem;
    font-weight: 600;
    color: #e2e8f0;
    border-radius: 1rem 1rem 0 0;
  }
  #synergyRoot .card-header .fw-semibold {
    color: inherit;
    font-weight: 700;
    letter-spacing: inherit;
  }
  #synergyRoot .card-body {
    padding: 1.35rem;
  }

  .synergy-stat {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: .85rem;
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: .35rem;
    box-shadow: 0 .75rem 1.5rem rgba(15, 23, 42, 0.08);
  }
  .synergy-stat-label {
    text-transform: uppercase;
    letter-spacing: .08em;
    font-size: .7rem;
    color: var(--bs-secondary-color);
  }
  .synergy-stat-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--bs-body-color);
  }
  .synergy-stat-value small {
    font-size: .8rem;
    font-weight: 500;
    color: var(--bs-secondary-color);
  }

  #synergyRoot .text-uppercase.text-muted.fw-semibold {
    letter-spacing: .14em;
    font-size: .72rem;
    color: rgba(191, 219, 254, 0.82) !important;
    display: inline-flex;
    align-items: center;
    gap: .4rem;
  }
  #synergyRoot .text-uppercase.text-muted.fw-semibold::after {
    content: "";
    display: inline-block;
    height: 1px;
    width: 42px;
    background: currentColor;
    opacity: .35;
  }

  .synergy-role-grid {
    display: grid;
    gap: 1rem;
  }
  @media (min-width: 768px) {
    .synergy-role-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (min-width: 1200px) {
    .synergy-role-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
  }

  .synergy-role-card {
    border: 1px solid rgba(148, 163, 184, 0.16);
    border-radius: .85rem;
    padding: 1rem 1.1rem;
    background: rgba(15, 23, 42, 0.45);
    color: var(--bs-body-color);
    cursor: pointer;
    transition: transform .18s var(--dv-ease-soft), border-color .18s var(--dv-ease-soft), background-color .18s var(--dv-ease-soft);
    box-shadow: none;
  }
  .synergy-role-card:hover,
  .synergy-role-card:focus-visible {
    transform: translateY(-4px);
    border-color: rgba(99, 102, 241, 0.45);
    background: rgba(99, 102, 241, 0.16);
  }
  .synergy-role-card:focus-visible {
    outline: 2px solid rgba(var(--bs-primary-rgb), .45);
    outline-offset: 3px;
  }
  .synergy-role-card.active {
    border-color: rgba(var(--bs-primary-rgb), .55);
    box-shadow: none;
    background: rgba(var(--bs-primary-rgb), .18);
  }
  .synergy-role-card.needs-attention {
    border-color: rgba(255, 193, 7, .65);
    background: rgba(255, 193, 7, .08);
  }
  .synergy-role-card .role-count {
    font-size: 2.25rem;
    font-weight: 600;
    line-height: 1.05;
  }
  .synergy-role-card .metric {
    font-size: 1rem;
    font-weight: 600;
  }
  .synergy-role-card .metric span {
    font-size: .9rem;
    font-weight: 400;
    color: var(--bs-secondary-color);
  }

  .synergy-role-detail-card {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: .85rem;
    box-shadow: 0 .75rem 1.5rem rgba(15, 23, 42, 0.08);
  }

  .synergy-theme-card .badge {
    font-size: .8rem;
  }

  .mana-inline {
    display: inline-flex;
    align-items: center;
    gap: .15rem;
  }
  .mana-inline img.mana {
    height: 1em;
    vertical-align: text-bottom;
  }
  .synergy-card-color {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: .35rem;
    justify-content: center;
    color: var(--bs-secondary-color);
  }
  .synergy-card-color .mana-inline {
    gap: .25rem;
  }
  .synergy-card-color .mana-inline img.mana {
    height: 1.35em;
  }
  .synergy-theme-pill {
    font-size: .75rem;
    letter-spacing: .04em;
    text-transform: uppercase;
  }
  .synergy-theme-card {
    background: rgba(15, 23, 42, 0.45);
    border: 1px solid rgba(148, 163, 184, 0.16);
    border-radius: .85rem;
    box-shadow: none;
    transition: border-color .18s var(--dv-ease-soft), background-color .18s var(--dv-ease-soft);
  }
  .synergy-theme-card:hover {
    border-color: rgba(99, 102, 241, 0.4);
    background: rgba(99, 102, 241, 0.16);
  }
  .theme-highlight-section {
    border-radius: .85rem;
    padding: .85rem 1rem;
    background: rgba(148, 163, 184, 0.12);
    border: 1px solid rgba(148, 163, 184, 0.2);
    transition: background-color .18s var(--dv-ease-soft), border-color .18s var(--dv-ease-soft);
  }
  .theme-highlight-section + .theme-highlight-section {
    margin-top: 1rem;
  }
  .theme-highlight-key {
    background: rgba(56, 189, 248, 0.12);
    border-color: rgba(56, 189, 248, 0.32);
  }
  .theme-highlight-upgrade {
    background: rgba(34, 197, 94, 0.12);
    border-color: rgba(34, 197, 94, 0.3);
  }
  html[data-bs-theme="light"] .theme-highlight-key {
    background: rgba(56, 189, 248, 0.18);
  }
  html[data-bs-theme="light"] .theme-highlight-upgrade {
    background: rgba(34, 197, 94, 0.18);
  }
  .theme-highlight-section-header {
    display: flex;
    align-items: center;
    gap: .5rem;
    text-transform: uppercase;
    letter-spacing: .08em;
    font-size: .7rem;
    font-weight: 600;
    color: var(--bs-secondary-color);
  }
  .theme-highlight-section-header .label {
    color: var(--bs-body-color);
    font-size: .78rem;
    letter-spacing: .06em;
  }
  .theme-highlight-section-header i {
    font-size: 1rem;
    opacity: .85;
  }
  .theme-highlight-count {
    margin-left: auto;
    font-size: .65rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    background: rgba(15, 23, 42, 0.35);
    color: var(--bs-body-color);
    border-radius: 999px;
    padding: .15rem .55rem;
  }
  .theme-highlight-key .theme-highlight-count {
    background: rgba(56, 189, 248, 0.25);
    color: #e0f2fe;
  }
  .theme-highlight-upgrade .theme-highlight-count {
    background: rgba(34, 197, 94, 0.25);
    color: #d1fae5;
  }
  html[data-bs-theme="light"] .theme-highlight-key .theme-highlight-count {
    color: #075985;
  }
  html[data-bs-theme="light"] .theme-highlight-upgrade .theme-highlight-count {
    color: #065f46;
  }
  .theme-highlight-section-body {
    margin-top: .75rem;
  }
  .theme-collapse-toggle {
    border-radius: .65rem;
    padding: .25rem .5rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: inherit;
  }
  .theme-collapse-toggle .bi {
    transition: transform .2s var(--dv-ease-soft);
  }
  .theme-collapse-toggle[aria-expanded="true"] .bi {
    transform: rotate(180deg);
  }
  .theme-card-collapse {
    margin-top: .75rem;
  }

  .synergy-card-grid {
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }
  @media (min-width: 576px) {
    .synergy-card-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (min-width: 992px) {
    .synergy-card-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .synergy-card {
    background: rgba(15, 23, 42, 0.35);
    border: 1px solid rgba(148, 163, 184, 0.16);
    border-radius: .85rem;
    padding: 1rem;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: .75rem;
    box-shadow: none;
    transition: transform .18s var(--dv-ease-soft), border-color .18s var(--dv-ease-soft), background-color .18s var(--dv-ease-soft);
    color: var(--bs-body-color);
  }
  .synergy-card:hover {
    transform: translateY(-4px);
    background-color: rgba(99, 102, 241, 0.18);
    border-color: rgba(99, 102, 241, 0.4);
  }
  .synergy-card__image {
    display: flex;
    justify-content: center;
  }
  .synergy-card-thumb {
    width: 100%;
    max-width: 260px;
    border-radius: 1rem;
    box-shadow: 0 1.5rem 3rem rgba(15, 23, 42, 0.35);
  }
  .synergy-card__body {
    display: flex;
    flex-direction: column;
    gap: .5rem;
    text-align: center;
  }
  .synergy-card__header {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: center;
    gap: .5rem;
  }
  .synergy-card__title {
    font-weight: 600;
  }
  .synergy-card__title .synergy-card-link {
    color: var(--bs-body-color);
    text-decoration-color: rgba(var(--bs-primary-rgb), 0.35);
  }
  .synergy-card__title .synergy-card-link:hover,
  .synergy-card__title .synergy-card-link:focus-visible {
    color: var(--bs-link-hover-color);
    text-decoration-color: currentColor;
  }
  .synergy-card-badges,
  .synergy-card-tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: .35rem;
  }
  .synergy-card-meta-list {
    display: flex;
    flex-direction: column;
    gap: .25rem;
  }
  .synergy-card-meta {
    color: var(--bs-secondary-color);
    font-size: .78rem;
  }
  .synergy-tag-badge {
    background: rgba(var(--bs-primary-rgb), 0.12);
    color: var(--bs-primary);
    border: 1px solid rgba(var(--bs-primary-rgb), 0.22);
    text-transform: uppercase;
    letter-spacing: .06em;
    font-size: .72rem;
  }

  #synergyRoot[data-view-mode="list"] .synergy-card-grid {
    display: flex;
    flex-direction: column;
    gap: .5rem;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card {
    flex-direction: row;
    align-items: center;
    text-align: left;
    padding: .65rem 1rem;
    gap: .5rem;
    border-radius: 0;
    box-shadow: none;
    border: 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    background: transparent;
    transition: background-color .18s var(--dv-ease-soft), border-color .18s var(--dv-ease-soft);
  }
  #synergyRoot[data-view-mode="list"] .synergy-card + .synergy-card {
    border-top: 0;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card:hover {
    transform: none;
    background-color: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.25);
  }
  #synergyRoot[data-view-mode="list"] .synergy-card__image {
    display: none;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card-thumb {
    display: none;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card__body {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    grid-template-rows: auto auto;
    gap: .2rem;
    align-items: center;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card__header {
    justify-content: flex-start;
    gap: .5rem;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card__title {
    font-size: 1rem;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card-badges {
    margin-left: auto;
    gap: .35rem;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card-color,
  #synergyRoot[data-view-mode="list"] .synergy-card-tags {
    display: none;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card-meta-list {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    grid-column: 1 / -1;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card-meta-list .synergy-card-meta:nth-child(n+2) {
    display: none;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card__body {
    align-items: flex-start;
    text-align: left;
    flex: 1;
    gap: .35rem;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card__header {
    justify-content: space-between;
  }
  #synergyRoot[data-view-mode="list"] .synergy-card-badges,
  #synergyRoot[data-view-mode="list"] .synergy-card-tags,
  #synergyRoot[data-view-mode="list"] .synergy-card-color {
    justify-content: flex-start;
  }

  .synergy-empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--bs-secondary-color);
  }

  .deck-synergy-table th {
    font-size: .75rem;
    letter-spacing: .08em;
  }
  .deck-synergy-table tr.role-match {
    background: rgba(var(--bs-primary-rgb), 0.12);
  }
  .deck-synergy-table tbody tr:hover {
    background: rgba(var(--bs-primary-rgb), 0.08);
  }

  .synergy-type-column {
    position: sticky;
    top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .synergy-type-offcanvas {
    --bs-offcanvas-width: min(420px, 100%);
  }
  .type-breakdown-trigger {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
  }
  .type-breakdown-trigger .bi {
    font-size: 1rem;
  }
  @media (max-width: 1199.98px) {
    .synergy-type-column {
      position: static;
    }
  }

  .collapse-toggle {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
  }
  .collapse-toggle .bi {
    transition: transform .2s ease;
  }
  .collapse-toggle[aria-expanded="false"] .bi {
    transform: rotate(180deg);
  }
</style>

{% set hover_lookup = hover_lookup | default({}, true) %}
{% set card_link_lookup = namespace(values={}) %}

{% macro register_card_link(name, card_id=None, url=None, external=None) -%}
  {%- if name -%}
  {%- set key = name|lower -%}
  {%- set entry = card_link_lookup.values.get(key) -%}
  {%- if not entry -%}
    {%- set entry = {} -%}
  {%- endif -%}
  {%- if card_id and entry.get('card_id') != card_id -%}
    {%- set _ = entry.update({'card_id': card_id}) -%}
    {%- if entry.get('external') -%}
      {%- set _ = entry.update({'external': False}) -%}
    {%- endif -%}
  {%- endif -%}
  {%- if url and entry.get('url') != url -%}
    {%- set _ = entry.update({'url': url}) -%}
  {%- endif -%}
  {%- if external is not none -%}
    {%- set _ = entry.update({'external': external}) -%}
  {%- endif -%}
  {%- set _ = card_link_lookup.values.update({key: entry}) -%}
  {%- endif -%}
{%- endmacro %}

{% macro synergy_card_link(name, hover=none, card_id=none, url=none, classes='', external=False) -%}
  {%- set hover_src = hover -%}
  {%- if (not hover_src) and (hover_lookup is defined) -%}
    {%- set hover_src = hover_lookup.get(name|lower) -%}
  {%- endif -%}
  {%- set href = (card_id and url_for('views.card_detail', card_id=card_id)) or url -%}
  {%- set target = '_blank' if external and href else none -%}
  {%- if href -%}
    <a href="{{ href }}" class="{{ classes }}" {% if target %}target="{{ target }}" rel="noreferrer"{% endif %} {% if hover_src %}data-hover-src="{{ hover_src }}"{% endif %}>{{ name }}</a>
  {%- else -%}
    <span class="{{ classes }}" {% if hover_src %}data-hover-src="{{ hover_src }}"{% endif %}>{{ name }}</span>
  {%- endif -%}
{%- endmacro %}

{% macro synergy_card_row(name, hover_image=none, card_id=none, url=none, meta=none, tags=none, badge_html=none, external=None, card_classes='') -%}
  {%- set hover_src = hover_image -%}
  {%- if (not hover_src) and (hover_lookup is defined) -%}
    {%- set hover_src = hover_lookup.get(name|lower) -%}
  {%- endif -%}
  {%- set link_entry = (card_link_lookup.values.get(name|lower) if card_link_lookup is defined else None) -%}
  {%- set resolved_card_id = card_id or (link_entry.get('card_id') if link_entry else None) -%}
  {%- set resolved_url = url or (link_entry.get('url') if link_entry else None) -%}
  {%- set resolved_external = external -%}
  {%- if resolved_external is none -%}
    {%- set resolved_external = False -%}
  {%- endif -%}
  {%- if resolved_card_id -%}
    {%- set resolved_external = False -%}
  {%- elif link_entry and link_entry.get('external') is not none and external is none -%}
    {%- set resolved_external = link_entry.get('external') -%}
  {%- endif -%}
  {%- set thumb = hover_src or url_for('static', filename='img/card-placeholder.svg') -%}
  {%- set color_meta_ns = namespace(values=[]) -%}
  {%- set info_meta_ns = namespace(values=[]) -%}
  {%- if meta -%}
    {%- for line in meta -%}
      {%- if line -%}
        {%- if 'mana-inline' in line -%}
          {%- set _ = color_meta_ns.values.append(line) -%}
        {%- else -%}
          {%- set _ = info_meta_ns.values.append(line) -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
  {%- set search_ns = namespace(tokens=[name]) -%}
  {%- for line in color_meta_ns.values -%}
    {%- set _ = search_ns.tokens.append(line|striptags) -%}
  {%- endfor -%}
  {%- for line in info_meta_ns.values -%}
    {%- set _ = search_ns.tokens.append(line|striptags) -%}
  {%- endfor -%}
  {%- if tags -%}
    {%- for tag in tags -%}
      {%- if tag -%}
        {%- set _ = search_ns.tokens.append(tag) -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
  {%- set card_search = search_ns.tokens | join(' ') -%}
  <article class="synergy-card {{ card_classes }}" data-card-name="{{ name }}" data-card-search="{{ card_search|trim }}">
    <div class="synergy-card__image">
      <img class="synergy-card-thumb" src="{{ thumb }}" alt="{{ name }}" loading="lazy" referrerpolicy="no-referrer"{% if hover_src %} data-hover-src="{{ hover_src }}"{% endif %}>
    </div>
    <div class="synergy-card__body">
      <div class="synergy-card__header">
        <div class="synergy-card__title">
          {{ synergy_card_link(name, hover_src, resolved_card_id, resolved_url, classes='synergy-card-link link-underline-opacity-25 link-underline-opacity-100-hover', external=resolved_external) }}
        </div>
        {% if badge_html %}
          <div class="synergy-card-badges">{{ badge_html|safe }}</div>
        {% endif %}
      </div>
      {% if color_meta_ns.values %}
        <div class="synergy-card-color">
          {% for line in color_meta_ns.values %}
            {{ line|safe }}
          {% endfor %}
        </div>
      {% endif %}
      {% if info_meta_ns.values %}
        <div class="synergy-card-meta-list">
          {% for line in info_meta_ns.values %}
            <div class="synergy-card-meta">{{ line|safe }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {% if tags %}
        <div class="synergy-card-tags">
          {% for tag in tags %}
            {% if tag %}
              <span class="badge synergy-tag-badge">{{ tag }}</span>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </article>
{%- endmacro %}

{% macro synergy_type_card(title, chart, total=0, collapse_id='', persist_key='', description=None, mdfc_cards=None) -%}
  <div class="card shadow-sm">
    <div class="card-header bg-body-secondary d-flex justify-content-between align-items-center">
      <span class="fw-semibold">{{ title }}</span>
      {% if collapse_id %}
        <button class="btn btn-outline-secondary btn-sm collapse-toggle"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#{{ collapse_id }}"
                aria-expanded="true"
                aria-controls="{{ collapse_id }}">
          <i class="bi bi-chevron-up"></i>
          <span class="visually-hidden">Toggle {{ title|lower }}</span>
        </button>
      {% endif %}
    </div>
    <div {% if collapse_id %}id="{{ collapse_id }}"{% endif %} class="collapse show" {% if persist_key %}data-persist-collapse="{{ persist_key }}"{% endif %}>
      <div class="card-body">
        {% if description %}
          <p class="text-muted small mb-3">{{ description }}</p>
        {% endif %}
        <div class="d-flex flex-column">
          {% for item in chart %}
            {% set percent_calc = 0 %}
            {% set percent_raw = None %}
            {% if item.percent is defined %}
              {% set percent_raw = item.percent %}
            {% elif item.get is defined %}
              {% set percent_raw = item.get('percent') %}
            {% endif %}
            {% if percent_raw is string %}
              {% set percent_raw = percent_raw|float %}
            {% endif %}
            {% set value_raw = 0 %}
            {% if item.value is defined %}
              {% set value_raw = item.value %}
            {% elif item.get is defined %}
              {% set value_raw = item.get('value', 0) %}
            {% endif %}
            {% if percent_raw is not none %}
              {% if percent_raw <= 1 %}
                {% set percent_calc = percent_raw * 100 %}
              {% else %}
                {% set percent_calc = percent_raw %}
              {% endif %}
            {% elif total %}
              {% set percent_calc = (value_raw * 100 / total) %}
            {% endif %}
            {% set percent = percent_calc|round(1, 'common') %}
            {% set swatch = item.color or (item.get('color') if item.get is defined else '#0d6efd') %}
            <div class="chart-row">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="d-flex align-items-center gap-2">
                  <span class="chart-swatch" style="background-color: {{ swatch }};"></span>
                  <span class="fw-semibold">{{ item.label if item.label is defined else (item.get('label') if item.get is defined else 'Unknown') }}</span>
                </div>
                <span class="text-muted small">{{ value_raw }} cards ({{ percent }}%)</span>
              </div>
              <div class="progress">
                <div class="progress-bar" style="width: {{ percent }}%; background-color: {{ swatch }};"></div>
              </div>
            </div>
          {% endfor %}
        </div>
        {% if mdfc_cards %}
          <div class="alert alert-secondary mt-3 mb-0">
            <div class="text-uppercase small fw-semibold text-muted mb-1">Modal DFCs (counted as lands)</div>
            <div class="synergy-card-grid mb-2">
              {% for card in mdfc_cards %}
                {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                {% set meta_lines = [] %}
                {% if card.color_identity_html is defined and card.color_identity_html %}
                  {% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}
                {% endif %}
                {% if card.face_summary %}{% set _ = meta_lines.append(card.face_summary) %}{% endif %}
                {% set badge_ns = namespace(html=[]) %}
                {% if card.quantity and card.quantity > 1 %}
                  {% set _ = badge_ns.html.append('<span class="badge text-bg-secondary">x{0}</span>'.format(card.quantity)) %}
                {% endif %}
                {{ register_card_link(card.name, card.card_id, None, external=(not card.card_id)) }}
                {{ synergy_card_row(card.name, hover_src, card.card_id, meta=meta_lines, badge_html=badge_ns.html|join('')) }}
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{%- endmacro %}

{% macro render_synergy_type_breakdown_stack(deck_chart=None, edhrec_chart=None, mdfc_cards=None, prefix='main', include_deck_chart=True) -%}
  {% set deck_collapse_id = prefix ~ '_deckTypeCollapse' %}
  {% set edhrec_collapse_id = prefix ~ '_edhrecTypeCollapse' %}
  {% set deck_persist = 'deck-type-' ~ prefix %}
  {% set edhrec_persist = 'edhrec-type-' ~ prefix %}
  <div class="d-flex flex-column gap-3">
    {% if deck_chart and include_deck_chart %}
      {% set deck_description = 'Live breakdown of your {0} unique cards ({1} total).'.format(deck.unique_cards, deck.total_cards) %}
      {{ synergy_type_card(deck_chart.title or 'Deck Type Distribution', deck_chart.content, deck_chart.total, deck_collapse_id, deck_persist, deck_description, mdfc_cards) }}
    {% endif %}
    {% if edhrec_chart %}
      {% set edhrec_total = edhrec_chart.content | sum(attribute='value') %}
      {% set edhrec_description = 'Based on {0} recent lists for this commander'.format(edhrec_total if edhrec_total else 'EDHREC') %}
      {% if edhrec and edhrec.theme and edhrec.theme.tag_label %}
        {% set edhrec_description = edhrec_description ~ ' (' ~ edhrec.theme.tag_label ~ ')' %}
      {% endif %}
      {{ synergy_type_card('EDHREC Type Breakdown', edhrec_chart.content, edhrec_total, edhrec_collapse_id, edhrec_persist, edhrec_description) }}
    {% endif %}
    {% if not deck_chart and not edhrec_chart %}
      <div class="text-muted small">Type data will appear here once available.</div>
    {% endif %}
  </div>
{%- endmacro %}

<div id="synergyRoot" class="page-section" data-view-mode="grid">
  <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
    <h1 class="mb-0">Deck Synergy</h1>
    {% if analysis %}
      {% if role_alert_count %}
        <span class="badge text-bg-warning text-uppercase fw-semibold">Needs tweaks</span>
      {% else %}
        <span class="badge text-bg-success text-uppercase fw-semibold">Balanced</span>
      {% endif %}
    {% endif %}
  </div>
  <p class="text-muted">
    Pick a commander deck to see staple counts and synergy recommendations inspired by EDHREC-style heuristics.
    We scan your list for role coverage (ramp, draw, interaction, wipes) and highlight themes with tuned suggestions.
  </p>

  {% set synergy_deck_label = "Select a deck..." %}
  {% if selected_id %}
    {% for opt in deck_options %}
      {% if opt.id == selected_id %}
        {% set synergy_deck_label = opt.name ~ ((' (' ~ opt.qty ~ ' cards)') if opt.qty else '') %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <form method="get"
        action="{{ url_for('views.deck_synergy') }}"
        class="row g-3 align-items-end mb-4"
        hx-boost="false">
    <div class="col-md-6 col-lg-5">
      <label for="deckSelect" class="form-label">Choose a deck</label>
      <div class="dropdown dv-select w-100" data-dv-select="synergy-deck">
        <input type="hidden"
               id="deckSelect"
               name="folder_id"
               value="{{ selected_id or '' }}"
               data-dv-select-input>
        <button class="btn dv-select-toggle w-100 justify-content-between"
                type="button"
                id="deckSelectToggle"
                data-bs-toggle="dropdown"
                aria-expanded="false">
          <span data-dv-select-label>{{ synergy_deck_label }}</span>
          <i class="bi bi-chevron-down"></i>
        </button>
        <ul class="dropdown-menu dv-select-menu w-100" aria-labelledby="deckSelectToggle">
          <li class="dv-select-search-wrapper">
            <input type="text"
                   class="form-control form-control-sm dv-select-search"
                   placeholder="Search decks"
                   autocomplete="off"
                   data-dv-select-search>
          </li>
          <li>
            <button class="dropdown-item {% if not selected_id %}active{% endif %}"
                    type="button"
                    data-dv-select-option
                    data-value=""
                    data-label="Select a deck...">
              Select a deck...
            </button>
          </li>
          {% for opt in deck_options %}
            {% set option_label = opt.name ~ ((' (' ~ opt.qty ~ ' cards)') if opt.qty else '') %}
            <li>
              <button class="dropdown-item {% if selected_id == opt.id %}active{% endif %}"
                      type="button"
                      data-dv-select-option
                      data-value="{{ opt.id }}"
                      data-label="{{ option_label }}">
                {{ option_label }}
              </button>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn btn-primary">Analyse Deck</button>
    </div>
    {% if selected_id %}
      <div class="col-md-auto">
        <a class="btn btn-outline-secondary" href="{{ url_for('views.deck_synergy') }}">Clear</a>
      </div>
    {% endif %}
  </form>

{% for message in errors %}
  <div class="alert alert-warning" role="alert">{{ message }}</div>
{% endfor %}

{% if analysis %}
  {% set deck = analysis.deck %}
  {% set edhrec = analysis.edhrec %}
  {% set edhrec_commander = edhrec.commander if edhrec and edhrec.commander else none %}
  {% set edhrec_commander_slug = edhrec_commander.slug if edhrec_commander and edhrec_commander.slug else none %}
  {% set edhrec_commander_theme = edhrec_commander.applied_theme if edhrec_commander and edhrec_commander.applied_theme else none %}
  {% set commander_edhrec_url = none %}
  {% if edhrec_commander_slug %}
    {% set commander_edhrec_url = 'https://edhrec.com/commanders/' ~ edhrec_commander_slug %}
    {% if edhrec_commander_theme %}
      {% set commander_edhrec_url = commander_edhrec_url ~ '/' ~ edhrec_commander_theme %}
    {% endif %}
  {% endif %}
  {% set edhrec_theme = edhrec.theme if edhrec and edhrec.theme else none %}
  {% set edhrec_theme_slug = edhrec_theme.slug if edhrec_theme and edhrec_theme.slug else none %}
  {% set tag_edhrec_url = none %}
  {% if edhrec_theme_slug %}
    {% set tag_edhrec_url = 'https://edhrec.com/themes/' ~ edhrec_theme_slug %}
  {% endif %}
  {% for analysis_card in analysis.analysis_cards|default([], true) %}
    {{- register_card_link(analysis_card.name, analysis_card.card_id) -}}
  {% endfor %}
  {% for deck_row in analysis.deck_card_rows|default([], true) %}
    {{- register_card_link(deck_row.name, deck_row.card_id, deck_row.scryfall_url if deck_row.scryfall_url is defined else None, external=(not deck_row.card_id)) -}}
  {% endfor %}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-4">
    <div class="text-muted small fw-semibold text-uppercase">Card Display</div>
    <div class="btn-group btn-group-sm view-toggle-group" role="group" aria-label="Card display mode">
      <button type="button" class="btn btn-outline-secondary view-mode-active" data-view-toggle="grid" aria-pressed="true">
        <i class="bi bi-grid-3x3-gap-fill me-1" aria-hidden="true"></i> Gallery
      </button>
      <button type="button" class="btn btn-outline-secondary" data-view-toggle="list" aria-pressed="false">
        <i class="bi bi-list-ul me-1" aria-hidden="true"></i> List
      </button>
    </div>
  </div>
  <section class="card synergy-summary mb-4">
    <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
      <span>Deck Overview</span>
      <button class="btn btn-outline-secondary btn-sm collapse-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#synergySummaryCollapse"
              aria-expanded="true"
              aria-controls="synergySummaryCollapse">
        <i class="bi bi-chevron-up"></i>
        <span class="visually-hidden">Toggle deck overview</span>
      </button>
    </div>
    <div id="synergySummaryCollapse" class="collapse show" data-persist-collapse="synergy-summary">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center gap-3">
          {% if deck.commander and deck.commander.image %}
            <img
              src="{{ deck.commander.image }}"
              alt="{{ deck.commander.name or deck.name }}"
              class="commander-thumb flex-shrink-0"
              loading="lazy"
              referrerpolicy="no-referrer"
              data-hover-src="{{ deck.commander.image }}">
          {% endif %}
          <div class="flex-grow-1">
            <h2 class="h4 mb-1">{{ deck.name }}</h2>
            <div class="deck-header-meta mb-3">
              {% if deck.commander and deck.commander.name %}
                <div class="deck-commander-line">
                  <strong>Commander:</strong>
                  {% if deck.commander.scryfall_url %}
                    <a href="{{ deck.commander.scryfall_url }}" class="link-light link-underline-opacity-25 link-underline-opacity-100-hover" target="_blank" rel="noreferrer">
                      {{ deck.commander.name }}
                    </a>
                  {% else %}
                    {{ deck.commander.name }}
                  {% endif %}
                  {% if deck.commander.type_line %}
                    <span class="text-muted">{{ deck.commander.type_line }}</span>
                  {% endif %}
                </div>
              {% endif %}
              <div class="deck-color-identity">
                <span class="deck-color-identity-label">Color identity:</span>
                <span class="text-muted">{{ deck.color_identity.label }}</span>
                {% if deck.color_identity.html %}
                  <span class="synergy-card-color ms-0" aria-label="Color identity">{{ deck.color_identity.html | safe }}</span>
                {% endif %}
              </div>
            </div>
            {% if deck.tag %}
              <div class="d-flex flex-wrap align-items-center gap-2 text-muted small mb-3">
                <strong class="text-uppercase small text-muted">Deck tag</strong>
                <span class="badge text-bg-secondary">{{ deck.tag_label or deck.tag }}</span>
                {% if analysis.tag_synergy %}
                  <span class="badge text-bg-dark bg-opacity-50 me-1">Score {{ analysis.tag_synergy.score }}%</span>
                  <span class="badge text-bg-info text-dark me-1">Grade {{ analysis.tag_synergy.grade }}</span>
                  {% if analysis.tag_synergy.status_text %}
                    <span>{{ analysis.tag_synergy.status_text }}</span>
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}
            {% set can_send_to_build = selected_folder and selected_id and (selected_folder.category != selected_folder.CATEGORY_BUILD) and not selected_folder.is_collection %}
            {% set can_open_build = selected_folder and selected_folder.category == selected_folder.CATEGORY_BUILD %}
            {% if (deck.commander and deck.commander.name and (commander_edhrec_url or tag_edhrec_url)) or can_send_to_build or can_open_build %}
              <div class="deck-link-row d-flex flex-wrap align-items-center gap-2 mb-3">
                {% if deck.commander and deck.commander.name %}
                  {% if commander_edhrec_url %}
                    <a class="btn btn-sm btn-outline-info" href="{{ commander_edhrec_url }}" target="_blank" rel="noreferrer">
                      EDHREC Commander
                    </a>
                  {% endif %}
                  {% if tag_edhrec_url %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ tag_edhrec_url }}" target="_blank" rel="noreferrer">
                      EDHREC Tag
                    </a>
                  {% endif %}
                {% endif %}
                {% if can_send_to_build %}
                  <form method="post"
                        action="{{ url_for('views.deck_synergy_playground', folder_id=selected_id) }}"
                        class="mb-0 ms-sm-auto">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                      Send to Build-A-Deck Playground
                    </button>
                  </form>
                {% elif can_open_build %}
                  <a class="btn btn-sm btn-outline-primary ms-sm-auto"
                     href="{{ url_for('views.build_a_deck', folder_id=selected_folder.id) }}">
                    Open in Build-A-Deck
                  </a>
                {% endif %}
              </div>
            {% endif %}
            {% set has_edhrec_coverage = edhrec and (edhrec.coverage.present_count or edhrec.coverage.missing_candidates) %}
            {% if has_edhrec_coverage %}
              <div class="mt-3">
                <div class="text-muted small">
                  <strong>EDHREC coverage:</strong>
                  {% if edhrec.coverage.present_count %}
                    {{ edhrec.coverage.present_count }} card{{ 's' if edhrec.coverage.present_count != 1 else '' }} overlap
                    {% if edhrec.coverage.present_average_synergy_percent is not none %}
                      (avg synergy {{ edhrec.coverage.present_average_synergy_percent }}%)
                    {% endif %}
                  {% else %}
                    No commander/theme staples detected yet.
                  {% endif %}
                  {% if edhrec.coverage.missing_candidates %}
                    &middot; {{ edhrec.coverage.missing_candidates }} suggestion{{ 's' if edhrec.coverage.missing_candidates != 1 else '' }} queued
                  {% endif %}
                </div>
                <div class="mt-2">
                  {% if role_alert_count %}
                    <div class="text-warning fw-semibold small">
                      {{ role_alert_count }} role{{ 's' if role_alert_count != 1 else '' }} below recommended counts
                    </div>
                  {% else %}
                    <div class="text-success fw-semibold small">
                      Core role counts meet suggested baselines
                    </div>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <div class="mt-3">
                {% if role_alert_count %}
                  <div class="text-warning fw-semibold small">
                    {{ role_alert_count }} role{{ 's' if role_alert_count != 1 else '' }} below recommended counts
                  </div>
                {% else %}
                  <div class="text-success fw-semibold small">
                    Core role counts meet suggested baselines
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>

  {% set category_summary = analysis.deck_category_summary %}
  {% set deck_chart = analysis.deck_type_chart %}
  {% set edhrec_chart = edhrec.charts.type_distribution if edhrec and edhrec.charts and edhrec.charts.type_distribution else none %}
  {% set mdfc_cards = analysis.mdfc_cards if analysis and analysis.mdfc_cards else [] %}
{% set has_type_charts = false %}
  {% set type_panel_title = 'Type Distribution Comparison' if deck_chart and edhrec_chart else ('EDHREC Type Breakdown' if edhrec_chart else 'Type Distribution') %}
  {% if category_summary %}
    <section class="card mb-4">
      <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <span>Category Overview</span>
          {% if category_summary.cards_without_roles_or_themes %}
            <span class="small text-muted">
              {{ category_summary.cards_without_roles_or_themes | length }} card{{ 's' if category_summary.cards_without_roles_or_themes | length != 1 else '' }} rely on type fallback
            </span>
          {% endif %}
        </div>
        <button class="btn btn-outline-secondary btn-sm collapse-toggle"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#categoryOverviewCollapse"
                aria-expanded="true"
                aria-controls="categoryOverviewCollapse">
          <i class="bi bi-chevron-up"></i>
          <span class="visually-hidden">Toggle category overview</span>
        </button>
      </div>
      <div id="categoryOverviewCollapse" class="collapse show" data-persist-collapse="category-overview">
        <div class="card-body">
          <div class="row row-cols-1 row-cols-md-3 g-3">
            <div class="col">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-uppercase text-muted fw-semibold mb-2">Role Tags</h3>
                {% if category_summary.roles %}
                  <div class="d-flex flex-wrap gap-2">
                    {% for item in category_summary.roles[:6] %}
                      <span class="badge rounded-pill bg-primary-subtle text-primary">
                        {{ item.label }} ({{ item.count }})
                      </span>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted small mb-0">No role tags detected yet.</p>
                {% endif %}
              </div>
            </div>
            <div class="col">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-uppercase text-muted fw-semibold mb-2">Theme Tags</h3>
                {% if category_summary.themes %}
                  <div class="d-flex flex-wrap gap-2">
                    {% for item in category_summary.themes[:6] %}
                      <span class="badge rounded-pill bg-info-subtle text-info">
                        {{ item.label }} ({{ item.count }})
                      </span>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted small mb-0">No theme triggers detected yet.</p>
                {% endif %}
              </div>
            </div>
            <div class="col">
              <div class="border rounded p-3 h-100">
                <h3 class="h6 text-uppercase text-muted fw-semibold mb-2">Type Fallback</h3>
                {% if category_summary.fallback_types %}
                  <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for item in category_summary.fallback_types %}
                      <span class="badge rounded-pill bg-secondary-subtle text-secondary">
                        {{ item.label }} ({{ item.count }})
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}
                {% if category_summary.cards_without_roles_or_themes %}
                  <p class="text-muted small mb-0">
                    Needs tagging:
                    {{ category_summary.cards_without_roles_or_themes[:5] | join(', ') }}{% if category_summary.cards_without_roles_or_themes | length > 5 %}...{% endif %}
                  </p>
                {% else %}
                  <p class="text-muted small mb-0">All cards covered by roles or themes.</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% if deck_chart or edhrec_chart %}
            <div class="row g-3 mt-4">
              {% if deck_chart %}
                <div class="col-12{% if edhrec_chart %} col-xl-6{% endif %}">
                  {% set category_deck_collapse = 'categoryDeckTypeCollapse' %}
                  {% set category_deck_persist = 'deck-type-category' %}
                  {% set deck_description = 'Live breakdown of your {0} unique cards ({1} total).'.format(deck.unique_cards, deck.total_cards) %}
                  {{ synergy_type_card(deck_chart.title or 'Deck Type Distribution', deck_chart.content, deck_chart.total, category_deck_collapse, category_deck_persist, deck_description, mdfc_cards) }}
                </div>
              {% endif %}
              {% if edhrec_chart %}
                <div class="col-12{% if deck_chart %} col-xl-6{% endif %}">
                  {% set category_edhrec_collapse = 'categoryEdhrecTypeCollapse' %}
                  {% set category_edhrec_persist = 'edhrec-type-category' %}
                  {% set edhrec_total = edhrec_chart.content | sum(attribute='value') %}
                  {% set edhrec_description = 'Based on {0} recent lists for this commander'.format(edhrec_total if edhrec_total else 'EDHREC') %}
                  {% if edhrec and edhrec.theme and edhrec.theme.tag_label %}
                    {% set edhrec_description = edhrec_description ~ ' (' ~ edhrec.theme.tag_label ~ ')' %}
                  {% endif %}
                  {{ synergy_type_card('EDHREC Type Breakdown', edhrec_chart.content, edhrec_total, category_edhrec_collapse, category_edhrec_persist, edhrec_description) }}
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </section>
{% elif deck_chart or edhrec_chart %}
  <div class="mb-4">
    <div class="row g-3">
      {% if deck_chart %}
        <div class="col-12{% if edhrec_chart %} col-xl-6{% endif %}">
          {% set category_deck_collapse = 'categoryDeckTypeCollapse' %}
          {% set category_deck_persist = 'deck-type-category' %}
          {% set deck_description = 'Live breakdown of your {0} unique cards ({1} total).'.format(deck.unique_cards, deck.total_cards) %}
          {{ synergy_type_card(deck_chart.title or 'Deck Type Distribution', deck_chart.content, deck_chart.total, category_deck_collapse, category_deck_persist, deck_description, mdfc_cards) }}
        </div>
      {% endif %}
      {% if edhrec_chart %}
        <div class="col-12{% if deck_chart %} col-xl-6{% endif %}">
          {% set category_edhrec_collapse = 'categoryEdhrecTypeCollapse' %}
          {% set category_edhrec_persist = 'edhrec-type-category' %}
          {% set edhrec_total = edhrec_chart.content | sum(attribute='value') %}
          {% set edhrec_description = 'Based on {0} recent lists for this commander'.format(edhrec_total if edhrec_total else 'EDHREC') %}
          {% if edhrec and edhrec.theme and edhrec.theme.tag_label %}
            {% set edhrec_description = edhrec_description ~ ' (' ~ edhrec.theme.tag_label ~ ')' %}
          {% endif %}
          {{ synergy_type_card('EDHREC Type Breakdown', edhrec_chart.content, edhrec_total, category_edhrec_collapse, category_edhrec_persist, edhrec_description) }}
        </div>
      {% endif %}
    </div>
  </div>
{% endif %}

<div class="row g-4 align-items-start synergy-layout">
  <div class="col-12{% if has_type_charts %} col-xl-8 col-xxl-9 order-xl-1{% endif %}">
{% if edhrec and edhrec.errors %}
  <div class="alert alert-warning small" role="alert">
    <strong>EDHREC notice:</strong>
    <ul class="mb-0">
      {% for err in edhrec.errors %}
          <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if edhrec and (edhrec.combined.present or edhrec.combined.missing) %}
    <section class="card mb-4">
      <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
        <span>EDHREC Combined Suggestions</span>
        <button class="btn btn-outline-secondary btn-sm collapse-toggle"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#edhrecCombinedCollapse"
                aria-expanded="true"
                aria-controls="edhrecCombinedCollapse">
          <i class="bi bi-chevron-up"></i>
          <span class="visually-hidden">Toggle EDHREC combined suggestions</span>
        </button>
      </div>
      <div id="edhrecCombinedCollapse" class="collapse show" data-persist-collapse="edhrec-combined">
        <div class="card-body">
          <div id="themeHighlightsAccordion" class="row row-cols-1 row-cols-lg-2 g-3">
            <div class="col">
              <div class="card h-100">
                <div class="card-body">
                  <h3 class="h6 mb-2">Synergy Hits in Deck</h3>
                  <p class="small text-muted">Commander and tag staples you already play.</p>
                  {% if edhrec.combined.present %}
                    <div class="synergy-card-grid mb-0">
{% for rec in edhrec.combined.present[:8] %}
                        {% set hover_src = rec.hover_image or hover_lookup.get(rec.name|default('', true)|lower) %}
                        {% set badge_ns = namespace(html=[]) %}
                        {% set synergy = rec.synergy_percent if rec.synergy_percent is defined else (rec.synergy if rec.synergy is defined else none) %}
                        {% if synergy is not none %}
                          {% set _ = badge_ns.html.append('<span class="badge rounded-pill ' ~ ('text-bg-success' if synergy >= 0 else 'text-bg-warning') ~ '">{0}{1}%</span>'.format('+' if synergy >= 0 else '', synergy)) %}
                        {% endif %}
                        {% set _ = badge_ns.html.append('<span class="badge text-bg-success">In deck</span>') %}
                        {% set meta_lines = [] %}
                        {% set category_text = rec.category %}
                        {% if rec.source_kind == 'theme' and rec.tag %}
                          {% set category_text = category_text ~ '  Theme: ' ~ rec.tag %}
                        {% elif rec.source_kind == 'commander' %}
                          {% set category_text = category_text ~ '  Commander staples' %}
                        {% endif %}
                        {% if category_text %}{% set _ = meta_lines.append(category_text) %}{% endif %}
                        {% if rec.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ rec.color_identity_html ~ '</span>') %}{% endif %}
{{- register_card_link(rec.name, rec.card_id, rec.url, external=(not rec.card_id)) -}}
{{ synergy_card_row(
                            rec.name,
                            hover_src,
                            rec.card_id,
                            rec.url,
                            meta=meta_lines,
                            tags=(rec.role_labels or rec.roles),
                            badge_html=badge_ns.html|join(''),
                            external=(not rec.card_id)
                          ) }}

                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-muted small mb-0">No EDHREC staples detected yet.</p>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card h-100">
                <div class="card-body">
                  <h3 class="h6 mb-2">High-Impact Additions</h3>
                  <p class="small text-muted mb-2">Top EDHREC picks missing from this list.</p>
                  {% if edhrec.combined.missing %}
                    <div class="synergy-card-grid mb-0">
{% for rec in edhrec.combined.missing[:10] %}
                        {% set hover_src = rec.hover_image or hover_lookup.get(rec.name|default('', true)|lower) %}
                        {% set synergy = rec.synergy_percent if rec.synergy_percent is defined else (rec.synergy if rec.synergy is defined else none) %}
                        {% set badge_ns = namespace(html=[]) %}
                        {% if rec.already_in_deck %}
                          {% set _ = badge_ns.html.append('<span class="badge text-bg-success">In deck</span>') %}
                        {% elif rec.owned %}
                          {% set _ = badge_ns.html.append('<span class="badge text-bg-info">Owned</span>') %}
                        {% endif %}
                        {% if synergy is not none %}
                          {% set _ = badge_ns.html.append('<span class="badge rounded-pill ' ~ ('text-bg-success' if synergy >= 0 else 'text-bg-warning') ~ '">{0}{1}%</span>'.format('+' if synergy >= 0 else '', synergy)) %}
                        {% endif %}
                        {% set meta_lines = [] %}
                        {% set category_text = rec.category %}
                        {% if rec.source_kind == 'theme' and rec.tag %}
                          {% set category_text = category_text ~ '  Theme: ' ~ rec.tag %}
                        {% elif rec.source_kind == 'commander' %}
                          {% set category_text = category_text ~ '  Commander staples' %}
                        {% endif %}
                        {% if category_text %}{% set _ = meta_lines.append(category_text) %}{% endif %}
                        {% if rec.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ rec.color_identity_html ~ '</span>') %}{% endif %}
{{- register_card_link(rec.name, rec.card_id, rec.url, external=(not rec.card_id)) -}}
{{ synergy_card_row(
                            rec.name,
                            hover_src,
                            rec.card_id,
                            rec.url,
                            meta=meta_lines,
                            tags=(rec.role_labels or rec.roles),
                            badge_html=badge_ns.html|join(''),
                            external=(not rec.card_id)
                          ) }}

                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-muted small mb-0">You already cover the usual suspects for this shell.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  {% endif %}

  {% if edhrec.theme_showcase %}
    <section class="card mb-4">
      <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
        <div>
          <span>Commander Theme Spotlight</span>
          <div class="text-muted small">Fresh ideas from EDHREC</div>
        </div>
        <button class="btn btn-outline-secondary btn-sm collapse-toggle"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#themeShowcaseCollapse"
                aria-expanded="true"
                aria-controls="themeShowcaseCollapse">
          <i class="bi bi-chevron-up"></i>
          <span class="visually-hidden">Toggle commander theme spotlight</span>
        </button>
      </div>
      <div id="themeShowcaseCollapse" class="collapse show" data-persist-collapse="theme-showcase">
        <div class="card-body">
          <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            {% for showcase in edhrec.theme_showcase %}
              <div class="col">
                <div class="card h-100">
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h4 class="h6 mb-0">{{ showcase.label }}</h4>
                      {% if showcase.error %}
                        <span class="badge text-bg-warning text-dark">Data issue</span>
                      {% endif %}
                    </div>
                    {% if showcase.cards %}
                      <p class="text-muted small mb-2">High-synergy picks:</p>
                      <div class="synergy-card-grid mb-3">
{% for card in showcase.cards[:5] %}
                          {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                          {% set badge_ns = namespace(html=[]) %}
                          {% if card.synergy_percent is not none %}
                            {% set _ = badge_ns.html.append('<span class="badge text-bg-success">+{0}%</span>'.format(card.synergy_percent)) %}
                          {% endif %}
                          {% if card.already_in_deck %}
                            {% set _ = badge_ns.html.append('<span class="badge text-bg-secondary">In deck</span>') %}
                          {% elif card.owned %}
                            {% set _ = badge_ns.html.append('<span class="badge text-bg-info">Owned</span>') %}
                          {% endif %}
                          {% set meta_lines = [] %}
                          {% if card.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}{% endif %}
{{- register_card_link(card.name, card.card_id, card.url, external=(not card.card_id)) -}}
{{ synergy_card_row(
                              card.name,
                              hover_src,
                              card.card_id,
                              card.url,
                              meta=meta_lines,
                              badge_html=badge_ns.html|join(''),
                              external=(not card.card_id)
                            ) }}

                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="text-muted small mb-2">
                        {% if showcase.error %}{{ showcase.error }}{% else %}No curated picks available yet.{% endif %}
                      </p>
                    {% endif %}
                    <div class="mt-auto">
                      {% if showcase.source_url %}
                        <a class="btn btn-outline-primary btn-sm" href="{{ showcase.source_url }}" target="_blank" rel="noreferrer">View on EDHREC</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>
  {% endif %}

  {% if analysis.tag_synergy %}
    {% set tag = analysis.tag_synergy %}
    <section class="card synergy-tag-card mb-4">
      <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
        <span>Deck Tag Synergy</span>
        <button class="btn btn-outline-secondary btn-sm collapse-toggle"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#tagSynergyCollapse"
                aria-expanded="true"
                aria-controls="tagSynergyCollapse">
          <i class="bi bi-chevron-up"></i>
          <span class="visually-hidden">Toggle deck tag synergy</span>
        </button>
      </div>
      <div id="tagSynergyCollapse" class="collapse show" data-persist-collapse="tag-synergy">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
            <div class="flex-grow-1">
              <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
                <h3 class="h5 mb-0">{{ tag.label }}</h3>
                <span class="badge text-bg-secondary">{{ tag.canonical_tag }}</span>
              </div>
              <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                <span class="badge text-bg-dark">Score {{ tag.score }}%</span>
                <span class="badge text-bg-info text-dark">Grade {{ tag.grade }}</span>
                {% if tag.confidence is not none %}
                  <span class="badge text-bg-success bg-opacity-75">Theme fit {{ tag.confidence }}%</span>
                {% endif %}
              </div>
              {% if tag.description %}
                <p class="small text-muted mb-2">{{ tag.description }}</p>
              {% endif %}
              {% if tag.status_text %}
                <p class="small mb-0">{{ tag.status_text }}</p>
              {% endif %}
              {% if tag.themes %}
                <div class="mt-2 d-flex flex-wrap gap-2">
                  {% for theme in tag.themes %}
                    <span class="synergy-theme-pill badge {% if theme.meets %}text-bg-success{% else %}text-bg-warning text-dark{% endif %}">
                      {{ theme.label }} ({{ theme.hits }}/{{ theme.expected }})
                    </span>
                  {% endfor %}
                </div>
              {% endif %}
              {% if tag.explanation %}
                {% set expl = tag.explanation %}
                <details class="mt-3 small text-muted">
                  <summary class="fw-semibold">How this score works</summary>
                  <div class="mt-2">
                    {% if expl.score %}
                      <p class="mb-1">
                        Score reflects {{ expl.score.present_weight }} of {{ expl.score.total_weight }} weighted core staples currently in your list.
                      </p>
                    {% endif %}
                    {% if expl.grade and expl.grade.bands %}
                      <ul class="list-unstyled mb-1">
                        {% for band in expl.grade.bands %}
                          <li><strong>{{ band.grade }}</strong> &middot; {{ band.description }} ({{ band.min }}%+)</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                    {% if expl.confidence %}
                      <p class="mb-0">
                        {% if expl.confidence.value is not none %}Confidence {{ expl.confidence.value }}% &ndash; {% endif %}
                        {{ expl.confidence.note }}
                        {% if expl.confidence.expectations %}
                          ({{ expl.confidence.alignment }}/{{ expl.confidence.expectations }} themes met)
                        {% endif %}
                      </p>
                    {% endif %}
                  </div>
                </details>
              {% endif %}
            </div>
            {% if tag.alerts %}
              <div class="alert alert-warning small mb-0" role="alert">
                <ul class="mb-0">
                  {% for alert in tag.alerts %}
                    <li>{{ alert }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
          <div class="row row-cols-1 row-cols-lg-2 g-3 mt-3">
            <div class="col">
              <div class="border rounded p-3 h-100">
                <h4 class="h6 mb-2">Core Staples</h4>
                <p class="small text-muted mb-2">
                  {{ tag.core.present_count }} of {{ tag.core.eligible_count }} playable staples in deck.
                </p>
                {% if tag.core.present %}
                  <p class="small fw-semibold mb-1 text-success">Already present</p>
                  <div class="synergy-card-grid mb-2">
{% for card in tag.core.present %}
                      {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                      {% set meta_lines = [] %}
                      {% if card.type_line %}{% set _ = meta_lines.append(card.type_line) %}{% elif card.primary_type %}{% set _ = meta_lines.append(card.primary_type) %}{% endif %}
                      {% if card.color_identity_html is defined and card.color_identity_html %}
                        {% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}
                      {% endif %}
                      {% if card.notes %}{% set _ = meta_lines.append(card.notes) %}{% endif %}
                      {% set tag_tokens = [] %}
                      {% for label in card.role_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.theme_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.categories|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.tag_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% if card.tags is defined %}
                        {% if card.tags is string %}
                          {% if card.tags and card.tags not in tag_tokens %}
                            {% set _ = tag_tokens.append(card.tags) %}
                          {% endif %}
                        {% else %}
                          {% for label in card.tags %}
                            {% if label and label not in tag_tokens %}
                              {% set _ = tag_tokens.append(label) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      {% endif %}
                      {% set badge_ns = namespace(html=[]) %}
                      {% set card_synergy = card.synergy_percent if card.synergy_percent is defined else (card.synergy if card.synergy is defined else none) %}
                      {% if card_synergy is not none %}
                        {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if card_synergy >= 0 else 'text-bg-warning', '+' if card_synergy >= 0 else '', card_synergy)) %}
                      {% endif %}
                      {% set _ = badge_ns.html.append('<span class="badge text-bg-success">In deck</span>') %}
{{- register_card_link(card.name, card.card_id, card.scryfall_url, external=(not card.card_id)) -}}
{{- register_card_link(card.name, card.card_id, card.scryfall_url, external=(not card.card_id)) -}}
{{ synergy_card_row(card.name, hover_src, card.card_id, card.scryfall_url, meta=meta_lines, tags=tag_tokens, badge_html=badge_ns.html|join(''), external=(not card.card_id)) }}

                    {% endfor %}
                  </div>
                {% endif %}
                {% if tag.core.missing %}
                  <p class="small fw-semibold mb-1">High-impact additions</p>
                  <div class="synergy-card-grid mb-0">
{% for card in tag.core.missing %}
                      {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                      {% set meta_lines = [] %}
                      {% if card.type_line %}{% set _ = meta_lines.append(card.type_line) %}{% elif card.primary_type %}{% set _ = meta_lines.append(card.primary_type) %}{% endif %}
                      {% if card.color_identity_html is defined and card.color_identity_html %}
                        {% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}
                      {% endif %}
                      {% if card.notes %}{% set _ = meta_lines.append(card.notes) %}{% endif %}
                      {% set tag_tokens = [] %}
                      {% for label in card.role_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.theme_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.categories|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.tag_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% if card.tags is defined %}
                        {% if card.tags is string %}
                          {% if card.tags and card.tags not in tag_tokens %}
                            {% set _ = tag_tokens.append(card.tags) %}
                          {% endif %}
                        {% else %}
                          {% for label in card.tags %}
                            {% if label and label not in tag_tokens %}
                              {% set _ = tag_tokens.append(label) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      {% endif %}
                      {% set badge_ns = namespace(html=[]) %}
                      {% set card_synergy = card.synergy_percent if card.synergy_percent is defined else (card.synergy if card.synergy is defined else none) %}
                      {% if card_synergy is not none %}
                        {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if card_synergy >= 0 else 'text-bg-warning', '+' if card_synergy >= 0 else '', card_synergy)) %}
                      {% endif %}
                      {% set _ = badge_ns.html.append('<span class="badge text-bg-primary">Suggested</span>') %}
{{- register_card_link(card.name, card.card_id, card.scryfall_url, external=(not card.card_id)) -}}
{{ synergy_card_row(card.name, hover_src, card.card_id, card.scryfall_url, meta=meta_lines, tags=tag_tokens, badge_html=badge_ns.html|join(''), external=(not card.card_id)) }}

                    {% endfor %}
                  </div>
                {% else %}
                  <p class="small text-muted mb-0">Core package assembled.</p>
                {% endif %}
              </div>
            </div>
            <div class="col">
              <div class="border rounded p-3 h-100">
                <h4 class="h6 mb-2">Support Picks</h4>
                {% if tag.support.recommendations %}
                  <div class="synergy-card-grid mb-0">
{% for card in tag.support.recommendations %}
                      {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                      {% set meta_lines = [] %}
                      {% if card.type_line %}{% set _ = meta_lines.append(card.type_line) %}{% elif card.primary_type %}{% set _ = meta_lines.append(card.primary_type) %}{% endif %}
                      {% if card.color_identity_html is defined and card.color_identity_html %}
                        {% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}
                      {% endif %}
                      {% if card.notes %}{% set _ = meta_lines.append(card.notes) %}{% endif %}
                      {% set tag_tokens = [] %}
                      {% for label in card.role_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.theme_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.categories|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.tag_labels|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% for label in card.tags|default([], true) %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                      {% set badge_ns = namespace(html=[]) %}
                      {% set card_synergy = card.synergy_percent if card.synergy_percent is defined else (card.synergy if card.synergy is defined else none) %}
                      {% if card_synergy is not none %}
                        {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if card_synergy >= 0 else 'text-bg-warning', '+' if card_synergy >= 0 else '', card_synergy)) %}
                      {% endif %}
                      {% if card.already_in_deck %}
                        {% set _ = badge_ns.html.append('<span class="badge text-bg-success">In deck</span>') %}
                      {% elif card.owned %}
                        {% set _ = badge_ns.html.append('<span class="badge text-bg-info">Owned</span>') %}
                      {% endif %}
{{- register_card_link(card.name, card.card_id, card.scryfall_url, external=(not card.card_id)) -}}
{{ synergy_card_row(card.name, hover_src, card.card_id, card.scryfall_url, meta=meta_lines, tags=tag_tokens, badge_html=badge_ns.html|join(''), external=(not card.card_id)) }}

                    {% endfor %}
                  </div>
                  {% if tag.support.additional_available %}
                    <p class="small text-muted mt-2 mb-0">+ {{ tag.support.additional_available }} more available for this tag.</p>
                  {% endif %}
                {% else %}
                  <p class="small text-muted mb-0">You are already running the usual support pieces.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  {% endif %}

  {% set theme_count = analysis.themes | length if analysis and analysis.themes else 0 %}
  <section class="card mb-4">
    <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
      <div>
        <span>Core Role Checkup</span>
        <div class="text-muted small">Raw counts based on detected card roles</div>
      </div>
      <button class="btn btn-outline-secondary btn-sm collapse-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#coreRoleCollapse"
              aria-expanded="true"
              aria-controls="coreRoleCollapse">
        <i class="bi bi-chevron-up"></i>
        <span class="visually-hidden">Toggle core role checkup</span>
      </button>
    </div>
    <div id="coreRoleCollapse" class="collapse show" data-persist-collapse="core-role-checkup">
      <div class="card-body">
        {% if analysis.roles %}
          <div class="synergy-role-grid mb-3">
            {% for role in analysis.roles %}
              {% set role_key_attr = role.key or ('role-' ~ loop.index0) %}
              <div class="synergy-role-card"
                   data-role-key="{{ role_key_attr }}"
                   data-role-label="{{ role.label }}"
                   role="button"
                   tabindex="0"
                   aria-pressed="false">
                <div class="text-muted small text-uppercase mb-2">{{ role.label }}</div>
                <div class="role-count mb-1">{{ role.current }}</div>
                <div class="text-muted small">cards tagged</div>
              </div>
            {% endfor %}
          </div>
          <div class="card synergy-role-detail-card">
            <div class="card-body">
              <div id="synergyRolePlaceholder" class="text-muted small">
                Select a role to explore tagged cards and targeted recommendations.
              </div>
              {% for role in analysis.roles %}
                {% set role_key_attr = role.key or ('role-' ~ loop.index0) %}
                {% set role_cards = role.cards if role.cards is defined else [] %}
                {% set edhrec_recs = role.edhrec_recommendations or [] %}
                {% set house_recs = role.recommendations or [] %}
                <div class="synergy-role-detail d-none" data-role-detail="{{ role_key_attr }}">
                  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <h6 class="mb-0">{{ role.label }}</h6>
                    <span class="badge text-bg-secondary">{{ role.current }} cards</span>
                  </div>
                  {% if role_cards %}
                    <div class="synergy-card-grid mb-4">
{% for card in role_cards %}
                        {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                        {% set card_id = card.id %}
                        {% set quantity = card.quantity or 1 %}
                        {% set synergy = card.best_synergy_percent %}
                        {% set meta_lines = [] %}
                        {% if card.type_line %}{% set _ = meta_lines.append(card.type_line) %}{% elif card.primary_type %}{% set _ = meta_lines.append(card.primary_type) %}{% endif %}
                        {% if card.color_identity_html is defined and card.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}{% endif %}
                        {% set tag_tokens = [] %}
                        {% if card.role_labels %}
                          {% for label in card.role_labels %}
                            {% if label and label not in tag_tokens %}
                              {% set _ = tag_tokens.append(label) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                        {% if card.theme_labels %}
                          {% for label in card.theme_labels %}
                            {% if label and label not in tag_tokens %}
                              {% set _ = tag_tokens.append(label) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                        {% if not tag_tokens and card.categories %}
                          {% for label in card.categories %}
                            {% if label and label not in tag_tokens %}
                              {% set _ = tag_tokens.append(label) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                        {% set badge_ns = namespace(html=[]) %}
                        {% if quantity > 1 %}
                          {% set _ = badge_ns.html.append('<span class="badge text-bg-secondary">x{0}</span>'.format(quantity)) %}
                        {% endif %}
                        {% if synergy is not none %}
                          {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if synergy >= 0 else 'text-bg-warning', '+' if synergy >= 0 else '', synergy)) %}
                        {% endif %}
                        {% set _ = badge_ns.html.append('<span class="badge text-bg-success">In deck</span>') %}
{{- register_card_link(card.name, card_id, None, external=(not card_id)) -}}
{{ synergy_card_row(
                            card.name,
                            hover_src,
                            card_id,
                            meta=meta_lines,
                            tags=tag_tokens,
                            badge_html=badge_ns.html|join('')
                          ) }}

                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-muted small mb-3">No cards tagged for this role yet.</p>
                  {% endif %}
                  {% if edhrec_recs or house_recs %}
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                      {% if edhrec_recs %}
                        <div class="col">
                          <h6 class="small text-uppercase text-muted mb-2">EDHREC Suggestions</h6>
                          <div class="synergy-card-grid mb-0">
{% for rec in edhrec_recs %}
                              {% set hover_src = rec.hover_image or hover_lookup.get(rec.name|default('', true)|lower) %}
                              {% set synergy = rec.synergy_percent if rec.synergy_percent is defined else (rec.synergy if rec.synergy is defined else none) %}
                              {% set badge_ns = namespace(html=[]) %}
                              {% if rec.already_in_deck %}
                                {% set _ = badge_ns.html.append('<span class="badge text-bg-success">In deck</span>') %}
                              {% elif rec.owned %}
                                {% set _ = badge_ns.html.append('<span class="badge text-bg-info">Owned</span>') %}
                              {% endif %}
                              {% if synergy is not none %}
                                {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if synergy >= 0 else 'text-bg-warning', '+' if synergy >= 0 else '', synergy)) %}
                              {% endif %}
                              {% set meta_lines = [] %}
                              {% if rec.type_line %}{% set _ = meta_lines.append(rec.type_line) %}{% elif rec.primary_type %}{% set _ = meta_lines.append(rec.primary_type) %}{% endif %}
                              {% if rec.category %}{% set _ = meta_lines.append(rec.category) %}{% endif %}
                              {% if rec.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ rec.color_identity_html ~ '</span>') %}{% endif %}
                              {% set tag_tokens = [] %}
                              {% for label in rec.role_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in rec.theme_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% if rec.roles is defined %}
                                {% if rec.roles is string %}
                                  {% if rec.roles and rec.roles not in tag_tokens %}
                                    {% set _ = tag_tokens.append(rec.roles) %}
                                  {% endif %}
                                {% else %}
                                  {% for label in rec.roles %}
                                    {% if label and label not in tag_tokens %}
                                      {% set _ = tag_tokens.append(label) %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                              {% endif %}
                              {% for label in rec.categories|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in rec.tag_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% if rec.tags is defined %}
                                {% if rec.tags is string %}
                                  {% if rec.tags and rec.tags not in tag_tokens %}
                                    {% set _ = tag_tokens.append(rec.tags) %}
                                  {% endif %}
                                {% else %}
                                  {% for label in rec.tags %}
                                    {% if label and label not in tag_tokens %}
                                      {% set _ = tag_tokens.append(label) %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                              {% endif %}
{{- register_card_link(rec.name, rec.card_id, rec.url, external=(not rec.card_id)) -}}
{{ synergy_card_row(
                                  rec.name,
                                  hover_src,
                                  rec.card_id,
                                  rec.url,
                                  meta=meta_lines,
                                  tags=tag_tokens,
                                  badge_html=badge_ns.html|join(''),
                                  external=(not rec.card_id)
                                ) }}

                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                        {% if house_recs %}
                          <div class="col">
                            <h6 class="small text-uppercase text-muted mb-2">House Picks</h6>
                            <div class="synergy-card-grid mb-0">
{% for rec in house_recs %}
                                {% set hover_src = rec.hover_image or hover_lookup.get(rec.name|default('', true)|lower) %}
                                {% set badge_ns = namespace(html=[]) %}
                                {% set synergy = rec.synergy_percent if rec.synergy_percent is defined else (rec.synergy if rec.synergy is defined else none) %}
                                {% if synergy is not none %}
                                  {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if synergy >= 0 else 'text-bg-warning', '+' if synergy >= 0 else '', synergy)) %}
                                {% endif %}
                                {% if rec.already_in_deck %}
                                  {% set _ = badge_ns.html.append('<span class="badge text-bg-secondary">In deck</span>') %}
                                {% elif rec.owned %}
                                  {% set _ = badge_ns.html.append('<span class="badge text-bg-info">Owned</span>') %}
                                {% endif %}
                                {% set meta_lines = [] %}
                                {% if rec.type_line %}{% set _ = meta_lines.append(rec.type_line) %}{% elif rec.primary_type %}{% set _ = meta_lines.append(rec.primary_type) %}{% endif %}
                                {% if rec.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ rec.color_identity_html ~ '</span>') %}{% endif %}
                                {% if rec.notes %}{% set _ = meta_lines.append(rec.notes) %}{% endif %}
                                {% set tag_tokens = [] %}
                                {% for label in rec.role_labels|default([], true) %}
                                  {% if label and label not in tag_tokens %}
                                    {% set _ = tag_tokens.append(label) %}
                                  {% endif %}
                                {% endfor %}
                                {% for label in rec.theme_labels|default([], true) %}
                                  {% if label and label not in tag_tokens %}
                                    {% set _ = tag_tokens.append(label) %}
                                  {% endif %}
                                {% endfor %}
                                {% if rec.roles is defined %}
                                  {% if rec.roles is string %}
                                    {% if rec.roles and rec.roles not in tag_tokens %}
                                      {% set _ = tag_tokens.append(rec.roles) %}
                                    {% endif %}
                                  {% else %}
                                    {% for label in rec.roles %}
                                      {% if label and label not in tag_tokens %}
                                        {% set _ = tag_tokens.append(label) %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
                                {% for label in rec.categories|default([], true) %}
                                  {% if label and label not in tag_tokens %}
                                    {% set _ = tag_tokens.append(label) %}
                                  {% endif %}
                                {% endfor %}
                                {% for label in rec.tag_labels|default([], true) %}
                                  {% if label and label not in tag_tokens %}
                                    {% set _ = tag_tokens.append(label) %}
                                  {% endif %}
                                {% endfor %}
                                {% if rec.tags is defined %}
                                  {% if rec.tags is string %}
                                    {% if rec.tags and rec.tags not in tag_tokens %}
                                      {% set _ = tag_tokens.append(rec.tags) %}
                                    {% endif %}
                                  {% else %}
                                    {% for label in rec.tags %}
                                      {% if label and label not in tag_tokens %}
                                        {% set _ = tag_tokens.append(label) %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
{{- register_card_link(rec.name, rec.card_id, rec.scryfall_url, external=(not rec.card_id)) -}}
{{ synergy_card_row(
                                    rec.name,
                                    hover_src,
                                    rec.card_id,
                                    rec.scryfall_url,
                                    meta=meta_lines,
                                    tags=tag_tokens,
                                    badge_html=badge_ns.html|join(''),
                                    external=(not rec.card_id)
                                  ) }}

                              {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <p class="text-muted small mb-0">No additional recommendations at this time.</p>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <p class="text-muted small mb-0">No role information is available for this deck yet.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="card mb-4">
    <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
      <div>
        <span>Theme Highlights</span>
        {% if theme_count %}
          <div class="text-muted small">{{ theme_count }} theme{{ 's' if theme_count != 1 else '' }} detected</div>
        {% endif %}
      </div>
      <button class="btn btn-outline-secondary btn-sm collapse-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#themeHighlightsCollapse"
              aria-expanded="true"
              aria-controls="themeHighlightsCollapse">
        <i class="bi bi-chevron-up"></i>
        <span class="visually-hidden">Toggle theme highlights</span>
      </button>
    </div>
    <div id="themeHighlightsCollapse" class="collapse show" data-persist-collapse="theme-highlights">
      <div class="card-body">
        {% if analysis.themes %}
          <div class="row row-cols-1 row-cols-lg-2 g-3">
            {% for theme in analysis.themes %}
              {% set collapse_id = 'themeHighlightsItem-' ~ loop.index0 %}
              <div class="col">
                <div class="card h-100 synergy-theme-card">
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h4 class="h6 mb-1">{{ theme.label }}</h4>
                        {% if deck.tag and theme.key and theme.key|lower == deck.tag|lower %}
                          <span class="badge text-bg-primary text-uppercase small">Deck Tag Focus</span>
                        {% endif %}
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge text-bg-info text-dark">Score {{ theme.score }}</span>
                        <button class="btn btn-outline-secondary btn-sm theme-collapse-toggle collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#{{ collapse_id }}"
                                aria-expanded="false"
                                aria-controls="{{ collapse_id }}">
                          <i class="bi bi-chevron-down"></i>
                          <span class="visually-hidden">Toggle {{ theme.label }} details</span>
                        </button>
                      </div>
                    </div>
                    <div id="{{ collapse_id }}" class="collapse theme-card-collapse" data-bs-parent="#themeHighlightsAccordion">
                      <p class="small text-muted mb-3">{{ theme.description }}</p>
                    {% if theme.sample_cards %}
                      <div class="theme-highlight-section theme-highlight-key mb-3">
                        <div class="theme-highlight-section-header">
                          <i class="bi bi-stars" aria-hidden="true"></i>
                          <span class="label">Key Cards</span>
                          <span class="theme-highlight-count">{{ theme.sample_cards|length }}</span>
                        </div>
                        <div class="theme-highlight-section-body">
                          <div class="synergy-card-grid">
{% for sample in theme.sample_cards %}
                              {% set hover_src = sample.hover_image or hover_lookup.get(sample.name|default('', true)|lower) %}
                              {% set sample_url = sample.url if sample.url is defined else (sample.scryfall_url if sample.scryfall_url is defined else none) %}
                              {% set meta_lines = [] %}
                              {% if sample.type_line %}{% set _ = meta_lines.append(sample.type_line) %}{% elif sample.primary_type %}{% set _ = meta_lines.append(sample.primary_type) %}{% endif %}
                              {% if sample.color_identity_html is defined and sample.color_identity_html %}
                                {% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ sample.color_identity_html ~ '</span>') %}
                              {% endif %}
                              {% if sample.notes %}{% set _ = meta_lines.append(sample.notes) %}{% endif %}
                              {% set tag_tokens = [] %}
                              {% for label in sample.role_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in sample.theme_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in sample.categories|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in sample.tag_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% if sample.tags is defined %}
                                {% if sample.tags is string %}
                                  {% if sample.tags and sample.tags not in tag_tokens %}
                                    {% set _ = tag_tokens.append(sample.tags) %}
                                  {% endif %}
                                {% else %}
                                  {% for label in sample.tags %}
                                    {% if label and label not in tag_tokens %}
                                      {% set _ = tag_tokens.append(label) %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                              {% endif %}
{{- register_card_link(sample.name, sample.card_id, sample_url, external=(sample.card_id is none)) -}}
{{ synergy_card_row(sample.name, hover_src, sample.card_id, sample_url, meta=meta_lines, tags=tag_tokens, external=(sample.card_id is none)) }}

                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                    {% if theme.typal %}
                      <div class="small mb-2">
                        <strong>Creature types:</strong>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                          {% for typal in theme.typal %}
                            <span class="badge rounded-pill bg-primary-subtle text-primary">{{ typal }}</span>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                    {% if theme.keywords %}
                      <div class="small mb-2">
                        <strong>Common keywords:</strong>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                          {% for keyword in theme.keywords %}
                            <span class="badge rounded-pill bg-info-subtle text-info">{{ keyword }}</span>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                    {% set upgrade_count = theme.recommendations|length if theme.recommendations else 0 %}
                    <div class="theme-highlight-section theme-highlight-upgrade">
                      <div class="theme-highlight-section-header">
                        <i class="bi bi-rocket-takeoff" aria-hidden="true"></i>
                        <span class="label">Synergy Upgrades</span>
                        <span class="theme-highlight-count">{{ upgrade_count }}</span>
                      </div>
                      <div class="theme-highlight-section-body">
                        {% if theme.recommendations %}
                          <div class="synergy-card-grid">
{% for rec in theme.recommendations %}
                              {% set hover_src = rec.hover_image or hover_lookup.get(rec.name|default('', true)|lower) %}
                              {% set meta_lines = [] %}
                              {% if rec.type_line %}{% set _ = meta_lines.append(rec.type_line) %}{% elif rec.primary_type %}{% set _ = meta_lines.append(rec.primary_type) %}{% endif %}
                              {% if rec.color_identity_html %}{% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ rec.color_identity_html ~ '</span>') %}{% endif %}
                              {% if rec.notes %}{% set _ = meta_lines.append(rec.notes) %}{% endif %}
                              {% set tag_tokens = [] %}
                              {% for label in rec.role_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in rec.theme_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% if rec.roles is defined %}
                                {% if rec.roles is string %}
                                  {% if rec.roles and rec.roles not in tag_tokens %}
                                    {% set _ = tag_tokens.append(rec.roles) %}
                                  {% endif %}
                                {% else %}
                                  {% for label in rec.roles %}
                                    {% if label and label not in tag_tokens %}
                                      {% set _ = tag_tokens.append(label) %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                              {% endif %}
                              {% for label in rec.categories|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% for label in rec.tag_labels|default([], true) %}
                                {% if label and label not in tag_tokens %}
                                  {% set _ = tag_tokens.append(label) %}
                                {% endif %}
                              {% endfor %}
                              {% if rec.tags is defined %}
                                {% if rec.tags is string %}
                                  {% if rec.tags and rec.tags not in tag_tokens %}
                                    {% set _ = tag_tokens.append(rec.tags) %}
                                  {% endif %}
                                {% else %}
                                  {% for label in rec.tags %}
                                    {% if label and label not in tag_tokens %}
                                      {% set _ = tag_tokens.append(label) %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                              {% endif %}
                              {% set badge_ns = namespace(html=[]) %}
                              {% set synergy = rec.synergy_percent if rec.synergy_percent is defined else (rec.synergy if rec.synergy is defined else none) %}
                              {% if synergy is not none %}
                                {% set _ = badge_ns.html.append('<span class="badge {0}">{1}{2}%</span>'.format('text-bg-success' if synergy >= 0 else 'text-bg-warning', '+' if synergy >= 0 else '', synergy)) %}
                              {% endif %}
                              {% if rec.already_in_deck %}
                                {% set _ = badge_ns.html.append('<span class="badge text-bg-secondary">In deck</span>') %}
                              {% elif rec.owned %}
                                {% set _ = badge_ns.html.append('<span class="badge text-bg-info">Owned</span>') %}
                              {% endif %}
{{- register_card_link(rec.name, rec.card_id, rec.scryfall_url, external=(not rec.card_id)) -}}
{{ synergy_card_row(
                                rec.name,
                                hover_src,
                                rec.card_id,
                                rec.scryfall_url,
                                meta=meta_lines,
                                tags=tag_tokens,
                                badge_html=badge_ns.html|join(''),
                                external=(not rec.card_id)
                              ) }}

                            {% endfor %}
                          </div>
                        {% else %}
                          <p class="text-muted small mb-0">You are already running the usual standouts; key cards above are pulled from your list.</p>
                        {% endif %}
                      </div>
                    </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-secondary mb-0" role="alert">
            No strong themes detected yet. Add more cards around a core idea to unlock tailored suggestions.
          </div>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="card mb-4">
    <div class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center">
      <span>Deck Card Breakdown</span>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        {% if has_type_charts %}
          <button class="btn btn-outline-secondary btn-sm type-breakdown-trigger d-xl-none"
                  type="button"
                  data-bs-toggle="offcanvas"
                  data-bs-target="#synergyTypeDrawer"
                  aria-controls="synergyTypeDrawer">
            <i class="bi bi-pie-chart" aria-hidden="true"></i>
            Type Breakdown
          </button>
        {% endif %}
        <button class="btn btn-outline-secondary btn-sm collapse-toggle collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#deckCardBreakdownCollapse"
                aria-expanded="false"
                aria-controls="deckCardBreakdownCollapse">
          <i class="bi bi-chevron-up"></i>
          <span class="visually-hidden">Toggle deck card breakdown</span>
        </button>
      </div>
    </div>
    <div id="deckCardBreakdownCollapse" class="collapse" data-persist-collapse="deck-card-breakdown">
      <div class="card-body">
        <p class="text-muted small mb-3">Current list with role, theme, and EDHREC attribution for each card.</p>
        <div class="row g-2 align-items-end mb-3">
          <div class="col-sm-6 col-lg-4">
            <label for="deckTableFilterInput" class="form-label small text-uppercase text-muted mb-1">Filter cards</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="search"
                     id="deckTableFilterInput"
                     class="form-control"
                     placeholder="Search name, role, or type"
                     data-deck-table-filter-input>
              <button class="btn btn-outline-secondary"
                      type="button"
                      data-deck-table-filter-clear>
                Clear
              </button>
            </div>
          </div>
        </div>
        <div id="deckCardFilterEmpty" class="alert alert-info small d-none" role="status">
          No cards match the current filters. Try a different search or clear the filter.
        </div>
        <div class="table-responsive">
          {% set deck_tag_label = edhrec.theme.tag_label or deck.tag_label or 'Deck Tag' %}
          <table id="deckCardBreakdownTable" class="table table-sm table-hover table-striped align-middle mb-0 deck-synergy-table">
            <thead>
              <tr class="text-uppercase text-muted small text-nowrap">
                <th scope="col">
                  <button type="button" class="table-sort-button" data-sort-card data-sort-direction="none">
                    Card
                    <span class="sort-indicator" aria-hidden="true"></span>
                    <span class="visually-hidden">Toggle card sort</span>
                  </button>
                </th>
                <th scope="col" class="text-center">Commander</th>
                <th scope="col" class="text-center">{{ deck_tag_label }}</th>
              </tr>
            </thead>
            <tbody>
              {% for card in analysis.deck_card_rows %}
                {% set is_mdfc = card.layout is defined and (card.layout or '')|lower == 'modal_dfc' %}
                {% set other_faces = namespace(names=[]) %}
                {% if card.type_faces %}
                  {% for face in card.type_faces %}
                    {% set face_name = face.name %}
                    {% if face_name and face_name|lower != card.name|lower and face_name not in other_faces.names %}
                      {% set _ = other_faces.names.append(face_name) %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% set display_name = card.name %}
                {% if is_mdfc and other_faces.names %}
                  {% set display_name = card.name ~ ' // ' ~ (other_faces.names | join(' // ')) %}
                {% endif %}
                {% set search_tokens = [display_name] %}
                {% if card.type_line %}{% set _ = search_tokens.append(card.type_line) %}{% endif %}
                {% if card.primary_type %}{% set _ = search_tokens.append(card.primary_type) %}{% endif %}
                {% if card.color_identity_label is defined and card.color_identity_label %}{% set _ = search_tokens.append(card.color_identity_label) %}{% endif %}
                {% if card.notes %}{% set _ = search_tokens.append(card.notes) %}{% endif %}
                {% for label in card.roles or [] %}
                  {% if label %}{% set _ = search_tokens.append(label) %}{% endif %}
                {% endfor %}
                {% for label in card.theme_labels|default([], true) %}
                  {% if label %}{% set _ = search_tokens.append(label) %}{% endif %}
                {% endfor %}
                {% for label in card.categories|default([], true) %}
                  {% if label %}{% set _ = search_tokens.append(label) %}{% endif %}
                {% endfor %}
                {% for label in card.tag_labels|default([], true) %}
                  {% if label %}{% set _ = search_tokens.append(label) %}{% endif %}
                {% endfor %}
                <tr data-role-keys="{{ (card.roles or []) | join(' ') }}"
                    data-card-search="{{ search_tokens|join(' ')|lower }}">
                  <td style="min-width: 14rem;" data-card-name="{{ (card.name or '')|lower }}">
                    {% set hover_src = card.hover_image or hover_lookup.get(card.name|default('', true)|lower) %}
                    {% set badge_ns = namespace(html=[]) %}
                    {% if card.quantity and card.quantity > 1 %}
                      {% set _ = badge_ns.html.append('<span class="badge text-bg-secondary">x{0}</span>'.format(card.quantity)) %}
                    {% endif %}
                    {% set meta_lines = [] %}
                    {% if card.type_line %}
                      {% set _ = meta_lines.append(card.type_line) %}
                    {% elif card.primary_type %}
                      {% set _ = meta_lines.append(card.primary_type) %}
                    {% endif %}
                    {% if card.color_identity_html %}
                      {% set _ = meta_lines.append('<span class="mana-inline" aria-label="Color identity">' ~ card.color_identity_html ~ '</span>') %}
                    {% endif %}
                    {% set tag_tokens = [] %}
                    {% if card.role_labels %}
                      {% for label in card.role_labels %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    {% if card.theme_labels %}
                      {% for label in card.theme_labels %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    {% if not tag_tokens and card.categories %}
                      {% for label in card.categories %}
                        {% if label and label not in tag_tokens %}
                          {% set _ = tag_tokens.append(label) %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    {{- register_card_link(card.name, card.card_id, None, external=(not card.card_id)) -}}
                    {{ synergy_card_row(display_name, hover_src, card.card_id, meta=meta_lines, tags=tag_tokens, badge_html=badge_ns.html|join('')) }}
                  </td>
                  <td class="text-center">
                    {% set commander_source = card.commander_source %}
                    {% if commander_source %}
                      {% set commander_synergy = commander_source.synergy_percent %}
                      {% if commander_synergy is not none %}
                        {% if commander_synergy >= 0 %}
                          <span class="badge rounded-pill text-bg-success">+{{ commander_synergy }}%</span>
                        {% else %}
                          <span class="badge rounded-pill text-bg-warning">{{ commander_synergy }}%</span>
                        {% endif %}
                      {% else %}
                        <span class="text-muted small">&mdash;</span>
                      {% endif %}
                      <div class="text-muted small mt-1">
                        {{ commander_source.source_label or deck.commander.name }}
                      </div>
                    {% else %}
                      <span class="text-muted small">&mdash;</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% set theme_source = card.theme_source %}
                    {% if theme_source %}
                      {% set theme_synergy = theme_source.synergy_percent %}
                      {% if theme_synergy is not none %}
                        {% if theme_synergy >= 0 %}
                          <span class="badge rounded-pill text-bg-success">+{{ theme_synergy }}%</span>
                        {% else %}
                          <span class="badge rounded-pill text-bg-warning">{{ theme_synergy }}%</span>
                        {% endif %}
                      {% else %}
                        <span class="text-muted small">&mdash;</span>
                      {% endif %}
                      <div class="text-muted small mt-1">
                        {{ theme_source.source_label or deck_tag_label }}
                      </div>
                    {% else %}
                      <span class="text-muted small">&mdash;</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
</section>
{% elif selected_id %}
  <div class="alert alert-info">We could not analyse this deck yet. Try refreshing once card details are available.</div>
{% else %}
  <div class="alert alert-secondary">
    Select a deck from the dropdown to generate role coverage and synergy tips.
  </div>
{% endif %}

</div>
{% if has_type_charts %}
  <div class="col-12 col-xl-4 col-xxl-3 order-xl-2">
    <aside class="synergy-type-column">
      {{ render_synergy_type_breakdown_stack(deck_chart, edhrec_chart, mdfc_cards, 'sidebar', include_deck_chart=False) }}
    </aside>
  </div>
{% endif %}
</div>
{% if has_type_charts %}
  <div class="offcanvas offcanvas-end synergy-type-offcanvas"
       tabindex="-1"
       id="synergyTypeDrawer"
       aria-labelledby="synergyTypeDrawerLabel"
       data-bs-scroll="true">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="synergyTypeDrawerLabel">{{ type_panel_title }}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      {{ render_synergy_type_breakdown_stack(deck_chart, edhrec_chart, mdfc_cards, 'offcanvas') }}
    </div>
  </div>
{% endif %}

</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const synergyRoot = document.getElementById('synergyRoot');
    if (!synergyRoot) return;
    const viewButtons = Array.from(synergyRoot.querySelectorAll('[data-view-toggle]'));
    if (!viewButtons.length) return;
    const STORAGE_KEY = 'dv:synergy-view-mode';

    const setViewMode = (mode, { store = true } = {}) => {
      const target = mode === 'list' ? 'list' : 'grid';
      synergyRoot.dataset.viewMode = target;
      viewButtons.forEach((btn) => {
        const isActive = (btn.dataset.viewToggle || 'grid') === target;
        btn.classList.toggle('view-mode-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      if (store) {
        try {
          localStorage.setItem(STORAGE_KEY, target);
        } catch (err) {
          /* ignore storage errors */
        }
      }
    };

    const readStoredMode = () => {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored === 'list' || stored === 'grid') {
          return stored;
        }
      } catch (err) {
        /* ignore */
      }
      return 'grid';
    };

    setViewMode(readStoredMode(), { store: false });

    viewButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        setViewMode(btn.dataset.viewToggle || 'grid');
      });
    });
  });
</script>

<script>
  (function () {
    const STORAGE_KEY = 'dv:synergy-deck-filter';

    const initDeckFilter = () => {
      const root = document.getElementById('synergyRoot');
      const table = document.getElementById('deckCardBreakdownTable');
      if (!root || !table) return;
      const filterInput = root.querySelector('[data-deck-table-filter-input]');
      const filterClear = root.querySelector('[data-deck-table-filter-clear]');
      const emptyState = document.getElementById('deckCardFilterEmpty');
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      if (!filterInput || !rows.length) return;
      let filterText = '';

      const readStoredFilter = () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            filterText = stored;
            filterInput.value = stored;
          }
        } catch (err) {
          /* ignore storage errors */
        }
      };

      const persistFilter = (value) => {
        try {
          localStorage.setItem(STORAGE_KEY, value);
        } catch (err) {
          /* ignore */
        }
      };

      const applyFilter = () => {
        const normalized = (filterText || '').trim().toLowerCase();
        let visible = 0;
        rows.forEach((row) => {
          const haystack = (row.dataset.cardSearch || row.dataset.cardName || '').toLowerCase();
          const match = !normalized || haystack.includes(normalized);
          row.classList.toggle('d-none', !match);
          if (match) {
            visible += 1;
          }
        });
        if (emptyState) {
          emptyState.classList.toggle('d-none', visible !== 0);
        }
      };

      readStoredFilter();
      applyFilter();

      filterInput.addEventListener('input', () => {
        filterText = filterInput.value || '';
        persistFilter(filterText);
        applyFilter();
      });

      if (filterClear) {
        filterClear.addEventListener('click', () => {
          filterText = '';
          persistFilter(filterText);
          filterInput.value = '';
          filterInput.focus();
          applyFilter();
        });
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDeckFilter, { once: true });
    } else {
      initDeckFilter();
    }

    document.addEventListener('htmx:afterSwap', () => {
      initDeckFilter();
    });
  })();
</script>

<script>
  (function () {
    const initDeckCardSort = () => {
      const table = document.getElementById('deckCardBreakdownTable');
      if (!table || table.dataset.sortInit === '1') return;
      const button = table.querySelector('[data-sort-card]');
      const tbody = table.querySelector('tbody');
      if (!button || !tbody) return;
      table.dataset.sortInit = '1';

      const applySort = (direction) => {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const aVal = (a.querySelector('[data-card-name]')?.dataset.cardName || '').trim();
          const bVal = (b.querySelector('[data-card-name]')?.dataset.cardName || '').trim();
          return direction === 'asc'
            ? aVal.localeCompare(bVal, undefined, { sensitivity: 'base' })
            : bVal.localeCompare(aVal, undefined, { sensitivity: 'base' });
        });
        rows.forEach((row) => tbody.appendChild(row));
      };

      button.addEventListener('click', () => {
        const current = button.dataset.sortDirection || 'none';
        const next = current === 'asc' ? 'desc' : 'asc';
        button.dataset.sortDirection = next;
        applySort(next);
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDeckCardSort, { once: true });
    } else {
      initDeckCardSort();
    }

    document.addEventListener('htmx:afterSwap', () => {
      const table = document.getElementById('deckCardBreakdownTable');
      if (table) {
        table.dataset.sortInit = '';
      }
      initDeckCardSort();
    });
  })();
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (document.body) {
      document.body.dataset.hoverPreviewAnchor = 'cursor';
    }
  });
  window.addEventListener('beforeunload', () => {
    if (document.body) {
      delete document.body.dataset.hoverPreviewAnchor;
    }
  });
  document.addEventListener('htmx:beforeSwap', () => {
    if (document.body) {
      delete document.body.dataset.hoverPreviewAnchor;
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const roleCards = Array.from(document.querySelectorAll('.synergy-role-card[data-role-key]'));
    if (!roleCards.length) return;
    const roleDetails = Array.from(document.querySelectorAll('.synergy-role-detail[data-role-detail]'));
    const placeholder = document.getElementById('synergyRolePlaceholder');
    const deckRows = Array.from(document.querySelectorAll('[data-role-keys]'));
    let activeRoleKey = '';

    const updateDetails = () => {
      let anyVisible = false;
      roleDetails.forEach((detail) => {
        const key = detail.dataset.roleDetail || '';
        const isActive = key && key === activeRoleKey;
        detail.classList.toggle('d-none', !isActive);
        if (isActive) {
          anyVisible = true;
        }
      });
      if (placeholder) {
        placeholder.classList.toggle('d-none', anyVisible);
      }
    };

    const highlightDeckRows = () => {
      deckRows.forEach((row) => {
        const roles = (row.dataset.roleKeys || '').split(/\s+/).filter(Boolean);
        const matches = Boolean(activeRoleKey) && roles.includes(activeRoleKey);
        row.classList.toggle('role-match', matches);
      });
    };

    const setActiveRole = (key) => {
      activeRoleKey = key;
      roleCards.forEach((card) => {
        const cardKey = card.dataset.roleKey || '';
        const isActive = cardKey && cardKey === activeRoleKey;
        card.classList.toggle('active', isActive);
        card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      updateDetails();
      highlightDeckRows();
    };

    const toggleRoleCard = (card) => {
      if (!card) return;
      const key = card.dataset.roleKey || '';
      if (!key) return;
      setActiveRole(activeRoleKey === key ? '' : key);
    };

    roleCards.forEach((card) => {
      card.addEventListener('click', (evt) => {
        evt.preventDefault();
        toggleRoleCard(card);
      });
      card.addEventListener('keydown', (evt) => {
        if (evt.key !== 'Enter' && evt.key !== ' ') return;
        evt.preventDefault();
        toggleRoleCard(card);
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deckSelect = document.getElementById('deckSelect');
    if (!deckSelect) return;
    const form = deckSelect.form;
    if (!form) return;
    deckSelect.addEventListener('change', () => {
      if (!deckSelect.value) return;
      if (typeof form.requestSubmit === 'function') {
        form.requestSubmit();
      } else {
        form.submit();
      }
    });
  });
</script>

{% endblock %}

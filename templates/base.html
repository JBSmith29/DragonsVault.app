{# Base layout: provides sidebar navigation, sticky header, and shared scripts/styles used by all pages. #}
{% set recent_context = None %}
<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>{% block title %}DragonsVault{% endblock %}</title>

    {# Core stylesheet stack: Bootstrap + site styles. #}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roles.css') }}">

    {# Progressive enhancement scripts (instant page for prefetching). #}
    <!-- Perf helpers -->
    <script defer type="module" src="https://instant.page/5.2.0"></script>

    {# HTMX powers dynamic fragments throughout the app. #}
    <!-- HTMX 2.x (CDN) -->
    <script defer src="https://unpkg.com/htmx.org@2.0.2"></script>

    <!-- Minimal indicator styles + sidebar/layout CSS -->
    <style>
      :root {
        --sidebar-w: 260px;
        --app-header-h: 96px;
        --dv-body-gradient: linear-gradient(180deg, rgba(15, 23, 42, 0.78), rgba(2, 6, 23, 0.94));
        --dv-sidebar-shadow: 0 16px 40px rgba(2, 6, 23, 0.35);
        --dv-scroll-thumb: rgba(148, 180, 255, 0.55);
        --dv-scroll-thumb-hover: rgba(191, 219, 254, 0.8);
        --dv-scroll-track: rgba(15, 23, 42, 0.4);
        --dv-offcanvas-gap: clamp(0.65rem, 1.25vw, 1.25rem);
        --dv-offcanvas-offset: calc(var(--app-header-h, 96px) + var(--dv-offcanvas-gap));
      }
      html[data-bs-theme="light"] {
        --dv-body-gradient: linear-gradient(180deg, rgba(226, 232, 240, 0.92), rgba(148, 163, 184, 0.8)); /* keep a soft gray backdrop in light mode */
        --dv-scroll-thumb: rgba(37, 99, 235, 0.4);
        --dv-scroll-thumb-hover: rgba(37, 99, 235, 0.6);
        --dv-scroll-track: rgba(226, 232, 240, 0.55);
      }
      body {
        margin: 0;
        padding-top: var(--app-header-h, 96px);
        min-height: 100vh;
        height: 100vh;
        background:
          var(--dv-body-gradient),
          url("{{ url_for('static', filename='img/icon.png') }}") center/cover no-repeat fixed;
        color: var(--bs-body-color);
        overflow: hidden;
      }
      html[data-bs-theme="light"] body {
        color: #0f172a; /* ensure text remains legible over the gray background */
      }
      .htmx-indicator { display: none; }
      .htmx-indicator.htmx-request { display: block; }

      .layout-shell {
        display: grid;
        grid-template-columns: var(--sidebar-w) 1fr;
        min-height: calc(100vh - var(--app-header-h, 96px));
        height: calc(100vh - var(--app-header-h, 96px));
        background: transparent;
        overflow: hidden;
      }
      .layout-shell.layout-shell--guest {
        grid-template-columns: 1fr;
      }

      .dv-scroll-region {
        scrollbar-width: none;
        scrollbar-color: transparent transparent;
      }
      .dv-scroll-region.dv-scroll-visible {
        scrollbar-width: thin;
        scrollbar-color: var(--dv-scroll-thumb) transparent;
      }
      .dv-scroll-region::-webkit-scrollbar {
        width: 0.65rem;
        height: 0.65rem;
      }
      .dv-scroll-region::-webkit-scrollbar-track {
        background: transparent;
      }
      .dv-scroll-region::-webkit-scrollbar-thumb {
        background: transparent;
        border-radius: 999px;
        border: 2px solid transparent;
        box-shadow: inset 0 0 0 1px rgba(148, 180, 255, 0.25);
        opacity: 0;
        transition: opacity .18s var(--dv-ease-soft, ease), box-shadow .18s var(--dv-ease-soft, ease), background-color .18s var(--dv-ease-soft, ease);
      }
      .dv-scroll-region.dv-scroll-visible::-webkit-scrollbar-track {
        background: var(--dv-scroll-track);
        border-radius: 999px;
      }
      .dv-scroll-region.dv-scroll-visible::-webkit-scrollbar-thumb {
        background: var(--dv-scroll-thumb);
        box-shadow: inset 0 0 0 1px rgba(148, 180, 255, 0.45);
        opacity: 1;
      }
      .dv-scroll-region.dv-scroll-visible::-webkit-scrollbar-thumb:hover {
        background: var(--dv-scroll-thumb-hover);
        box-shadow: inset 0 0 0 1px rgba(191, 219, 254, 0.7);
      }

      /* Sidebar base */
      #sidebar {
        position: sticky;
        top: var(--app-header-h, 96px);
        height: calc(100vh - var(--app-header-h, 96px));
        min-height: calc(100vh - var(--app-header-h, 96px));
        width: var(--sidebar-w);
        background: linear-gradient(160deg, rgba(17, 24, 39, .94), rgba(15, 23, 42, .82));
        border-right: 1px solid rgba(255, 255, 255, 0.06);
        padding: 1.5rem 1.25rem 2rem;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        z-index: 1030;
        box-shadow: var(--dv-sidebar-shadow);
      }

      #sidebar .nav-link {
        display: block;
        color: rgba(255, 255, 255, 0.85) !important;
        background: transparent;
        border-radius: 14px;
        padding: .65rem .85rem;
        margin-bottom: .35rem;
        font-weight: 500;
        letter-spacing: .01em;
        transition: background-color .2s var(--dv-ease-soft),
                    color .2s var(--dv-ease-soft),
                    transform .18s var(--dv-ease-soft);
        position: relative;
      }
      #sidebar .nav-link i {
        font-size: 1.1rem;
      }
      #sidebar .nav-link:hover,
      #sidebar .nav-link:focus-visible {
        background: rgba(255, 255, 255, 0.92);
        color: #111827 !important;
        transform: translateX(4px);
      }
      #sidebar .nav-link.active,
      #sidebar .nav-link[aria-current="page"] {
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.98), rgba(226, 232, 240, 0.92));
        color: #0f172a !important;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.25);
      }
      #sidebar .nav-link.active i,
      #sidebar .nav-link[aria-current="page"] i,
      #sidebar .nav-link.active .sidebar-label,
      #sidebar .nav-link[aria-current="page"] .sidebar-label {
        color: #0f172a !important;
      }
      .sidebar-title {
        font-size: 1.2rem;
        font-weight: 600;
        letter-spacing: .04em;
        color: #f8fafc;
      }
      .sidebar-collapse-btn {
        border: 1px solid rgba(255, 255, 255, 0.24);
        background: rgba(255, 255, 255, 0.08);
        color: #e7ecf6;
        border-radius: 12px;
        width: 38px;
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: border-color .2s var(--dv-ease-soft), background-color .2s var(--dv-ease-soft), color .2s var(--dv-ease-soft);
      }
      .sidebar-collapse-btn:hover {
        background: rgba(255, 255, 255, 0.18);
        color: #0f172a;
        border-color: rgba(255, 255, 255, 0.35);
      }
      .sidebar-collapse-btn:focus-visible {
        outline: 2px solid rgba(var(--bs-primary-rgb), .6);
        outline-offset: 3px;
      }
      .sidebar-collapse-btn img {
        width: 30px;
        height: 30px;
        pointer-events: none;
        object-fit: contain;
      }
      body.sidebar-collapsed {
        --sidebar-w: 88px;
      }
      body.sidebar-collapsed #sidebar {
        padding-left: .75rem;
        padding-right: .75rem;
        align-items: center;
      }
      body.sidebar-collapsed .sidebar-header {
        justify-content: center;
      }
      body.sidebar-collapsed .sidebar-title {
        display: none;
      }
      body.sidebar-collapsed #sidebar .nav-link {
        justify-content: center;
        gap: 0;
        padding: .6rem .4rem;
      }
      body.sidebar-collapsed #sidebar .nav-link:hover,
      body.sidebar-collapsed #sidebar .nav-link:focus-visible {
        transform: none;
      }
      body.sidebar-collapsed #sidebar .sidebar-label {
        display: none;
      }
      body.sidebar-collapsed #sidebar .nav-link::after {
        content: attr(title);
        position: absolute;
        left: calc(100% + 12px);
        top: 50%;
        transform: translate(-6px, -50%);
        background: rgba(15, 23, 42, 0.95);
        border-radius: 12px;
        padding: .45rem .7rem;
        color: #f8fafc;
        font-size: .95rem;
        font-weight: 600;
        letter-spacing: .02em;
        box-shadow: 0 12px 30px rgba(2, 6, 23, 0.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity .18s var(--dv-ease-soft), transform .18s var(--dv-ease-soft);
        white-space: nowrap;
        z-index: 1050;
      }
      body.sidebar-collapsed #sidebar .nav-link:hover::after,
      body.sidebar-collapsed #sidebar .nav-link:focus-visible::after,
      body.sidebar-collapsed #sidebar .nav-link.active::after,
      body.sidebar-collapsed #sidebar .nav-link[aria-current="page"]::after {
        opacity: 1;
        transform: translate(8px, -50%);
      }
      body.sidebar-collapsed #sidebar hr {
        width: 100%;
      }
      .app-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1050;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding: 1.25rem clamp(1rem, 2vw + 1rem, 2.5rem);
        background: linear-gradient(120deg, rgba(15, 23, 42, 0.9), rgba(37, 99, 235, 0.18));
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
      }
      .app-header__branding {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .app-header__title {
        font-size: 1.9rem;
        font-weight: 700;
        letter-spacing: 0.04em;
      }
      .app-header__motto {
        font-size: 0.95rem;
        color: rgba(226, 232, 240, 0.75);
      }
      @media (max-width: 576px) {
        .app-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .app-header__title {
          font-size: 1.5rem;
        }
      }



      .content-toolbar {
        position: sticky;
        top: calc(var(--app-header-h, 96px) + 0.75rem);
        z-index: 1031;
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
        padding: .75rem 1rem;
        background: linear-gradient(125deg, rgba(15, 23, 42, 0.75), rgba(37, 99, 235, 0.12));
        backdrop-filter: blur(18px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .content-toolbar .brand-link {
        font-weight: 600;
        letter-spacing: .04em;
        text-transform: uppercase;
        color: inherit;
        text-decoration: none;
      }
      html[data-bs-theme="light"] .content-toolbar {
        background: linear-gradient(125deg, rgba(255, 255, 255, 0.9), rgba(226, 232, 240, 0.85));
        border-bottom-color: rgba(15, 23, 42, 0.08);
      }

      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        opacity: 0;
        pointer-events: none;
        transition: opacity .24s var(--dv-ease-soft);
        z-index: 1028;
      }
      html[data-bs-theme="light"] .sidebar-backdrop {
        background: rgba(15, 23, 42, 0.35);
      }
      body.sidebar-open .sidebar-backdrop {
        opacity: 1;
        pointer-events: auto;
      }
      @media (min-width: 992px) {
        .sidebar-backdrop {
          display: none;
        }
      }

      /* Card hover preview */
      .card-hover-preview {
        position: fixed;
        z-index: 2100;
        pointer-events: none;
        display: none;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 0.75rem;
        padding: 0.3rem;
        box-shadow:
          0 0.5rem 2rem rgba(0, 0, 0, 0.35),
          0 0 0 1px rgba(255, 255, 255, 0.05);
      }
      .card-hover-preview.is-visible { display: block; }
      .card-hover-preview img {
        width: clamp(220px, 24vw, 340px);
        max-height: 480px;
        border-radius: 0.6rem;
        display: block;
      }

      /* Content area */
      #content {
        flex: 1;
        min-height: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding-left: 2rem;
        padding-right: 2rem;
      }
      #content > main {
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 3rem;
      }
      .navbar { position: sticky; top: var(--app-header-h, 96px); z-index: 1031; }
      .navbar-glass {
        background: linear-gradient(120deg, rgba(15, 23, 42, 0.08), rgba(59, 130, 246, 0.12));
        backdrop-filter: blur(16px);
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 16px 40px rgba(2, 6, 23, 0.35);
      }
      .offcanvas {
        top: var(--dv-offcanvas-offset, var(--app-header-h, 96px));
        height: calc(100vh - var(--dv-offcanvas-offset, var(--app-header-h, 96px)));
      }
      .offcanvas-backdrop {
        top: var(--dv-offcanvas-offset, var(--app-header-h, 96px));
        height: calc(100vh - var(--dv-offcanvas-offset, var(--app-header-h, 96px)));
      }
      .brand-link { text-decoration: none; }
      .form-control,
      .form-select,
      .form-control:focus,
      .form-select:focus,
      textarea,
      textarea:focus {
        background-color: rgba(15, 23, 42, 0.18);
        border-color: rgba(148, 163, 184, 0.28);
        color: #e7ecf6;
        box-shadow: none;
      }
      .form-control::placeholder,
      textarea::placeholder {
        color: rgba(231, 236, 246, 0.6);
      }
      .form-check-input {
        background-color: rgba(15, 23, 42, 0.35);
        border-color: rgba(148, 163, 184, 0.35);
      }
      .form-check-input:checked {
        background-color: rgba(148, 180, 255, 0.9);
        border-color: rgba(148, 180, 255, 0.9);
      }
      .input-group-text {
        background-color: rgba(15, 23, 42, 0.22);
        border-color: rgba(148, 163, 184, 0.28);
        color: #e7ecf6;
      }
      .table {
        --bs-table-bg: transparent;
        background-color: transparent !important;
      }
      .table thead,
      .table tbody,
      .table tfoot {
        background-color: transparent !important;
      }
      .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: rgba(148, 163, 184, 0.06) !important;
      }

      @media (min-width: 992px) {
        #content {
          padding-left: 2rem;
          padding-right: 2rem;
        }
      }

      @media (max-width: 991.98px) {
        .layout-shell {
          grid-template-columns: 1fr;
        }
        #sidebar {
          position: fixed;
          inset: var(--app-header-h, 96px) auto 0 0;
          height: calc(100vh - var(--app-header-h, 96px));
          min-height: calc(100vh - var(--app-header-h, 96px));
          width: min(85vw, 320px);
          max-width: 320px;
          transform: translateX(-110%);
          transition: transform .24s var(--dv-ease-soft), box-shadow .24s var(--dv-ease-soft);
        }
        body.sidebar-open {
          overflow: hidden;
        }
        body.sidebar-open #sidebar {
          transform: translateX(0);
        }
        #content {
          padding-left: 1rem;
          padding-right: 1rem;
        }
        .content-toolbar {
          display: flex;
        }
      }

      @media (max-width: 768px) {
        #sidebar {
          width: min(90vw, 300px);
        }
      }

      .theme-toggle {
        position: relative;
        width: 46px;
        height: 46px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.08);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: transform .2s var(--dv-ease-soft), box-shadow .2s var(--dv-ease-soft), border-color .2s var(--dv-ease-soft);
        backdrop-filter: blur(10px);
      }
      .theme-toggle:focus-visible {
        outline: 2px solid rgba(var(--bs-primary-rgb), .6);
        outline-offset: 3px;
      }
      .theme-toggle__icon {
        position: absolute;
        top: 50%;
        left: 50%;
        font-size: 1.5rem;
        transform: translate(-50%, calc(-50% + 3px));
        transition: transform .35s var(--dv-ease-soft), opacity .35s var(--dv-ease-soft);
      }
      .theme-toggle.animate-toggle {
        transform: rotate(12deg) scale(1.05);
      }
      .theme-toggle__icon--sun { transform: translate(-50%, calc(-50% + 3px)); opacity: 1; }
      .theme-toggle__icon--moon { transform: translate(calc(-50% + 2px), calc(-50%)); opacity: 0; }
      html[data-bs-theme="light"] .theme-toggle__icon--sun { transform: translate(-50%, calc(-50% - 4px)); opacity: 0; }
      html[data-bs-theme="light"] .theme-toggle__icon--moon { transform: translate(calc(-50% + 2px), calc(-50% + 2px)); opacity: 1; }
      .theme-toggle.theme-toggle--solo .bi {
        position: static;
        font-size: 1.4rem;
        transform: none;
        margin-top: 2px;
      }

      /* Flip button placement (top-left over images) */
      .glyph-btn{background:transparent!important;border:0!important;padding:0;margin:0;box-shadow:none!important;line-height:1;font-size:1.2rem;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.65);cursor:pointer;}
      .js-prints-cycler, .js-face-container { position: relative; }
      .js-prints-cycler .flip-face, .js-face-container .flip-face {
        position: absolute; top: .35rem; left: .35rem; z-index: 3;
        background: rgba(0,0,0,.55); border-radius: .4rem; padding: .2rem .35rem;
      }

      .dv-flip-overlay{
      position:absolute; top:.5rem; left:.5rem; z-index:10;
      padding:.25rem .5rem; line-height:1; border-radius:.5rem;
      border:1px solid var(--bs-border-color);
      background:rgba(0,0,0,.6); color:#fff; font-weight:700;
      cursor:pointer;
    }
    @media (hover:hover){ .dv-flip-overlay:hover{ background:rgba(0,0,0,.8);} }

    </style>
  </head>
  

  <!-- Keep these tiny HTMX helpers early so they always bind -->
  <script>
    // Clean up Bootstrap overlays + image tooltips before HTMX swaps / requests
    (function () {
      function cleanupOverlays() {
        try {
          // Offcanvas / Modal
          document.querySelectorAll('.offcanvas.show').forEach(el => {
            const inst = (window.bootstrap && (bootstrap.Offcanvas.getInstance(el) || new bootstrap.Offcanvas(el))) || null;
            if (inst) inst.hide();
          });
          document.querySelectorAll('.modal.show').forEach(el => {
            const inst = (window.bootstrap && (bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el))) || null;
            if (inst) inst.hide();
          });
        } catch (_) {}

        // Dispose any tooltip/popover instances (prevents stuck hover images)
        try {
          if (window.bootstrap) {
            document.querySelectorAll(
              '.wl-card-link, .checker-card-link, [data-bs-toggle="tooltip"], [data-bs-toggle="popover"]'
            ).forEach(el => {
              const tip = bootstrap.Tooltip.getInstance(el);
              if (tip) tip.dispose();
              if (bootstrap.Popover) {
                const pop = bootstrap.Popover.getInstance(el);
                if (pop) pop.dispose();
              }
              if (el.dataset) el.dataset.hasTooltip = '';
            });
          }
        } catch (_) {}

        // Remove leftover nodes appended to <body>
        document.querySelectorAll('.tooltip, .popover, .modal-backdrop, .offcanvas-backdrop').forEach(n => n.remove());

        // Reset body styles Bootstrap may have set
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('paddingRight');
      }

      document.addEventListener('htmx:beforeRequest', cleanupOverlays);
      document.addEventListener('htmx:beforeSwap', cleanupOverlays);

      // Belt & suspenders on normal nav/unload
      window.addEventListener('beforeunload', cleanupOverlays);
      document.addEventListener('click', (e) => {
        if (e.target.closest('a, button[type="submit"]')) cleanupOverlays();
      });
    })();

    (function () {
      const hxEnabled = {{ 'true' if not (disable_hx | default(false)) else 'false' }};
      const PRESERVE_SCROLL_KEY = 'dv:preserve-scroll';
      const SCROLL_TOP_FLAG = 'dv:scroll-top-next';

      const setPreserveState = (value) => {
        try {
          if (value) {
            sessionStorage.setItem(PRESERVE_SCROLL_KEY, '1');
          } else {
            sessionStorage.removeItem(PRESERVE_SCROLL_KEY);
          }
        } catch (_) {
          /* ignore session storage issues */
        }
        try {
          if (value) {
            localStorage.setItem(PRESERVE_SCROLL_KEY, '1');
          } else {
            localStorage.removeItem(PRESERVE_SCROLL_KEY);
          }
        } catch (_) {
          /* ignore local storage issues */
        }
      };

      const clearPreserveScroll = () => setPreserveState(false);
      const markPreserveScroll = () => setPreserveState(true);

      const shouldPreserveScroll = () => {
        try {
          if (sessionStorage.getItem(PRESERVE_SCROLL_KEY) === '1') {
            return true;
          }
        } catch (_) {
          /* ignore */
        }
        try {
          return localStorage.getItem(PRESERVE_SCROLL_KEY) === '1';
        } catch (_) {
          return false;
        }
      };

      window.DV = window.DV || {};
      window.DV.hxEnabled = hxEnabled;
      window.DV.scroll = {
        key: PRESERVE_SCROLL_KEY,
        flag: SCROLL_TOP_FLAG,
        clear: clearPreserveScroll,
        mark: markPreserveScroll,
        should: shouldPreserveScroll,
      };

      const measureViewport = () => {
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
        document.documentElement.style.setProperty('--vh', viewportHeight . 'px');
        const header = document.querySelector('.app-header');
        const headerHeight = header ? header.getBoundingClientRect().height : 96;
        document.documentElement.style.setProperty('--header-height', headerHeight . 'px');
      };

      window.addEventListener('resize', measureViewport, { passive: true });
      measureViewport();

      window.clearPreserveScroll = clearPreserveScroll;
      window.markPreserveScroll = markPreserveScroll;
      window.shouldPreserveScroll = shouldPreserveScroll;

      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }

      const SCROLL_STORE_KEY = 'dv:scroll-pos';

      const resetScrollPosition = () => {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      };

      const saveScrollPosition = () => {
        try {
          const payload = {
            path: window.location.pathname + window.location.search,
            y: window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0,
            ts: Date.now(),
          };
          sessionStorage.setItem(SCROLL_STORE_KEY, JSON.stringify(payload));
        } catch (_) {
          /* ignore */
        }
      };

      const restoreScrollPosition = () => {
        try {
          const raw = sessionStorage.getItem(SCROLL_STORE_KEY);
          if (!raw) return false;
          const payload = JSON.parse(raw);
          const currentPath = window.location.pathname + window.location.search;
          if (payload && payload.path === currentPath && typeof payload.y === 'number') {
            window.scrollTo(0, payload.y);
            return true;
          }
        } catch (_) {
          /* ignore */
        }
        return false;
      };

      document.addEventListener('DOMContentLoaded', () => {
        const restored = restoreScrollPosition();
        if (!restored && !shouldPreserveScroll()) {
          resetScrollPosition();
          clearPreserveScroll();
        }
      });

      window.addEventListener('pageshow', (evt) => {
        if (evt.persisted) {
          restoreScrollPosition();
          return;
        }
        if (!shouldPreserveScroll()) {
          resetScrollPosition();
        }
      });

      window.addEventListener('beforeunload', () => {
        saveScrollPosition();
        if (!shouldPreserveScroll()) {
          resetScrollPosition();
        }
        clearPreserveScroll();
      });

      const scrollToTopInstant = () => {
        if (shouldPreserveScroll()) {
          return;
        }
        const setTop = resetScrollPosition;
        clearPreserveScroll();
        setTop();
        requestAnimationFrame(setTop);
        setTimeout(setTop, 0);
      };

      if (hxEnabled && window.htmx) {
        document.addEventListener('htmx:beforeRequest', scrollToTopInstant);
        document.addEventListener('htmx:afterSwap', (evt) => {
          if (!(evt.target && evt.target.id === 'main')) return;
          scrollToTopInstant();
        });
        document.addEventListener('htmx:afterSettle', (evt) => {
          if (!(evt.target && evt.target.id === 'main')) return;
          scrollToTopInstant();
        });
      }
      window.addEventListener('popstate', scrollToTopInstant);
    })();
  </script>

  {% set hx_enabled = not (disable_hx | default(false)) %}
  <body
    class=""
    {% if hx_enabled %}
      hx-boost="true"
      hx-target="#main"
      hx-select="#main"
      hx-swap="outerHTML"
      hx-indicator="#global-indicator"
    {% endif %}
  >
    {% set user_is_authenticated = current_user.is_authenticated if current_user is defined else False %}
    {% set user_is_admin = user_is_authenticated and (current_user.is_admin in [true, True, 1, '1', 'true', 'True']) %}
    {% if user_is_admin %}
      {% set account_label = "Admin Center" %}
      {% set account_url = url_for('views.admin_console') %}
      {% set account_endpoints = ["views.admin_console"] %}
    {% elif user_is_authenticated %}
      {% set account_label = "Settings" %}
      {% set account_url = url_for('views.account_center') %}
      {% set account_endpoints = ["views.account_center", "views.manage_api_token", "views.manage_folder_preferences"] %}
    {% else %}
      {% set account_label = "Sign in" %}
      {% set account_url = url_for('views.login') %}
      {% set account_endpoints = ["views.login", "views.register"] %}
    {% endif %}
    {% set sidebar_active = not (disable_sidebar | default(false)) %}
    <header class="app-header">
      <a class="app-header__branding text-reset text-decoration-none" href="{{ url_for('views.dashboard') }}" data-hx-boost="false">
        <div class="app-header__title">DragonsVault</div>
        <p class="app-header__motto">Collect &bull; Vault &bull; Conquer</p>
      </a>
      <div class="d-flex align-items-center gap-2">
        <button id="themeToggleBtn"
                class="theme-toggle btn-soft"
                type="button"
                aria-label="Toggle color theme"
                aria-pressed="true">
          <i class="bi bi-sun theme-toggle__icon theme-toggle__icon--sun"></i>
          <i class="bi bi-moon theme-toggle__icon theme-toggle__icon--moon"></i>
        </button>
        <a class="theme-toggle theme-toggle--solo btn-soft"
           href="{{ account_url }}"
           title="{{ account_label }}"
           aria-label="{{ account_label }}"
           data-hx-boost="false">
          <i class="bi bi-person-fill" aria-hidden="true"></i>
        </a>
      </div>
    </header>
    {# Layout shell: fixed sidebar + scrolling content column. #}
    {% set current_endpoint = request.endpoint or "" %}
    {% set legal_links_visible = current_endpoint in ["views.dashboard", "views.account_center", "views.import_csv"] %}
    <div class="layout-shell{% if not sidebar_active %} layout-shell--guest{% endif %}">
      {% if sidebar_active %}
      <nav id="sidebar" class="sidebar d-flex flex-column dv-scroll-region" role="navigation" aria-label="Primary" tabindex="-1">
        <div class="px-2 mb-3">
          <div class="sidebar-header d-flex align-items-center justify-content-between gap-2">
            <h4 class="sidebar-title mb-0">Navigation</h4>
            <div class="d-flex align-items-center gap-2">
              <button id="sidebarMobileClose"
                      class="sidebar-collapse-btn d-inline-flex d-lg-none"
                      type="button"
                      aria-label="Close navigation">
                <i class="bi bi-x-lg" aria-hidden="true"></i>
              </button>
              <button id="sidebarCollapseBtn"
                      class="sidebar-collapse-btn d-none d-lg-inline-flex"
                      type="button"
                      aria-label="Collapse sidebar"
                      aria-pressed="false">
                <img src="{{ url_for('static', filename='img/DragonsVault Icon.png') }}"
                     alt=""
                     aria-hidden="true"
                     width="30"
                     height="30">
              </button>
            </div>
          </div>
        </div>
        <ul class="nav flex-column px-2 mb-auto">
          {# Each link maps directly to a high-level feature route. #}
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint in ['views.dashboard', 'views.index'] %}active{% endif %}"
               href="{{ url_for('views.dashboard') }}"
               title="Dashboard"
               aria-label="Dashboard"
               data-endpoints="views.dashboard,views.index">
              <i class="bi bi-speedometer2" aria-hidden="true"></i>
              <span class="sidebar-label">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.list_cards' %}active{% endif %}"
               href="{{ url_for('views.list_cards') }}"
               title="My Cards"
               aria-label="My Cards"
               data-endpoints="views.list_cards">
              <i class="bi bi-collection" aria-hidden="true"></i>
              <span class="sidebar-label">My Cards</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.shared_folders' %}active{% endif %}"
               href="{{ url_for('views.shared_folders') }}"
               title="Shared Folders"
               aria-label="Shared Folders"
               data-endpoints="views.shared_folders">
              <i class="bi bi-people" aria-hidden="true"></i>
              <span class="sidebar-label">Shared</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.collection_overview' %}active{% endif %}"
               href="{{ url_for('views.collection_overview') }}"
               title="Collection"
               aria-label="Collection"
               data-endpoints="views.collection_overview">
              <i class="bi bi-archive" aria-hidden="true"></i>
              <span class="sidebar-label">Collection</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.decks_overview' %}active{% endif %}"
               href="{{ url_for('views.decks_overview') }}"
               title="Decks"
               aria-label="Decks"
               data-endpoints="views.decks_overview">
              <i class="bi bi-layers" aria-hidden="true"></i>
              <span class="sidebar-label">Decks</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.opening_hand' %}active{% endif %}"
               href="{{ url_for('views.opening_hand') }}"
               title="Opening Hand"
               aria-label="Opening Hand"
               data-endpoints="views.opening_hand">
              <i class="bi bi-hand-index-thumb" aria-hidden="true"></i>
              <span class="sidebar-label">Opening Hand</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.deck_synergy' %}active{% endif %}"
               href="{{ url_for('views.deck_synergy') }}"
               title="Synergy Lab"
               aria-label="Synergy Lab"
               data-endpoints="views.deck_synergy">
              <i class="bi bi-graph-up-arrow" aria-hidden="true"></i>
              <span class="sidebar-label">Synergy Lab</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.build_a_deck' %}active{% endif %}"
               href="{{ url_for('views.build_a_deck') }}"
               title="Build-A-Deck"
               aria-label="Build-A-Deck"
               data-endpoints="views.build_a_deck"
               data-hx-boost="false">
              <i class="bi bi-diagram-3" aria-hidden="true"></i>
              <span class="sidebar-label">Build-A-Deck</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.sets_overview' %}active{% endif %}"
               href="{{ url_for('views.sets_overview') }}"
               title="Sets"
               aria-label="Sets"
               data-endpoints="views.sets_overview">
              <i class="bi bi-grid-3x3-gap" aria-hidden="true"></i>
              <span class="sidebar-label">Sets</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.list_checker' %}active{% endif %}"
               href="{{ url_for('views.list_checker') }}"
               title="List Checker"
               aria-label="List Checker"
               data-endpoints="views.list_checker">
              <i class="bi bi-list-check" aria-hidden="true"></i>
              <span class="sidebar-label">List Checker</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.wishlist' %}active{% endif %}"
               href="{{ url_for('views.wishlist') }}"
               title="Wishlist"
               aria-label="Wishlist"
               data-endpoints="views.wishlist">
              <i class="bi bi-heart" aria-hidden="true"></i>
              <span class="sidebar-label">Wishlist</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.scryfall_browser' %}active{% endif %}"
               href="{{ url_for('views.scryfall_browser') }}"
               title="Scryfall Cards"
               aria-label="Scryfall Cards"
               data-endpoints="views.scryfall_browser">
              <i class="bi bi-search" aria-hidden="true"></i>
              <span class="sidebar-label">Scryfall Cards</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint == 'views.import_csv' %}active{% endif %}"
               href="{{ url_for('views.import_csv') }}"
               title="Import / Export"
               aria-label="Import / Export"
               data-endpoints="views.import_csv">
              <i class="bi bi-upload" aria-hidden="true"></i>
              <span class="sidebar-label">Import / Export</span>
            </a>
          </li>
        </ul>
        <div class="mt-auto w-100 px-2 pb-4">
          <hr class="border-secondary opacity-25">
          <a class="nav-link text-white d-flex align-items-center gap-2 {% if current_endpoint in account_endpoints %}active{% endif %}"
             href="{{ account_url }}"
             title="{{ account_label }}"
             aria-label="{{ account_label }}"
             data-endpoints="{{ account_endpoints|join(',') }}"
             data-hx-boost="false">
            <i class="bi bi-gear" aria-hidden="true"></i>
            <span class="sidebar-label">{{ account_label }}</span>
          </a>
        </div>
      </nav>
      {% endif %}

      <div id="content" class="flex-grow-1 position-relative{% if not sidebar_active %} w-100{% endif %}">
        {% if sidebar_active %}
        <header class="content-toolbar d-lg-none">
          <button
            id="sidebarMobileToggle"
            class="sidebar-collapse-btn"
            type="button"
            aria-controls="sidebar"
            aria-expanded="false"
            aria-label="Open navigation">
            <i class="bi bi-list" aria-hidden="true"></i>
          </button>
          <a class="brand-link small text-uppercase fw-semibold text-decoration-none text-reset"
             href="{{ url_for('views.dashboard') }}">
            DragonsVault
          </a>
        </header>
        {% endif %}
        <!-- Explicit ID + hx-history-elt for better back/forward snapshots -->
        <main
          id="main"
          class="{% if sidebar_active %}container-fluid mt-4 dv-scroll-region{% else %}container py-5{% endif %}"
          hx-history-elt
          data-active-endpoint="{{ current_endpoint }}"
          data-legal-visible="{{ '1' if legal_links_visible else '0' }}"
        >
          {# Render any flashed messages before the page-specific content block. #}
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="mb-3">
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'warning' if category=='message' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          {% block breadcrumbs %}{% endblock %}
          {# Child templates supply their markup inside the main content block. #}
          {% block content %}{% endblock %}
        </main>
        <footer class="app-footer py-3 border-top mt-auto{% if not legal_links_visible %} d-none{% endif %}">
          <div class="container-fluid text-center small d-flex flex-wrap justify-content-center gap-3">
            <a class="text-decoration-none" href="{{ url_for('views.terms_of_service') }}">Terms of Service</a>
            <a class="text-decoration-none" href="{{ url_for('views.terms_of_use') }}">Terms of Use</a>
            <a class="text-decoration-none" href="{{ url_for('views.privacy_policy') }}">Privacy Policy</a>
            <a class="text-decoration-none" href="{{ url_for('views.accessibility_statement') }}">Accessibility</a>
            <a class="text-decoration-none" href="{{ url_for('views.legal_disclaimer') }}">Disclaimer</a>
            <a class="text-decoration-none" href="{{ url_for('views.coppa_notice') }}">COPPA Notice</a>
            <a class="text-decoration-none" href="{{ url_for('views.about_page') }}">About</a>
            <a class="text-decoration-none" href="{{ url_for('views.contact_page') }}">Contact</a>
          </div>
        </footer>
      </div>
    </div>
    {% if sidebar_active %}
    <div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true"></div>
    {% endif %}

    <!-- Global loading indicator for boosted nav/search -->
    <div id="global-indicator"
         class="htmx-indicator alert alert-secondary shadow-sm"
         role="status"
         style="position:fixed; top:calc(var(--app-header-h, 96px) + 1rem); right:1rem; z-index:1080;">
      Loading...
    </div>

    <script>
      (function () {
        const header = document.querySelector(".app-header");
        if (!header) return;
        const root = document.documentElement;

        const applyOffcanvasOffset = (target) => {
          const headerHeight = header.offsetHeight || 0;
          const rootStyles = window.getComputedStyle(root);
          const fontSize = parseFloat(rootStyles.fontSize) || 16;
          const minGap = 0.65 * fontSize;
          const maxGap = 1.25 * fontSize;
          const viewportGap = 0.0125 * window.innerWidth;
          const gap = Math.min(Math.max(minGap, viewportGap), maxGap);
          const offset = headerHeight + gap;
          root.style.setProperty("--dv-offcanvas-offset", `${offset}px`);

          const canvases = target
            ? [target]
            : Array.from(document.querySelectorAll(".offcanvas"));
          canvases.forEach((el) => {
            el.style.top = `${offset}px`;
            const heightCalc = `calc(100vh - ${offset}px)`;
            el.style.height = heightCalc;
            el.style.setProperty("--bs-offcanvas-height", heightCalc);
          });

          Array.from(document.querySelectorAll(".offcanvas-backdrop")).forEach((el) => {
            el.style.top = `${offset}px`;
            el.style.height = `calc(100vh - ${offset}px)`;
          });
        };

        const update = () => {
          const h = header.offsetHeight || 0;
          root.style.setProperty("--app-header-h", `${h}px`);
          applyOffcanvasOffset();
        };

        update();

        if (window.ResizeObserver) {
          const observer = new ResizeObserver(() => update());
          observer.observe(header);
        }

        window.addEventListener("resize", () => update(), { passive: true });
        document.addEventListener("show.bs.offcanvas", (event) => {
          applyOffcanvasOffset(event.target);
        });
        document.addEventListener("shown.bs.offcanvas", (event) => {
          applyOffcanvasOffset(event.target);
        });
      })();
    </script>
    <script>
      (function () {
        const regions = Array.from(document.querySelectorAll(".dv-scroll-region"));
        if (!regions.length) return;
        const visibleClass = "dv-scroll-visible";
        const timers = new WeakMap();

        const hasScrollableContent = (el) => (el.scrollHeight - el.clientHeight) > 2;

        const clearTimer = (el) => {
          const existing = timers.get(el);
          if (existing) {
            window.clearTimeout(existing);
            timers.delete(el);
          }
        };

        const scheduleHide = (el, delay = 650) => {
          clearTimer(el);
          const timer = window.setTimeout(() => {
            el.classList.remove(visibleClass);
            timers.delete(el);
          }, delay);
          timers.set(el, timer);
        };

        const reveal = (el) => {
          if (!hasScrollableContent(el)) return;
          el.classList.add(visibleClass);
          scheduleHide(el);
        };

        regions.forEach((el) => {
          el.addEventListener("scroll", () => reveal(el), { passive: true });

          if (el.scrollTop > 0) {
            el.classList.add(visibleClass);
            scheduleHide(el);
          }
        });
      })();
    </script>

    <script>
      (function () {
        const token = document.querySelector('meta[name="csrf-token"]')?.content;
        if (!token) return;

        // Attach CSRF header for HTMX / fetch requests
        document.addEventListener("htmx:configRequest", function (event) {
          event.detail.headers["X-CSRFToken"] = token;
        });

        // Backfill hidden CSRF inputs on POST forms (covers static templates)
        document.addEventListener("submit", function (event) {
          const form = event.target;
          if (!form || form.tagName !== "FORM") return;
          const method = (form.getAttribute("method") || "get").toLowerCase();
          if (method !== "post") return;
          if (form.querySelector('input[name="csrf_token"]')) return;
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "csrf_token";
          input.value = token;
          form.appendChild(input);
        }, true);
      })();
    </script>

    <!-- Bootstrap JS (single include) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <!-- Sidebar toggle logic (independent from Bootstrap) -->
    <script>
      (function () {
        const STORAGE_KEY = 'dv:sidebar-collapsed';
        const body = document.body;
        const toggleBtn = document.getElementById('sidebarCollapseBtn');
        if (!body || !toggleBtn) return;

        const readStoredState = () => {
          try {
            return localStorage.getItem(STORAGE_KEY) === '1';
          } catch (err) {
            return false;
          }
        };

        const applyState = (collapsed, { store = true } = {}) => {
          body.classList.toggle('sidebar-collapsed', collapsed);
          toggleBtn.classList.toggle('collapsed', collapsed);
          toggleBtn.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
          toggleBtn.setAttribute('aria-label', collapsed ? 'Expand sidebar' : 'Collapse sidebar');
          toggleBtn.setAttribute('title', collapsed ? 'Expand sidebar' : 'Collapse sidebar');
          if (store) {
            try {
              if (collapsed) {
                localStorage.setItem(STORAGE_KEY, '1');
              } else {
                localStorage.removeItem(STORAGE_KEY);
              }
            } catch (err) {
              /* ignore */
            }
          }
        };

        const initialCollapsed = body.classList.contains('sidebar-collapsed') || readStoredState();
        applyState(initialCollapsed, { store: false });

        toggleBtn.addEventListener('click', () => {
          applyState(!body.classList.contains('sidebar-collapsed'));
        });
      })();
    </script>

    <script>
      (function () {
        const body = document.body;
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('sidebarMobileToggle');
        const closeBtn = document.getElementById('sidebarMobileClose');
        const backdrop = document.getElementById('sidebarBackdrop');
        if (!body || !sidebar || !toggle) return;

        const DESKTOP_QUERY = '(min-width: 992px)';
        const mq = window.matchMedia(DESKTOP_QUERY);
        const focusableSelector = 'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';

        const applyAria = (open) => {
          const expanded = open ? 'true' : 'false';
          toggle.setAttribute('aria-expanded', expanded);
          sidebar.setAttribute('aria-hidden', open ? 'false' : 'true');
        };

        const focusSidebar = () => {
          try {
            const focusable = sidebar.querySelector(focusableSelector);
            (focusable || sidebar).focus({ preventScroll: true });
          } catch (_) {
            /* noop */
          }
        };

        const closeMobile = ({ keepFocus = false } = {}) => {
          body.classList.remove('sidebar-open');
          applyAria(false);
          if (!keepFocus) {
            try {
              toggle.focus({ preventScroll: true });
            } catch (_) { /* noop */ }
          }
        };

        const openMobile = () => {
          body.classList.add('sidebar-open');
          applyAria(true);
          focusSidebar();
        };

        const isMobile = () => !mq.matches;

        const handleToggle = () => {
          if (!isMobile()) return;
          const open = body.classList.contains('sidebar-open');
          if (open) {
            closeMobile();
          } else {
            openMobile();
          }
        };

        toggle.addEventListener('click', handleToggle);
        closeBtn?.addEventListener('click', () => closeMobile({ keepFocus: true }));
        backdrop?.addEventListener('click', () => closeMobile({ keepFocus: true }));

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && isMobile()) {
            closeMobile({ keepFocus: true });
          }
        });

        const syncViewportState = () => {
          if (mq.matches) {
            body.classList.remove('sidebar-open');
            sidebar.setAttribute('aria-hidden', 'false');
            toggle.setAttribute('aria-expanded', 'false');
          } else if (!body.classList.contains('sidebar-open')) {
            sidebar.setAttribute('aria-hidden', 'true');
            toggle.setAttribute('aria-expanded', 'false');
          }
        };

        if (mq.addEventListener) {
          mq.addEventListener('change', syncViewportState);
        } else if (mq.addListener) {
          mq.addListener(syncViewportState);
        }
        window.addEventListener('resize', syncViewportState, { passive: true });

        document.addEventListener('htmx:afterSwap', () => {
          if (isMobile()) closeMobile({ keepFocus: true });
        });
        document.addEventListener('htmx:afterSettle', () => {
          if (isMobile() && !body.classList.contains('sidebar-open')) {
            sidebar.setAttribute('aria-hidden', 'true');
          }
        });

        syncViewportState();
      })();
    </script>

    <script>
      (function () {
        function resetScroll(target) {
          if (!target) return;
          target.scrollTop = 0;
          const body = target.querySelector(".offcanvas-body");
          if (body) body.scrollTop = 0;
        }

        document.addEventListener("show.bs.offcanvas", (event) => {
          resetScroll(event.target);
        });

        document.addEventListener("shown.bs.offcanvas", (event) => {
          resetScroll(event.target);
        });
      })();
    </script>

    <script>
      (function () {
        function normalizePath(path) {
          try {
            const url = new URL(path, window.location.origin);
            let normalized = url.pathname || "/";
            if (normalized.length > 1 && normalized.endsWith("/")) {
              normalized = normalized.slice(0, -1);
            }
            return normalized || "/";
          } catch (_) {
            return path;
          }
        }

        function updateSidebarActive(endpoint) {
          const links = document.querySelectorAll("#sidebar .nav-link");
          const currentPath = normalizePath(window.location.pathname || "/");
          links.forEach((link) => {
            const raw = link.dataset.endpoints || "";
            const endpoints = raw.split(",").map((s) => s.trim()).filter(Boolean);
            const hrefPath = normalizePath(link.getAttribute("href") || "");
            const matchesEndpoint = endpoint && endpoints.includes(endpoint);
            const matchesPath = currentPath === hrefPath;
            const shouldActivate = Boolean(matchesEndpoint || matchesPath);
            link.classList.toggle("active", shouldActivate);
            if (shouldActivate) {
              link.setAttribute("aria-current", "page");
            } else {
              link.removeAttribute("aria-current");
            }
          });
        }

        function syncActiveNav() {
          const main = document.getElementById("main");
          const endpoint = main?.dataset?.activeEndpoint || "";
          updateSidebarActive(endpoint);
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", syncActiveNav, { once: true });
        } else {
          syncActiveNav();
        }

        window.addEventListener("popstate", syncActiveNav);
        document.addEventListener("htmx:afterSwap", function (event) {
          if (event.target && event.target.id === "main") {
            syncActiveNav();
          }
        });
      })();
    </script>

    <script>
      (function () {
        const SCROLL_TOP_FLAG = (window.DV && window.DV.scroll && window.DV.scroll.flag) || "dv:scroll-top-next";
        let pendingScroll = false;

        const markForScrollTop = (event) => {
          if (event.defaultPrevented) return;
          if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
          if (event.button !== 0) return;
          sessionStorage.setItem(SCROLL_TOP_FLAG, "1");
          pendingScroll = true;
          clearPreserveScroll();
        };

        const shouldIgnoreLink = (link) => {
          if (!link || link.dataset.noScrollTop === "true") return true;
          const href = link.getAttribute("href") || "";
          if (!href || href.startsWith("#") || href.startsWith("javascript:")) return true;
          const target = link.getAttribute("target");
          if (target && target !== "_self") return true;
          if (link.hasAttribute("download")) return true;
          return false;
        };

        const attachHandlers = (root) => {
          const scoped = root || document;
          const linkSelector = 'a[href]:not([data-scroll-top-attached="true"])';
          scoped.querySelectorAll(linkSelector).forEach((link) => {
            if (shouldIgnoreLink(link)) return;
            link.dataset.scrollTopAttached = "true";
            link.addEventListener("click", markForScrollTop);
          });
          const formSelector = 'form[data-preserve-scroll][data-scroll-top-attached="true"]';
          scoped.querySelectorAll(formSelector).forEach((form) => form.removeAttribute('data-scroll-top-attached'));
          scoped.querySelectorAll('form:not([data-scroll-top-attached="true"])').forEach((form) => {
            if (form.dataset.preserveScroll === "true") return;
            form.dataset.scrollTopAttached = "true";
            form.addEventListener("submit", () => {
              sessionStorage.setItem(SCROLL_TOP_FLAG, "1");
              pendingScroll = true;
            });
          });
        };

        const applyScrollTop = () => {
          if (pendingScroll || sessionStorage.getItem(SCROLL_TOP_FLAG)) {
            pendingScroll = false;
            sessionStorage.removeItem(SCROLL_TOP_FLAG);
            window.scrollTo(0, 0);
            clearPreserveScroll();
          }
        };

        attachHandlers(document);

        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                attachHandlers(node);
              }
            });
          });
        });

        observer.observe(document.body, { childList: true, subtree: true });

        window.addEventListener("pageshow", applyScrollTop);
        document.addEventListener("DOMContentLoaded", applyScrollTop);
        document.addEventListener("htmx:afterSwap", () => {
          attachHandlers(document);
          applyScrollTop();
        });
      })();
    </script>
    {% if session.get("force_full_refresh") %}
      {% set _ = session.pop("force_full_refresh", None) %}
      <script>
        // Force a hard reload after login so layout + permissions refresh everywhere
        window.location.replace(window.location.href);
      </script>
    {% endif %}
    <script>
      (function () {
        const footer = document.querySelector(".app-footer");
        const updateFooterVisibility = () => {
          if (!footer) return;
          const main = document.getElementById("main");
          const shouldShow = main && main.dataset.legalVisible === "1";
          footer.classList.toggle("d-none", !shouldShow);
        };
        document.addEventListener("DOMContentLoaded", updateFooterVisibility);
        document.addEventListener("htmx:afterSwap", (evt) => {
          if (evt.target && evt.target.id === "main") {
            updateFooterVisibility();
          }
        });
      })();
    </script>
    <script>
      window.CARD_BACK_PLACEHOLDER = "{{ url_for('static', filename='img/card-back-placeholder.png') }}";
    </script>

    <!-- App helpers -->
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dv-select.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/ui-enhancements.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/search-focus.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prints-cycler.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/face-flip.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/card-hover.js') }}" defer></script>
  </body>
</html>
